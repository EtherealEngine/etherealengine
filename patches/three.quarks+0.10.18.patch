diff --git a/node_modules/three.quarks/dist/three.quarks.cjs b/node_modules/three.quarks/dist/three.quarks.cjs
index 07037ca..146e363 100644
--- a/node_modules/three.quarks/dist/three.quarks.cjs
+++ b/node_modules/three.quarks/dist/three.quarks.cjs
@@ -1,5 +1,5 @@
 /**
- * three.quarks v0.10.18 build Mon Oct 23 2023
+ * three.quarks v0.10.18 build Tue Oct 24 2023
  * https://github.com/Alchemist0823/three.quarks#readme
  * Copyright 2023 Alchemist0823 <the.forrest.sun@gmail.com>, MIT
  */
@@ -1211,18 +1211,18 @@ var ColorRange = /*#__PURE__*/function () {
     _defineProperty(this, "type", void 0);
     this.a = a;
     this.b = b;
-    this.type = "function";
+    this.type = 'value';
   }
   _createClass(ColorRange, [{
     key: "genColor",
     value: function genColor(color, t) {
-      return color.copy(this.a).lerp(this.b, t);
+      return color.copy(this.a).lerp(this.b, Math.random());
     }
   }, {
     key: "toJSON",
     value: function toJSON() {
       return {
-        type: "ColorRange",
+        type: 'ColorRange',
         a: ColorToJSON(this.a),
         b: ColorToJSON(this.b)
       };
@@ -4629,7 +4629,7 @@ var ParticleSystem = /*#__PURE__*/function () {
     /**
      * the emitter object that should be added in the scene.
      *
-     * @type {ParticleEmitter<BaseEvent>}
+     * @type {ParticleEmitter<Object3DEventMap>}
      */
     _defineProperty(this, "emitter", void 0);
     /**
@@ -7295,7 +7295,7 @@ var NodeVFX = /*#__PURE__*/function () {
     /**
      * the emitter object that should be added in the scene.
      *
-     * @type {ParticleEmitter<BaseEvent>}
+     * @type {ParticleEmitter<Object3DEventMap>}
      */
     _defineProperty(this, "emitter", void 0);
     /**
diff --git a/node_modules/three.quarks/dist/three.quarks.esm.js b/node_modules/three.quarks/dist/three.quarks.esm.js
index 445b88f..17dac21 100644
--- a/node_modules/three.quarks/dist/three.quarks.esm.js
+++ b/node_modules/three.quarks/dist/three.quarks.esm.js
@@ -1,5 +1,5 @@
 /**
- * three.quarks v0.10.18 build Mon Oct 23 2023
+ * three.quarks v0.10.18 build Tue Oct 24 2023
  * https://github.com/Alchemist0823/three.quarks#readme
  * Copyright 2023 Alchemist0823 <the.forrest.sun@gmail.com>, MIT
  */
@@ -1209,18 +1209,18 @@ var ColorRange = /*#__PURE__*/function () {
     _defineProperty(this, "type", void 0);
     this.a = a;
     this.b = b;
-    this.type = "function";
+    this.type = 'value';
   }
   _createClass(ColorRange, [{
     key: "genColor",
     value: function genColor(color, t) {
-      return color.copy(this.a).lerp(this.b, t);
+      return color.copy(this.a).lerp(this.b, Math.random());
     }
   }, {
     key: "toJSON",
     value: function toJSON() {
       return {
-        type: "ColorRange",
+        type: 'ColorRange',
         a: ColorToJSON(this.a),
         b: ColorToJSON(this.b)
       };
@@ -4627,7 +4627,7 @@ var ParticleSystem = /*#__PURE__*/function () {
     /**
      * the emitter object that should be added in the scene.
      *
-     * @type {ParticleEmitter<BaseEvent>}
+     * @type {ParticleEmitter<Object3DEventMap>}
      */
     _defineProperty(this, "emitter", void 0);
     /**
@@ -7293,7 +7293,7 @@ var NodeVFX = /*#__PURE__*/function () {
     /**
      * the emitter object that should be added in the scene.
      *
-     * @type {ParticleEmitter<BaseEvent>}
+     * @type {ParticleEmitter<Object3DEventMap>}
      */
     _defineProperty(this, "emitter", void 0);
     /**
diff --git a/node_modules/three.quarks/dist/three.quarks.esm.min.js b/node_modules/three.quarks/dist/three.quarks.esm.min.js
index 35707fb..d19d152 100644
--- a/node_modules/three.quarks/dist/three.quarks.esm.min.js
+++ b/node_modules/three.quarks/dist/three.quarks.esm.min.js
@@ -1 +1 @@
-var e,t;e=void 0,t=function(e,t){function _regeneratorRuntime(){_regeneratorRuntime=function(){return t};var e,t={},i=Object.prototype,r=i.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag";function define(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{define({},"")}catch(e){define=function(e,t,i){return e[t]=i}}function wrap(e,t,i,r){var o=t&&t.prototype instanceof Generator?t:Generator,a=Object.create(o.prototype),s=new Context(r||[]);return n(a,"_invoke",{value:makeInvokeMethod(e,i,s)}),a}function tryCatch(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}t.wrap=wrap;var u="suspendedStart",c="suspendedYield",d="executing",h="completed",f={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(values([])));y&&y!==i&&r.call(y,a)&&(p=y);var v=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(e){["next","throw","return"].forEach((function(t){define(e,t,(function(e){return this._invoke(t,e)}))}))}function AsyncIterator(e,t){function invoke(i,n,o,a){var s=tryCatch(e[i],e,n);if("throw"!==s.type){var l=s.arg,u=l.value;return u&&"object"==typeof u&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){invoke("next",e,o,a)}),(function(e){invoke("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return invoke("throw",e,o,a)}))}a(s.arg)}var i;n(this,"_invoke",{value:function(e,r){function callInvokeWithMethodAndArg(){return new t((function(t,i){invoke(e,r,t,i)}))}return i=i?i.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(t,i,r){var n=u;return function(o,a){if(n===d)throw new Error("Generator is already running");if(n===h){if("throw"===o)throw a;return{value:e,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var l=maybeInvokeDelegate(s,r);if(l){if(l===f)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===u)throw n=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=d;var p=tryCatch(t,i,r);if("normal"===p.type){if(n=r.done?h:c,p.arg===f)continue;return{value:p.arg,done:r.done}}"throw"===p.type&&(n=h,r.method="throw",r.arg=p.arg)}}}function maybeInvokeDelegate(t,i){var r=i.method,n=t.iterator[r];if(n===e)return i.delegate=null,"throw"===r&&t.iterator.return&&(i.method="return",i.arg=e,maybeInvokeDelegate(t,i),"throw"===i.method)||"return"!==r&&(i.method="throw",i.arg=new TypeError("The iterator does not provide a '"+r+"' method")),f;var o=tryCatch(n,t.iterator,i.arg);if("throw"===o.type)return i.method="throw",i.arg=o.arg,i.delegate=null,f;var a=o.arg;return a?a.done?(i[t.resultName]=a.value,i.next=t.nextLoc,"return"!==i.method&&(i.method="next",i.arg=e),i.delegate=null,f):a:(i.method="throw",i.arg=new TypeError("iterator result is not an object"),i.delegate=null,f)}function pushTryEntry(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function resetTryEntry(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function Context(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t||""===t){var i=t[a];if(i)return i.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,o=function next(){for(;++n<t.length;)if(r.call(t,n))return next.value=t[n],next.done=!1,next;return next.value=e,next.done=!0,next};return o.next=o}}throw new TypeError(typeof t+" is not iterable")}return GeneratorFunction.prototype=GeneratorFunctionPrototype,n(v,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),n(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===GeneratorFunction||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,GeneratorFunctionPrototype):(e.__proto__=GeneratorFunctionPrototype,define(e,l,"GeneratorFunction")),e.prototype=Object.create(v),e},t.awrap=function(e){return{__await:e}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,s,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(e,i,r,n,o){void 0===o&&(o=Promise);var a=new AsyncIterator(wrap(e,i,r,n),o);return t.isGeneratorFunction(i)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},defineIteratorMethods(v),define(v,l,"Generator"),define(v,a,(function(){return this})),define(v,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),i=[];for(var r in t)i.push(r);return i.reverse(),function next(){for(;i.length;){var e=i.pop();if(e in t)return next.value=e,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(resetTryEntry),!t)for(var i in this)"t"===i.charAt(0)&&r.call(this,i)&&!isNaN(+i.slice(1))&&(this[i]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var i=this;function handle(r,n){return a.type="throw",a.arg=t,i.next=r,n&&(i.method="next",i.arg=e),!!n}for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n],a=o.completion;if("root"===o.tryLoc)return handle("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(s&&l){if(this.prev<o.catchLoc)return handle(o.catchLoc,!0);if(this.prev<o.finallyLoc)return handle(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return handle(o.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return handle(o.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&r.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),resetTryEntry(i),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var n=r.arg;resetTryEntry(i)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(t,i,r){return this.delegate={iterator:values(t),resultName:i,nextLoc:r},"next"===this.method&&(this.arg=e),f}},t}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _createSuper(e){var t=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var i,r=_getPrototypeOf(e);if(t){var n=_getPrototypeOf(this).constructor;i=Reflect.construct(r,arguments,n)}else i=r.apply(this,arguments);return function _possibleConstructorReturn(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}(this,i)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(e,t,i){var r=function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(arguments.length<3?e:i):n.value}},_get.apply(this,arguments)}function _slicedToArray(e,t){return function _arrayWithHoles(e){if(Array.isArray(e))return e}(e)||function _iterableToArrayLimit(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var r,n,o,a,s=[],l=!0,u=!1;try{if(o=(i=i.call(e)).next,0===t){if(Object(i)!==i)return;l=!1}else for(;!(l=(r=o.call(i)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){u=!0,n=e}finally{try{if(!l&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(u)throw n}}return s}}(e,t)||_unsupportedIterableToArray(e,t)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function _createForOfIteratorHelper(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0,F=function(){};return{s:F,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,a=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){a=!0,n=e},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw n}}}}function _toPropertyKey(e){var t=function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}var i=function(e){_inherits(ParticleEmitter,e);var t=_createSuper(ParticleEmitter);function ParticleEmitter(e){var i;return _classCallCheck(this,ParticleEmitter),_defineProperty(_assertThisInitialized(i=t.call(this)),"type","ParticleEmitter"),_defineProperty(_assertThisInitialized(i),"system",void 0),i.system=e,i}return _createClass(ParticleEmitter,[{key:"clone",value:function clone(){var e=this.system.clone();return e.emitter.copy(this,!0),e.emitter}},{key:"dispose",value:function dispose(){}},{key:"extractFromCache",value:function extractFromCache(e){var t=[];for(var i in e){var r=e[i];delete r.metadata,t.push(r)}return t}},{key:"toJSON",value:function toJSON(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=void 0===e||"string"==typeof e,r={};i&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var n={};if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),null!==this.system&&(n.ps=this.system.toJSON(e,t)),this.children.length>0){n.children=[];for(var o=0;o<this.children.length;o++)"ParticleSystemPreview"!==this.children[o].type&&n.children.push(this.children[o].toJSON(e).object)}if(i){var a=this.extractFromCache(e.geometries),s=this.extractFromCache(e.materials),l=this.extractFromCache(e.textures),u=this.extractFromCache(e.images);a.length>0&&(r.geometries=a),s.length>0&&(r.materials=s),l.length>0&&(r.textures=l),u.length>0&&(r.images=u)}return r.object=n,r}}]),ParticleEmitter}(t.Object3D),r=function(){function LinkedListNode(e){_classCallCheck(this,LinkedListNode),_defineProperty(this,"data",void 0),_defineProperty(this,"next",void 0),_defineProperty(this,"prev",void 0),this.data=e,this.next=null,this.prev=null}return _createClass(LinkedListNode,[{key:"hasPrev",value:function hasPrev(){return null!==this.prev}},{key:"hasNext",value:function hasNext(){return null!==this.next}}]),LinkedListNode}(),n=function(){function LinkedList(){_classCallCheck(this,LinkedList),_defineProperty(this,"length",void 0),_defineProperty(this,"head",void 0),_defineProperty(this,"tail",void 0),this.length=0,this.head=this.tail=null}return _createClass(LinkedList,[{key:"isEmpty",value:function isEmpty(){return null===this.head}},{key:"clear",value:function clear(){this.length=0,this.head=this.tail=null}},{key:"front",value:function front(){return null===this.head?null:this.head.data}},{key:"back",value:function back(){return null===this.tail?null:this.tail.data}},{key:"dequeue",value:function dequeue(){if(this.head){var e=this.head.data;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}}},{key:"pop",value:function pop(){if(this.tail){var e=this.tail.data;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}}},{key:"queue",value:function queue(e){var t=new r(e);this.tail||(this.tail=t),this.head&&(this.head.prev=t,t.next=this.head),this.head=t,this.length++}},{key:"push",value:function push(e){var t=new r(e);this.head||(this.head=t),this.tail&&(this.tail.next=t,t.prev=this.tail),this.tail=t,this.length++}},{key:"insertBefore",value:function insertBefore(e,t){var i=new r(t);i.next=e,i.prev=e.prev,null!==i.prev&&(i.prev.next=i),i.next.prev=i,e==this.head&&(this.head=i),this.length++}},{key:"remove",value:function remove(e){if(null!==this.head&&null!==this.tail){var t=this.head;for(e===this.head.data&&(this.head=this.head.next),e===this.tail.data&&(this.tail=this.tail.prev);null!==t.next&&t.data!==e;)t=t.next;t.data===e&&(null!==t.prev&&(t.prev.next=t.next),null!==t.next&&(t.next.prev=t.prev),this.length--)}}},{key:"values",value:_regeneratorRuntime().mark((function values(){var e;return _regeneratorRuntime().wrap((function values$(t){for(;;)switch(t.prev=t.next){case 0:e=this.head;case 1:if(null===e){t.next=7;break}return t.next=4,e.data;case 4:e=e.next,t.next=1;break;case 7:case"end":return t.stop()}}),values,this)}))}]),LinkedList}(),o=function(){function NodeParticle(){_classCallCheck(this,NodeParticle),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"angularVelocity",void 0),_defineProperty(this,"rotation",0),_defineProperty(this,"color",new t.Vector4(1,1,1,1)),_defineProperty(this,"uvTile",0)}return _createClass(NodeParticle,[{key:"died",get:function get(){return this.age>=this.life}},{key:"reset",value:function reset(){this.position.set(0,0,0),this.velocity.set(0,0,0),this.age=0,this.life=1,this.size=1,this.rotation=0,this.color.set(1,1,1,1),this.uvTile=0}}]),NodeParticle}(),a=function(){function SpriteParticle(){_classCallCheck(this,SpriteParticle),_defineProperty(this,"parentMatrix",void 0),_defineProperty(this,"startSpeed",0),_defineProperty(this,"startColor",new t.Vector4),_defineProperty(this,"startSize",1),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"angularVelocity",void 0),_defineProperty(this,"rotation",0),_defineProperty(this,"color",new t.Vector4),_defineProperty(this,"uvTile",0)}return _createClass(SpriteParticle,[{key:"died",get:function get(){return this.age>=this.life}}]),SpriteParticle}(),s=_createClass((function RecordState(e,t,i){_classCallCheck(this,RecordState),this.position=e,this.size=t,this.color=i})),l=function(){function TrailParticle(){_classCallCheck(this,TrailParticle),_defineProperty(this,"parentMatrix",void 0),_defineProperty(this,"startSpeed",0),_defineProperty(this,"startColor",new t.Vector4),_defineProperty(this,"startSize",1),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"localPosition",void 0),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"length",100),_defineProperty(this,"color",new t.Vector4),_defineProperty(this,"previous",new n),_defineProperty(this,"uvTile",0)}return _createClass(TrailParticle,[{key:"update",value:function update(){for(this.age<=this.life?this.previous.push(new s(this.position.clone(),this.size,this.color.clone())):this.previous.length>0&&this.previous.dequeue();this.previous.length>this.length;)this.previous.dequeue()}},{key:"died",get:function get(){return this.age>=this.life}},{key:"reset",value:function reset(){this.previous.clear()}}]),TrailParticle}(),u=function(){function Bezier(e,t,i,r){_classCallCheck(this,Bezier),_defineProperty(this,"p",void 0),this.p=[e,t,i,r]}return _createClass(Bezier,[{key:"genValue",value:function genValue(e){var t=e*e,i=e*e*e,r=1-e,n=r*r,o=n*r;return this.p[0]*o+this.p[1]*n*e*3+this.p[2]*r*t*3+this.p[3]*i}},{key:"derivativeCoefficients",value:function derivativeCoefficients(e){for(var t=[],i=e,r=i.length-1;r>0;r--){for(var n=[],o=0;o<r;o++){var a=r*(i[o+1]-i[o]);n.push(a)}t.push(n),i=n}return t}},{key:"getSlope",value:function getSlope(e){var t=this.derivativeCoefficients(this.p)[0],i=1-e,r=i*e*2,n=e*e;return i*i*t[0]+r*t[1]+n*t[2]}},{key:"controlCurve",value:function controlCurve(e,t){this.p[1]=e/3+this.p[0],this.p[2]=this.p[3]-t/3}},{key:"hull",value:function hull(e){var t,i=this.p,r=[],n=0,o=0,a=0,s=[];for(s[n++]=i[0],s[n++]=i[1],s[n++]=i[2],s[n++]=i[3];i.length>1;){for(r=[],o=0,a=i.length-1;o<a;o++)t=e*i[o]+(1-e)*i[o+1],s[n++]=t,r.push(t);i=r}return s}},{key:"split",value:function split(e){var t=this.hull(e);return{left:new Bezier(t[0],t[4],t[7],t[9]),right:new Bezier(t[9],t[8],t[6],t[3]),span:t}}},{key:"clone",value:function clone(){return new Bezier(this.p[0],this.p[1],this.p[2],this.p[3])}},{key:"toJSON",value:function toJSON(){return{p0:this.p[0],p1:this.p[1],p2:this.p[2],p3:this.p[3]}}}],[{key:"fromJSON",value:function fromJSON(e){return new Bezier(e.p0,e.p1,e.p2,e.p3)}}]),Bezier}(),c=function ColorToJSON(e){return{r:e.x,g:e.y,b:e.z,a:e.w}},d=function JSONToColor(e){return new t.Vector4(e.r,e.g,e.b,e.a)},h=function JSONToValue(e,i){switch(i){case"Vector3":return new t.Vector3(e.x,e.y,e.z);case"Vector4":return new t.Vector4(e.x,e.y,e.z,e.w);case"Color":return new t.Vector3(e.r,e.g,e.b);default:return e}},f=function ValueToJSON(e,t){switch(t){case"Vector3":return{x:e.x,y:e.y,z:e.z};case"Vector4":return{x:e.x,y:e.y,z:e.z,w:e.w};case"Color":return{r:e.x,g:e.y,b:e.z};default:return e}},p=function(){function RandomColor(e,t){_classCallCheck(this,RandomColor),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="value"}return _createClass(RandomColor,[{key:"genColor",value:function genColor(e){var t=Math.random();return e.copy(this.a).lerp(this.b,t)}},{key:"toJSON",value:function toJSON(){return{type:"RandomColor",a:c(this.a),b:c(this.b)}}},{key:"clone",value:function clone(){return new RandomColor(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomColor(d(e.a),d(e.b))}}]),RandomColor}(),m=function(){function ColorRange(e,t){_classCallCheck(this,ColorRange),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="function"}return _createClass(ColorRange,[{key:"genColor",value:function genColor(e,t){return e.copy(this.a).lerp(this.b,t)}},{key:"toJSON",value:function toJSON(){return{type:"ColorRange",a:c(this.a),b:c(this.b)}}},{key:"clone",value:function clone(){return new ColorRange(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorRange(d(e.a),d(e.b))}}]),ColorRange}(),y=function(){function ContinuousLinearFunction(e,t){_classCallCheck(this,ContinuousLinearFunction),_defineProperty(this,"keys",void 0),_defineProperty(this,"type",void 0),_defineProperty(this,"subType",void 0),this.subType=t,this.type="function",this.keys=e}return _createClass(ContinuousLinearFunction,[{key:"findKey",value:function findKey(e){for(var t=0,i=0,r=this.keys.length-1;i+1<r;)if(t=Math.floor((i+r)/2),e<this.getStartX(t))r=t-1;else{if(!(e>this.getEndX(t)))return t;i=t+1}for(var n=i;n<=r;n++)if(e>=this.getStartX(n)&&e<=this.getEndX(n))return n;return-1}},{key:"getStartX",value:function getStartX(e){return this.keys[e][1]}},{key:"getEndX",value:function getEndX(e){return e+1<this.keys.length?this.keys[e+1][1]:1}},{key:"genValue",value:function genValue(e,t){var i=this.findKey(t);return"Number"===this.subType?-1===i?this.keys[0][0]:i+1>=this.keys.length?this.keys[this.keys.length-1][0]:(this.keys[i+1][0]-this.keys[i][0])*((t-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))+this.keys[i][0]:-1===i?e.copy(this.keys[0][0]):i+1>=this.keys.length?e.copy(this.keys[this.keys.length-1][0]):e.copy(this.keys[i][0]).lerp(this.keys[i+1][0],(t-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))}},{key:"toJSON",value:function toJSON(){var e=this;return this.keys[0][0].constructor.name,{type:"CLinearFunction",subType:this.subType,keys:this.keys.map((function(t){var i=_slicedToArray(t,2),r=i[0],n=i[1];return{value:f(r,e.subType),pos:n}}))}}},{key:"clone",value:function clone(){return"Number"===this.subType?new ContinuousLinearFunction(this.keys.map((function(e){var t=_slicedToArray(e,2);return[t[0],t[1]]})),this.subType):new ContinuousLinearFunction(this.keys.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return[i.clone(),r]})),this.subType)}}],[{key:"fromJSON",value:function fromJSON(e){return new ContinuousLinearFunction(e.keys.map((function(t){return[h(t.value,e.subType),t.pos]})),e.subType)}}]),ContinuousLinearFunction}(),v=new t.Vector3,g=function(){function Gradient(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new t.Vector3(0,0,0),0],[new t.Vector3(1,1,1),0]],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[[1,0],[1,1]];_classCallCheck(this,Gradient),_defineProperty(this,"type",void 0),_defineProperty(this,"color",void 0),_defineProperty(this,"alpha",void 0),this.type="function",this.color=new y(e,"Color"),this.alpha=new y(i,"Number")}return _createClass(Gradient,[{key:"genColor",value:function genColor(e,t){return this.color.genValue(v,t),e.set(v.x,v.y,v.z,this.alpha.genValue(1,t))}},{key:"toJSON",value:function toJSON(){return{type:"Gradient",color:this.color.toJSON(),alpha:this.alpha.toJSON()}}},{key:"clone",value:function clone(){var e=new Gradient;return e.alpha=this.alpha.clone(),e.color=this.color.clone(),e}}],[{key:"fromJSON",value:function fromJSON(e){if(e.functions){var i=e.functions.map((function(e){return[m.fromJSON(e.function).a,e.start]}));return e.functions.length>0&&i.push([m.fromJSON(e.functions[e.functions.length-1].function).b,1]),new Gradient(i.map((function(e){return[new t.Vector3(e[0].x,e[0].y,e[0].z),e[1]]})),i.map((function(e){return[e[0].w,e[1]]})))}var r=new Gradient;return r.alpha=y.fromJSON(e.alpha),r.color=y.fromJSON(e.color),r}}]),Gradient}(),S=new t.Vector4,_=function(){function RandomColorBetweenGradient(e,t){_classCallCheck(this,RandomColorBetweenGradient),_defineProperty(this,"gradient1",void 0),_defineProperty(this,"gradient2",void 0),_defineProperty(this,"type",void 0),this.type="memorizedFunction",this.gradient1=e,this.gradient2=t}return _createClass(RandomColorBetweenGradient,[{key:"startGen",value:function startGen(e){e.rand=Math.random()}},{key:"genColor",value:function genColor(e,t,i){return this.gradient1.genColor(e,t),this.gradient2.genColor(S,t),i&&i.rand?e.lerp(S,i.rand):e.lerp(S,Math.random()),e}},{key:"toJSON",value:function toJSON(){return{type:"RandomColorBetweenGradient",gradient1:this.gradient1.toJSON(),gradient2:this.gradient2.toJSON()}}},{key:"clone",value:function clone(){return new RandomColorBetweenGradient(this.gradient1.clone(),this.gradient2.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomColorBetweenGradient(g.fromJSON(e.gradient1),g.fromJSON(e.gradient2))}}]),RandomColorBetweenGradient}(),w=function(){function ConstantColor(e){_classCallCheck(this,ConstantColor),_defineProperty(this,"type",void 0),this.color=e,this.type="value"}return _createClass(ConstantColor,[{key:"genColor",value:function genColor(e){return e.copy(this.color)}},{key:"toJSON",value:function toJSON(){return{type:"ConstantColor",color:c(this.color)}}},{key:"clone",value:function clone(){return new ConstantColor(this.color.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ConstantColor(d(e.color))}}]),ConstantColor}();function ColorGeneratorFromJSON(e){switch(e.type){case"ConstantColor":return w.fromJSON(e);case"ColorRange":return m.fromJSON(e);case"RandomColor":return p.fromJSON(e);case"Gradient":return g.fromJSON(e);case"RandomColorBetweenGradient":return _.fromJSON(e);default:return new w(new t.Vector4(1,1,1,1))}}var O=function(){function ConstantValue(e){_classCallCheck(this,ConstantValue),_defineProperty(this,"type",void 0),this.value=e,this.type="value"}return _createClass(ConstantValue,[{key:"genValue",value:function genValue(){return this.value}},{key:"toJSON",value:function toJSON(){return{type:"ConstantValue",value:this.value}}},{key:"clone",value:function clone(){return new ConstantValue(this.value)}}],[{key:"fromJSON",value:function fromJSON(e){return new ConstantValue(e.value)}}]),ConstantValue}(),x=function(){function IntervalValue(e,t){_classCallCheck(this,IntervalValue),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="value"}return _createClass(IntervalValue,[{key:"genValue",value:function genValue(){return t.MathUtils.lerp(this.a,this.b,Math.random())}},{key:"toJSON",value:function toJSON(){return{type:"IntervalValue",a:this.a,b:this.b}}},{key:"clone",value:function clone(){return new IntervalValue(this.a,this.b)}}],[{key:"fromJSON",value:function fromJSON(e){return new IntervalValue(e.a,e.b)}}]),IntervalValue}(),b=function(){function PiecewiseFunction(){_classCallCheck(this,PiecewiseFunction),_defineProperty(this,"functions",void 0),this.functions=new Array}return _createClass(PiecewiseFunction,[{key:"findFunction",value:function findFunction(e){for(var t=0,i=0,r=this.functions.length-1;i+1<r;)if(t=Math.floor((i+r)/2),e<this.getStartX(t))r=t-1;else{if(!(e>this.getEndX(t)))return t;i=t+1}for(var n=i;n<=r;n++)if(e>=this.functions[n][1]&&e<=this.getEndX(n))return n;return-1}},{key:"getStartX",value:function getStartX(e){return this.functions[e][1]}},{key:"setStartX",value:function setStartX(e,t){e>0&&(this.functions[e][1]=t)}},{key:"getEndX",value:function getEndX(e){return e+1<this.functions.length?this.functions[e+1][1]:1}},{key:"setEndX",value:function setEndX(e,t){e+1<this.functions.length&&(this.functions[e+1][1]=t)}},{key:"insertFunction",value:function insertFunction(e,t){var i=this.findFunction(e);this.functions.splice(i+1,0,[t,e])}},{key:"removeFunction",value:function removeFunction(e){return this.functions.splice(e,1)[0][0]}},{key:"getFunction",value:function getFunction(e){return this.functions[e][0]}},{key:"setFunction",value:function setFunction(e,t){this.functions[e][0]=t}},{key:"numOfFunctions",get:function get(){return this.functions.length}}]),PiecewiseFunction}(),N=function(e){_inherits(PiecewiseBezier,e);var t=_createSuper(PiecewiseBezier);function PiecewiseBezier(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new u(0,1/3,1/3*2,1),0]];return _classCallCheck(this,PiecewiseBezier),_defineProperty(_assertThisInitialized(e=t.call(this)),"type",void 0),e.type="function",e.functions=i,e}return _createClass(PiecewiseBezier,[{key:"genValue",value:function genValue(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this.findFunction(e);return-1===t?0:this.functions[t][0].genValue((e-this.getStartX(t))/(this.getEndX(t)-this.getStartX(t)))}},{key:"toSVG",value:function toSVG(e,t){if(t<1)return"";for(var i=["M",0,this.functions[0][0].p[0]].join(" "),r=1/t;r<=1;r+=1/t)i=[i,"L",r*e,this.genValue(r)].join(" ");return i}},{key:"toJSON",value:function toJSON(){return{type:"PiecewiseBezier",functions:this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return{function:i.toJSON(),start:r}}))}}},{key:"clone",value:function clone(){return new PiecewiseBezier(this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return[i.clone(),r]})))}}],[{key:"fromJSON",value:function fromJSON(e){return new PiecewiseBezier(e.functions.map((function(e){return[u.fromJSON(e.function),e.start]})))}}]),PiecewiseBezier}(b);function ValueGeneratorFromJSON(e){switch(e.type){case"ConstantValue":return O.fromJSON(e);case"IntervalValue":return x.fromJSON(e);case"PiecewiseBezier":return N.fromJSON(e);default:return new O(0)}}var P=function(){function RandomQuatGenerator(){_classCallCheck(this,RandomQuatGenerator),_defineProperty(this,"type",void 0),this.type="rotation"}return _createClass(RandomQuatGenerator,[{key:"genValue",value:function genValue(e,t){var i,r,n,o,a,s;do{n=(i=2*Math.random()-1)*i+(r=2*Math.random()-1)*r}while(n>1);do{s=(o=2*Math.random()-1)*o+(a=2*Math.random()-1)*a}while(s>1);var l=Math.sqrt((1-n)/s);return e.set(i,r,l*o,l*a),e}},{key:"toJSON",value:function toJSON(){return{type:"RandomQuat"}}},{key:"clone",value:function clone(){return new RandomQuatGenerator}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomQuatGenerator}}]),RandomQuatGenerator}(),k=function(){function AxisAngleGenerator(e,t){_classCallCheck(this,AxisAngleGenerator),_defineProperty(this,"type",void 0),this.axis=e,this.angle=t,this.type="rotation"}return _createClass(AxisAngleGenerator,[{key:"genValue",value:function genValue(e,t){return e.setFromAxisAngle(this.axis,this.angle.genValue(t))}},{key:"toJSON",value:function toJSON(){return{type:"AxisAngle",axis:{x:this.axis.x,y:this.axis.y,z:this.axis.z},angle:this.angle.toJSON()}}},{key:"clone",value:function clone(){return new AxisAngleGenerator(this.axis.clone(),this.angle.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new AxisAngleGenerator(new t.Vector3(e.axis.x,e.axis.y,e.axis.z),ValueGeneratorFromJSON(e.angle))}}]),AxisAngleGenerator}(),M=function(){function EulerGenerator(e,i,r,n){_classCallCheck(this,EulerGenerator),_defineProperty(this,"type",void 0),_defineProperty(this,"eular",void 0),this.angleX=e,this.angleY=i,this.angleZ=r,this.type="rotation",this.eular=new t.Euler(0,0,0,n)}return _createClass(EulerGenerator,[{key:"genValue",value:function genValue(e,t){return this.eular.set(this.angleX.genValue(t),this.angleY.genValue(t),this.angleZ.genValue(t)),e.setFromEuler(this.eular)}},{key:"toJSON",value:function toJSON(){return{type:"Euler",angleX:this.angleX.toJSON(),angleY:this.angleY.toJSON(),angleZ:this.angleZ.toJSON(),eulerOrder:this.eular.order}}},{key:"clone",value:function clone(){return new EulerGenerator(this.angleX,this.angleY,this.angleZ,this.eular.order)}}],[{key:"fromJSON",value:function fromJSON(e){return new EulerGenerator(ValueGeneratorFromJSON(e.angleX),ValueGeneratorFromJSON(e.angleY),ValueGeneratorFromJSON(e.angleZ),e.eulerOrder)}}]),EulerGenerator}();function RotationGeneratorFromJSON(e){switch(e.type){case"AxisAngle":return k.fromJSON(e);case"Euler":return M.fromJSON(e);case"RandomQuat":return P.fromJSON(e);default:return new P}}function GeneratorFromJSON(e){switch(e.type){case"ConstantValue":case"IntervalValue":case"PiecewiseBezier":return ValueGeneratorFromJSON(e);case"AxisAngle":case"RandomQuat":case"Euler":return RotationGeneratorFromJSON(e);default:return new O(0)}}var C=function(){function ColorOverLife(e){_classCallCheck(this,ColorOverLife),_defineProperty(this,"type","ColorOverLife"),this.color=e}return _createClass(ColorOverLife,[{key:"initialize",value:function initialize(e){"memorizedFunction"===this.color.type&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function update(e,t){"memorizedFunction"===this.color.type?this.color.genColor(e.color,e.age/e.life,e.colorOverLifeMemory):this.color.genColor(e.color,e.age/e.life),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,color:this.color.toJSON()}}},{key:"clone",value:function clone(){return new ColorOverLife(this.color.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorOverLife(ColorGeneratorFromJSON(e.color))}}]),ColorOverLife}(),V=function(){function RotationOverLife(e,i){_classCallCheck(this,RotationOverLife),_defineProperty(this,"type","RotationOverLife"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.dynamic=i}return _createClass(RotationOverLife,[{key:"initialize",value:function initialize(e){!this.dynamic&&e instanceof a&&(e.angularVelocity=this.angularVelocity.genValue())}},{key:"update",value:function update(e,t){this.dynamic?e.rotation+=t*this.angularVelocity.genValue(e.age/e.life):e instanceof a&&(e.rotation+=t*e.angularVelocity)}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new RotationOverLife(this.angularVelocity.clone(),this.dynamic)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new RotationOverLife(ValueGeneratorFromJSON(e.angularVelocity),e.dynamic)}}]),RotationOverLife}(),B=new t.Quaternion,T=function(){function Rotation3DOverLife(e,i){_classCallCheck(this,Rotation3DOverLife),_defineProperty(this,"type","Rotation3DOverLife"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.dynamic=i}return _createClass(Rotation3DOverLife,[{key:"initialize",value:function initialize(e){!this.dynamic&&e instanceof a&&(e.angularVelocity=new t.Quaternion,this.angularVelocity.genValue(e.angularVelocity))}},{key:"update",value:function update(e,t){this.dynamic?(this.angularVelocity.genValue(this.tempQuat,e.age/e.life),this.tempQuat.slerpQuaternions(B,this.tempQuat,t),e.rotation.multiply(this.tempQuat)):e instanceof a&&(this.tempQuat.slerpQuaternions(B,e.angularVelocity,t),e.rotation.multiply(this.tempQuat))}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new Rotation3DOverLife(this.angularVelocity.clone(),this.dynamic)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new Rotation3DOverLife(RotationGeneratorFromJSON(e.angularVelocity),e.dynamic)}}]),Rotation3DOverLife}(),E=function(){function ForceOverLife(e,i,r){_classCallCheck(this,ForceOverLife),_defineProperty(this,"type","ForceOverLife"),_defineProperty(this,"_temp",new t.Vector3),this.x=e,this.y=i,this.z=r}return _createClass(ForceOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this._temp.set(this.x.genValue(e.age/e.life),this.y.genValue(e.age/e.life),this.z.genValue(e.age/e.life)),e.velocity.addScaledVector(this._temp,t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,x:this.x.toJSON(),y:this.y.toJSON(),z:this.z.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new ForceOverLife(this.x.clone(),this.y.clone(),this.z.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ForceOverLife(ValueGeneratorFromJSON(e.x),ValueGeneratorFromJSON(e.y),ValueGeneratorFromJSON(e.z))}}]),ForceOverLife}(),z=function(){function SizeOverLife(e){_classCallCheck(this,SizeOverLife),_defineProperty(this,"type","SizeOverLife"),this.size=e}return _createClass(SizeOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){e.size=e.startSize*this.size.genValue(e.age/e.life)}},{key:"toJSON",value:function toJSON(){return{type:this.type,size:this.size.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SizeOverLife(this.size.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SizeOverLife(ValueGeneratorFromJSON(e.size))}}]),SizeOverLife}(),A=function(){function SpeedOverLife(e){_classCallCheck(this,SpeedOverLife),_defineProperty(this,"type","SpeedOverLife"),this.speed=e}return _createClass(SpeedOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){e.speedModifier=this.speed.genValue(e.age/e.life)}},{key:"toJSON",value:function toJSON(){return{type:this.type,speed:this.speed.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SpeedOverLife(this.speed.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SpeedOverLife(ValueGeneratorFromJSON(e.speed))}}]),SpeedOverLife}(),J=function(){function FrameOverLife(e){_classCallCheck(this,FrameOverLife),_defineProperty(this,"type","FrameOverLife"),this.frame=e}return _createClass(FrameOverLife,[{key:"initialize",value:function initialize(e){this.frame instanceof N||(e.uvTile=Math.floor(this.frame.genValue(0)))}},{key:"update",value:function update(e,t){this.frame instanceof N&&(e.uvTile=Math.floor(this.frame.genValue(e.age/e.life)))}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,frame:this.frame.toJSON()}}},{key:"clone",value:function clone(){return new FrameOverLife(this.frame.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new FrameOverLife(ValueGeneratorFromJSON(e.frame))}}]),FrameOverLife}();new t.Vector3(0,0,1);var L=function(){function OrbitOverLife(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new t.Vector3(0,1,0);_classCallCheck(this,OrbitOverLife),_defineProperty(this,"type","OrbitOverLife"),_defineProperty(this,"rotation",void 0),_defineProperty(this,"line",void 0),_defineProperty(this,"temp",new t.Vector3),this.orbitSpeed=e,this.axis=i,this.rotation=new t.Quaternion,this.line=new t.Line3}return _createClass(OrbitOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,i){this.line.set(new t.Vector3(0,0,0),this.axis),this.line.closestPointToPoint(e.position,!1,this.temp),this.rotation.setFromAxisAngle(this.axis,this.orbitSpeed.genValue(e.age/e.life)*i),e.position.sub(this.temp),e.position.applyQuaternion(this.rotation),e.position.add(this.temp)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,orbitSpeed:this.orbitSpeed.toJSON(),axis:[this.axis.x,this.axis.y,this.axis.z]}}},{key:"clone",value:function clone(){return new OrbitOverLife(this.orbitSpeed.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new OrbitOverLife(ValueGeneratorFromJSON(e.orbitSpeed),e.axis?new t.Vector3(e.axis[0],e.axis[1],e.axis[2]):void 0)}}]),OrbitOverLife}(),U=function(){function WidthOverLength(e){_classCallCheck(this,WidthOverLength),_defineProperty(this,"type","WidthOverLength"),this.width=e}return _createClass(WidthOverLength,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){if(e instanceof l)for(var t=e.previous.values(),i=0;i<e.previous.length;i++)t.next().value.size=this.width.genValue((e.previous.length-i)/e.length)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,width:this.width.toJSON()}}},{key:"clone",value:function clone(){return new WidthOverLength(this.width.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new WidthOverLength(ValueGeneratorFromJSON(e.width))}}]),WidthOverLength}(),R=function(){function ApplyForce(e,t){_classCallCheck(this,ApplyForce),_defineProperty(this,"type","ApplyForce"),_defineProperty(this,"magnitudeValue",void 0),this.direction=e,this.magnitude=t,this.magnitudeValue=this.magnitude.genValue()}return _createClass(ApplyForce,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){e.velocity.addScaledVector(this.direction,this.magnitudeValue*t)}},{key:"frameUpdate",value:function frameUpdate(e){this.magnitudeValue=this.magnitude.genValue()}},{key:"toJSON",value:function toJSON(){return{type:this.type,direction:[this.direction.x,this.direction.y,this.direction.z],magnitude:this.magnitude.toJSON()}}},{key:"clone",value:function clone(){return new ApplyForce(this.direction.clone(),this.magnitude.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){var i;return new ApplyForce(new t.Vector3(e.direction[0],e.direction[1],e.direction[2]),ValueGeneratorFromJSON(null!==(i=e.magnitude)&&void 0!==i?i:e.force))}}]),ApplyForce}(),I=function(){function GravityForce(e,i){_classCallCheck(this,GravityForce),_defineProperty(this,"type","GravityForce"),_defineProperty(this,"temp",new t.Vector3),this.center=e,this.magnitude=i}return _createClass(GravityForce,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this.temp.copy(this.center).sub(e.position).normalize(),e.velocity.addScaledVector(this.temp,this.magnitude/e.position.distanceToSquared(this.center)*t)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,center:[this.center.x,this.center.y,this.center.z],magnitude:this.magnitude}}},{key:"clone",value:function clone(){return new GravityForce(this.center.clone(),this.magnitude)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new GravityForce(new t.Vector3(e.center[0],e.center[1],e.center[2]),e.magnitude)}}]),GravityForce}();new t.Vector3(0,0,1);var G=function(){function ChangeEmitDirection(e){_classCallCheck(this,ChangeEmitDirection),_defineProperty(this,"type","ChangeEmitDirection"),_defineProperty(this,"_temp",new t.Vector3),_defineProperty(this,"_q",new t.Quaternion),this.angle=e}return _createClass(ChangeEmitDirection,[{key:"initialize",value:function initialize(e){var t=e.velocity.length();0!=t&&(e.velocity.normalize(),0===e.velocity.x&&0===e.velocity.y?this._temp.set(0,e.velocity.z,0):this._temp.set(-e.velocity.y,e.velocity.x,0),this._q.setFromAxisAngle(this._temp.normalize(),this.angle.genValue()),this._temp.copy(e.velocity),e.velocity.applyQuaternion(this._q),this._q.setFromAxisAngle(this._temp,Math.random()*Math.PI*2),e.velocity.applyQuaternion(this._q),e.velocity.setLength(t))}},{key:"update",value:function update(e,t){}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,angle:this.angle.toJSON()}}},{key:"clone",value:function clone(){return new ChangeEmitDirection(this.angle)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ChangeEmitDirection(ValueGeneratorFromJSON(e.angle))}}]),ChangeEmitDirection}(),D=new t.Vector3(1,1,1),q=new t.Vector3(0,0,1),X=function(e){return e[e.Death=0]="Death",e[e.Birth=1]="Birth",e[e.Frame=2]="Frame",e}({}),j=function(){function EmitSubParticleSystem(e,i,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:X.Frame,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;_classCallCheck(this,EmitSubParticleSystem),_defineProperty(this,"type","EmitSubParticleSystem"),_defineProperty(this,"q_",new t.Quaternion),_defineProperty(this,"v_",new t.Vector3),_defineProperty(this,"v2_",new t.Vector3),_defineProperty(this,"subEmissions",new Array),this.particleSystem=e,this.useVelocityAsBasis=i,this.subParticleSystem=r,this.mode=n,this.emitProbability=o,this.subParticleSystem&&this.subParticleSystem.system&&(this.subParticleSystem.system.onlyUsedByOther=!0)}return _createClass(EmitSubParticleSystem,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){(this.mode===X.Frame||this.mode===X.Birth&&0===e.age||this.mode===X.Death&&e.age+t>=e.life)&&this.emit(e,t)}},{key:"emit",value:function emit(e,i){if(this.subParticleSystem&&!(Math.random()>this.emitProbability)){var r=new t.Matrix4;this.setMatrixFromParticle(r,e),this.subEmissions.push({burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,matrix:r,travelDistance:0,particle:e})}}},{key:"frameUpdate",value:function frameUpdate(e){if(this.subParticleSystem)for(var t=0;t<this.subEmissions.length;t++)if(this.subEmissions[t].time>=this.subParticleSystem.system.duration)this.subEmissions[t]=this.subEmissions[this.subEmissions.length-1],this.subEmissions.length=this.subEmissions.length-1,t--;else{var i=this.subEmissions[t];i.particle&&i.particle.age<i.particle.life?this.setMatrixFromParticle(i.matrix,i.particle):i.particle=void 0,console.log(i),console.log(this.subParticleSystem.system.emissionOverDistance),this.subParticleSystem.system.emit(e,i,i.matrix)}}},{key:"toJSON",value:function toJSON(){return{type:this.type,subParticleSystem:this.subParticleSystem?this.subParticleSystem.uuid:"",useVelocityAsBasis:this.useVelocityAsBasis,mode:this.mode,emitProbability:this.emitProbability}}},{key:"clone",value:function clone(){return new EmitSubParticleSystem(this.particleSystem,this.useVelocityAsBasis,this.subParticleSystem,this.mode,this.emitProbability)}},{key:"reset",value:function reset(){}},{key:"setMatrixFromParticle",value:function setMatrixFromParticle(e,i){var r;if(void 0===i.rotation||this.useVelocityAsBasis)if(0!==i.velocity.x||0!==i.velocity.y||1!==i.velocity.z&&0!==i.velocity.z){this.v_.copy(q).cross(i.velocity),this.v2_.copy(i.velocity).cross(this.v_);var n=this.v_.length(),o=this.v2_.length();e.set(this.v_.x/n,this.v2_.x/o,i.velocity.x,i.position.x,this.v_.y/n,this.v2_.y/o,i.velocity.y,i.position.y,this.v_.z/n,this.v2_.z/o,i.velocity.z,i.position.z,0,0,0,1)}else e.set(1,0,0,i.position.x,0,1,0,i.position.y,0,0,1,i.position.z,0,0,0,1);else i.rotation instanceof t.Quaternion?r=i.rotation:(this.q_.setFromAxisAngle(q,i.rotation),r=this.q_),e.compose(i.position,r,D);this.particleSystem.worldSpace||e.multiplyMatrices(this.particleSystem.emitter.matrixWorld,e)}}],[{key:"fromJSON",value:function fromJSON(e,t){return new EmitSubParticleSystem(t,e.useVelocityAsBasis,e.subParticleSystem,e.mode,e.emitProbability)}}]),EmitSubParticleSystem}(),H=.5*(Math.sqrt(3)-1),W=(3-Math.sqrt(3))/6,Q=1/6,Y=(Math.sqrt(5)-1)/4,Z=(5-Math.sqrt(5))/20,K=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),$=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),ee=function(){function SimplexNoise(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.random;_classCallCheck(this,SimplexNoise),_defineProperty(this,"p",void 0),_defineProperty(this,"perm",void 0),_defineProperty(this,"permMod12",void 0);var t="function"==typeof e?e:function alea(e){var t=0,i=0,r=0,n=1,o=function masher(){var e=4022871197;return function(t){t=t.toString();for(var i=0;i<t.length;i++){var r=.02519603282416938*(e+=t.charCodeAt(i));r-=e=r>>>0,e=(r*=e)>>>0,e+=4294967296*(r-=e)}return 2.3283064365386963e-10*(e>>>0)}}();return t=o(" "),i=o(" "),r=o(" "),(t-=o(e))<0&&(t+=1),(i-=o(e))<0&&(i+=1),(r-=o(e))<0&&(r+=1),function(){var e=2091639*t+2.3283064365386963e-10*n;return t=i,i=r,r=e-(n=0|e)}}(e);this.p=function buildPermutationTable(e){for(var t=new Uint8Array(256),i=0;i<256;i++)t[i]=i;for(var r=0;r<255;r++){var n=r+~~(e()*(256-r)),o=t[r];t[r]=t[n],t[n]=o}return t}(t),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var i=0;i<512;i++)this.perm[i]=this.p[255&i],this.permMod12[i]=this.perm[i]%12}return _createClass(SimplexNoise,[{key:"noise2D",value:function noise2D(e,t){var i,r,n=this.permMod12,o=this.perm,a=0,s=0,l=0,u=(e+t)*H,c=Math.floor(e+u),d=Math.floor(t+u),h=(c+d)*W,f=e-(c-h),p=t-(d-h);f>p?(i=1,r=0):(i=0,r=1);var m=f-i+W,y=p-r+W,v=f-1+2*W,g=p-1+2*W,S=255&c,_=255&d,w=.5-f*f-p*p;if(w>=0){var O=3*n[S+o[_]];a=(w*=w)*w*(K[O]*f+K[O+1]*p)}var x=.5-m*m-y*y;if(x>=0){var b=3*n[S+i+o[_+r]];s=(x*=x)*x*(K[b]*m+K[b+1]*y)}var N=.5-v*v-g*g;if(N>=0){var P=3*n[S+1+o[_+1]];l=(N*=N)*N*(K[P]*v+K[P+1]*g)}return 70*(a+s+l)}},{key:"noise3D",value:function noise3D(e,t,i){var r,n,o,a,s,l,u,c,d,h,f=this.permMod12,p=this.perm,m=.3333333333333333*(e+t+i),y=Math.floor(e+m),v=Math.floor(t+m),g=Math.floor(i+m),S=(y+v+g)*Q,_=e-(y-S),w=t-(v-S),O=i-(g-S);_>=w?w>=O?(s=1,l=0,u=0,c=1,d=1,h=0):_>=O?(s=1,l=0,u=0,c=1,d=0,h=1):(s=0,l=0,u=1,c=1,d=0,h=1):w<O?(s=0,l=0,u=1,c=0,d=1,h=1):_<O?(s=0,l=1,u=0,c=0,d=1,h=1):(s=0,l=1,u=0,c=1,d=1,h=0);var x=_-s+Q,b=w-l+Q,N=O-u+Q,P=_-c+2*Q,k=w-d+2*Q,M=O-h+2*Q,C=_-1+.5,V=w-1+.5,B=O-1+.5,T=255&y,E=255&v,z=255&g,A=.6-_*_-w*w-O*O;if(A<0)r=0;else{var J=3*f[T+p[E+p[z]]];r=(A*=A)*A*(K[J]*_+K[J+1]*w+K[J+2]*O)}var L=.6-x*x-b*b-N*N;if(L<0)n=0;else{var U=3*f[T+s+p[E+l+p[z+u]]];n=(L*=L)*L*(K[U]*x+K[U+1]*b+K[U+2]*N)}var R=.6-P*P-k*k-M*M;if(R<0)o=0;else{var I=3*f[T+c+p[E+d+p[z+h]]];o=(R*=R)*R*(K[I]*P+K[I+1]*k+K[I+2]*M)}var G=.6-C*C-V*V-B*B;if(G<0)a=0;else{var D=3*f[T+1+p[E+1+p[z+1]]];a=(G*=G)*G*(K[D]*C+K[D+1]*V+K[D+2]*B)}return 32*(r+n+o+a)}},{key:"noise4D",value:function noise4D(e,t,i,r){var n,o,a,s,l,u=this.perm,c=(e+t+i+r)*Y,d=Math.floor(e+c),h=Math.floor(t+c),f=Math.floor(i+c),p=Math.floor(r+c),m=(d+h+f+p)*Z,y=e-(d-m),v=t-(h-m),g=i-(f-m),S=r-(p-m),_=0,w=0,O=0,x=0;y>v?_++:w++,y>g?_++:O++,y>S?_++:x++,v>g?w++:O++,v>S?w++:x++,g>S?O++:x++;var b=_>=3?1:0,N=w>=3?1:0,P=O>=3?1:0,k=x>=3?1:0,M=_>=2?1:0,C=w>=2?1:0,V=O>=2?1:0,B=x>=2?1:0,T=_>=1?1:0,E=w>=1?1:0,z=O>=1?1:0,A=x>=1?1:0,J=y-b+Z,L=v-N+Z,U=g-P+Z,R=S-k+Z,I=y-M+2*Z,G=v-C+2*Z,D=g-V+2*Z,q=S-B+2*Z,X=y-T+3*Z,j=v-E+3*Z,H=g-z+3*Z,W=S-A+3*Z,Q=y-1+4*Z,K=v-1+4*Z,ee=g-1+4*Z,te=S-1+4*Z,ie=255&d,re=255&h,ne=255&f,oe=255&p,ae=.6-y*y-v*v-g*g-S*S;if(ae<0)n=0;else{var se=u[ie+u[re+u[ne+u[oe]]]]%32*4;n=(ae*=ae)*ae*($[se]*y+$[se+1]*v+$[se+2]*g+$[se+3]*S)}var le=.6-J*J-L*L-U*U-R*R;if(le<0)o=0;else{var ue=u[ie+b+u[re+N+u[ne+P+u[oe+k]]]]%32*4;o=(le*=le)*le*($[ue]*J+$[ue+1]*L+$[ue+2]*U+$[ue+3]*R)}var ce=.6-I*I-G*G-D*D-q*q;if(ce<0)a=0;else{var de=u[ie+M+u[re+C+u[ne+V+u[oe+B]]]]%32*4;a=(ce*=ce)*ce*($[de]*I+$[de+1]*G+$[de+2]*D+$[de+3]*q)}var he=.6-X*X-j*j-H*H-W*W;if(he<0)s=0;else{var fe=u[ie+T+u[re+E+u[ne+z+u[oe+A]]]]%32*4;s=(he*=he)*he*($[fe]*X+$[fe+1]*j+$[fe+2]*H+$[fe+3]*W)}var pe=.6-Q*Q-K*K-ee*ee-te*te;if(pe<0)l=0;else{var me=u[ie+1+u[re+1+u[ne+1+u[oe+1]]]]%32*4;l=(pe*=pe)*pe*($[me]*Q+$[me+1]*K+$[me+2]*ee+$[me+3]*te)}return 27*(n+o+a+s+l)}}]),SimplexNoise}(),te=function(){function TurbulenceField(e,i,r,n){_classCallCheck(this,TurbulenceField),_defineProperty(this,"type","TurbulenceField"),_defineProperty(this,"generator",new ee),_defineProperty(this,"timeOffset",new t.Vector3),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"temp2",new t.Vector3),this.scale=e,this.octaves=i,this.velocityMultiplier=r,this.timeScale=n,this.timeOffset.x=Math.random()/this.scale.x*this.timeScale.x,this.timeOffset.y=Math.random()/this.scale.y*this.timeScale.y,this.timeOffset.z=Math.random()/this.scale.z*this.timeScale.z}return _createClass(TurbulenceField,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=e.position.x/this.scale.x,r=e.position.y/this.scale.y,n=e.position.z/this.scale.z;this.temp.set(0,0,0);for(var o=1,a=0;a<this.octaves;a++)this.temp2.set(this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.x*o)/o,this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.y*o)/o,this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.z*o)/o),this.temp.add(this.temp2),o*=2;this.temp.multiply(this.velocityMultiplier),e.velocity.addScaledVector(this.temp,t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,scale:[this.scale.x,this.scale.y,this.scale.z],octaves:this.octaves,velocityMultiplier:[this.velocityMultiplier.x,this.velocityMultiplier.y,this.velocityMultiplier.z],timeScale:[this.timeScale.x,this.timeScale.y,this.timeScale.z]}}},{key:"frameUpdate",value:function frameUpdate(e){this.timeOffset.x+=e*this.timeScale.x,this.timeOffset.y+=e*this.timeScale.y,this.timeOffset.z+=e*this.timeScale.z}},{key:"clone",value:function clone(){return new TurbulenceField(this.scale.clone(),this.octaves,this.velocityMultiplier.clone(),this.timeScale.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new TurbulenceField(new t.Vector3(e.scale[0],e.scale[1],e.scale[2]),e.octaves,new t.Vector3(e.velocityMultiplier[0],e.velocityMultiplier[1],e.velocityMultiplier[2]),new t.Vector3(e.timeScale[0],e.timeScale[1],e.timeScale[2]))}}]),TurbulenceField}();function randomInt(e,t){return Math.floor(Math.random()*(t-e))+e}var ie=[],re=new t.Vector3,ne=new t.Quaternion,oe=function(){function Noise(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new O(1),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new O(0);if(_classCallCheck(this,Noise),_defineProperty(this,"type","Noise"),_defineProperty(this,"duration",0),this.frequency=e,this.power=t,this.positionAmount=i,this.rotationAmount=r,0===ie.length)for(var n=0;n<100;n++)ie.push(new ee)}return _createClass(Noise,[{key:"initialize",value:function initialize(e){e.seed=10*Math.random(),e.lastPosNoise=new t.Vector3,"number"==typeof e.rotation?e.lastRotNoise=0:e.lastRotNoise=new t.Quaternion,e.generatorIndex=[randomInt(0,100),randomInt(0,100),randomInt(0,100),randomInt(0,100)]}},{key:"update",value:function update(e,t){var i=this.frequency.genValue(e.age/e.life),r=this.power.genValue(e.age/e.life),n=this.positionAmount.genValue(e.age/e.life),o=this.rotationAmount.genValue(e.age/e.life);n>0&&(e.position.sub(e.lastPosNoise),re.set(ie[e.generatorIndex[0]].noise2D(0,e.age*i)*r*n,ie[e.generatorIndex[1]].noise2D(0,e.age*i)*r*n,ie[e.generatorIndex[2]].noise2D(0,e.age*i)*r*n),e.position.add(re),e.lastPosNoise.copy(re)),o>0&&("number"==typeof e.rotation?(e.rotation-=e.lastRotNoise,e.rotation+=ie[e.generatorIndex[3]].noise2D(0,e.age*i)*Math.PI*r*o):(e.lastRotNoise.invert(),e.rotation.multiply(e.lastRotNoise),ne.set(ie[e.generatorIndex[0]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[1]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[2]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[3]].noise2D(0,e.age*i)*r*o).normalize(),e.rotation.multiply(ne),e.lastRotNoise.copy(ne)))}},{key:"toJSON",value:function toJSON(){return{type:this.type,frequency:this.frequency.toJSON(),power:this.power.toJSON(),positionAmount:this.positionAmount.toJSON(),rotationAmount:this.rotationAmount.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){this.duration+=e}},{key:"clone",value:function clone(){return new Noise(this.frequency.clone(),this.power.clone(),this.positionAmount.clone(),this.rotationAmount.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new Noise(ValueGeneratorFromJSON(e.frequency),ValueGeneratorFromJSON(e.power),ValueGeneratorFromJSON(e.positionAmount),ValueGeneratorFromJSON(e.rotationAmount))}}]),Noise}(),ae=function(){function TextureSequencer(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new t.Vector3;_classCallCheck(this,TextureSequencer),_defineProperty(this,"locations",[]),this.scaleX=e,this.scaleY=i,this.position=r}return _createClass(TextureSequencer,[{key:"transform",value:function transform(e,t){e.x=this.locations[t%this.locations.length].x*this.scaleX+this.position.x,e.y=this.locations[t%this.locations.length].y*this.scaleY+this.position.y,e.z=this.position.z}},{key:"clone",value:function clone(){var e=new TextureSequencer(this.scaleX,this.scaleY,this.position.clone());return e.locations=this.locations.map((function(e){return e.clone()})),e}},{key:"toJSON",value:function toJSON(){return{scaleX:this.scaleX,scaleY:this.scaleY,position:this.position,locations:this.locations.map((function(e){return{x:e.x,y:e.y}}))}}},{key:"fromImage",value:function fromImage(e,i){var r=document.createElement("canvas");r.width=e.width,r.height=e.height;var n=r.getContext("2d");if(n){n.drawImage(e,0,0);var o=n.getImageData(0,0,r.width,r.height,{colorSpace:"srgb"});r.remove(),this.locations.length=0;for(var a=0;a<o.height;a++)for(var s=0;s<o.width;s++)o.data[4*(a*o.width+s)+3]>i&&this.locations.push(new t.Vector2(s,o.height-a))}}}],[{key:"fromJSON",value:function fromJSON(e){var i=new TextureSequencer(e.scaleX,e.scaleY,new t.Vector3(e.position[0],e.position[1],e.position[2]));return i.locations=e.locations.map((function(e){return new t.Vector2(e.x,e.y)})),i}}]),TextureSequencer}();function SequencerFromJSON(e){return"TextureSequencer"===e.type?ae.fromJSON(e):new ae}var se,le=function(){function ApplySequences(e){_classCallCheck(this,ApplySequences),_defineProperty(this,"type","ApplySequences"),_defineProperty(this,"sequencers",[]),_defineProperty(this,"time",0),_defineProperty(this,"index",0),_defineProperty(this,"pCount",0),_defineProperty(this,"delay",void 0),_defineProperty(this,"tempV",new t.Vector3),this.delay=e}return _createClass(ApplySequences,[{key:"initialize",value:function initialize(e){e.id=this.pCount,e.dst=new t.Vector3,e.begin=new t.Vector3,e.inMotion=!1,this.pCount++}},{key:"reset",value:function reset(){this.time=0,this.index=0,this.pCount=0}},{key:"update",value:function update(e,t){var i=this.sequencers[this.index],r=e.id*this.delay;this.time>=i[0].a+r&&this.time<=i[0].b+r?(e.inMotion||(e.inMotion=!0,e.begin.copy(e.position),i[1].transform(e.dst,e.id)),e.position.lerpVectors(e.begin,e.dst,ApplySequences.BEZIER.genValue((this.time-i[0].a-r)/(i[0].b-i[0].a)))):this.time>i[0].b+r&&(e.inMotion=!1)}},{key:"frameUpdate",value:function frameUpdate(e){for(;this.index+1<this.sequencers.length&&this.time>=this.sequencers[this.index+1][0].a;)this.index++;this.time+=e}},{key:"appendSequencer",value:function appendSequencer(e,t){this.sequencers.push([e,t])}},{key:"toJSON",value:function toJSON(){return{type:this.type,delay:this.delay,sequencers:this.sequencers.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return{range:i.toJSON(),sequencer:r.toJSON()}}))}}},{key:"clone",value:function clone(){var e=new ApplySequences(this.delay);return e.sequencers=this.sequencers.map((function(e){return[e[0].clone(),e[1].clone()]})),e}}],[{key:"fromJSON",value:function fromJSON(e){var t=new ApplySequences(e.delay);return e.sequencers.forEach((function(e){t.sequencers.push([ValueGeneratorFromJSON(e.range),SequencerFromJSON(e.sequencer)])})),t}}]),ApplySequences}();function getPhysicsResolver(){return se}_defineProperty(le,"BEZIER",new u(0,0,1,1));var ue=function(){function ApplyCollision(e,i){_classCallCheck(this,ApplyCollision),_defineProperty(this,"type","ApplyCollision"),_defineProperty(this,"tempV",new t.Vector3),this.resolver=e,this.bounce=i}return _createClass(ApplyCollision,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this.resolver.resolve(e.position,this.tempV)&&e.velocity.reflect(this.tempV).multiplyScalar(this.bounce)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,bounce:this.bounce}}},{key:"clone",value:function clone(){return new ApplyCollision(this.resolver,this.bounce)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ApplyCollision(getPhysicsResolver(),e.bounce)}}]),ApplyCollision}(),ce=function(){function ColorBySpeed(e,t){_classCallCheck(this,ColorBySpeed),_defineProperty(this,"type","ColorBySpeed"),this.color=e,this.speedRange=t}return _createClass(ColorBySpeed,[{key:"initialize",value:function initialize(e){"memorizedFunction"===this.color.type&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function update(e,t){var i=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);"memorizedFunction"===this.color.type?this.color.genColor(e.color,i,e.colorOverLifeMemory):this.color.genColor(e.color,i),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,color:this.color.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"clone",value:function clone(){return new ColorBySpeed(this.color.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorBySpeed(ColorGeneratorFromJSON(e.color),x.fromJSON(e.speedRange))}}]),ColorBySpeed}(),de=function(){function SizeBySpeed(e,t){_classCallCheck(this,SizeBySpeed),_defineProperty(this,"type","SizeBySpeed"),this.size=e,this.speedRange=t}return _createClass(SizeBySpeed,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){var t=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.size=e.startSize*this.size.genValue(t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,size:this.size.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SizeBySpeed(this.size.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SizeBySpeed(ValueGeneratorFromJSON(e.size),x.fromJSON(e.speedRange))}}]),SizeBySpeed}(),he=function(){function RotationBySpeed(e,i){_classCallCheck(this,RotationBySpeed),_defineProperty(this,"type","RotationBySpeed"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.speedRange=i}return _createClass(RotationBySpeed,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.rotation+=t*this.angularVelocity.genValue(i)}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new RotationBySpeed(this.angularVelocity.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new RotationBySpeed(ValueGeneratorFromJSON(e.angularVelocity),x.fromJSON(e.speedRange))}}]),RotationBySpeed}(),fe=function(){function LimitSpeedOverLife(e,t){_classCallCheck(this,LimitSpeedOverLife),_defineProperty(this,"type","LimitSpeedOverLife"),this.speed=e,this.dampen=t}return _createClass(LimitSpeedOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=e.velocity.length(),r=this.speed.genValue(e.age/e.life);if(i>r){var n=(i-r)/i;e.velocity.multiplyScalar(1-n*this.dampen*t*20)}}},{key:"toJSON",value:function toJSON(){return{type:this.type,speed:this.speed.toJSON(),dampen:this.dampen}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new LimitSpeedOverLife(this.speed.clone(),this.dampen)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new LimitSpeedOverLife(ValueGeneratorFromJSON(e.speed),e.dampen)}}]),LimitSpeedOverLife}(),pe={ApplyForce:{type:"ApplyForce",constructor:R,params:[["direction","vec3"],["magnitude","value"]],loadJSON:R.fromJSON},Noise:{type:"Noise",constructor:oe,params:[["frequency","value"],["power","value"],["positionAmount","value"],["rotationAmount","value"]],loadJSON:oe.fromJSON},TurbulenceField:{type:"TurbulenceField",constructor:te,params:[["scale","vec3"],["octaves","number"],["velocityMultiplier","vec3"],["timeScale","vec3"]],loadJSON:te.fromJSON},GravityForce:{type:"GravityForce",constructor:I,params:[["center","vec3"],["magnitude","number"]],loadJSON:I.fromJSON},ColorOverLife:{type:"ColorOverLife",constructor:C,params:[["color","colorFunc"]],loadJSON:C.fromJSON},RotationOverLife:{type:"RotationOverLife",constructor:V,params:[["angularVelocity","valueFunc"],["dynamic","boolean"]],loadJSON:V.fromJSON},Rotation3DOverLife:{type:"Rotation3DOverLife",constructor:T,params:[["angularVelocity","rotationFunc"],["dynamic","boolean"]],loadJSON:T.fromJSON},SizeOverLife:{type:"SizeOverLife",constructor:z,params:[["size","valueFunc"]],loadJSON:z.fromJSON},ColorBySpeed:{type:"ColorBySpeed",constructor:ce,params:[["color","colorFunc"],["speedRange","range"]],loadJSON:ce.fromJSON},RotationBySpeed:{type:"RotationBySpeed",constructor:he,params:[["angularVelocity","valueFunc"],["speedRange","range"]],loadJSON:he.fromJSON},SizeBySpeed:{type:"SizeBySpeed",constructor:de,params:[["size","valueFunc"],["speedRange","range"]],loadJSON:de.fromJSON},SpeedOverLife:{type:"SpeedOverLife",constructor:A,params:[["speed","valueFunc"]],loadJSON:A.fromJSON},FrameOverLife:{type:"FrameOverLife",constructor:J,params:[["frame","valueFunc"]],loadJSON:J.fromJSON},ForceOverLife:{type:"ForceOverLife",constructor:E,params:[["x","valueFunc"],["y","valueFunc"],["z","valueFunc"]],loadJSON:E.fromJSON},OrbitOverLife:{type:"OrbitOverLife",constructor:L,params:[["orbitSpeed","valueFunc"],["axis","vec3"]],loadJSON:L.fromJSON},WidthOverLength:{type:"WidthOverLength",constructor:U,params:[["width","valueFunc"]],loadJSON:U.fromJSON},ChangeEmitDirection:{type:"ChangeEmitDirection",constructor:G,params:[["angle","value"]],loadJSON:G.fromJSON},EmitSubParticleSystem:{type:"EmitSubParticleSystem",constructor:j,params:[["particleSystem","self"],["useVelocityAsBasis","boolean"],["subParticleSystem","particleSystem"],["mode","number"],["emitProbability","number"]],loadJSON:j.fromJSON},LimitSpeedOverLife:{type:"LimitSpeedOverLife",constructor:fe,params:[["speed","valueFunc"],["dampen","number"]],loadJSON:fe.fromJSON}};function BehaviorFromJSON(e,t){return pe[e.type].loadJSON(e,t)}var me=function(){function ConeEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,ConeEmitter),_defineProperty(this,"type","cone"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),_defineProperty(this,"angle",void 0),this.radius=null!==(e=n.radius)&&void 0!==e?e:10,this.arc=null!==(t=n.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=n.thickness)&&void 0!==i?i:1,this.angle=null!==(r=n.angle)&&void 0!==r?r:Math.PI/6}return _createClass(ConeEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=t.MathUtils.lerp(1-this.thickness,1,Math.random()),n=i*this.arc,o=Math.sqrt(r),a=Math.sin(n),s=Math.cos(n);e.position.x=o*s,e.position.y=o*a,e.position.z=0;var l=this.angle*o;e.velocity.set(0,0,Math.cos(l)).addScaledVector(e.position,Math.sin(l)).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius)}},{key:"toJSON",value:function toJSON(){return{type:"cone",radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle}}},{key:"clone",value:function clone(){return new ConeEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle})}}],[{key:"fromJSON",value:function fromJSON(e){return new ConeEmitter(e)}}]),ConeEmitter}(),ye=function(){function CircleEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,CircleEmitter),_defineProperty(this,"type","circle"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(CircleEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=t.MathUtils.lerp(1-this.thickness,1,Math.random()),n=i*this.arc;e.position.x=Math.cos(n),e.position.y=Math.sin(n),e.position.z=0,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*r)}},{key:"toJSON",value:function toJSON(){return{type:"circle",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new CircleEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new CircleEmitter(e)}}]),CircleEmitter}(),ve=function(){function DonutEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,DonutEmitter),_defineProperty(this,"type","donut"),_defineProperty(this,"radius",void 0),_defineProperty(this,"donutRadius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=n.radius)&&void 0!==e?e:10,this.arc=null!==(t=n.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=n.thickness)&&void 0!==i?i:1,this.donutRadius=null!==(r=n.donutRadius)&&void 0!==r?r:.2*this.radius}return _createClass(DonutEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=r*Math.PI*2,s=Math.sin(o),l=Math.cos(o);e.position.x=this.radius*l,e.position.y=this.radius*s,e.position.z=0,e.velocity.z=this.donutRadius*n*Math.sin(a),e.velocity.x=this.donutRadius*n*Math.cos(a)*l,e.velocity.y=this.donutRadius*n*Math.cos(a)*s,e.position.add(e.velocity),e.velocity.normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"donut",radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius}}},{key:"clone",value:function clone(){return new DonutEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius})}}],[{key:"fromJSON",value:function fromJSON(e){return new DonutEmitter(e)}}]),DonutEmitter}(),ge=function(){function PointEmitter(){_classCallCheck(this,PointEmitter),_defineProperty(this,"type","point")}return _createClass(PointEmitter,[{key:"initialize",value:function initialize(e){var t=Math.random(),i=Math.random(),r=t*Math.PI*2,n=Math.acos(2*i-1),o=Math.cbrt(Math.random()),a=Math.sin(r),s=Math.cos(r),l=Math.sin(n),u=Math.cos(n);e.velocity.x=o*l*s,e.velocity.y=o*l*a,e.velocity.z=o*u,e.velocity.multiplyScalar(e.startSpeed),e.position.setScalar(0)}},{key:"toJSON",value:function toJSON(){return{type:"point"}}},{key:"clone",value:function clone(){return new PointEmitter}}],[{key:"fromJSON",value:function fromJSON(e){return new PointEmitter}}]),PointEmitter}(),Se=function(){function SphereEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,SphereEmitter),_defineProperty(this,"type","sphere"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(SphereEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=Math.acos(2*r-1),s=Math.sin(o),l=Math.cos(o),u=Math.sin(a),c=Math.cos(a);e.position.x=u*l,e.position.y=u*s,e.position.z=c,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*n)}},{key:"toJSON",value:function toJSON(){return{type:"sphere",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new SphereEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new SphereEmitter(e)}}]),SphereEmitter}(),_e=function(){function HemisphereEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,HemisphereEmitter),_defineProperty(this,"type","sphere"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(HemisphereEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=Math.acos(r),s=Math.sin(o),l=Math.cos(o),u=Math.sin(a),c=Math.cos(a);e.position.x=u*l,e.position.y=u*s,e.position.z=c,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*n)}},{key:"toJSON",value:function toJSON(){return{type:"hemisphere",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new HemisphereEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new HemisphereEmitter(e)}}]),HemisphereEmitter}(),we=function(){function GridEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,GridEmitter),_defineProperty(this,"type","grid"),_defineProperty(this,"width",void 0),_defineProperty(this,"height",void 0),_defineProperty(this,"column",void 0),_defineProperty(this,"row",void 0),this.width=null!==(e=n.width)&&void 0!==e?e:1,this.height=null!==(t=n.height)&&void 0!==t?t:1,this.column=null!==(i=n.column)&&void 0!==i?i:10,this.row=null!==(r=n.row)&&void 0!==r?r:10}return _createClass(GridEmitter,[{key:"initialize",value:function initialize(e){var t=Math.floor(Math.random()*this.row),i=Math.floor(Math.random()*this.column);e.position.x=i*this.width/this.column-this.width/2,e.position.y=t*this.height/this.row-this.height/2,e.position.z=0,e.velocity.set(0,0,e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"grid",width:this.width,height:this.height,column:this.column,row:this.row}}},{key:"clone",value:function clone(){return new GridEmitter({width:this.width,height:this.height,column:this.column,row:this.row})}}],[{key:"fromJSON",value:function fromJSON(e){return new GridEmitter(e)}}]),GridEmitter}(),Oe=function(){function MeshSurfaceEmitter(e){_classCallCheck(this,MeshSurfaceEmitter),_defineProperty(this,"type","mesh_surface"),_defineProperty(this,"_triangleIndexToArea",[]),_defineProperty(this,"_geometry",void 0),_defineProperty(this,"_tempA",new t.Vector3),_defineProperty(this,"_tempB",new t.Vector3),_defineProperty(this,"_tempC",new t.Vector3),e&&(this.geometry=e)}return _createClass(MeshSurfaceEmitter,[{key:"geometry",get:function get(){return this._geometry},set:function set(e){if(this._geometry=e,void 0!==e&&"string"!=typeof e){var i=new t.Triangle;this._triangleIndexToArea.length=0;var r=0;if(e.getIndex()){var n=e.getIndex().array,o=n.length/3;this._triangleIndexToArea.push(0);for(var a=0;a<o;a++)i.setFromAttributeAndIndices(e.getAttribute("position"),n[3*a],n[3*a+1],n[3*a+2]),r+=i.getArea(),this._triangleIndexToArea.push(r);e.userData.triangleIndexToArea=this._triangleIndexToArea}}}},{key:"initialize",value:function initialize(e){var t=this._geometry;if(!t||null===t.getIndex())return e.position.set(0,0,0),void e.velocity.set(0,0,1).multiplyScalar(e.startSpeed);for(var i=this._triangleIndexToArea.length-1,r=0,n=i,o=Math.random()*this._triangleIndexToArea[i];r+1<n;){var a=Math.floor((r+n)/2);o<this._triangleIndexToArea[a]?n=a:r=a}var s=Math.random(),l=Math.random();s+l>1&&(s=1-s,l=1-l);var u=t.getIndex().array[3*r],c=t.getIndex().array[3*r+1],d=t.getIndex().array[3*r+2],h=t.getAttribute("position");this._tempA.fromBufferAttribute(h,u),this._tempB.fromBufferAttribute(h,c),this._tempC.fromBufferAttribute(h,d),this._tempB.sub(this._tempA),this._tempC.sub(this._tempA),this._tempA.addScaledVector(this._tempB,s).addScaledVector(this._tempC,l),e.position.copy(this._tempA),this._tempA.copy(this._tempB).cross(this._tempC).normalize(),e.velocity.copy(this._tempA).normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"mesh_surface",mesh:this._geometry?this._geometry.uuid:""}}},{key:"clone",value:function clone(){return new MeshSurfaceEmitter(this._geometry)}}],[{key:"fromJSON",value:function fromJSON(e,t){return new MeshSurfaceEmitter(t.geometries[e.geometry])}}]),MeshSurfaceEmitter}(),xe={circle:{type:"circle",params:[["radius","number"],["arc","radian"],["thickness","number"]],constructor:ye,loadJSON:ye.fromJSON},cone:{type:"cone",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:me,loadJSON:me.fromJSON},donut:{type:"donut",params:[["radius","number"],["arc","radian"],["thickness","number"],["donutRadius","number"]],constructor:ve,loadJSON:ve.fromJSON},point:{type:"point",params:[],constructor:ge,loadJSON:ge.fromJSON},sphere:{type:"sphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:Se,loadJSON:Se.fromJSON},hemisphere:{type:"hemisphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:_e,loadJSON:_e.fromJSON},grid:{type:"grid",params:[["width","number"],["height","number"],["rows","number"],["column","number"]],constructor:we,loadJSON:we.fromJSON},mesh_surface:{type:"mesh_surface",params:[["geometry","geometry"]],constructor:Oe,loadJSON:Oe.fromJSON}};function EmitterFromJSON(e,t){return xe[e.type].loadJSON(e,t)}var be=function(e){return e[e.BillBoard=0]="BillBoard",e[e.StretchedBillBoard=1]="StretchedBillBoard",e[e.Mesh=2]="Mesh",e[e.Trail=3]="Trail",e[e.HorizontalBillBoard=4]="HorizontalBillBoard",e[e.VerticalBillBoard=5]="VerticalBillBoard",e}({}),Ne=function(e){_inherits(VFXBatch,e);var i=_createSuper(VFXBatch);function VFXBatch(e){var r;_classCallCheck(this,VFXBatch),_defineProperty(_assertThisInitialized(r=i.call(this)),"type","VFXBatch"),_defineProperty(_assertThisInitialized(r),"systems",void 0),_defineProperty(_assertThisInitialized(r),"settings",void 0),_defineProperty(_assertThisInitialized(r),"maxParticles",void 0),r.maxParticles=1e3,r.systems=new Set;var n=new t.Layers;n.mask=e.layers.mask;var o=e.material.clone();return o.defines={},Object.assign(o.defines,e.material.defines),r.settings={instancingGeometry:e.instancingGeometry,renderMode:e.renderMode,renderOrder:e.renderOrder,material:o,uTileCount:e.uTileCount,vTileCount:e.vTileCount,layers:n},r.frustumCulled=!1,r.renderOrder=r.settings.renderOrder,r}return _createClass(VFXBatch,[{key:"addSystem",value:function addSystem(e){this.systems.add(e)}},{key:"removeSystem",value:function removeSystem(e){this.systems.delete(e)}}]),VFXBatch}(t.Mesh),Pe=new t.Vector3(0,0,1),ke=new t.Quaternion,Me=new t.Vector3,Ce=new t.Vector3;new t.Vector3;var Ve=new t.PlaneGeometry(1,1,1,1),Be=function(){function ParticleSystem(e){var r,n,o,a,s,l,u,c,d,h,f,p,m,y,v,g,S,_,x,b;if(_classCallCheck(this,ParticleSystem),_defineProperty(this,"autoDestroy",void 0),_defineProperty(this,"prewarm",void 0),_defineProperty(this,"looping",void 0),_defineProperty(this,"duration",void 0),_defineProperty(this,"startLife",void 0),_defineProperty(this,"startSpeed",void 0),_defineProperty(this,"startRotation",void 0),_defineProperty(this,"startSize",void 0),_defineProperty(this,"startColor",void 0),_defineProperty(this,"startTileIndex",void 0),_defineProperty(this,"rendererEmitterSettings",void 0),_defineProperty(this,"emissionOverTime",void 0),_defineProperty(this,"emissionOverDistance",void 0),_defineProperty(this,"emissionBursts",void 0),_defineProperty(this,"onlyUsedByOther",void 0),_defineProperty(this,"worldSpace",void 0),_defineProperty(this,"particleNum",void 0),_defineProperty(this,"paused",void 0),_defineProperty(this,"particles",void 0),_defineProperty(this,"emitterShape",void 0),_defineProperty(this,"emitter",void 0),_defineProperty(this,"rendererSettings",void 0),_defineProperty(this,"neededToUpdateRender",void 0),_defineProperty(this,"behaviors",void 0),_defineProperty(this,"prewarmed",void 0),_defineProperty(this,"emissionState",void 0),_defineProperty(this,"emitEnded",void 0),_defineProperty(this,"markForDestroy",void 0),_defineProperty(this,"previousWorldPos",void 0),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"travelDistance",0),_defineProperty(this,"normalMatrix",new t.Matrix3),_defineProperty(this,"_renderer",void 0),this.autoDestroy=void 0!==e.autoDestroy&&e.autoDestroy,this.duration=null!==(r=e.duration)&&void 0!==r?r:1,this.looping=void 0===e.looping||e.looping,this.prewarm=void 0!==e.prewarm&&e.prewarm,this.startLife=null!==(n=e.startLife)&&void 0!==n?n:new O(5),this.startSpeed=null!==(o=e.startSpeed)&&void 0!==o?o:new O(0),this.startRotation=null!==(a=e.startRotation)&&void 0!==a?a:new O(0),this.startSize=null!==(s=e.startSize)&&void 0!==s?s:new O(1),this.startColor=null!==(l=e.startColor)&&void 0!==l?l:new w(new t.Vector4(1,1,1,1)),this.emissionOverTime=null!==(u=e.emissionOverTime)&&void 0!==u?u:new O(10),this.emissionOverDistance=null!==(c=e.emissionOverDistance)&&void 0!==c?c:new O(0),this.emissionBursts=null!==(d=e.emissionBursts)&&void 0!==d?d:[],this.onlyUsedByOther=null!==(h=e.onlyUsedByOther)&&void 0!==h&&h,this.emitterShape=null!==(f=e.shape)&&void 0!==f?f:new Se,this.behaviors=null!==(p=e.behaviors)&&void 0!==p?p:new Array,this.worldSpace=null!==(m=e.worldSpace)&&void 0!==m&&m,this.rendererEmitterSettings=null!==(y=e.rendererEmitterSettings)&&void 0!==y?y:{},e.renderMode===be.StretchedBillBoard){var N,P,k=this.rendererEmitterSettings;void 0!==e.speedFactor&&(k.speedFactor=e.speedFactor),k.speedFactor=null!==(N=k.speedFactor)&&void 0!==N?N:0,k.lengthFactor=null!==(P=k.lengthFactor)&&void 0!==P?P:0}this.rendererSettings={instancingGeometry:null!==(v=e.instancingGeometry)&&void 0!==v?v:Ve,renderMode:null!==(g=e.renderMode)&&void 0!==g?g:be.BillBoard,renderOrder:null!==(S=e.renderOrder)&&void 0!==S?S:0,material:e.material,uTileCount:null!==(_=e.uTileCount)&&void 0!==_?_:1,vTileCount:null!==(x=e.vTileCount)&&void 0!==x?x:1,layers:null!==(b=e.layers)&&void 0!==b?b:new t.Layers},this.neededToUpdateRender=!0,this.particles=new Array,this.startTileIndex=e.startTileIndex||new O(0),this.emitter=new i(this),this.paused=!1,this.particleNum=0,this.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,travelDistance:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return _createClass(ParticleSystem,[{key:"time",get:function get(){return this.emissionState.time},set:function set(e){this.emissionState.time=e}},{key:"layers",get:function get(){return this.rendererSettings.layers}},{key:"texture",get:function get(){return this.rendererSettings.material.map},set:function set(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function get(){return this.rendererSettings.material},set:function set(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"uTileCount",get:function get(){return this.rendererSettings.uTileCount},set:function set(e){this.rendererSettings.uTileCount=e,this.neededToUpdateRender=!0}},{key:"vTileCount",get:function get(){return this.rendererSettings.vTileCount},set:function set(e){this.rendererSettings.vTileCount=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function get(){return this.rendererSettings.instancingGeometry},set:function set(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function get(){return this.rendererSettings.renderMode},set:function set(e){if((this.rendererSettings.renderMode!=be.Trail&&e===be.Trail||this.rendererSettings.renderMode==be.Trail&&e!==be.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==e)switch(e){case be.Trail:this.rendererEmitterSettings={startLength:new O(30),followLocalOrigin:!1};break;case be.Mesh:this.rendererEmitterSettings={geometry:new t.PlaneGeometry(1,1)},this.startRotation=new k(new t.Vector3(0,1,0),new O(0));break;case be.StretchedBillBoard:this.rendererEmitterSettings={speedFactor:0,lengthFactor:2},this.rendererSettings.renderMode===be.Mesh&&(this.startRotation=new O(0));break;case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:this.rendererEmitterSettings={},this.rendererSettings.renderMode===be.Mesh&&(this.startRotation=new O(0))}this.rendererSettings.renderMode=e,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function get(){return this.rendererSettings.renderOrder},set:function set(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function get(){return this.rendererSettings.material.blending},set:function set(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function pause(){this.paused=!0}},{key:"play",value:function play(){this.paused=!1}},{key:"spawn",value:function spawn(e,i,r){ke.setFromRotationMatrix(r);var n=Me,o=ke,s=Ce;r.decompose(n,o,s);for(var u=0;u<e;u++){for(this.particleNum++;this.particles.length<this.particleNum;)this.rendererSettings.renderMode===be.Trail?this.particles.push(new l):this.particles.push(new a);var c=this.particles[this.particleNum-1];if(this.startColor.genColor(c.startColor,this.emissionState.time,{}),c.color.copy(c.startColor),c.startSpeed=this.startSpeed.genValue(i.time/this.duration),c.life=this.startLife.genValue(i.time/this.duration),c.age=0,c.startSize=this.startSize.genValue(i.time/this.duration),c.uvTile=Math.floor(this.startTileIndex.genValue()),c.size=c.startSize,this.rendererSettings.renderMode===be.Mesh||this.rendererSettings.renderMode===be.BillBoard||this.rendererSettings.renderMode===be.VerticalBillBoard||this.rendererSettings.renderMode===be.HorizontalBillBoard||this.rendererSettings.renderMode===be.StretchedBillBoard){var d=c;this.rendererSettings.renderMode===be.Mesh?(d.rotation instanceof t.Quaternion||(d.rotation=new t.Quaternion),"rotation"===this.startRotation.type?this.startRotation.genValue(d.rotation,i.time/this.duration):d.rotation.setFromAxisAngle(Pe,this.startRotation.genValue(i.time/this.duration))):"rotation"===this.startRotation.type?d.rotation=0:d.rotation=this.startRotation.genValue(i.time/this.duration)}else if(this.rendererSettings.renderMode===be.Trail){var h=c;h.length=this.rendererEmitterSettings.startLength.genValue(i.time/this.duration),h.reset()}if(this.emitterShape.initialize(c),this.rendererSettings.renderMode===be.Trail&&this.rendererEmitterSettings.followLocalOrigin){var f=c;f.localPosition=(new t.Vector3).copy(f.position)}this.worldSpace?(c.position.applyMatrix4(r),c.startSize=c.startSize*(Math.abs(s.x)+Math.abs(s.y)+Math.abs(s.z))/3,c.size=c.startSize,c.velocity.multiply(s).applyMatrix3(this.normalMatrix),c.rotation&&c.rotation instanceof t.Quaternion&&c.rotation.multiplyQuaternions(ke,c.rotation)):this.onlyUsedByOther&&(c.parentMatrix=r);for(var p=0;p<this.behaviors.length;p++)this.behaviors[p].initialize(c)}}},{key:"endEmit",value:function endEmit(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function dispose(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function restart(){this.paused=!1,this.particleNum=0,this.emissionState.burstIndex=0,this.emissionState.burstWaveIndex=0,this.emissionState.time=0,this.emissionState.waitEmiting=0,this.behaviors.forEach((function(e){e.reset()})),this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function update(e){if(!this.paused){for(var t=this.emitter;t.parent;)t=t.parent;if("Scene"===t.type)if(this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var i=0;i<60*this.duration;i++)this.update(1/60)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.onlyUsedByOther||this.emit(e,this.emissionState,this.emitter.matrixWorld);for(var r=0;r<this.behaviors.length;r++){for(var n=0;n<this.particleNum;n++)this.particles[n].died||this.behaviors[r].update(this.particles[n],e);this.behaviors[r].frameUpdate(e)}for(var o=0;o<this.particleNum;o++){if(this.rendererEmitterSettings.followLocalOrigin&&this.particles[o].localPosition)this.particles[o].position.copy(this.particles[o].localPosition),this.particles[o].parentMatrix?this.particles[o].position.applyMatrix4(this.particles[o].parentMatrix):this.particles[o].position.applyMatrix4(this.emitter.matrixWorld);else{var a,s=null!==(a=this.particles[o].speedModifier)&&void 0!==a?a:1;this.particles[o].position.addScaledVector(this.particles[o].velocity,e*s)}this.particles[o].age+=e}if(this.rendererSettings.renderMode===be.Trail)for(var u=0;u<this.particleNum;u++)this.particles[u].update();for(var c=0;c<this.particleNum;c++){var d=this.particles[c];!d.died||d instanceof l&&0!==d.previous.length||(this.particles[c]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=d,this.particleNum--,c--)}}else this.dispose()}}},{key:"emit",value:function emit(e,i,r){i.time>this.duration&&(this.looping?(i.time-=this.duration,i.burstIndex=0,this.behaviors.forEach((function(e){e.reset()}))):this.emitEnded||this.onlyUsedByOther||this.endEmit()),this.normalMatrix.getNormalMatrix(r);var n=Math.ceil(i.waitEmiting);for(this.spawn(n,i,r),i.waitEmiting-=n;i.burstIndex<this.emissionBursts.length&&this.emissionBursts[i.burstIndex].time<=i.time;){if(Math.random()<this.emissionBursts[i.burstIndex].probability){var o=this.emissionBursts[i.burstIndex].count.genValue(this.time);this.spawn(o,i,r)}i.burstIndex++}if(!this.emitEnded&&(i.waitEmiting+=e*this.emissionOverTime.genValue(i.time/this.duration),null!=i.previousWorldPos)){this.temp.set(r.elements[12],r.elements[13],r.elements[14]),i.travelDistance+=i.previousWorldPos.distanceTo(this.temp);var a=this.emissionOverDistance.genValue(i.time/this.duration);if(i.travelDistance*a>0){var s=Math.floor(i.travelDistance*a);i.travelDistance-=s/a,i.waitEmiting+=s}}void 0===i.previousWorldPos&&(i.previousWorldPos=new t.Vector3),i.previousWorldPos.set(r.elements[12],r.elements[13],r.elements[14]),i.time+=e}},{key:"toJSON",value:function toJSON(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if((void 0===e||"string"==typeof e)&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}}),e.materials[this.rendererSettings.material.uuid]=this.rendererSettings.material.toJSON(e),i.useUrlForImage&&void 0!==this.texture.source){var r=this.texture.source;e.images[r.uuid]={uuid:r.uuid,url:this.texture.image.url}}t=this.renderMode===be.Trail?{startLength:this.rendererEmitterSettings.startLength.toJSON(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:this.renderMode===be.Mesh?{}:this.renderMode===be.StretchedBillBoard?{speedFactor:this.rendererEmitterSettings.speedFactor,lengthFactor:this.rendererEmitterSettings.lengthFactor}:{};var n=this.rendererSettings.instancingGeometry;return e.geometries&&!e.geometries[n.uuid]&&(e.geometries[n.uuid]=n.toJSON()),{version:"2.0",autoDestroy:this.autoDestroy,looping:this.looping,prewarm:this.prewarm,duration:this.duration,shape:this.emitterShape.toJSON(),startLife:this.startLife.toJSON(),startSpeed:this.startSpeed.toJSON(),startRotation:this.startRotation.toJSON(),startSize:this.startSize.toJSON(),startColor:this.startColor.toJSON(),emissionOverTime:this.emissionOverTime.toJSON(),emissionOverDistance:this.emissionOverDistance.toJSON(),emissionBursts:this.emissionBursts.map((function(e){return{time:e.time,count:e.count.toJSON(),probability:e.probability,interval:e.interval,cycle:e.cycle}})),onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry.uuid,renderOrder:this.renderOrder,renderMode:this.renderMode,rendererEmitterSettings:t,material:this.rendererSettings.material.uuid,layers:this.layers.mask,startTileIndex:this.startTileIndex.toJSON(),uTileCount:this.uTileCount,vTileCount:this.vTileCount,behaviors:this.behaviors.map((function(e){return e.toJSON()})),worldSpace:this.worldSpace}}},{key:"addBehavior",value:function addBehavior(e){this.behaviors.push(e)}},{key:"getRendererSettings",value:function getRendererSettings(){return this.rendererSettings}},{key:"clone",value:function clone(){var e,i=[],r=_createForOfIteratorHelper(this.emissionBursts);try{for(r.s();!(e=r.n()).done;){var n=e.value,o={};Object.assign(o,n),i.push(o)}}catch(e){r.e(e)}finally{r.f()}var a,s,l=[],u=_createForOfIteratorHelper(this.behaviors);try{for(u.s();!(a=u.n()).done;){var c=a.value;l.push(c.clone())}}catch(e){u.e(e)}finally{u.f()}s=this.renderMode===be.Trail?{startLength:this.rendererEmitterSettings.startLength.clone(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:{};var d=new t.Layers;return d.mask=this.layers.mask,new ParticleSystem({autoDestroy:this.autoDestroy,looping:this.looping,duration:this.duration,shape:this.emitterShape.clone(),startLife:this.startLife.clone(),startSpeed:this.startSpeed.clone(),startRotation:this.startRotation.clone(),startSize:this.startSize.clone(),startColor:this.startColor.clone(),emissionOverTime:this.emissionOverTime.clone(),emissionOverDistance:this.emissionOverDistance.clone(),emissionBursts:i,onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry,renderMode:this.renderMode,renderOrder:this.renderOrder,rendererEmitterSettings:s,material:this.rendererSettings.material,startTileIndex:this.startTileIndex,uTileCount:this.uTileCount,vTileCount:this.vTileCount,behaviors:l,worldSpace:this.worldSpace,layers:d})}}],[{key:"fromJSON",value:function fromJSON(e,i,r){var n,o,a,s=EmitterFromJSON(e.shape,i);if(e.renderMode===be.Trail){var l=e.rendererEmitterSettings;a={startLength:null!=l.startLength?ValueGeneratorFromJSON(l.startLength):new O(30),followLocalOrigin:l.followLocalOrigin}}else e.renderMode===be.Mesh?a={}:e.renderMode===be.StretchedBillBoard?(a=e.rendererEmitterSettings,null!=e.speedFactor&&(a.speedFactor=e.speedFactor)):a={};var u=new t.Layers;e.layers&&(u.mask=e.layers);var c=new ParticleSystem({autoDestroy:e.autoDestroy,looping:e.looping,prewarm:e.prewarm,duration:e.duration,shape:s,startLife:ValueGeneratorFromJSON(e.startLife),startSpeed:ValueGeneratorFromJSON(e.startSpeed),startRotation:GeneratorFromJSON(e.startRotation),startSize:ValueGeneratorFromJSON(e.startSize),startColor:ColorGeneratorFromJSON(e.startColor),emissionOverTime:ValueGeneratorFromJSON(e.emissionOverTime),emissionOverDistance:ValueGeneratorFromJSON(e.emissionOverDistance),emissionBursts:null===(n=e.emissionBursts)||void 0===n?void 0:n.map((function(e){return{time:e.time,count:"number"==typeof e.count?new O(e.count):ValueGeneratorFromJSON(e.count),probability:e.probability,interval:e.interval,cycle:e.cycle}})),onlyUsedByOther:e.onlyUsedByOther,instancingGeometry:i.geometries[e.instancingGeometry],renderMode:e.renderMode,rendererEmitterSettings:a,renderOrder:e.renderOrder,layers:u,material:e.material?i.materials[e.material]:e.texture?new t.MeshBasicMaterial({map:i.textures[e.texture],transparent:null===(o=e.transparent)||void 0===o||o,blending:e.blending,side:t.DoubleSide}):new t.MeshBasicMaterial({color:16777215,transparent:!0,blending:t.AdditiveBlending,side:t.DoubleSide}),startTileIndex:"number"==typeof e.startTileIndex?new O(e.startTileIndex):ValueGeneratorFromJSON(e.startTileIndex),uTileCount:e.uTileCount,vTileCount:e.vTileCount,behaviors:[],worldSpace:e.worldSpace});return c.behaviors=e.behaviors.map((function(e){var t=BehaviorFromJSON(e,c);return"EmitSubParticleSystem"===t.type&&(r[e.subParticleSystem]=t),t})),c}}]),ParticleSystem}(),Te="\n\n#include <common>\n#include <uv_pars_fragment>\n#include <color_pars_fragment>\n#include <map_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n#include <alphatest_pars_fragment>\n\nvoid main() {\n\n    #include <clipping_planes_fragment>\n    \n    vec3 outgoingLight = vec3( 0.0 );\n    vec4 diffuseColor = vColor;\n    \n    #include <logdepthbuf_fragment>\n    \n    #ifdef USE_MAP\n    diffuseColor *= texture2D( map, vMapUv);\n    #endif\n    \n    #include <alphatest_fragment>\n\n    outgoingLight = diffuseColor.rgb;\n    \n    #ifdef USE_COLOR_AS_ALPHA\n    gl_FragColor = vec4( outgoingLight, diffuseColor.r );\n    #else\n    gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n    #endif\n    \n    \n    #include <tonemapping_fragment>\n\n}\n",Ee="\n\n    #ifdef UV_TILE\n        float col = mod(uvTile, tileCount.x);\n        float row = (tileCount.y - floor(uvTile / tileCount.x) - 1.0);\n        \n        mat3 tileTransform = mat3(\n          1.0 / tileCount.x, 0.0, 0.0,\n          0.0, 1.0 / tileCount.y, 0.0, \n          col / tileCount.x, row / tileCount.y, 1.0);\n    #else\n        mat3 tileTransform = mat3(1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0);\n    #endif\n\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\nvUv = (tileTransform *vec3( uv, 1 )).xy;\n\n#endif\n#ifdef USE_MAP\n\nvMapUv = ( tileTransform * (mapTransform * vec3( MAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ALPHAMAP\n\nvAlphaMapUv = ( tileTransform * (alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_LIGHTMAP\n\nvLightMapUv = ( tileTransform * (lightMapTransform * vec3( LIGHTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_AOMAP\n\nvAoMapUv = ( tileTransform * (aoMapTransform * vec3( AOMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_BUMPMAP\n\nvBumpMapUv = ( tileTransform * (bumpMapTransform * vec3( BUMPMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_NORMALMAP\n\nvNormalMapUv = ( tileTransform * (normalMapTransform * vec3( NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\nvDisplacementMapUv = ( tileTransform * (displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\nvEmissiveMapUv = ( tileTransform * (emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_METALNESSMAP\n\nvMetalnessMapUv = ( tileTransform * (metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\nvRoughnessMapUv = ( tileTransform * (roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\nvAnisotropyMapUv = ( tileTransform * (anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\nvClearcoatMapUv = ( tileTransform * (clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\nvClearcoatNormalMapUv = ( tileTransform * (clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\nvClearcoatRoughnessMapUv = ( tileTransform * (clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\nvIridescenceMapUv = ( tileTransform * (iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\nvIridescenceThicknessMapUv = ( tileTransform * (iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\nvSheenColorMapUv = ( tileTransform * (sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\nvSheenRoughnessMapUv = ( tileTransform * (sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULARMAP\n\nvSpecularMapUv = ( tileTransform * (specularMapTransform * vec3( SPECULARMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\nvSpecularColorMapUv = ( tileTransform * (specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\nvSpecularIntensityMapUv = ( tileTransform * (specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\nvTransmissionMapUv = ( tileTransform * transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\nvThicknessMapUv = ( tileTransform * thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n",ze="\n#include <common>\n#include <color_pars_vertex>\n#include <uv_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nvoid main() {\n\n    ".concat(Ee,"\n\t\n    vec2 alignedPosition = ( position.xy ) * size;\n    \n    vec2 rotatedPosition;\n    rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n    rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n#ifdef HORIZONTAL\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.x += rotatedPosition.x;\n    mvPosition.z -= rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n#elif defined(VERTICAL)\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.y += rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n    mvPosition.x += rotatedPosition.x;\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    mvPosition.xy += rotatedPosition;\n#endif\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n"),Ae="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\n// attribute vec4 color;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nvoid main() {\n\n    ".concat(Ee,"\n    \n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n    \n    mat4 matrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n    \n    vec4 mvPosition = modelViewMatrix * (matrix * vec4( position, 1.0 ));\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n"),Je="\n#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n    ".concat(Ee,"\n\n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n\n    mat4 particleMatrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\n\t// replace defaultnormal_vertex\n\tvec3 transformedNormal = objectNormal;\n    mat3 m = mat3( particleMatrix );\n    transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n    transformedNormal = m * transformedNormal;\n    transformedNormal = normalMatrix * transformedNormal;\n    #ifdef FLIP_SIDED\n        transformedNormal = - transformedNormal;\n    #endif\n    #ifdef USE_TANGENT\n        vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n        #ifdef FLIP_SIDED\n        transformedTangent = - transformedTangent;\n        #endif\n    #endif\n\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\n\t// replace include <project_vertex>\n  vec4 mvPosition = vec4( transformed, 1.0 );\n  mvPosition = modelViewMatrix * (particleMatrix * mvPosition);\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n\tvViewPosition = - mvPosition.xyz;\n\t\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}\n"),Le="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute vec4 velocity;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nuniform float speedFactor;\n\nvoid main() {\n\n    ".concat(Ee,"\n    \n    float lengthFactor = velocity.w;\n#ifdef USE_SKEW\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n\n    vec3 scaledPos = vec3(position.xy * size, position.z);\n    float vlength = length(viewVelocity);\n    vec3 projVelocity =  dot(scaledPos, viewVelocity) * viewVelocity / vlength;\n    mvPosition.xyz += scaledPos + projVelocity * (speedFactor / size + lengthFactor / vlength);\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n    float vlength = length(viewVelocity); \n    mvPosition.xyz += position.y * normalize(cross(mvPosition.xyz, viewVelocity)) * size; // switch the cross to  match unity implementation\n    mvPosition.xyz -= (position.x + 0.5) * viewVelocity * (1.0 + lengthFactor / vlength) * size; // minus position.x to match unity implementation\n#endif\n\tvColor = color;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n");function getMaterialUVChannelName(e){return 0===e?"uv":"uv".concat(e)}new t.Vector3(0,0,1);var Ue=function(e){_inherits(SpriteBatch,e);var i=_createSuper(SpriteBatch);function SpriteBatch(e){var r;return _classCallCheck(this,SpriteBatch),_defineProperty(_assertThisInitialized(r=i.call(this,e)),"offsetBuffer",void 0),_defineProperty(_assertThisInitialized(r),"rotationBuffer",void 0),_defineProperty(_assertThisInitialized(r),"sizeBuffer",void 0),_defineProperty(_assertThisInitialized(r),"colorBuffer",void 0),_defineProperty(_assertThisInitialized(r),"uvTileBuffer",void 0),_defineProperty(_assertThisInitialized(r),"velocityBuffer",void 0),_defineProperty(_assertThisInitialized(r),"vector_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector2_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector3_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"quaternion_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"quaternion2_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"quaternion3_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"rotationMat_",new t.Matrix3),_defineProperty(_assertThisInitialized(r),"rotationMat2_",new t.Matrix3),r.maxParticles=1e3,r.setupBuffers(),r.rebuildMaterial(),r}return _createClass(SpriteBatch,[{key:"buildExpandableBuffers",value:function buildExpandableBuffers(){this.offsetBuffer=new t.InstancedBufferAttribute(new Float32Array(3*this.maxParticles),3),this.offsetBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("offset",this.offsetBuffer),this.colorBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.colorBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("color",this.colorBuffer),this.settings.renderMode===be.Mesh?(this.rotationBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.rotationBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("rotation",this.rotationBuffer)):this.settings.renderMode!==be.BillBoard&&this.settings.renderMode!==be.HorizontalBillBoard&&this.settings.renderMode!==be.VerticalBillBoard&&this.settings.renderMode!==be.StretchedBillBoard||(this.rotationBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.rotationBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("rotation",this.rotationBuffer)),this.sizeBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.sizeBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("size",this.sizeBuffer),this.uvTileBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.uvTileBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("uvTile",this.uvTileBuffer),this.settings.renderMode===be.StretchedBillBoard&&(this.velocityBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.velocityBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("velocity",this.velocityBuffer))}},{key:"setupBuffers",value:function setupBuffers(){this.geometry&&this.geometry.dispose(),this.geometry=new t.InstancedBufferGeometry,this.geometry.setIndex(this.settings.instancingGeometry.getIndex()),this.settings.instancingGeometry.hasAttribute("normal")&&this.geometry.setAttribute("normal",this.settings.instancingGeometry.getAttribute("normal")),this.geometry.setAttribute("position",this.settings.instancingGeometry.getAttribute("position")),this.geometry.setAttribute("uv",this.settings.instancingGeometry.getAttribute("uv")),this.buildExpandableBuffers()}},{key:"expandBuffers",value:function expandBuffers(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function rebuildMaterial(){var e;this.layers.mask=this.settings.layers.mask;var i={};if("MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type){var r=this.settings.material;(e=t.UniformsUtils.merge([t.UniformsLib.common,t.UniformsLib.envmap,t.UniformsLib.aomap,t.UniformsLib.lightmap,t.UniformsLib.emissivemap,t.UniformsLib.bumpmap,t.UniformsLib.normalmap,t.UniformsLib.displacementmap,t.UniformsLib.roughnessmap,t.UniformsLib.metalnessmap,t.UniformsLib.fog,t.UniformsLib.lights,{emissive:{value:new t.Color(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}])).diffuse.value=r.color,e.opacity.value=r.opacity,e.emissive.value=r.emissive,e.roughness.value=r.roughness,e.metalness.value=r.metalness,r.envMap&&(e.envMap.value=r.envMap,e.envMapIntensity.value=r.envMapIntensity),r.normalMap&&(e.normalMap.value=r.normalMap,e.normalScale.value=r.normalScale),r.roughnessMap&&(e.roughnessMap.value=r.roughnessMap),r.metalnessMap&&(e.metalnessMap.value=r.metalnessMap),r.map&&(e.map=new t.Uniform(r.map))}else(e={}).map=new t.Uniform(this.settings.material.map);this.settings.material.alphaTest&&(i.USE_ALPHATEST="",e.alphaTest=new t.Uniform(this.settings.material.alphaTest)),i.USE_UV="";var n=this.settings.uTileCount,o=this.settings.vTileCount;(n>1||o>1)&&(i.UV_TILE="",e.tileCount=new t.Uniform(new t.Vector2(n,o))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(i.USE_COLOR_AS_ALPHA=""),this.settings.material.normalMap&&(i.USE_NORMALMAP="",i.NORMALMAP_UV=getMaterialUVChannelName(this.settings.material.normalMap.channel),e.normalMapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.normalMap.matrix))),this.settings.material.map&&(i.USE_MAP="",i.MAP_UV=getMaterialUVChannelName(this.settings.material.map.channel),e.mapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.map.matrix))),i.USE_COLOR_ALPHA="";var a=!1;if(this.settings.renderMode===be.BillBoard||this.settings.renderMode===be.VerticalBillBoard||this.settings.renderMode===be.HorizontalBillBoard||this.settings.renderMode===be.Mesh){var s,l;this.settings.renderMode===be.Mesh?"MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type?(i.USE_COLOR="",s=Je,l="\n#define STANDARD\n#ifdef PHYSICAL\n#define IOR\n#define SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\nuniform float ior;\n#endif\n#ifdef SPECULAR\nuniform float specularIntensity;\nuniform vec3 specularColor;\n#ifdef USE_SPECULARINTENSITYMAP\nuniform sampler2D specularIntensityMap;\n#endif\n#ifdef USE_SPECULARCOLORMAP\nuniform sampler2D specularColorMap;\n#endif\n#endif\n#ifdef USE_CLEARCOAT\nuniform float clearcoat;\nuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\nuniform float iridescence;\nuniform float iridescenceIOR;\nuniform float iridescenceThicknessMinimum;\nuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\nuniform vec3 sheenColor;\nuniform float sheenRoughness;\n#ifdef USE_SHEENCOLORMAP\nuniform sampler2D sheenColorMap;\n#endif\n#ifdef USE_SHEENROUGHNESSMAP\nuniform sampler2D sheenRoughnessMap;\n#endif\n#endif\n\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n    #include <clipping_planes_fragment>\n    vec4 diffuseColor = vec4( diffuse, opacity );\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    vec3 totalEmissiveRadiance = emissive;\n    #include <logdepthbuf_fragment>\n    #include <map_fragment>\n    #include <color_fragment>\n    #include <alphamap_fragment>\n    #include <alphatest_fragment>\n    #include <roughnessmap_fragment>\n    #include <metalnessmap_fragment>\n    #include <normal_fragment_begin>\n    #include <normal_fragment_maps>\n    #include <clearcoat_normal_fragment_begin>\n    #include <clearcoat_normal_fragment_maps>\n    #include <emissivemap_fragment>\n    // accumulation\n    #include <lights_physical_fragment>\n    #include <lights_fragment_begin>\n    #include <lights_fragment_maps>\n    #include <lights_fragment_end>\n    // modulation\n    #include <aomap_fragment>\n    vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n    vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n    #include <transmission_fragment>\n    vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n    #ifdef USE_SHEEN\n    // Sheen energy compensation approximation calculation can be found at the end of\n        // https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\n        float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n        outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;\n    #endif\n    #ifdef USE_CLEARCOAT\n        float dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n        vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n        outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;\n    #endif\n    #include <output_fragment>\n    #include <tonemapping_fragment>\n    #include <encodings_fragment>\n    #include <fog_fragment>\n    #include <premultiplied_alpha_fragment>\n    #include <dithering_fragment>\n}",a=!0):(s=Ae,l=Te):(s=ze,l=Te),this.settings.renderMode===be.VerticalBillBoard?i.VERTICAL="":this.settings.renderMode===be.HorizontalBillBoard&&(i.HORIZONTAL=""),this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:s,fragmentShader:l,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest,lights:a})}else{if(this.settings.renderMode!==be.StretchedBillBoard)throw new Error("render mode unavailable");e.speedFactor=new t.Uniform(1),this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:Le,fragmentShader:Te,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest})}}},{key:"update",value:function update(){var e=this,t=0,i=0;this.systems.forEach((function(e){i+=e.particleNum})),i>this.maxParticles&&this.expandBuffers(i),this.systems.forEach((function(i){var r=i.particles,n=i.particleNum,o=e.quaternion2_,a=e.vector2_,s=e.vector3_;i.emitter.matrixWorld.decompose(a,o,s),e.rotationMat_.setFromMatrix4(i.emitter.matrixWorld);for(var l=0;l<n;l++,t++){var u=r[l];if(e.settings.renderMode===be.Mesh){var c=void 0;if(i.worldSpace)c=u.rotation;else{var d=void 0;d=u.parentMatrix?e.quaternion3_.setFromRotationMatrix(u.parentMatrix):o,(c=e.quaternion_).copy(u.rotation).multiply(d)}e.rotationBuffer.setXYZW(t,c.x,c.y,c.z,c.w)}else e.settings.renderMode!==be.StretchedBillBoard&&e.settings.renderMode!==be.VerticalBillBoard&&e.settings.renderMode!==be.HorizontalBillBoard&&e.settings.renderMode!==be.BillBoard||e.rotationBuffer.setX(t,u.rotation);var h=void 0;if(i.worldSpace?h=u.position:(h=e.vector_,u.parentMatrix?h.copy(u.position).applyMatrix4(u.parentMatrix):h.copy(u.position).applyMatrix4(i.emitter.matrixWorld)),e.offsetBuffer.setXYZ(t,h.x,h.y,h.z),e.colorBuffer.setXYZW(t,u.color.x,u.color.y,u.color.z,u.color.w),i.worldSpace||u.parentMatrix?e.sizeBuffer.setX(t,u.size):e.sizeBuffer.setX(t,u.size*(Math.abs(s.x)+Math.abs(s.y)+Math.abs(s.z))/3),e.uvTileBuffer.setX(t,u.uvTile),e.settings.renderMode===be.StretchedBillBoard&&e.velocityBuffer){var f=i.rendererEmitterSettings.speedFactor;0===f&&(f=.001);var p=i.rendererEmitterSettings.lengthFactor,m=void 0;i.worldSpace?m=u.velocity:(m=e.vector_,u.parentMatrix?(e.rotationMat2_.setFromMatrix4(u.parentMatrix),m.copy(u.velocity).applyMatrix3(e.rotationMat2_)):m.copy(u.velocity).applyMatrix3(e.rotationMat_)),e.velocityBuffer.setXYZW(t,m.x*f,m.y*f,m.z*f,p)}}})),this.geometry.instanceCount=t,t>0&&(this.offsetBuffer.updateRange.count=3*t,this.offsetBuffer.needsUpdate=!0,this.sizeBuffer.updateRange.count=t,this.sizeBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.uvTileBuffer.updateRange.count=t,this.uvTileBuffer.needsUpdate=!0,this.settings.renderMode===be.StretchedBillBoard&&this.velocityBuffer&&(this.velocityBuffer.updateRange.count=4*t,this.velocityBuffer.needsUpdate=!0),this.settings.renderMode===be.Mesh?(this.rotationBuffer.updateRange.count=4*t,this.rotationBuffer.needsUpdate=!0):this.settings.renderMode!==be.StretchedBillBoard&&this.settings.renderMode!==be.HorizontalBillBoard&&this.settings.renderMode!==be.VerticalBillBoard&&this.settings.renderMode!==be.BillBoard||(this.rotationBuffer.updateRange.count=t,this.rotationBuffer.needsUpdate=!0))}},{key:"dispose",value:function dispose(){this.geometry.dispose()}}]),SpriteBatch}(Ne),Re="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <fog_pars_vertex>\n\nattribute vec3 previous;\nattribute vec3 next;\nattribute float side;\nattribute float width;\n\nuniform vec2 resolution;\nuniform float lineWidth;\nuniform float sizeAttenuation;\n    \nvec2 fix(vec4 i, float aspect) {\n    vec2 res = i.xy / i.w;\n    res.x *= aspect;\n    return res;\n}\n    \nvoid main() {\n\n    ".concat(Ee,"\n    \n    float aspect = resolution.x / resolution.y;\n\n    vColor = color;\n\n    mat4 m = projectionMatrix * modelViewMatrix;\n    vec4 finalPosition = m * vec4( position, 1.0 );\n    vec4 prevPos = m * vec4( previous, 1.0 );\n    vec4 nextPos = m * vec4( next, 1.0 );\n\n    vec2 currentP = fix( finalPosition, aspect );\n    vec2 prevP = fix( prevPos, aspect );\n    vec2 nextP = fix( nextPos, aspect );\n\n    float w = lineWidth * width;\n\n    vec2 dir;\n    if( nextP == currentP ) dir = normalize( currentP - prevP );\n    else if( prevP == currentP ) dir = normalize( nextP - currentP );\n    else {\n        vec2 dir1 = normalize( currentP - prevP );\n        vec2 dir2 = normalize( nextP - currentP );\n        dir = normalize( dir1 + dir2 );\n\n        vec2 perp = vec2( -dir1.y, dir1.x );\n        vec2 miter = vec2( -dir.y, dir.x );\n        //w = clamp( w / dot( miter, perp ), 0., 4., * lineWidth * width );\n\n    }\n\n    //vec2 normal = ( cross( vec3( dir, 0. ) vec3( 0., 0., 1. ) ) ).xy;\n    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );\n    normal.xy *= .5 * w;\n    normal *= projectionMatrix;\n    if( sizeAttenuation == 0. ) {\n        normal.xy *= finalPosition.w;\n        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;\n    }\n\n    finalPosition.xy += normal.xy * side;\n\n    gl_Position = finalPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    \n\t#include <fog_vertex>\n}");new t.Vector3(0,0,1);var Fe=function(e){_inherits(TrailBatch,e);var i=_createSuper(TrailBatch);function TrailBatch(e){var r;return _classCallCheck(this,TrailBatch),_defineProperty(_assertThisInitialized(r=i.call(this,e)),"positionBuffer",void 0),_defineProperty(_assertThisInitialized(r),"previousBuffer",void 0),_defineProperty(_assertThisInitialized(r),"nextBuffer",void 0),_defineProperty(_assertThisInitialized(r),"uvBuffer",void 0),_defineProperty(_assertThisInitialized(r),"sideBuffer",void 0),_defineProperty(_assertThisInitialized(r),"widthBuffer",void 0),_defineProperty(_assertThisInitialized(r),"colorBuffer",void 0),_defineProperty(_assertThisInitialized(r),"indexBuffer",void 0),_defineProperty(_assertThisInitialized(r),"vector_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector2_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector3_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"quaternion_",new t.Quaternion),r.maxParticles=1e4,r.setupBuffers(),r.rebuildMaterial(),r}return _createClass(TrailBatch,[{key:"setupBuffers",value:function setupBuffers(){this.geometry&&this.geometry.dispose(),this.geometry=new t.BufferGeometry,this.indexBuffer=new t.BufferAttribute(new Uint32Array(6*this.maxParticles),1),this.indexBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setIndex(this.indexBuffer),this.positionBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.positionBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("position",this.positionBuffer),this.previousBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.previousBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("previous",this.previousBuffer),this.nextBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.nextBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("next",this.nextBuffer),this.widthBuffer=new t.BufferAttribute(new Float32Array(2*this.maxParticles),1),this.widthBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("width",this.widthBuffer),this.sideBuffer=new t.BufferAttribute(new Float32Array(2*this.maxParticles),1),this.sideBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("side",this.sideBuffer),this.uvBuffer=new t.BufferAttribute(new Float32Array(4*this.maxParticles),2),this.uvBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("uv",this.uvBuffer),this.colorBuffer=new t.BufferAttribute(new Float32Array(8*this.maxParticles),4),this.colorBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("color",this.colorBuffer)}},{key:"expandBuffers",value:function expandBuffers(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function rebuildMaterial(){this.layers.mask=this.settings.layers.mask;var e={lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},resolution:{value:new t.Vector2(1,1)},sizeAttenuation:{value:1},visibility:{value:1},alphaTest:{value:0},repeat:{value:new t.Vector2(1,1)}},i={USE_UV:"",USE_COLOR_ALPHA:""};if(this.settings.material.map&&(i.USE_MAP="",i.MAP_UV=getMaterialUVChannelName(this.settings.material.map.channel),e.map=new t.Uniform(this.settings.material.map),e.mapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.map.matrix))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(i.USE_COLOR_AS_ALPHA=""),this.settings.renderMode!==be.Trail)throw new Error("render mode unavailable");this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:Re,fragmentShader:"\n\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nuniform sampler2D alphaMap;\nuniform float useAlphaMap;\nuniform float visibility;\nuniform float alphaTest;\nuniform vec2 repeat;\n\nvarying vec4 vColor;\n    \nvoid main() {\n    #include <clipping_planes_fragment>\n    #include <logdepthbuf_fragment>\n\n    vec4 c = vColor;\n    \n    #ifdef USE_MAP\n    #ifdef USE_COLOR_AS_ALPHA\n    vec4 tex = texture2D( map, vUv * repeat );\n    c *= vec4(tex.rgb, tex.r);\n    #else\n    c *= texture2D( map, vUv * repeat );\n    #endif\n    #endif\n    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUv * repeat ).a;\n    if( c.a < alphaTest ) discard;\n    gl_FragColor = c;\n\n    #include <fog_fragment>\n    #include <tonemapping_fragment>\n}",transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,side:this.settings.material.side,blending:this.settings.material.blending||t.AdditiveBlending})}},{key:"update",value:function update(){var e=this,t=0,i=0,r=0;this.systems.forEach((function(e){for(var t=0;t<e.particleNum;t++)r+=2*e.particles[t].previous.length})),r>this.maxParticles&&this.expandBuffers(r),this.systems.forEach((function(r){var n=e.quaternion_,o=e.vector2_,a=e.vector3_;r.emitter.matrixWorld.decompose(o,n,a);for(var s=r.particles,l=r.particleNum,u=e.settings.uTileCount,c=e.settings.vTileCount,d=1/u,h=1/c,f=0;f<l;f++){var p=s[f],m=p.uvTile%c,y=Math.floor(p.uvTile/c),v=p.previous.values(),g=v.next(),S=g.value,_=S;g.done||(g=v.next());var w=void 0;w=void 0!==g.value?g.value:_;for(var O=0;O<p.previous.length;O++,t+=2){if(e.positionBuffer.setXYZ(t,_.position.x,_.position.y,_.position.z),e.positionBuffer.setXYZ(t+1,_.position.x,_.position.y,_.position.z),r.worldSpace?(e.positionBuffer.setXYZ(t,_.position.x,_.position.y,_.position.z),e.positionBuffer.setXYZ(t+1,_.position.x,_.position.y,_.position.z)):(p.parentMatrix?e.vector_.copy(_.position).applyMatrix4(p.parentMatrix):e.vector_.copy(_.position).applyMatrix4(r.emitter.matrixWorld),e.positionBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.positionBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),r.worldSpace?(e.previousBuffer.setXYZ(t,S.position.x,S.position.y,S.position.z),e.previousBuffer.setXYZ(t+1,S.position.x,S.position.y,S.position.z)):(p.parentMatrix?e.vector_.copy(S.position).applyMatrix4(p.parentMatrix):e.vector_.copy(S.position).applyMatrix4(r.emitter.matrixWorld),e.previousBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.previousBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),r.worldSpace?(e.nextBuffer.setXYZ(t,w.position.x,w.position.y,w.position.z),e.nextBuffer.setXYZ(t+1,w.position.x,w.position.y,w.position.z)):(p.parentMatrix?e.vector_.copy(w.position).applyMatrix4(p.parentMatrix):e.vector_.copy(w.position).applyMatrix4(r.emitter.matrixWorld),e.nextBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.nextBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),e.sideBuffer.setX(t,-1),e.sideBuffer.setX(t+1,1),r.worldSpace)e.widthBuffer.setX(t,_.size),e.widthBuffer.setX(t+1,_.size);else if(p.parentMatrix)e.widthBuffer.setX(t,_.size),e.widthBuffer.setX(t+1,_.size);else{var x=(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z))/3;e.widthBuffer.setX(t,_.size*x),e.widthBuffer.setX(t+1,_.size*x)}e.uvBuffer.setXY(t,(O/p.previous.length+m)*d,(c-y-1)*h),e.uvBuffer.setXY(t+1,(O/p.previous.length+m)*d,(c-y)*h),e.colorBuffer.setXYZW(t,_.color.x,_.color.y,_.color.z,_.color.w),e.colorBuffer.setXYZW(t+1,_.color.x,_.color.y,_.color.z,_.color.w),O+1<p.previous.length&&(e.indexBuffer.setX(3*i,t),e.indexBuffer.setX(3*i+1,t+1),e.indexBuffer.setX(3*i+2,t+2),i++,e.indexBuffer.setX(3*i,t+2),e.indexBuffer.setX(3*i+1,t+1),e.indexBuffer.setX(3*i+2,t+3),i++),S=_,_=w,g.done||void 0!==(g=v.next()).value&&(w=g.value)}}})),this.positionBuffer.updateRange.count=3*t,this.positionBuffer.needsUpdate=!0,this.previousBuffer.updateRange.count=3*t,this.previousBuffer.needsUpdate=!0,this.nextBuffer.updateRange.count=3*t,this.nextBuffer.needsUpdate=!0,this.sideBuffer.updateRange.count=t,this.sideBuffer.needsUpdate=!0,this.widthBuffer.updateRange.count=t,this.widthBuffer.needsUpdate=!0,this.uvBuffer.updateRange.count=2*t,this.uvBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.indexBuffer.updateRange.count=3*i,this.indexBuffer.needsUpdate=!0,this.geometry.setDrawRange(0,3*i)}},{key:"dispose",value:function dispose(){this.geometry.dispose()}}]),TrailBatch}(Ne),Ie=function(e){_inherits(BatchedRenderer,e);var t=_createSuper(BatchedRenderer);function BatchedRenderer(){var e;return _classCallCheck(this,BatchedRenderer),_defineProperty(_assertThisInitialized(e=t.call(this)),"batches",[]),_defineProperty(_assertThisInitialized(e),"systemToBatchIndex",new Map),_defineProperty(_assertThisInitialized(e),"type","BatchedRenderer"),e}return _createClass(BatchedRenderer,[{key:"addSystem",value:function addSystem(e){e._renderer=this;for(var t,i=e.getRendererSettings(),r=0;r<this.batches.length;r++)if(BatchedRenderer.equals(this.batches[r].settings,i))return this.batches[r].addSystem(e),void this.systemToBatchIndex.set(e,r);switch(i.renderMode){case be.Trail:t=new Fe(i);break;case be.Mesh:case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:case be.StretchedBillBoard:t=new Ue(i)}t.addSystem(e),this.batches.push(t),this.systemToBatchIndex.set(e,this.batches.length-1),this.add(t)}},{key:"deleteSystem",value:function deleteSystem(e){var t=this.systemToBatchIndex.get(e);null!=t&&(this.batches[t].removeSystem(e),this.systemToBatchIndex.delete(e))}},{key:"updateSystem",value:function updateSystem(e){this.deleteSystem(e),this.addSystem(e)}},{key:"update",value:function update(e){this.systemToBatchIndex.forEach((function(t,i){i.update(e)}));for(var t=0;t<this.batches.length;t++)this.batches[t].update()}}],[{key:"equals",value:function equals(e,t){return e.material.side===t.material.side&&e.material.blending===t.material.blending&&e.material.transparent===t.material.transparent&&e.material.type===t.material.type&&e.material.alphaTest===t.material.alphaTest&&e.material.map===t.material.map&&e.renderMode===t.renderMode&&e.uTileCount===t.uTileCount&&e.vTileCount===t.vTileCount&&e.instancingGeometry===t.instancingGeometry&&e.renderOrder===t.renderOrder&&e.layers.mask===t.layers.mask}}]),BatchedRenderer}(t.Object3D),Ge=Ie,De=function(e){_inherits(QuarksLoader,e);var i=_createSuper(QuarksLoader);function QuarksLoader(e){return _classCallCheck(this,QuarksLoader),i.call(this,e)}return _createClass(QuarksLoader,[{key:"linkReference",value:function linkReference(e){var t={};e.traverse((function(e){t[e.uuid]=e})),e.traverse((function(e){if("ParticleEmitter"===e.type){var i=e.system;i.emitterShape;for(var r=0;r<i.behaviors.length;r++)i.behaviors[r]instanceof j&&(i.behaviors[r].subParticleSystem=t[i.behaviors[r].subParticleSystem])}}))}},{key:"parse",value:function parse(e,t){var i=_get(_getPrototypeOf(QuarksLoader.prototype),"parse",this).call(this,e,t);return this.linkReference(i),i}},{key:"parseObject",value:function parseObject(e,i,r,n,o){var a,s,l;function getGeometry(e){return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),i[e]}function getMaterial(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],i=0,n=e.length;i<n;i++){var o=e[i];void 0===r[o]&&console.warn("THREE.ObjectLoader: Undefined material",o),t.push(r[o])}return t}return void 0===r[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),r[e]}}function getTexture(e){return void 0===n[e]&&console.warn("THREE.ObjectLoader: Undefined texture",e),n[e]}var u={textures:n,geometries:i,materials:r};switch(e.type){case"ParticleEmitter":a=Be.fromJSON(e.ps,u,{}).emitter;break;case"Scene":a=new t.Scene,void 0!==e.background&&(Number.isInteger(e.background)?a.background=new t.Color(e.background):a.background=getTexture(e.background)),void 0!==e.environment&&(a.environment=getTexture(e.environment)),void 0!==e.fog&&("Fog"===e.fog.type?a.fog=new t.Fog(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(a.fog=new t.FogExp2(e.fog.color,e.fog.density))),void 0!==e.backgroundBlurriness&&(a.backgroundBlurriness=e.backgroundBlurriness);break;case"PerspectiveCamera":a=new t.PerspectiveCamera(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(a.focus=e.focus),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.filmGauge&&(a.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(a.filmOffset=e.filmOffset),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"OrthographicCamera":a=new t.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"AmbientLight":a=new t.AmbientLight(e.color,e.intensity);break;case"DirectionalLight":a=new t.DirectionalLight(e.color,e.intensity);break;case"PointLight":a=new t.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":a=new t.RectAreaLight(e.color,e.intensity,e.width,e.height);break;case"SpotLight":a=new t.SpotLight(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay);break;case"HemisphereLight":a=new t.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"LightProbe":a=(new t.LightProbe).fromJSON(e);break;case"SkinnedMesh":s=getGeometry(e.geometry),l=getMaterial(e.material),a=new t.SkinnedMesh(s,l),void 0!==e.bindMode&&(a.bindMode=e.bindMode),void 0!==e.bindMatrix&&a.bindMatrix.fromArray(e.bindMatrix),void 0!==e.skeleton&&(a.skeleton=e.skeleton);break;case"Mesh":s=getGeometry(e.geometry),l=getMaterial(e.material),a=new t.Mesh(s,l);break;case"InstancedMesh":s=getGeometry(e.geometry),l=getMaterial(e.material);var c=e.count,d=e.instanceMatrix,h=e.instanceColor;(a=new t.InstancedMesh(s,l,c)).instanceMatrix=new t.InstancedBufferAttribute(new Float32Array(d.array),16),void 0!==h&&(a.instanceColor=new t.InstancedBufferAttribute(new Float32Array(h.array),h.itemSize));break;case"LOD":a=new t.LOD;break;case"Line":a=new t.Line(getGeometry(e.geometry),getMaterial(e.material));break;case"LineLoop":a=new t.LineLoop(getGeometry(e.geometry),getMaterial(e.material));break;case"LineSegments":a=new t.LineSegments(getGeometry(e.geometry),getMaterial(e.material));break;case"PointCloud":case"Points":a=new t.Points(getGeometry(e.geometry),getMaterial(e.material));break;case"Sprite":a=new t.Sprite(getMaterial(e.material));break;case"Group":a=new t.Group;break;case"Bone":a=new t.Bone;break;default:a=new t.Object3D}if(a.uuid=e.uuid,void 0!==e.name&&(a.name=e.name),void 0!==e.matrix?(a.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(a.matrixAutoUpdate=e.matrixAutoUpdate),a.matrixAutoUpdate&&a.matrix.decompose(a.position,a.quaternion,a.scale)):(void 0!==e.position&&a.position.fromArray(e.position),void 0!==e.rotation&&a.rotation.fromArray(e.rotation),void 0!==e.quaternion&&a.quaternion.fromArray(e.quaternion),void 0!==e.scale&&a.scale.fromArray(e.scale)),void 0!==e.castShadow&&(a.castShadow=e.castShadow),void 0!==e.receiveShadow&&(a.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(a.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(a.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(a.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&a.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(a.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(a.visible=e.visible),void 0!==e.frustumCulled&&(a.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(a.renderOrder=e.renderOrder),void 0!==e.userData&&(a.userData=e.userData),void 0!==e.layers&&(a.layers.mask=e.layers),void 0!==e.children)for(var f=e.children,p=0;p<f.length;p++)a.add(this.parseObject(f[p],i,r,n,o));if(void 0!==e.animations)for(var m=e.animations,y=0;y<m.length;y++){var v=m[y];a.animations.push(o[v])}if("LOD"===e.type){void 0!==e.autoUpdate&&(a.autoUpdate=e.autoUpdate);for(var g=e.levels,S=0;S<g.length;S++){var _=g[S],w=a.getObjectByProperty("uuid",_.object);void 0!==w&&a.addLevel(w,_.distance)}}return a}}]),QuarksLoader}(t.ObjectLoader),qe=[],Xe=function(e){return e[e.Number=0]="Number",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Boolean=4]="Boolean",e[e.AnyType=5]="AnyType",e[e.NullableAnyType=6]="NullableAnyType",e[e.EventStream=7]="EventStream",e}({}),je=function genDefaultForNodeValueType(e){switch(e){case Xe.Boolean:return!1;case Xe.Number:return 0;case Xe.Vec2:return new t.Vector2;case Xe.Vec3:return new t.Vector3;case Xe.Vec4:return new t.Vector4;case Xe.AnyType:return 0;case Xe.NullableAnyType:return}},He=function(){function Node(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck(this,Node),_defineProperty(this,"id",void 0),_defineProperty(this,"inputs",[]),_defineProperty(this,"outputs",[]),_defineProperty(this,"type",void 0),_defineProperty(this,"signatureIndex",-1),_defineProperty(this,"data",void 0),_defineProperty(this,"position",new t.Vector2),_defineProperty(this,"outputValues",[]),this.id=""+Math.round(1e5*Math.random()),this.type=e,this.signatureIndex=i,this.data=r;for(var n=-1===i?0:i,o=0;o<e.nodeTypeSignatures[n].inputTypes.length;o++)this.inputs.push(void 0);for(var a=0;a<e.nodeTypeSignatures[n].outputTypes.length;a++)this.outputs.push([]),this.outputValues.push(je(e.nodeTypeSignatures[n].outputTypes[a]))}return _createClass(Node,[{key:"inputTypes",get:function get(){var e=-1===this.signatureIndex?0:this.signatureIndex;return this.type.nodeTypeSignatures[e].inputTypes}},{key:"outputTypes",get:function get(){var e=-1===this.signatureIndex?0:this.signatureIndex;return this.type.nodeTypeSignatures[e].outputTypes}},{key:"func",value:function func(e,t,i){var r=-1===this.signatureIndex?0:this.signatureIndex;this.type.nodeTypeSignatures[r].func(e,this.data,t,i)}}]),Node}(),We=_createClass((function Wire(e,t,i,r){_classCallCheck(this,Wire),_defineProperty(this,"input",void 0),_defineProperty(this,"inputIndex",void 0),_defineProperty(this,"output",void 0),_defineProperty(this,"outputIndex",void 0),this.input=e,this.inputIndex=t,this.input.outputs[t].push(this),this.output=i,this.outputIndex=r,this.output.inputs[r]=this})),Qe=function(){function BaseCompiler(){_classCallCheck(this,BaseCompiler),_defineProperty(this,"visited",new Set),BaseCompiler.Instance=this}return _createClass(BaseCompiler,[{key:"buildExecutionOrder",value:function buildExecutionOrder(e,t){e.nodesInOrder.length=0,this.visited.clear();for(var i=0;i<e.outputNodes.length;i++){var r=e.outputNodes[i];void 0!==r.inputs[0]&&this._traverse(r,e,t)}e.compiled=!0}},{key:"_traverse",value:function _traverse(e,t,i){this.visited.add(e.id);for(var r=0;r<e.inputs.length;r++)if(e.inputs[r]instanceof We){var n=e.inputs[r].input;this.visited.has(n.id)||this._traverse(n,t,i)}else e.inputs[r];t.nodesInOrder.push(e)}}]),BaseCompiler}();_defineProperty(Qe,"Instance",void 0);var Ye=function(e){_inherits(Interpreter,e);var t=_createSuper(Interpreter);function Interpreter(){return _classCallCheck(this,Interpreter),t.call(this)}return _createClass(Interpreter,[{key:"executeCompiledGraph",value:function executeCompiledGraph(e,t){for(var i=e.nodesInOrder,r=0;r<i.length;r++){for(var n=[],o=i[r],a=0;a<o.inputs.length;a++)o.inputs[a]instanceof We?n.push(o.inputs[a].input.outputValues[o.inputs[a].inputIndex]):void 0!==o.inputs[a]?n.push(o.inputs[a].getValue(t)):n.push(void 0);o.func(t,n,o.outputValues)}}},{key:"run",value:function run(e,t){e.compiled||this.buildExecutionOrder(e,t),this.executeCompiledGraph(e,t)}}]),Interpreter}(Qe),Ze=function(){function NodeType(e){_classCallCheck(this,NodeType),_defineProperty(this,"name",void 0),_defineProperty(this,"nodeTypeSignatures",[]),this.name=e}return _createClass(NodeType,[{key:"addSignature",value:function addSignature(e,t,i){this.nodeTypeSignatures.push({inputTypes:e,outputTypes:t,func:i})}}]),NodeType}(),Ke=function(e){_inherits(GraphNodeType,e);var t=_createSuper(GraphNodeType);function GraphNodeType(e){var i;_classCallCheck(this,GraphNodeType);for(var r=[],n=0;n<e.inputNodes.length;n++)"input"===e.inputNodes[n].type.name&&r.push(e.inputNodes[n].data.type);for(var o=[],a=0;a<e.outputNodes.length;a++)"output"===e.outputNodes[a].type.name&&o.push(e.outputNodes[a].data.type);return _defineProperty(_assertThisInitialized(i=t.call(this,e.name)),"nodeGraph",void 0),i.addSignature(r,o,(function(t,i,r,n){t.inputs=r,t.outputs=n,Ye.Instance.run(e,t)})),i.nodeGraph=e,i}return _createClass(GraphNodeType)}(Ze),$e={},et=new Ze("add");et.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]+i[1]})),et.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),et.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),et.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),$e.add=et;var tt=new Ze("sub");tt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]-i[1]})),tt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),tt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),tt.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),$e.sub=tt;var it=new Ze("mul");it.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]*i[1]})),it.addSignature([Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),it.addSignature([Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),it.addSignature([Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),$e.mul=it;var rt=new Ze("div");rt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]/i[1]})),rt.addSignature([Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),rt.addSignature([Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),rt.addSignature([Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),$e.div=rt;var nt=new Ze("sin");nt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.sin(i[0])})),$e.sin=nt;var ot=new Ze("cos");ot.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.cos(i[0])})),$e.cos=ot;var at=new Ze("tan");at.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.tan(i[0])})),$e.tan=at;var st=new Ze("abs");st.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.abs(i[0])})),$e.abs=st;var lt=new Ze("min");lt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.min(i[0],i[1])})),$e.min=lt;var ut=new Ze("max");ut.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.max(i[0],i[1])})),$e.max=ut;var ct=new Ze("dot");ct.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),ct.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),ct.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),$e.dot=ct;var dt=new Ze("cross");dt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].crossVectors(i[0],i[1])})),$e.cross=dt;var ht=new Ze("length");ht.addSignature([Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),ht.addSignature([Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),ht.addSignature([Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),$e.length=ht;var ft=new Ze("lengthSq");ft.addSignature([Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),ft.addSignature([Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),ft.addSignature([Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),$e.lengthSq=ft;var pt=new Ze("normalize");pt.addSignature([Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),pt.addSignature([Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),pt.addSignature([Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),$e.normalize=pt;var mt=new Ze("distance");mt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].distanceTo(i[1])})),mt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].distanceTo(i[1])})),$e.distance=mt;var yt=new Ze("and");yt.addSignature([Xe.Boolean,Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]&&i[1]})),$e.and=yt;var vt=new Ze("or");vt.addSignature([Xe.Boolean,Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]||i[1]})),$e.or=vt;var gt=new Ze("not");gt.addSignature([Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=!i[0]})),$e.not=gt;var St=new Ze("equal");St.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]===i[1]})),St.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),St.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),St.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),$e.equal=St;var _t=new Ze("lessThan");_t.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]<i[1]})),$e.lessThan=_t;var wt=new Ze("greaterThan");wt.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]>i[1]})),$e.greaterThan=wt;var Ot=new Ze("lessThanOrEqual");Ot.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]<=i[1]})),$e.lessThanOrEqual=Ot;var xt=new Ze("greaterThanOrEqual");xt.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]>=i[1]})),$e.greaterThanOrEqual=xt;var bt=new Ze("if");bt.addSignature([Xe.Boolean,Xe.AnyType,Xe.AnyType],[Xe.AnyType],(function(e,t,i,r){r[0]=i[0]?i[1]:i[2]})),$e.if=bt;var Nt=new Ze("number");Nt.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=t.value})),$e.number=Nt;var Pt=new Ze("vec2");Pt.addSignature([Xe.Number,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1]})),$e.vec2=Pt;var kt=new Ze("vec3");kt.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1],r[0].z=i[2]})),$e.vec3=kt;var Mt=new Ze("vec4");Mt.addSignature([Xe.Number,Xe.Number,Xe.Number,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1],r[0].z=i[2],r[0].w=i[3]})),$e.vec4=Mt;var Ct=new Ze("splitVec2");Ct.addSignature([Xe.Vec2],[Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y})),$e.splitVec2=Ct;var Vt=new Ze("splitVec3");Vt.addSignature([Xe.Vec3],[Xe.Number,Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y,r[2]=i[0].z})),$e.splitVec3=Vt;var Bt=new Ze("splitVec4");Bt.addSignature([Xe.Vec4],[Xe.Number,Xe.Number,Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y,r[2]=i[0].z,r[3]=i[0].w})),$e.splitVec4=Bt;var Tt=new Ze("bool");Tt.addSignature([],[Xe.Boolean],(function(e,t,i,r){r[0]=t.value})),$e.bool=Tt;var Et=new Ze("particleProperty");Et.addSignature([Xe.NullableAnyType],[Xe.NullableAnyType],(function(e,t,i,r){void 0!==i[0]&&("object"===_typeof(i[0])?e.particle[t.property].copy(i[0]):e.particle[t.property]=i[0]),void 0!==e.particle[t.property]&&("object"===_typeof(r[0])?r[0].copy(e.particle[t.property]):r[0]=e.particle[t.property])})),$e.particleProperty=Et;var zt=new Ze("emit");zt.addSignature([Xe.EventStream],[],(function(e,t,i,r){for(var n=i[0],o=0;o<n.length;o++)e.signal(o,n[o])})),$e.emit=zt;var At=new Ze("graphProperty");At.addSignature([Xe.NullableAnyType],[Xe.NullableAnyType],(function(e,t,i,r){void 0!==i[0]&&("object"===_typeof(i[0])?e.graph[t.property].copy(i[0]):e.graph[t.property]=i[0]),void 0!==e.graph[t.property]&&("object"===_typeof(r[0])?r[0].copy(e.graph[t.property]):r[0]=e.graph[t.property])})),$e.graphProperty=At;var Jt=new Ze("startEvent");Jt.addSignature([],[Xe.EventStream],(function(e,t,i,r){r[0]=[{type:"start"}]})),$e.startEvent=Jt;var Lt=new Ze("repeater");Lt.addSignature([Xe.EventStream,Xe.Number],[Xe.EventStream],(function(e,t,i,r){for(var n=i[0],o=i[1],a=[],s=0;s<n.length;s++)for(var l=0;l<o;l++)a.push(n[s]);r[0]=a})),$e.repeater=Lt;var Ut=new Ze("time");Ut.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=e.emissionState.time})),$e.time=Ut;var Rt=new Ze("delta");Rt.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=e.delta})),$e.delta=Rt;var Ft=new Ze("output");Ft.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]})),$e.output=Ft;var It=new Ze("lerp");It.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]*(1-i[2])+i[1]*i[2]})),It.addSignature([Xe.Vec2,Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),It.addSignature([Xe.Vec3,Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),It.addSignature([Xe.Vec4,Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),$e.lerp=It;var Gt=new Ze("normDistrib");Gt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=function normalD(e){return 1/Math.sqrt(2*Math.PI)*Math.exp(e*e*-.5)}(i[0])})),$e.normDistrib=Gt;var Dt=new Ze("normcdf");Dt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){var n=i[0],o=1;n<0&&(o=-1);var a=1/(1+.3275911*(n=Math.abs(n)/Math.sqrt(2))),s=1-((((1.061405429*a-1.453152027)*a+1.421413741)*a-.284496736)*a+.254829592)*a*Math.exp(-n*n);r[0]=.5*(1+o*s)})),$e.normcdf=Dt;var qt=new Ze("normcdfInv"),Xt=function rationalApproximation(e){var t=[2.515517,.802853,.010328],i=[1.432788,.189269,.001308];return e-((t[2]*e+t[1])*e+t[0])/(((i[2]*e+i[1])*e+i[0])*e+1)},jt=function normcdfInv(e){return e<.5?-Xt(Math.sqrt(-2*Math.log(e))):Xt(Math.sqrt(-2*Math.log(1-e)))};qt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=jt(i[0])})),$e.normcdfInv=qt;var Ht=new Ze("clamp");Ht.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.max(Math.min(i[0],i[2]),i[1])})),$e.clamp=Ht;var Wt=new Ze("smoothstep");Wt.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){var n=Math.max(Math.min(i[0],i[2]),i[1]);r[0]=n*n*(3-2*n)})),$e.smoothstep=Wt;var Qt=new Ze("random");Qt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.random()*(i[1]-i[0])+i[0]})),Qt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),Qt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),Qt.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),$e.random=Qt;var Yt=new Ze("vrand");Yt.addSignature([],[Xe.Vec2],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=Math.sqrt(n*n+o*o);r[0].set(n/a,o/a)})),Yt.addSignature([],[Xe.Vec3],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=jt(Math.random()),s=Math.sqrt(n*n+o*o+a*a);r[0].set(n/s,o/s,a/s)})),Yt.addSignature([],[Xe.Vec4],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=jt(Math.random()),s=jt(Math.random()),l=Math.sqrt(n*n+o*o+a*a+s*s);r[0].set(n/l,o/l,a/l,s/l)})),$e.vrand=Yt;var Zt=new Ze("bsdf");Zt.addSignature([Xe.Vec3,Xe.Vec3,Xe.Vec3,Xe.Number],[],(function(e,t,i,r){})),$e.bsdf=Zt;var Kt=new Set(["output","particleProperty","graphProperty","emit"]),$t=function(){function NodeGraph(e){_classCallCheck(this,NodeGraph),_defineProperty(this,"uuid",void 0),_defineProperty(this,"name",void 0),_defineProperty(this,"version",void 0),_defineProperty(this,"revision",void 0),_defineProperty(this,"inputNodes",[]),_defineProperty(this,"outputNodes",[]),_defineProperty(this,"allNodes",new Map),_defineProperty(this,"wires",[]),_defineProperty(this,"compiled",!1),_defineProperty(this,"nodesInOrder",[]),this.version="1.0",this.uuid=t.MathUtils.generateUUID(),this.name=e,this.revision=0}return _createClass(NodeGraph,[{key:"addWire",value:function addWire(e){this.wires.push(e),this.revision++}},{key:"addNode",value:function addNode(e){this.allNodes.set(e.id,e),e.type===$e.input?this.inputNodes.push(e):Kt.has(e.type.name)&&this.outputNodes.push(e),this.revision++}},{key:"getNode",value:function getNode(e){return this.allNodes.get(e)}},{key:"deleteNode",value:function deleteNode(e){this.allNodes.delete(e.id),this.revision++}},{key:"deleteWire",value:function deleteWire(e){var t=e.input.outputs[e.inputIndex].indexOf(e);-1!==t&&e.input.outputs[e.inputIndex].splice(t,1),e.output.inputs[e.outputIndex]=void 0,-1!=(t=this.wires.indexOf(e))&&(this.wires[t]=this.wires[this.wires.length-1],this.wires.pop()),this.revision++}},{key:"toJSON",value:function toJSON(){throw new Error("not implemented")}},{key:"clone",value:function clone(){throw new Error("not implemented")}}]),NodeGraph}();new t.Vector3(0,0,1);var ei=new t.Quaternion,ti=new t.Vector3,ii=new t.Vector3,ri=new t.PlaneGeometry(1,1,1,1),ni=function(){function NodeVFX(e){var r,n,o,a,s,l,u;_classCallCheck(this,NodeVFX),_defineProperty(this,"emissionGraph",void 0),_defineProperty(this,"updateGraph",void 0),_defineProperty(this,"interpreter",void 0),_defineProperty(this,"autoDestroy",void 0),_defineProperty(this,"prewarm",void 0),_defineProperty(this,"looping",void 0),_defineProperty(this,"duration",void 0),_defineProperty(this,"particleNum",void 0),_defineProperty(this,"paused",void 0),_defineProperty(this,"particles",void 0),_defineProperty(this,"emitter",void 0),_defineProperty(this,"rendererSettings",void 0),_defineProperty(this,"neededToUpdateRender",void 0),_defineProperty(this,"rendererEmitterSettings",void 0),_defineProperty(this,"worldSpace",void 0),_defineProperty(this,"prewarmed",void 0),_defineProperty(this,"emissionState",void 0),_defineProperty(this,"emitEnded",void 0),_defineProperty(this,"markForDestroy",void 0),_defineProperty(this,"previousWorldPos",void 0),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"travelDistance",0),_defineProperty(this,"normalMatrix",new t.Matrix3),_defineProperty(this,"_renderer",void 0),_defineProperty(this,"speedFactor",0),this.autoDestroy=void 0!==e.autoDestroy&&e.autoDestroy,this.duration=null!==(r=e.duration)&&void 0!==r?r:1,this.looping=void 0===e.looping||e.looping,this.prewarm=void 0!==e.prewarm&&e.prewarm,this.worldSpace=null!==(n=e.worldSpace)&&void 0!==n&&n,this.rendererEmitterSettings=null!==(o=e.rendererEmitterSettings)&&void 0!==o?o:{},this.emissionGraph=e.emissionGraph,this.updateGraph=e.updateGraph,this.interpreter=new Ye,this.rendererSettings={instancingGeometry:null!==(a=e.instancingGeometry)&&void 0!==a?a:ri,renderMode:null!==(s=e.renderMode)&&void 0!==s?s:be.BillBoard,renderOrder:null!==(l=e.renderOrder)&&void 0!==l?l:0,material:e.material,layers:null!==(u=e.layers)&&void 0!==u?u:new t.Layers,uTileCount:1,vTileCount:1},this.neededToUpdateRender=!0,this.particles=new Array,this.emitter=new i(this),this.paused=!1,this.particleNum=0,this.emissionState={time:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return _createClass(NodeVFX,[{key:"time",get:function get(){return this.emissionState.time},set:function set(e){this.emissionState.time=e}},{key:"layers",get:function get(){return this.rendererSettings.layers}},{key:"texture",get:function get(){return this.rendererSettings.material.map},set:function set(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function get(){return this.rendererSettings.material},set:function set(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function get(){return this.rendererSettings.instancingGeometry},set:function set(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function get(){return this.rendererSettings.renderMode},set:function set(e){if((this.rendererSettings.renderMode!=be.Trail&&e===be.Trail||this.rendererSettings.renderMode==be.Trail&&e!==be.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==e)switch(e){case be.Trail:this.rendererEmitterSettings={startLength:30,followLocalOrigin:!1};break;case be.Mesh:this.rendererEmitterSettings={geometry:new t.PlaneGeometry(1,1)};break;case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:case be.StretchedBillBoard:this.rendererEmitterSettings={}}this.rendererSettings.renderMode=e,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function get(){return this.rendererSettings.renderOrder},set:function set(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function get(){return this.rendererSettings.material.blending},set:function set(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function pause(){this.paused=!0}},{key:"play",value:function play(){this.paused=!1}},{key:"spawn",value:function spawn(e,i){ei.setFromRotationMatrix(i);var r=ti,n=ei,a=ii;for(i.decompose(r,n,a),this.particleNum++;this.particles.length<this.particleNum;)this.particles.push(new o);var s=this.particles[this.particleNum-1];if(s.reset(),this.interpreter.run(this.updateGraph,{particle:s,emissionState:this.emissionState}),this.rendererSettings.renderMode===be.Trail&&this.rendererEmitterSettings.followLocalOrigin){var l=s;l.localPosition=(new t.Vector3).copy(l.position)}this.worldSpace&&(s.position.applyMatrix4(i),s.size*=(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z))/3,s.velocity.multiply(a).applyMatrix3(this.normalMatrix),s.rotation&&s.rotation instanceof t.Quaternion&&s.rotation.multiplyQuaternions(ei,s.rotation))}},{key:"endEmit",value:function endEmit(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function dispose(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function restart(){this.paused=!1,this.particleNum=0,this.emissionState.time=0,this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function update(e){if(!this.paused){for(var t=this.emitter;t.parent;)t=t.parent;if("Scene"===t.type)if(this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var i=0;i<60*this.duration;i++)this.update(1/60)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.emit(e,this.emissionState,this.emitter.matrixWorld);for(var r={particle:void 0,emissionState:this.emissionState,delta:e},n=0;n<this.particleNum;n++)r.particle=this.particles[n],this.interpreter.run(this.updateGraph,r);for(var o=0;o<this.particleNum;o++)this.rendererEmitterSettings.followLocalOrigin&&this.particles[o].localPosition?(this.particles[o].position.copy(this.particles[o].localPosition),this.particles[o].parentMatrix?this.particles[o].position.applyMatrix4(this.particles[o].parentMatrix):this.particles[o].position.applyMatrix4(this.emitter.matrixWorld)):this.particles[o].position.addScaledVector(this.particles[o].velocity,e),this.particles[o].age+=e;if(this.rendererSettings.renderMode===be.Trail)for(var a=0;a<this.particleNum;a++)this.particles[a].update();for(var s=0;s<this.particleNum;s++){var u=this.particles[s];!u.died||u instanceof l&&0!==u.previous.length||(this.particles[s]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=u,this.particleNum--,s--)}}else this.dispose()}}},{key:"emit",value:function emit(e,i,r){var n=this;i.time>this.duration&&(this.looping?i.time-=this.duration:this.emitEnded||this.endEmit()),this.normalMatrix.getNormalMatrix(r);var o={signal:function signal(){n.spawn(i,r)},emissionState:i,delta:e};this.emitEnded||this.interpreter.run(this.emissionGraph,o),void 0===this.previousWorldPos&&(this.previousWorldPos=new t.Vector3),this.emitter.getWorldPosition(this.previousWorldPos),i.time+=e}},{key:"toJSON",value:function toJSON(e){return{}}},{key:"getRendererSettings",value:function getRendererSettings(){return this.rendererSettings}},{key:"clone",value:function clone(){return this}}]),NodeVFX}();console.log("%c Particle system powered by three.quarks. https://quarks.art/","font-size: 16px; font-weight: bold;"),e.ApplyCollision=ue,e.ApplyForce=R,e.ApplySequences=le,e.AxisAngleGenerator=k,e.BatchedParticleRenderer=Ge,e.BatchedRenderer=Ie,e.BehaviorFromJSON=BehaviorFromJSON,e.BehaviorTypes=pe,e.Bezier=u,e.ChangeEmitDirection=G,e.CircleEmitter=ye,e.ColorBySpeed=ce,e.ColorGeneratorFromJSON=ColorGeneratorFromJSON,e.ColorOverLife=C,e.ColorRange=m,e.ConeEmitter=me,e.ConstantColor=w,e.ConstantValue=O,e.DonutEmitter=ve,e.EmitSubParticleSystem=j,e.EmitterFromJSON=EmitterFromJSON,e.EmitterShapes=xe,e.EulerGenerator=M,e.ForceOverLife=E,e.FrameOverLife=J,e.GeneratorFromJSON=GeneratorFromJSON,e.Gradient=g,e.GraphNodeType=Ke,e.GravityForce=I,e.GridEmitter=we,e.HemisphereEmitter=_e,e.Interpreter=Ye,e.IntervalValue=x,e.LimitSpeedOverLife=fe,e.MeshSurfaceEmitter=Oe,e.Node=He,e.NodeGraph=$t,e.NodeParticle=o,e.NodeType=Ze,e.NodeTypes=$e,e.NodeVFX=ni,e.NodeValueType=Xe,e.Noise=oe,e.OrbitOverLife=L,e.OutputNodeTypeNames=Kt,e.ParticleEmitter=i,e.ParticleSystem=Be,e.PiecewiseBezier=N,e.PiecewiseFunction=b,e.Plugins=qe,e.PointEmitter=ge,e.QuarksLoader=De,e.RandomColor=p,e.RandomColorBetweenGradient=_,e.RandomQuatGenerator=P,e.RecordState=s,e.RenderMode=be,e.Rotation3DOverLife=T,e.RotationBySpeed=he,e.RotationGeneratorFromJSON=RotationGeneratorFromJSON,e.RotationOverLife=V,e.SequencerFromJSON=SequencerFromJSON,e.SizeBySpeed=de,e.SizeOverLife=z,e.SpeedOverLife=A,e.SphereEmitter=Se,e.SpriteBatch=Ue,e.SpriteParticle=a,e.SubParticleEmitMode=X,e.TextureSequencer=ae,e.TrailBatch=Fe,e.TrailParticle=l,e.TurbulenceField=te,e.VFXBatch=Ne,e.ValueGeneratorFromJSON=ValueGeneratorFromJSON,e.WidthOverLength=U,e.Wire=We,e.genDefaultForNodeValueType=je,e.getPhysicsResolver=getPhysicsResolver,e.loadPlugin=function loadPlugin(e){if(!qe.find((function(t){return t.id===e.id}))){e.initialize();var t,i=_createForOfIteratorHelper(e.emitterShapes);try{for(i.s();!(t=i.n()).done;){var r=t.value;xe[r.type]||(xe[r.type]=r)}}catch(e){i.e(e)}finally{i.f()}var n,o=_createForOfIteratorHelper(e.behaviors);try{for(o.s();!(n=o.n()).done;){var a=n.value;pe[a.type]||(pe[a.type]=a)}}catch(e){o.e(e)}finally{o.f()}}},e.setPhysicsResolver=function setPhysicsResolver(e){se=e},e.unloadPlugin=function unloadPlugin(e){var t=qe.find((function(t){return t.id===e}));if(t){var i,r=_createForOfIteratorHelper(t.emitterShapes);try{for(r.s();!(i=r.n()).done;){var n=i.value;xe[n.type]&&delete xe[n.type]}}catch(e){r.e(e)}finally{r.f()}var o,a=_createForOfIteratorHelper(t.behaviors);try{for(a.s();!(o=a.n()).done;){var s=o.value;pe[s.type]&&delete pe[s.type]}}catch(e){a.e(e)}finally{a.f()}}}},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).THREE=e.THREE||{},e.THREE.QUARKS={}),e.THREE);
+var e,t;e=void 0,t=function(e,t){function _regeneratorRuntime(){_regeneratorRuntime=function(){return t};var e,t={},i=Object.prototype,r=i.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag";function define(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{define({},"")}catch(e){define=function(e,t,i){return e[t]=i}}function wrap(e,t,i,r){var o=t&&t.prototype instanceof Generator?t:Generator,a=Object.create(o.prototype),s=new Context(r||[]);return n(a,"_invoke",{value:makeInvokeMethod(e,i,s)}),a}function tryCatch(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}t.wrap=wrap;var u="suspendedStart",c="suspendedYield",d="executing",h="completed",f={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(values([])));y&&y!==i&&r.call(y,a)&&(p=y);var v=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(e){["next","throw","return"].forEach((function(t){define(e,t,(function(e){return this._invoke(t,e)}))}))}function AsyncIterator(e,t){function invoke(i,n,o,a){var s=tryCatch(e[i],e,n);if("throw"!==s.type){var l=s.arg,u=l.value;return u&&"object"==typeof u&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){invoke("next",e,o,a)}),(function(e){invoke("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return invoke("throw",e,o,a)}))}a(s.arg)}var i;n(this,"_invoke",{value:function(e,r){function callInvokeWithMethodAndArg(){return new t((function(t,i){invoke(e,r,t,i)}))}return i=i?i.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(t,i,r){var n=u;return function(o,a){if(n===d)throw new Error("Generator is already running");if(n===h){if("throw"===o)throw a;return{value:e,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var l=maybeInvokeDelegate(s,r);if(l){if(l===f)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===u)throw n=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=d;var p=tryCatch(t,i,r);if("normal"===p.type){if(n=r.done?h:c,p.arg===f)continue;return{value:p.arg,done:r.done}}"throw"===p.type&&(n=h,r.method="throw",r.arg=p.arg)}}}function maybeInvokeDelegate(t,i){var r=i.method,n=t.iterator[r];if(n===e)return i.delegate=null,"throw"===r&&t.iterator.return&&(i.method="return",i.arg=e,maybeInvokeDelegate(t,i),"throw"===i.method)||"return"!==r&&(i.method="throw",i.arg=new TypeError("The iterator does not provide a '"+r+"' method")),f;var o=tryCatch(n,t.iterator,i.arg);if("throw"===o.type)return i.method="throw",i.arg=o.arg,i.delegate=null,f;var a=o.arg;return a?a.done?(i[t.resultName]=a.value,i.next=t.nextLoc,"return"!==i.method&&(i.method="next",i.arg=e),i.delegate=null,f):a:(i.method="throw",i.arg=new TypeError("iterator result is not an object"),i.delegate=null,f)}function pushTryEntry(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function resetTryEntry(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function Context(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t||""===t){var i=t[a];if(i)return i.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,o=function next(){for(;++n<t.length;)if(r.call(t,n))return next.value=t[n],next.done=!1,next;return next.value=e,next.done=!0,next};return o.next=o}}throw new TypeError(typeof t+" is not iterable")}return GeneratorFunction.prototype=GeneratorFunctionPrototype,n(v,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),n(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===GeneratorFunction||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,GeneratorFunctionPrototype):(e.__proto__=GeneratorFunctionPrototype,define(e,l,"GeneratorFunction")),e.prototype=Object.create(v),e},t.awrap=function(e){return{__await:e}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,s,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(e,i,r,n,o){void 0===o&&(o=Promise);var a=new AsyncIterator(wrap(e,i,r,n),o);return t.isGeneratorFunction(i)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},defineIteratorMethods(v),define(v,l,"Generator"),define(v,a,(function(){return this})),define(v,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),i=[];for(var r in t)i.push(r);return i.reverse(),function next(){for(;i.length;){var e=i.pop();if(e in t)return next.value=e,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(resetTryEntry),!t)for(var i in this)"t"===i.charAt(0)&&r.call(this,i)&&!isNaN(+i.slice(1))&&(this[i]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var i=this;function handle(r,n){return a.type="throw",a.arg=t,i.next=r,n&&(i.method="next",i.arg=e),!!n}for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n],a=o.completion;if("root"===o.tryLoc)return handle("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(s&&l){if(this.prev<o.catchLoc)return handle(o.catchLoc,!0);if(this.prev<o.finallyLoc)return handle(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return handle(o.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return handle(o.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&r.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),resetTryEntry(i),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var n=r.arg;resetTryEntry(i)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(t,i,r){return this.delegate={iterator:values(t),resultName:i,nextLoc:r},"next"===this.method&&(this.arg=e),f}},t}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _createSuper(e){var t=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var i,r=_getPrototypeOf(e);if(t){var n=_getPrototypeOf(this).constructor;i=Reflect.construct(r,arguments,n)}else i=r.apply(this,arguments);return function _possibleConstructorReturn(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}(this,i)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(e,t,i){var r=function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(arguments.length<3?e:i):n.value}},_get.apply(this,arguments)}function _slicedToArray(e,t){return function _arrayWithHoles(e){if(Array.isArray(e))return e}(e)||function _iterableToArrayLimit(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var r,n,o,a,s=[],l=!0,u=!1;try{if(o=(i=i.call(e)).next,0===t){if(Object(i)!==i)return;l=!1}else for(;!(l=(r=o.call(i)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){u=!0,n=e}finally{try{if(!l&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(u)throw n}}return s}}(e,t)||_unsupportedIterableToArray(e,t)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function _createForOfIteratorHelper(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0,F=function(){};return{s:F,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,a=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){a=!0,n=e},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw n}}}}function _toPropertyKey(e){var t=function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}var i=function(e){_inherits(ParticleEmitter,e);var t=_createSuper(ParticleEmitter);function ParticleEmitter(e){var i;return _classCallCheck(this,ParticleEmitter),_defineProperty(_assertThisInitialized(i=t.call(this)),"type","ParticleEmitter"),_defineProperty(_assertThisInitialized(i),"system",void 0),i.system=e,i}return _createClass(ParticleEmitter,[{key:"clone",value:function clone(){var e=this.system.clone();return e.emitter.copy(this,!0),e.emitter}},{key:"dispose",value:function dispose(){}},{key:"extractFromCache",value:function extractFromCache(e){var t=[];for(var i in e){var r=e[i];delete r.metadata,t.push(r)}return t}},{key:"toJSON",value:function toJSON(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=void 0===e||"string"==typeof e,r={};i&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var n={};if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),null!==this.system&&(n.ps=this.system.toJSON(e,t)),this.children.length>0){n.children=[];for(var o=0;o<this.children.length;o++)"ParticleSystemPreview"!==this.children[o].type&&n.children.push(this.children[o].toJSON(e).object)}if(i){var a=this.extractFromCache(e.geometries),s=this.extractFromCache(e.materials),l=this.extractFromCache(e.textures),u=this.extractFromCache(e.images);a.length>0&&(r.geometries=a),s.length>0&&(r.materials=s),l.length>0&&(r.textures=l),u.length>0&&(r.images=u)}return r.object=n,r}}]),ParticleEmitter}(t.Object3D),r=function(){function LinkedListNode(e){_classCallCheck(this,LinkedListNode),_defineProperty(this,"data",void 0),_defineProperty(this,"next",void 0),_defineProperty(this,"prev",void 0),this.data=e,this.next=null,this.prev=null}return _createClass(LinkedListNode,[{key:"hasPrev",value:function hasPrev(){return null!==this.prev}},{key:"hasNext",value:function hasNext(){return null!==this.next}}]),LinkedListNode}(),n=function(){function LinkedList(){_classCallCheck(this,LinkedList),_defineProperty(this,"length",void 0),_defineProperty(this,"head",void 0),_defineProperty(this,"tail",void 0),this.length=0,this.head=this.tail=null}return _createClass(LinkedList,[{key:"isEmpty",value:function isEmpty(){return null===this.head}},{key:"clear",value:function clear(){this.length=0,this.head=this.tail=null}},{key:"front",value:function front(){return null===this.head?null:this.head.data}},{key:"back",value:function back(){return null===this.tail?null:this.tail.data}},{key:"dequeue",value:function dequeue(){if(this.head){var e=this.head.data;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}}},{key:"pop",value:function pop(){if(this.tail){var e=this.tail.data;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}}},{key:"queue",value:function queue(e){var t=new r(e);this.tail||(this.tail=t),this.head&&(this.head.prev=t,t.next=this.head),this.head=t,this.length++}},{key:"push",value:function push(e){var t=new r(e);this.head||(this.head=t),this.tail&&(this.tail.next=t,t.prev=this.tail),this.tail=t,this.length++}},{key:"insertBefore",value:function insertBefore(e,t){var i=new r(t);i.next=e,i.prev=e.prev,null!==i.prev&&(i.prev.next=i),i.next.prev=i,e==this.head&&(this.head=i),this.length++}},{key:"remove",value:function remove(e){if(null!==this.head&&null!==this.tail){var t=this.head;for(e===this.head.data&&(this.head=this.head.next),e===this.tail.data&&(this.tail=this.tail.prev);null!==t.next&&t.data!==e;)t=t.next;t.data===e&&(null!==t.prev&&(t.prev.next=t.next),null!==t.next&&(t.next.prev=t.prev),this.length--)}}},{key:"values",value:_regeneratorRuntime().mark((function values(){var e;return _regeneratorRuntime().wrap((function values$(t){for(;;)switch(t.prev=t.next){case 0:e=this.head;case 1:if(null===e){t.next=7;break}return t.next=4,e.data;case 4:e=e.next,t.next=1;break;case 7:case"end":return t.stop()}}),values,this)}))}]),LinkedList}(),o=function(){function NodeParticle(){_classCallCheck(this,NodeParticle),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"angularVelocity",void 0),_defineProperty(this,"rotation",0),_defineProperty(this,"color",new t.Vector4(1,1,1,1)),_defineProperty(this,"uvTile",0)}return _createClass(NodeParticle,[{key:"died",get:function get(){return this.age>=this.life}},{key:"reset",value:function reset(){this.position.set(0,0,0),this.velocity.set(0,0,0),this.age=0,this.life=1,this.size=1,this.rotation=0,this.color.set(1,1,1,1),this.uvTile=0}}]),NodeParticle}(),a=function(){function SpriteParticle(){_classCallCheck(this,SpriteParticle),_defineProperty(this,"parentMatrix",void 0),_defineProperty(this,"startSpeed",0),_defineProperty(this,"startColor",new t.Vector4),_defineProperty(this,"startSize",1),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"angularVelocity",void 0),_defineProperty(this,"rotation",0),_defineProperty(this,"color",new t.Vector4),_defineProperty(this,"uvTile",0)}return _createClass(SpriteParticle,[{key:"died",get:function get(){return this.age>=this.life}}]),SpriteParticle}(),s=_createClass((function RecordState(e,t,i){_classCallCheck(this,RecordState),this.position=e,this.size=t,this.color=i})),l=function(){function TrailParticle(){_classCallCheck(this,TrailParticle),_defineProperty(this,"parentMatrix",void 0),_defineProperty(this,"startSpeed",0),_defineProperty(this,"startColor",new t.Vector4),_defineProperty(this,"startSize",1),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"localPosition",void 0),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"length",100),_defineProperty(this,"color",new t.Vector4),_defineProperty(this,"previous",new n),_defineProperty(this,"uvTile",0)}return _createClass(TrailParticle,[{key:"update",value:function update(){for(this.age<=this.life?this.previous.push(new s(this.position.clone(),this.size,this.color.clone())):this.previous.length>0&&this.previous.dequeue();this.previous.length>this.length;)this.previous.dequeue()}},{key:"died",get:function get(){return this.age>=this.life}},{key:"reset",value:function reset(){this.previous.clear()}}]),TrailParticle}(),u=function(){function Bezier(e,t,i,r){_classCallCheck(this,Bezier),_defineProperty(this,"p",void 0),this.p=[e,t,i,r]}return _createClass(Bezier,[{key:"genValue",value:function genValue(e){var t=e*e,i=e*e*e,r=1-e,n=r*r,o=n*r;return this.p[0]*o+this.p[1]*n*e*3+this.p[2]*r*t*3+this.p[3]*i}},{key:"derivativeCoefficients",value:function derivativeCoefficients(e){for(var t=[],i=e,r=i.length-1;r>0;r--){for(var n=[],o=0;o<r;o++){var a=r*(i[o+1]-i[o]);n.push(a)}t.push(n),i=n}return t}},{key:"getSlope",value:function getSlope(e){var t=this.derivativeCoefficients(this.p)[0],i=1-e,r=i*e*2,n=e*e;return i*i*t[0]+r*t[1]+n*t[2]}},{key:"controlCurve",value:function controlCurve(e,t){this.p[1]=e/3+this.p[0],this.p[2]=this.p[3]-t/3}},{key:"hull",value:function hull(e){var t,i=this.p,r=[],n=0,o=0,a=0,s=[];for(s[n++]=i[0],s[n++]=i[1],s[n++]=i[2],s[n++]=i[3];i.length>1;){for(r=[],o=0,a=i.length-1;o<a;o++)t=e*i[o]+(1-e)*i[o+1],s[n++]=t,r.push(t);i=r}return s}},{key:"split",value:function split(e){var t=this.hull(e);return{left:new Bezier(t[0],t[4],t[7],t[9]),right:new Bezier(t[9],t[8],t[6],t[3]),span:t}}},{key:"clone",value:function clone(){return new Bezier(this.p[0],this.p[1],this.p[2],this.p[3])}},{key:"toJSON",value:function toJSON(){return{p0:this.p[0],p1:this.p[1],p2:this.p[2],p3:this.p[3]}}}],[{key:"fromJSON",value:function fromJSON(e){return new Bezier(e.p0,e.p1,e.p2,e.p3)}}]),Bezier}(),c=function ColorToJSON(e){return{r:e.x,g:e.y,b:e.z,a:e.w}},d=function JSONToColor(e){return new t.Vector4(e.r,e.g,e.b,e.a)},h=function JSONToValue(e,i){switch(i){case"Vector3":return new t.Vector3(e.x,e.y,e.z);case"Vector4":return new t.Vector4(e.x,e.y,e.z,e.w);case"Color":return new t.Vector3(e.r,e.g,e.b);default:return e}},f=function ValueToJSON(e,t){switch(t){case"Vector3":return{x:e.x,y:e.y,z:e.z};case"Vector4":return{x:e.x,y:e.y,z:e.z,w:e.w};case"Color":return{r:e.x,g:e.y,b:e.z};default:return e}},p=function(){function RandomColor(e,t){_classCallCheck(this,RandomColor),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="value"}return _createClass(RandomColor,[{key:"genColor",value:function genColor(e){var t=Math.random();return e.copy(this.a).lerp(this.b,t)}},{key:"toJSON",value:function toJSON(){return{type:"RandomColor",a:c(this.a),b:c(this.b)}}},{key:"clone",value:function clone(){return new RandomColor(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomColor(d(e.a),d(e.b))}}]),RandomColor}(),m=function(){function ColorRange(e,t){_classCallCheck(this,ColorRange),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="value"}return _createClass(ColorRange,[{key:"genColor",value:function genColor(e,t){return e.copy(this.a).lerp(this.b,Math.random())}},{key:"toJSON",value:function toJSON(){return{type:"ColorRange",a:c(this.a),b:c(this.b)}}},{key:"clone",value:function clone(){return new ColorRange(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorRange(d(e.a),d(e.b))}}]),ColorRange}(),y=function(){function ContinuousLinearFunction(e,t){_classCallCheck(this,ContinuousLinearFunction),_defineProperty(this,"keys",void 0),_defineProperty(this,"type",void 0),_defineProperty(this,"subType",void 0),this.subType=t,this.type="function",this.keys=e}return _createClass(ContinuousLinearFunction,[{key:"findKey",value:function findKey(e){for(var t=0,i=0,r=this.keys.length-1;i+1<r;)if(t=Math.floor((i+r)/2),e<this.getStartX(t))r=t-1;else{if(!(e>this.getEndX(t)))return t;i=t+1}for(var n=i;n<=r;n++)if(e>=this.getStartX(n)&&e<=this.getEndX(n))return n;return-1}},{key:"getStartX",value:function getStartX(e){return this.keys[e][1]}},{key:"getEndX",value:function getEndX(e){return e+1<this.keys.length?this.keys[e+1][1]:1}},{key:"genValue",value:function genValue(e,t){var i=this.findKey(t);return"Number"===this.subType?-1===i?this.keys[0][0]:i+1>=this.keys.length?this.keys[this.keys.length-1][0]:(this.keys[i+1][0]-this.keys[i][0])*((t-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))+this.keys[i][0]:-1===i?e.copy(this.keys[0][0]):i+1>=this.keys.length?e.copy(this.keys[this.keys.length-1][0]):e.copy(this.keys[i][0]).lerp(this.keys[i+1][0],(t-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))}},{key:"toJSON",value:function toJSON(){var e=this;return this.keys[0][0].constructor.name,{type:"CLinearFunction",subType:this.subType,keys:this.keys.map((function(t){var i=_slicedToArray(t,2),r=i[0],n=i[1];return{value:f(r,e.subType),pos:n}}))}}},{key:"clone",value:function clone(){return"Number"===this.subType?new ContinuousLinearFunction(this.keys.map((function(e){var t=_slicedToArray(e,2);return[t[0],t[1]]})),this.subType):new ContinuousLinearFunction(this.keys.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return[i.clone(),r]})),this.subType)}}],[{key:"fromJSON",value:function fromJSON(e){return new ContinuousLinearFunction(e.keys.map((function(t){return[h(t.value,e.subType),t.pos]})),e.subType)}}]),ContinuousLinearFunction}(),v=new t.Vector3,g=function(){function Gradient(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new t.Vector3(0,0,0),0],[new t.Vector3(1,1,1),0]],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[[1,0],[1,1]];_classCallCheck(this,Gradient),_defineProperty(this,"type",void 0),_defineProperty(this,"color",void 0),_defineProperty(this,"alpha",void 0),this.type="function",this.color=new y(e,"Color"),this.alpha=new y(i,"Number")}return _createClass(Gradient,[{key:"genColor",value:function genColor(e,t){return this.color.genValue(v,t),e.set(v.x,v.y,v.z,this.alpha.genValue(1,t))}},{key:"toJSON",value:function toJSON(){return{type:"Gradient",color:this.color.toJSON(),alpha:this.alpha.toJSON()}}},{key:"clone",value:function clone(){var e=new Gradient;return e.alpha=this.alpha.clone(),e.color=this.color.clone(),e}}],[{key:"fromJSON",value:function fromJSON(e){if(e.functions){var i=e.functions.map((function(e){return[m.fromJSON(e.function).a,e.start]}));return e.functions.length>0&&i.push([m.fromJSON(e.functions[e.functions.length-1].function).b,1]),new Gradient(i.map((function(e){return[new t.Vector3(e[0].x,e[0].y,e[0].z),e[1]]})),i.map((function(e){return[e[0].w,e[1]]})))}var r=new Gradient;return r.alpha=y.fromJSON(e.alpha),r.color=y.fromJSON(e.color),r}}]),Gradient}(),S=new t.Vector4,_=function(){function RandomColorBetweenGradient(e,t){_classCallCheck(this,RandomColorBetweenGradient),_defineProperty(this,"gradient1",void 0),_defineProperty(this,"gradient2",void 0),_defineProperty(this,"type",void 0),this.type="memorizedFunction",this.gradient1=e,this.gradient2=t}return _createClass(RandomColorBetweenGradient,[{key:"startGen",value:function startGen(e){e.rand=Math.random()}},{key:"genColor",value:function genColor(e,t,i){return this.gradient1.genColor(e,t),this.gradient2.genColor(S,t),i&&i.rand?e.lerp(S,i.rand):e.lerp(S,Math.random()),e}},{key:"toJSON",value:function toJSON(){return{type:"RandomColorBetweenGradient",gradient1:this.gradient1.toJSON(),gradient2:this.gradient2.toJSON()}}},{key:"clone",value:function clone(){return new RandomColorBetweenGradient(this.gradient1.clone(),this.gradient2.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomColorBetweenGradient(g.fromJSON(e.gradient1),g.fromJSON(e.gradient2))}}]),RandomColorBetweenGradient}(),w=function(){function ConstantColor(e){_classCallCheck(this,ConstantColor),_defineProperty(this,"type",void 0),this.color=e,this.type="value"}return _createClass(ConstantColor,[{key:"genColor",value:function genColor(e){return e.copy(this.color)}},{key:"toJSON",value:function toJSON(){return{type:"ConstantColor",color:c(this.color)}}},{key:"clone",value:function clone(){return new ConstantColor(this.color.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ConstantColor(d(e.color))}}]),ConstantColor}();function ColorGeneratorFromJSON(e){switch(e.type){case"ConstantColor":return w.fromJSON(e);case"ColorRange":return m.fromJSON(e);case"RandomColor":return p.fromJSON(e);case"Gradient":return g.fromJSON(e);case"RandomColorBetweenGradient":return _.fromJSON(e);default:return new w(new t.Vector4(1,1,1,1))}}var O=function(){function ConstantValue(e){_classCallCheck(this,ConstantValue),_defineProperty(this,"type",void 0),this.value=e,this.type="value"}return _createClass(ConstantValue,[{key:"genValue",value:function genValue(){return this.value}},{key:"toJSON",value:function toJSON(){return{type:"ConstantValue",value:this.value}}},{key:"clone",value:function clone(){return new ConstantValue(this.value)}}],[{key:"fromJSON",value:function fromJSON(e){return new ConstantValue(e.value)}}]),ConstantValue}(),x=function(){function IntervalValue(e,t){_classCallCheck(this,IntervalValue),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="value"}return _createClass(IntervalValue,[{key:"genValue",value:function genValue(){return t.MathUtils.lerp(this.a,this.b,Math.random())}},{key:"toJSON",value:function toJSON(){return{type:"IntervalValue",a:this.a,b:this.b}}},{key:"clone",value:function clone(){return new IntervalValue(this.a,this.b)}}],[{key:"fromJSON",value:function fromJSON(e){return new IntervalValue(e.a,e.b)}}]),IntervalValue}(),b=function(){function PiecewiseFunction(){_classCallCheck(this,PiecewiseFunction),_defineProperty(this,"functions",void 0),this.functions=new Array}return _createClass(PiecewiseFunction,[{key:"findFunction",value:function findFunction(e){for(var t=0,i=0,r=this.functions.length-1;i+1<r;)if(t=Math.floor((i+r)/2),e<this.getStartX(t))r=t-1;else{if(!(e>this.getEndX(t)))return t;i=t+1}for(var n=i;n<=r;n++)if(e>=this.functions[n][1]&&e<=this.getEndX(n))return n;return-1}},{key:"getStartX",value:function getStartX(e){return this.functions[e][1]}},{key:"setStartX",value:function setStartX(e,t){e>0&&(this.functions[e][1]=t)}},{key:"getEndX",value:function getEndX(e){return e+1<this.functions.length?this.functions[e+1][1]:1}},{key:"setEndX",value:function setEndX(e,t){e+1<this.functions.length&&(this.functions[e+1][1]=t)}},{key:"insertFunction",value:function insertFunction(e,t){var i=this.findFunction(e);this.functions.splice(i+1,0,[t,e])}},{key:"removeFunction",value:function removeFunction(e){return this.functions.splice(e,1)[0][0]}},{key:"getFunction",value:function getFunction(e){return this.functions[e][0]}},{key:"setFunction",value:function setFunction(e,t){this.functions[e][0]=t}},{key:"numOfFunctions",get:function get(){return this.functions.length}}]),PiecewiseFunction}(),N=function(e){_inherits(PiecewiseBezier,e);var t=_createSuper(PiecewiseBezier);function PiecewiseBezier(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new u(0,1/3,1/3*2,1),0]];return _classCallCheck(this,PiecewiseBezier),_defineProperty(_assertThisInitialized(e=t.call(this)),"type",void 0),e.type="function",e.functions=i,e}return _createClass(PiecewiseBezier,[{key:"genValue",value:function genValue(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this.findFunction(e);return-1===t?0:this.functions[t][0].genValue((e-this.getStartX(t))/(this.getEndX(t)-this.getStartX(t)))}},{key:"toSVG",value:function toSVG(e,t){if(t<1)return"";for(var i=["M",0,this.functions[0][0].p[0]].join(" "),r=1/t;r<=1;r+=1/t)i=[i,"L",r*e,this.genValue(r)].join(" ");return i}},{key:"toJSON",value:function toJSON(){return{type:"PiecewiseBezier",functions:this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return{function:i.toJSON(),start:r}}))}}},{key:"clone",value:function clone(){return new PiecewiseBezier(this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return[i.clone(),r]})))}}],[{key:"fromJSON",value:function fromJSON(e){return new PiecewiseBezier(e.functions.map((function(e){return[u.fromJSON(e.function),e.start]})))}}]),PiecewiseBezier}(b);function ValueGeneratorFromJSON(e){switch(e.type){case"ConstantValue":return O.fromJSON(e);case"IntervalValue":return x.fromJSON(e);case"PiecewiseBezier":return N.fromJSON(e);default:return new O(0)}}var P=function(){function RandomQuatGenerator(){_classCallCheck(this,RandomQuatGenerator),_defineProperty(this,"type",void 0),this.type="rotation"}return _createClass(RandomQuatGenerator,[{key:"genValue",value:function genValue(e,t){var i,r,n,o,a,s;do{n=(i=2*Math.random()-1)*i+(r=2*Math.random()-1)*r}while(n>1);do{s=(o=2*Math.random()-1)*o+(a=2*Math.random()-1)*a}while(s>1);var l=Math.sqrt((1-n)/s);return e.set(i,r,l*o,l*a),e}},{key:"toJSON",value:function toJSON(){return{type:"RandomQuat"}}},{key:"clone",value:function clone(){return new RandomQuatGenerator}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomQuatGenerator}}]),RandomQuatGenerator}(),k=function(){function AxisAngleGenerator(e,t){_classCallCheck(this,AxisAngleGenerator),_defineProperty(this,"type",void 0),this.axis=e,this.angle=t,this.type="rotation"}return _createClass(AxisAngleGenerator,[{key:"genValue",value:function genValue(e,t){return e.setFromAxisAngle(this.axis,this.angle.genValue(t))}},{key:"toJSON",value:function toJSON(){return{type:"AxisAngle",axis:{x:this.axis.x,y:this.axis.y,z:this.axis.z},angle:this.angle.toJSON()}}},{key:"clone",value:function clone(){return new AxisAngleGenerator(this.axis.clone(),this.angle.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new AxisAngleGenerator(new t.Vector3(e.axis.x,e.axis.y,e.axis.z),ValueGeneratorFromJSON(e.angle))}}]),AxisAngleGenerator}(),M=function(){function EulerGenerator(e,i,r,n){_classCallCheck(this,EulerGenerator),_defineProperty(this,"type",void 0),_defineProperty(this,"eular",void 0),this.angleX=e,this.angleY=i,this.angleZ=r,this.type="rotation",this.eular=new t.Euler(0,0,0,n)}return _createClass(EulerGenerator,[{key:"genValue",value:function genValue(e,t){return this.eular.set(this.angleX.genValue(t),this.angleY.genValue(t),this.angleZ.genValue(t)),e.setFromEuler(this.eular)}},{key:"toJSON",value:function toJSON(){return{type:"Euler",angleX:this.angleX.toJSON(),angleY:this.angleY.toJSON(),angleZ:this.angleZ.toJSON(),eulerOrder:this.eular.order}}},{key:"clone",value:function clone(){return new EulerGenerator(this.angleX,this.angleY,this.angleZ,this.eular.order)}}],[{key:"fromJSON",value:function fromJSON(e){return new EulerGenerator(ValueGeneratorFromJSON(e.angleX),ValueGeneratorFromJSON(e.angleY),ValueGeneratorFromJSON(e.angleZ),e.eulerOrder)}}]),EulerGenerator}();function RotationGeneratorFromJSON(e){switch(e.type){case"AxisAngle":return k.fromJSON(e);case"Euler":return M.fromJSON(e);case"RandomQuat":return P.fromJSON(e);default:return new P}}function GeneratorFromJSON(e){switch(e.type){case"ConstantValue":case"IntervalValue":case"PiecewiseBezier":return ValueGeneratorFromJSON(e);case"AxisAngle":case"RandomQuat":case"Euler":return RotationGeneratorFromJSON(e);default:return new O(0)}}var C=function(){function ColorOverLife(e){_classCallCheck(this,ColorOverLife),_defineProperty(this,"type","ColorOverLife"),this.color=e}return _createClass(ColorOverLife,[{key:"initialize",value:function initialize(e){"memorizedFunction"===this.color.type&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function update(e,t){"memorizedFunction"===this.color.type?this.color.genColor(e.color,e.age/e.life,e.colorOverLifeMemory):this.color.genColor(e.color,e.age/e.life),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,color:this.color.toJSON()}}},{key:"clone",value:function clone(){return new ColorOverLife(this.color.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorOverLife(ColorGeneratorFromJSON(e.color))}}]),ColorOverLife}(),V=function(){function RotationOverLife(e,i){_classCallCheck(this,RotationOverLife),_defineProperty(this,"type","RotationOverLife"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.dynamic=i}return _createClass(RotationOverLife,[{key:"initialize",value:function initialize(e){!this.dynamic&&e instanceof a&&(e.angularVelocity=this.angularVelocity.genValue())}},{key:"update",value:function update(e,t){this.dynamic?e.rotation+=t*this.angularVelocity.genValue(e.age/e.life):e instanceof a&&(e.rotation+=t*e.angularVelocity)}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new RotationOverLife(this.angularVelocity.clone(),this.dynamic)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new RotationOverLife(ValueGeneratorFromJSON(e.angularVelocity),e.dynamic)}}]),RotationOverLife}(),B=new t.Quaternion,T=function(){function Rotation3DOverLife(e,i){_classCallCheck(this,Rotation3DOverLife),_defineProperty(this,"type","Rotation3DOverLife"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.dynamic=i}return _createClass(Rotation3DOverLife,[{key:"initialize",value:function initialize(e){!this.dynamic&&e instanceof a&&(e.angularVelocity=new t.Quaternion,this.angularVelocity.genValue(e.angularVelocity))}},{key:"update",value:function update(e,t){this.dynamic?(this.angularVelocity.genValue(this.tempQuat,e.age/e.life),this.tempQuat.slerpQuaternions(B,this.tempQuat,t),e.rotation.multiply(this.tempQuat)):e instanceof a&&(this.tempQuat.slerpQuaternions(B,e.angularVelocity,t),e.rotation.multiply(this.tempQuat))}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new Rotation3DOverLife(this.angularVelocity.clone(),this.dynamic)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new Rotation3DOverLife(RotationGeneratorFromJSON(e.angularVelocity),e.dynamic)}}]),Rotation3DOverLife}(),E=function(){function ForceOverLife(e,i,r){_classCallCheck(this,ForceOverLife),_defineProperty(this,"type","ForceOverLife"),_defineProperty(this,"_temp",new t.Vector3),this.x=e,this.y=i,this.z=r}return _createClass(ForceOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this._temp.set(this.x.genValue(e.age/e.life),this.y.genValue(e.age/e.life),this.z.genValue(e.age/e.life)),e.velocity.addScaledVector(this._temp,t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,x:this.x.toJSON(),y:this.y.toJSON(),z:this.z.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new ForceOverLife(this.x.clone(),this.y.clone(),this.z.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ForceOverLife(ValueGeneratorFromJSON(e.x),ValueGeneratorFromJSON(e.y),ValueGeneratorFromJSON(e.z))}}]),ForceOverLife}(),z=function(){function SizeOverLife(e){_classCallCheck(this,SizeOverLife),_defineProperty(this,"type","SizeOverLife"),this.size=e}return _createClass(SizeOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){e.size=e.startSize*this.size.genValue(e.age/e.life)}},{key:"toJSON",value:function toJSON(){return{type:this.type,size:this.size.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SizeOverLife(this.size.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SizeOverLife(ValueGeneratorFromJSON(e.size))}}]),SizeOverLife}(),A=function(){function SpeedOverLife(e){_classCallCheck(this,SpeedOverLife),_defineProperty(this,"type","SpeedOverLife"),this.speed=e}return _createClass(SpeedOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){e.speedModifier=this.speed.genValue(e.age/e.life)}},{key:"toJSON",value:function toJSON(){return{type:this.type,speed:this.speed.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SpeedOverLife(this.speed.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SpeedOverLife(ValueGeneratorFromJSON(e.speed))}}]),SpeedOverLife}(),J=function(){function FrameOverLife(e){_classCallCheck(this,FrameOverLife),_defineProperty(this,"type","FrameOverLife"),this.frame=e}return _createClass(FrameOverLife,[{key:"initialize",value:function initialize(e){this.frame instanceof N||(e.uvTile=Math.floor(this.frame.genValue(0)))}},{key:"update",value:function update(e,t){this.frame instanceof N&&(e.uvTile=Math.floor(this.frame.genValue(e.age/e.life)))}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,frame:this.frame.toJSON()}}},{key:"clone",value:function clone(){return new FrameOverLife(this.frame.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new FrameOverLife(ValueGeneratorFromJSON(e.frame))}}]),FrameOverLife}();new t.Vector3(0,0,1);var L=function(){function OrbitOverLife(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new t.Vector3(0,1,0);_classCallCheck(this,OrbitOverLife),_defineProperty(this,"type","OrbitOverLife"),_defineProperty(this,"rotation",void 0),_defineProperty(this,"line",void 0),_defineProperty(this,"temp",new t.Vector3),this.orbitSpeed=e,this.axis=i,this.rotation=new t.Quaternion,this.line=new t.Line3}return _createClass(OrbitOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,i){this.line.set(new t.Vector3(0,0,0),this.axis),this.line.closestPointToPoint(e.position,!1,this.temp),this.rotation.setFromAxisAngle(this.axis,this.orbitSpeed.genValue(e.age/e.life)*i),e.position.sub(this.temp),e.position.applyQuaternion(this.rotation),e.position.add(this.temp)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,orbitSpeed:this.orbitSpeed.toJSON(),axis:[this.axis.x,this.axis.y,this.axis.z]}}},{key:"clone",value:function clone(){return new OrbitOverLife(this.orbitSpeed.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new OrbitOverLife(ValueGeneratorFromJSON(e.orbitSpeed),e.axis?new t.Vector3(e.axis[0],e.axis[1],e.axis[2]):void 0)}}]),OrbitOverLife}(),U=function(){function WidthOverLength(e){_classCallCheck(this,WidthOverLength),_defineProperty(this,"type","WidthOverLength"),this.width=e}return _createClass(WidthOverLength,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){if(e instanceof l)for(var t=e.previous.values(),i=0;i<e.previous.length;i++)t.next().value.size=this.width.genValue((e.previous.length-i)/e.length)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,width:this.width.toJSON()}}},{key:"clone",value:function clone(){return new WidthOverLength(this.width.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new WidthOverLength(ValueGeneratorFromJSON(e.width))}}]),WidthOverLength}(),R=function(){function ApplyForce(e,t){_classCallCheck(this,ApplyForce),_defineProperty(this,"type","ApplyForce"),_defineProperty(this,"magnitudeValue",void 0),this.direction=e,this.magnitude=t,this.magnitudeValue=this.magnitude.genValue()}return _createClass(ApplyForce,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){e.velocity.addScaledVector(this.direction,this.magnitudeValue*t)}},{key:"frameUpdate",value:function frameUpdate(e){this.magnitudeValue=this.magnitude.genValue()}},{key:"toJSON",value:function toJSON(){return{type:this.type,direction:[this.direction.x,this.direction.y,this.direction.z],magnitude:this.magnitude.toJSON()}}},{key:"clone",value:function clone(){return new ApplyForce(this.direction.clone(),this.magnitude.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){var i;return new ApplyForce(new t.Vector3(e.direction[0],e.direction[1],e.direction[2]),ValueGeneratorFromJSON(null!==(i=e.magnitude)&&void 0!==i?i:e.force))}}]),ApplyForce}(),I=function(){function GravityForce(e,i){_classCallCheck(this,GravityForce),_defineProperty(this,"type","GravityForce"),_defineProperty(this,"temp",new t.Vector3),this.center=e,this.magnitude=i}return _createClass(GravityForce,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this.temp.copy(this.center).sub(e.position).normalize(),e.velocity.addScaledVector(this.temp,this.magnitude/e.position.distanceToSquared(this.center)*t)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,center:[this.center.x,this.center.y,this.center.z],magnitude:this.magnitude}}},{key:"clone",value:function clone(){return new GravityForce(this.center.clone(),this.magnitude)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new GravityForce(new t.Vector3(e.center[0],e.center[1],e.center[2]),e.magnitude)}}]),GravityForce}();new t.Vector3(0,0,1);var G=function(){function ChangeEmitDirection(e){_classCallCheck(this,ChangeEmitDirection),_defineProperty(this,"type","ChangeEmitDirection"),_defineProperty(this,"_temp",new t.Vector3),_defineProperty(this,"_q",new t.Quaternion),this.angle=e}return _createClass(ChangeEmitDirection,[{key:"initialize",value:function initialize(e){var t=e.velocity.length();0!=t&&(e.velocity.normalize(),0===e.velocity.x&&0===e.velocity.y?this._temp.set(0,e.velocity.z,0):this._temp.set(-e.velocity.y,e.velocity.x,0),this._q.setFromAxisAngle(this._temp.normalize(),this.angle.genValue()),this._temp.copy(e.velocity),e.velocity.applyQuaternion(this._q),this._q.setFromAxisAngle(this._temp,Math.random()*Math.PI*2),e.velocity.applyQuaternion(this._q),e.velocity.setLength(t))}},{key:"update",value:function update(e,t){}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,angle:this.angle.toJSON()}}},{key:"clone",value:function clone(){return new ChangeEmitDirection(this.angle)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ChangeEmitDirection(ValueGeneratorFromJSON(e.angle))}}]),ChangeEmitDirection}(),D=new t.Vector3(1,1,1),q=new t.Vector3(0,0,1),X=function(e){return e[e.Death=0]="Death",e[e.Birth=1]="Birth",e[e.Frame=2]="Frame",e}({}),j=function(){function EmitSubParticleSystem(e,i,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:X.Frame,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;_classCallCheck(this,EmitSubParticleSystem),_defineProperty(this,"type","EmitSubParticleSystem"),_defineProperty(this,"q_",new t.Quaternion),_defineProperty(this,"v_",new t.Vector3),_defineProperty(this,"v2_",new t.Vector3),_defineProperty(this,"subEmissions",new Array),this.particleSystem=e,this.useVelocityAsBasis=i,this.subParticleSystem=r,this.mode=n,this.emitProbability=o,this.subParticleSystem&&this.subParticleSystem.system&&(this.subParticleSystem.system.onlyUsedByOther=!0)}return _createClass(EmitSubParticleSystem,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){(this.mode===X.Frame||this.mode===X.Birth&&0===e.age||this.mode===X.Death&&e.age+t>=e.life)&&this.emit(e,t)}},{key:"emit",value:function emit(e,i){if(this.subParticleSystem&&!(Math.random()>this.emitProbability)){var r=new t.Matrix4;this.setMatrixFromParticle(r,e),this.subEmissions.push({burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,matrix:r,travelDistance:0,particle:e})}}},{key:"frameUpdate",value:function frameUpdate(e){if(this.subParticleSystem)for(var t=0;t<this.subEmissions.length;t++)if(this.subEmissions[t].time>=this.subParticleSystem.system.duration)this.subEmissions[t]=this.subEmissions[this.subEmissions.length-1],this.subEmissions.length=this.subEmissions.length-1,t--;else{var i=this.subEmissions[t];i.particle&&i.particle.age<i.particle.life?this.setMatrixFromParticle(i.matrix,i.particle):i.particle=void 0,console.log(i),console.log(this.subParticleSystem.system.emissionOverDistance),this.subParticleSystem.system.emit(e,i,i.matrix)}}},{key:"toJSON",value:function toJSON(){return{type:this.type,subParticleSystem:this.subParticleSystem?this.subParticleSystem.uuid:"",useVelocityAsBasis:this.useVelocityAsBasis,mode:this.mode,emitProbability:this.emitProbability}}},{key:"clone",value:function clone(){return new EmitSubParticleSystem(this.particleSystem,this.useVelocityAsBasis,this.subParticleSystem,this.mode,this.emitProbability)}},{key:"reset",value:function reset(){}},{key:"setMatrixFromParticle",value:function setMatrixFromParticle(e,i){var r;if(void 0===i.rotation||this.useVelocityAsBasis)if(0!==i.velocity.x||0!==i.velocity.y||1!==i.velocity.z&&0!==i.velocity.z){this.v_.copy(q).cross(i.velocity),this.v2_.copy(i.velocity).cross(this.v_);var n=this.v_.length(),o=this.v2_.length();e.set(this.v_.x/n,this.v2_.x/o,i.velocity.x,i.position.x,this.v_.y/n,this.v2_.y/o,i.velocity.y,i.position.y,this.v_.z/n,this.v2_.z/o,i.velocity.z,i.position.z,0,0,0,1)}else e.set(1,0,0,i.position.x,0,1,0,i.position.y,0,0,1,i.position.z,0,0,0,1);else i.rotation instanceof t.Quaternion?r=i.rotation:(this.q_.setFromAxisAngle(q,i.rotation),r=this.q_),e.compose(i.position,r,D);this.particleSystem.worldSpace||e.multiplyMatrices(this.particleSystem.emitter.matrixWorld,e)}}],[{key:"fromJSON",value:function fromJSON(e,t){return new EmitSubParticleSystem(t,e.useVelocityAsBasis,e.subParticleSystem,e.mode,e.emitProbability)}}]),EmitSubParticleSystem}(),H=.5*(Math.sqrt(3)-1),W=(3-Math.sqrt(3))/6,Q=1/6,Y=(Math.sqrt(5)-1)/4,Z=(5-Math.sqrt(5))/20,K=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),$=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),ee=function(){function SimplexNoise(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.random;_classCallCheck(this,SimplexNoise),_defineProperty(this,"p",void 0),_defineProperty(this,"perm",void 0),_defineProperty(this,"permMod12",void 0);var t="function"==typeof e?e:function alea(e){var t=0,i=0,r=0,n=1,o=function masher(){var e=4022871197;return function(t){t=t.toString();for(var i=0;i<t.length;i++){var r=.02519603282416938*(e+=t.charCodeAt(i));r-=e=r>>>0,e=(r*=e)>>>0,e+=4294967296*(r-=e)}return 2.3283064365386963e-10*(e>>>0)}}();return t=o(" "),i=o(" "),r=o(" "),(t-=o(e))<0&&(t+=1),(i-=o(e))<0&&(i+=1),(r-=o(e))<0&&(r+=1),function(){var e=2091639*t+2.3283064365386963e-10*n;return t=i,i=r,r=e-(n=0|e)}}(e);this.p=function buildPermutationTable(e){for(var t=new Uint8Array(256),i=0;i<256;i++)t[i]=i;for(var r=0;r<255;r++){var n=r+~~(e()*(256-r)),o=t[r];t[r]=t[n],t[n]=o}return t}(t),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var i=0;i<512;i++)this.perm[i]=this.p[255&i],this.permMod12[i]=this.perm[i]%12}return _createClass(SimplexNoise,[{key:"noise2D",value:function noise2D(e,t){var i,r,n=this.permMod12,o=this.perm,a=0,s=0,l=0,u=(e+t)*H,c=Math.floor(e+u),d=Math.floor(t+u),h=(c+d)*W,f=e-(c-h),p=t-(d-h);f>p?(i=1,r=0):(i=0,r=1);var m=f-i+W,y=p-r+W,v=f-1+2*W,g=p-1+2*W,S=255&c,_=255&d,w=.5-f*f-p*p;if(w>=0){var O=3*n[S+o[_]];a=(w*=w)*w*(K[O]*f+K[O+1]*p)}var x=.5-m*m-y*y;if(x>=0){var b=3*n[S+i+o[_+r]];s=(x*=x)*x*(K[b]*m+K[b+1]*y)}var N=.5-v*v-g*g;if(N>=0){var P=3*n[S+1+o[_+1]];l=(N*=N)*N*(K[P]*v+K[P+1]*g)}return 70*(a+s+l)}},{key:"noise3D",value:function noise3D(e,t,i){var r,n,o,a,s,l,u,c,d,h,f=this.permMod12,p=this.perm,m=.3333333333333333*(e+t+i),y=Math.floor(e+m),v=Math.floor(t+m),g=Math.floor(i+m),S=(y+v+g)*Q,_=e-(y-S),w=t-(v-S),O=i-(g-S);_>=w?w>=O?(s=1,l=0,u=0,c=1,d=1,h=0):_>=O?(s=1,l=0,u=0,c=1,d=0,h=1):(s=0,l=0,u=1,c=1,d=0,h=1):w<O?(s=0,l=0,u=1,c=0,d=1,h=1):_<O?(s=0,l=1,u=0,c=0,d=1,h=1):(s=0,l=1,u=0,c=1,d=1,h=0);var x=_-s+Q,b=w-l+Q,N=O-u+Q,P=_-c+2*Q,k=w-d+2*Q,M=O-h+2*Q,C=_-1+.5,V=w-1+.5,B=O-1+.5,T=255&y,E=255&v,z=255&g,A=.6-_*_-w*w-O*O;if(A<0)r=0;else{var J=3*f[T+p[E+p[z]]];r=(A*=A)*A*(K[J]*_+K[J+1]*w+K[J+2]*O)}var L=.6-x*x-b*b-N*N;if(L<0)n=0;else{var U=3*f[T+s+p[E+l+p[z+u]]];n=(L*=L)*L*(K[U]*x+K[U+1]*b+K[U+2]*N)}var R=.6-P*P-k*k-M*M;if(R<0)o=0;else{var I=3*f[T+c+p[E+d+p[z+h]]];o=(R*=R)*R*(K[I]*P+K[I+1]*k+K[I+2]*M)}var G=.6-C*C-V*V-B*B;if(G<0)a=0;else{var D=3*f[T+1+p[E+1+p[z+1]]];a=(G*=G)*G*(K[D]*C+K[D+1]*V+K[D+2]*B)}return 32*(r+n+o+a)}},{key:"noise4D",value:function noise4D(e,t,i,r){var n,o,a,s,l,u=this.perm,c=(e+t+i+r)*Y,d=Math.floor(e+c),h=Math.floor(t+c),f=Math.floor(i+c),p=Math.floor(r+c),m=(d+h+f+p)*Z,y=e-(d-m),v=t-(h-m),g=i-(f-m),S=r-(p-m),_=0,w=0,O=0,x=0;y>v?_++:w++,y>g?_++:O++,y>S?_++:x++,v>g?w++:O++,v>S?w++:x++,g>S?O++:x++;var b=_>=3?1:0,N=w>=3?1:0,P=O>=3?1:0,k=x>=3?1:0,M=_>=2?1:0,C=w>=2?1:0,V=O>=2?1:0,B=x>=2?1:0,T=_>=1?1:0,E=w>=1?1:0,z=O>=1?1:0,A=x>=1?1:0,J=y-b+Z,L=v-N+Z,U=g-P+Z,R=S-k+Z,I=y-M+2*Z,G=v-C+2*Z,D=g-V+2*Z,q=S-B+2*Z,X=y-T+3*Z,j=v-E+3*Z,H=g-z+3*Z,W=S-A+3*Z,Q=y-1+4*Z,K=v-1+4*Z,ee=g-1+4*Z,te=S-1+4*Z,ie=255&d,re=255&h,ne=255&f,oe=255&p,ae=.6-y*y-v*v-g*g-S*S;if(ae<0)n=0;else{var se=u[ie+u[re+u[ne+u[oe]]]]%32*4;n=(ae*=ae)*ae*($[se]*y+$[se+1]*v+$[se+2]*g+$[se+3]*S)}var le=.6-J*J-L*L-U*U-R*R;if(le<0)o=0;else{var ue=u[ie+b+u[re+N+u[ne+P+u[oe+k]]]]%32*4;o=(le*=le)*le*($[ue]*J+$[ue+1]*L+$[ue+2]*U+$[ue+3]*R)}var ce=.6-I*I-G*G-D*D-q*q;if(ce<0)a=0;else{var de=u[ie+M+u[re+C+u[ne+V+u[oe+B]]]]%32*4;a=(ce*=ce)*ce*($[de]*I+$[de+1]*G+$[de+2]*D+$[de+3]*q)}var he=.6-X*X-j*j-H*H-W*W;if(he<0)s=0;else{var fe=u[ie+T+u[re+E+u[ne+z+u[oe+A]]]]%32*4;s=(he*=he)*he*($[fe]*X+$[fe+1]*j+$[fe+2]*H+$[fe+3]*W)}var pe=.6-Q*Q-K*K-ee*ee-te*te;if(pe<0)l=0;else{var me=u[ie+1+u[re+1+u[ne+1+u[oe+1]]]]%32*4;l=(pe*=pe)*pe*($[me]*Q+$[me+1]*K+$[me+2]*ee+$[me+3]*te)}return 27*(n+o+a+s+l)}}]),SimplexNoise}(),te=function(){function TurbulenceField(e,i,r,n){_classCallCheck(this,TurbulenceField),_defineProperty(this,"type","TurbulenceField"),_defineProperty(this,"generator",new ee),_defineProperty(this,"timeOffset",new t.Vector3),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"temp2",new t.Vector3),this.scale=e,this.octaves=i,this.velocityMultiplier=r,this.timeScale=n,this.timeOffset.x=Math.random()/this.scale.x*this.timeScale.x,this.timeOffset.y=Math.random()/this.scale.y*this.timeScale.y,this.timeOffset.z=Math.random()/this.scale.z*this.timeScale.z}return _createClass(TurbulenceField,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=e.position.x/this.scale.x,r=e.position.y/this.scale.y,n=e.position.z/this.scale.z;this.temp.set(0,0,0);for(var o=1,a=0;a<this.octaves;a++)this.temp2.set(this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.x*o)/o,this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.y*o)/o,this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.z*o)/o),this.temp.add(this.temp2),o*=2;this.temp.multiply(this.velocityMultiplier),e.velocity.addScaledVector(this.temp,t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,scale:[this.scale.x,this.scale.y,this.scale.z],octaves:this.octaves,velocityMultiplier:[this.velocityMultiplier.x,this.velocityMultiplier.y,this.velocityMultiplier.z],timeScale:[this.timeScale.x,this.timeScale.y,this.timeScale.z]}}},{key:"frameUpdate",value:function frameUpdate(e){this.timeOffset.x+=e*this.timeScale.x,this.timeOffset.y+=e*this.timeScale.y,this.timeOffset.z+=e*this.timeScale.z}},{key:"clone",value:function clone(){return new TurbulenceField(this.scale.clone(),this.octaves,this.velocityMultiplier.clone(),this.timeScale.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new TurbulenceField(new t.Vector3(e.scale[0],e.scale[1],e.scale[2]),e.octaves,new t.Vector3(e.velocityMultiplier[0],e.velocityMultiplier[1],e.velocityMultiplier[2]),new t.Vector3(e.timeScale[0],e.timeScale[1],e.timeScale[2]))}}]),TurbulenceField}();function randomInt(e,t){return Math.floor(Math.random()*(t-e))+e}var ie=[],re=new t.Vector3,ne=new t.Quaternion,oe=function(){function Noise(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new O(1),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new O(0);if(_classCallCheck(this,Noise),_defineProperty(this,"type","Noise"),_defineProperty(this,"duration",0),this.frequency=e,this.power=t,this.positionAmount=i,this.rotationAmount=r,0===ie.length)for(var n=0;n<100;n++)ie.push(new ee)}return _createClass(Noise,[{key:"initialize",value:function initialize(e){e.seed=10*Math.random(),e.lastPosNoise=new t.Vector3,"number"==typeof e.rotation?e.lastRotNoise=0:e.lastRotNoise=new t.Quaternion,e.generatorIndex=[randomInt(0,100),randomInt(0,100),randomInt(0,100),randomInt(0,100)]}},{key:"update",value:function update(e,t){var i=this.frequency.genValue(e.age/e.life),r=this.power.genValue(e.age/e.life),n=this.positionAmount.genValue(e.age/e.life),o=this.rotationAmount.genValue(e.age/e.life);n>0&&(e.position.sub(e.lastPosNoise),re.set(ie[e.generatorIndex[0]].noise2D(0,e.age*i)*r*n,ie[e.generatorIndex[1]].noise2D(0,e.age*i)*r*n,ie[e.generatorIndex[2]].noise2D(0,e.age*i)*r*n),e.position.add(re),e.lastPosNoise.copy(re)),o>0&&("number"==typeof e.rotation?(e.rotation-=e.lastRotNoise,e.rotation+=ie[e.generatorIndex[3]].noise2D(0,e.age*i)*Math.PI*r*o):(e.lastRotNoise.invert(),e.rotation.multiply(e.lastRotNoise),ne.set(ie[e.generatorIndex[0]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[1]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[2]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[3]].noise2D(0,e.age*i)*r*o).normalize(),e.rotation.multiply(ne),e.lastRotNoise.copy(ne)))}},{key:"toJSON",value:function toJSON(){return{type:this.type,frequency:this.frequency.toJSON(),power:this.power.toJSON(),positionAmount:this.positionAmount.toJSON(),rotationAmount:this.rotationAmount.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){this.duration+=e}},{key:"clone",value:function clone(){return new Noise(this.frequency.clone(),this.power.clone(),this.positionAmount.clone(),this.rotationAmount.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new Noise(ValueGeneratorFromJSON(e.frequency),ValueGeneratorFromJSON(e.power),ValueGeneratorFromJSON(e.positionAmount),ValueGeneratorFromJSON(e.rotationAmount))}}]),Noise}(),ae=function(){function TextureSequencer(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new t.Vector3;_classCallCheck(this,TextureSequencer),_defineProperty(this,"locations",[]),this.scaleX=e,this.scaleY=i,this.position=r}return _createClass(TextureSequencer,[{key:"transform",value:function transform(e,t){e.x=this.locations[t%this.locations.length].x*this.scaleX+this.position.x,e.y=this.locations[t%this.locations.length].y*this.scaleY+this.position.y,e.z=this.position.z}},{key:"clone",value:function clone(){var e=new TextureSequencer(this.scaleX,this.scaleY,this.position.clone());return e.locations=this.locations.map((function(e){return e.clone()})),e}},{key:"toJSON",value:function toJSON(){return{scaleX:this.scaleX,scaleY:this.scaleY,position:this.position,locations:this.locations.map((function(e){return{x:e.x,y:e.y}}))}}},{key:"fromImage",value:function fromImage(e,i){var r=document.createElement("canvas");r.width=e.width,r.height=e.height;var n=r.getContext("2d");if(n){n.drawImage(e,0,0);var o=n.getImageData(0,0,r.width,r.height,{colorSpace:"srgb"});r.remove(),this.locations.length=0;for(var a=0;a<o.height;a++)for(var s=0;s<o.width;s++)o.data[4*(a*o.width+s)+3]>i&&this.locations.push(new t.Vector2(s,o.height-a))}}}],[{key:"fromJSON",value:function fromJSON(e){var i=new TextureSequencer(e.scaleX,e.scaleY,new t.Vector3(e.position[0],e.position[1],e.position[2]));return i.locations=e.locations.map((function(e){return new t.Vector2(e.x,e.y)})),i}}]),TextureSequencer}();function SequencerFromJSON(e){return"TextureSequencer"===e.type?ae.fromJSON(e):new ae}var se,le=function(){function ApplySequences(e){_classCallCheck(this,ApplySequences),_defineProperty(this,"type","ApplySequences"),_defineProperty(this,"sequencers",[]),_defineProperty(this,"time",0),_defineProperty(this,"index",0),_defineProperty(this,"pCount",0),_defineProperty(this,"delay",void 0),_defineProperty(this,"tempV",new t.Vector3),this.delay=e}return _createClass(ApplySequences,[{key:"initialize",value:function initialize(e){e.id=this.pCount,e.dst=new t.Vector3,e.begin=new t.Vector3,e.inMotion=!1,this.pCount++}},{key:"reset",value:function reset(){this.time=0,this.index=0,this.pCount=0}},{key:"update",value:function update(e,t){var i=this.sequencers[this.index],r=e.id*this.delay;this.time>=i[0].a+r&&this.time<=i[0].b+r?(e.inMotion||(e.inMotion=!0,e.begin.copy(e.position),i[1].transform(e.dst,e.id)),e.position.lerpVectors(e.begin,e.dst,ApplySequences.BEZIER.genValue((this.time-i[0].a-r)/(i[0].b-i[0].a)))):this.time>i[0].b+r&&(e.inMotion=!1)}},{key:"frameUpdate",value:function frameUpdate(e){for(;this.index+1<this.sequencers.length&&this.time>=this.sequencers[this.index+1][0].a;)this.index++;this.time+=e}},{key:"appendSequencer",value:function appendSequencer(e,t){this.sequencers.push([e,t])}},{key:"toJSON",value:function toJSON(){return{type:this.type,delay:this.delay,sequencers:this.sequencers.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return{range:i.toJSON(),sequencer:r.toJSON()}}))}}},{key:"clone",value:function clone(){var e=new ApplySequences(this.delay);return e.sequencers=this.sequencers.map((function(e){return[e[0].clone(),e[1].clone()]})),e}}],[{key:"fromJSON",value:function fromJSON(e){var t=new ApplySequences(e.delay);return e.sequencers.forEach((function(e){t.sequencers.push([ValueGeneratorFromJSON(e.range),SequencerFromJSON(e.sequencer)])})),t}}]),ApplySequences}();function getPhysicsResolver(){return se}_defineProperty(le,"BEZIER",new u(0,0,1,1));var ue=function(){function ApplyCollision(e,i){_classCallCheck(this,ApplyCollision),_defineProperty(this,"type","ApplyCollision"),_defineProperty(this,"tempV",new t.Vector3),this.resolver=e,this.bounce=i}return _createClass(ApplyCollision,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this.resolver.resolve(e.position,this.tempV)&&e.velocity.reflect(this.tempV).multiplyScalar(this.bounce)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,bounce:this.bounce}}},{key:"clone",value:function clone(){return new ApplyCollision(this.resolver,this.bounce)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ApplyCollision(getPhysicsResolver(),e.bounce)}}]),ApplyCollision}(),ce=function(){function ColorBySpeed(e,t){_classCallCheck(this,ColorBySpeed),_defineProperty(this,"type","ColorBySpeed"),this.color=e,this.speedRange=t}return _createClass(ColorBySpeed,[{key:"initialize",value:function initialize(e){"memorizedFunction"===this.color.type&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function update(e,t){var i=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);"memorizedFunction"===this.color.type?this.color.genColor(e.color,i,e.colorOverLifeMemory):this.color.genColor(e.color,i),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,color:this.color.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"clone",value:function clone(){return new ColorBySpeed(this.color.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorBySpeed(ColorGeneratorFromJSON(e.color),x.fromJSON(e.speedRange))}}]),ColorBySpeed}(),de=function(){function SizeBySpeed(e,t){_classCallCheck(this,SizeBySpeed),_defineProperty(this,"type","SizeBySpeed"),this.size=e,this.speedRange=t}return _createClass(SizeBySpeed,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){var t=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.size=e.startSize*this.size.genValue(t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,size:this.size.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SizeBySpeed(this.size.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SizeBySpeed(ValueGeneratorFromJSON(e.size),x.fromJSON(e.speedRange))}}]),SizeBySpeed}(),he=function(){function RotationBySpeed(e,i){_classCallCheck(this,RotationBySpeed),_defineProperty(this,"type","RotationBySpeed"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.speedRange=i}return _createClass(RotationBySpeed,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.rotation+=t*this.angularVelocity.genValue(i)}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new RotationBySpeed(this.angularVelocity.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new RotationBySpeed(ValueGeneratorFromJSON(e.angularVelocity),x.fromJSON(e.speedRange))}}]),RotationBySpeed}(),fe=function(){function LimitSpeedOverLife(e,t){_classCallCheck(this,LimitSpeedOverLife),_defineProperty(this,"type","LimitSpeedOverLife"),this.speed=e,this.dampen=t}return _createClass(LimitSpeedOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=e.velocity.length(),r=this.speed.genValue(e.age/e.life);if(i>r){var n=(i-r)/i;e.velocity.multiplyScalar(1-n*this.dampen*t*20)}}},{key:"toJSON",value:function toJSON(){return{type:this.type,speed:this.speed.toJSON(),dampen:this.dampen}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new LimitSpeedOverLife(this.speed.clone(),this.dampen)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new LimitSpeedOverLife(ValueGeneratorFromJSON(e.speed),e.dampen)}}]),LimitSpeedOverLife}(),pe={ApplyForce:{type:"ApplyForce",constructor:R,params:[["direction","vec3"],["magnitude","value"]],loadJSON:R.fromJSON},Noise:{type:"Noise",constructor:oe,params:[["frequency","value"],["power","value"],["positionAmount","value"],["rotationAmount","value"]],loadJSON:oe.fromJSON},TurbulenceField:{type:"TurbulenceField",constructor:te,params:[["scale","vec3"],["octaves","number"],["velocityMultiplier","vec3"],["timeScale","vec3"]],loadJSON:te.fromJSON},GravityForce:{type:"GravityForce",constructor:I,params:[["center","vec3"],["magnitude","number"]],loadJSON:I.fromJSON},ColorOverLife:{type:"ColorOverLife",constructor:C,params:[["color","colorFunc"]],loadJSON:C.fromJSON},RotationOverLife:{type:"RotationOverLife",constructor:V,params:[["angularVelocity","valueFunc"],["dynamic","boolean"]],loadJSON:V.fromJSON},Rotation3DOverLife:{type:"Rotation3DOverLife",constructor:T,params:[["angularVelocity","rotationFunc"],["dynamic","boolean"]],loadJSON:T.fromJSON},SizeOverLife:{type:"SizeOverLife",constructor:z,params:[["size","valueFunc"]],loadJSON:z.fromJSON},ColorBySpeed:{type:"ColorBySpeed",constructor:ce,params:[["color","colorFunc"],["speedRange","range"]],loadJSON:ce.fromJSON},RotationBySpeed:{type:"RotationBySpeed",constructor:he,params:[["angularVelocity","valueFunc"],["speedRange","range"]],loadJSON:he.fromJSON},SizeBySpeed:{type:"SizeBySpeed",constructor:de,params:[["size","valueFunc"],["speedRange","range"]],loadJSON:de.fromJSON},SpeedOverLife:{type:"SpeedOverLife",constructor:A,params:[["speed","valueFunc"]],loadJSON:A.fromJSON},FrameOverLife:{type:"FrameOverLife",constructor:J,params:[["frame","valueFunc"]],loadJSON:J.fromJSON},ForceOverLife:{type:"ForceOverLife",constructor:E,params:[["x","valueFunc"],["y","valueFunc"],["z","valueFunc"]],loadJSON:E.fromJSON},OrbitOverLife:{type:"OrbitOverLife",constructor:L,params:[["orbitSpeed","valueFunc"],["axis","vec3"]],loadJSON:L.fromJSON},WidthOverLength:{type:"WidthOverLength",constructor:U,params:[["width","valueFunc"]],loadJSON:U.fromJSON},ChangeEmitDirection:{type:"ChangeEmitDirection",constructor:G,params:[["angle","value"]],loadJSON:G.fromJSON},EmitSubParticleSystem:{type:"EmitSubParticleSystem",constructor:j,params:[["particleSystem","self"],["useVelocityAsBasis","boolean"],["subParticleSystem","particleSystem"],["mode","number"],["emitProbability","number"]],loadJSON:j.fromJSON},LimitSpeedOverLife:{type:"LimitSpeedOverLife",constructor:fe,params:[["speed","valueFunc"],["dampen","number"]],loadJSON:fe.fromJSON}};function BehaviorFromJSON(e,t){return pe[e.type].loadJSON(e,t)}var me=function(){function ConeEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,ConeEmitter),_defineProperty(this,"type","cone"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),_defineProperty(this,"angle",void 0),this.radius=null!==(e=n.radius)&&void 0!==e?e:10,this.arc=null!==(t=n.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=n.thickness)&&void 0!==i?i:1,this.angle=null!==(r=n.angle)&&void 0!==r?r:Math.PI/6}return _createClass(ConeEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=t.MathUtils.lerp(1-this.thickness,1,Math.random()),n=i*this.arc,o=Math.sqrt(r),a=Math.sin(n),s=Math.cos(n);e.position.x=o*s,e.position.y=o*a,e.position.z=0;var l=this.angle*o;e.velocity.set(0,0,Math.cos(l)).addScaledVector(e.position,Math.sin(l)).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius)}},{key:"toJSON",value:function toJSON(){return{type:"cone",radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle}}},{key:"clone",value:function clone(){return new ConeEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle})}}],[{key:"fromJSON",value:function fromJSON(e){return new ConeEmitter(e)}}]),ConeEmitter}(),ye=function(){function CircleEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,CircleEmitter),_defineProperty(this,"type","circle"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(CircleEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=t.MathUtils.lerp(1-this.thickness,1,Math.random()),n=i*this.arc;e.position.x=Math.cos(n),e.position.y=Math.sin(n),e.position.z=0,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*r)}},{key:"toJSON",value:function toJSON(){return{type:"circle",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new CircleEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new CircleEmitter(e)}}]),CircleEmitter}(),ve=function(){function DonutEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,DonutEmitter),_defineProperty(this,"type","donut"),_defineProperty(this,"radius",void 0),_defineProperty(this,"donutRadius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=n.radius)&&void 0!==e?e:10,this.arc=null!==(t=n.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=n.thickness)&&void 0!==i?i:1,this.donutRadius=null!==(r=n.donutRadius)&&void 0!==r?r:.2*this.radius}return _createClass(DonutEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=r*Math.PI*2,s=Math.sin(o),l=Math.cos(o);e.position.x=this.radius*l,e.position.y=this.radius*s,e.position.z=0,e.velocity.z=this.donutRadius*n*Math.sin(a),e.velocity.x=this.donutRadius*n*Math.cos(a)*l,e.velocity.y=this.donutRadius*n*Math.cos(a)*s,e.position.add(e.velocity),e.velocity.normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"donut",radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius}}},{key:"clone",value:function clone(){return new DonutEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius})}}],[{key:"fromJSON",value:function fromJSON(e){return new DonutEmitter(e)}}]),DonutEmitter}(),ge=function(){function PointEmitter(){_classCallCheck(this,PointEmitter),_defineProperty(this,"type","point")}return _createClass(PointEmitter,[{key:"initialize",value:function initialize(e){var t=Math.random(),i=Math.random(),r=t*Math.PI*2,n=Math.acos(2*i-1),o=Math.cbrt(Math.random()),a=Math.sin(r),s=Math.cos(r),l=Math.sin(n),u=Math.cos(n);e.velocity.x=o*l*s,e.velocity.y=o*l*a,e.velocity.z=o*u,e.velocity.multiplyScalar(e.startSpeed),e.position.setScalar(0)}},{key:"toJSON",value:function toJSON(){return{type:"point"}}},{key:"clone",value:function clone(){return new PointEmitter}}],[{key:"fromJSON",value:function fromJSON(e){return new PointEmitter}}]),PointEmitter}(),Se=function(){function SphereEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,SphereEmitter),_defineProperty(this,"type","sphere"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(SphereEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=Math.acos(2*r-1),s=Math.sin(o),l=Math.cos(o),u=Math.sin(a),c=Math.cos(a);e.position.x=u*l,e.position.y=u*s,e.position.z=c,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*n)}},{key:"toJSON",value:function toJSON(){return{type:"sphere",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new SphereEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new SphereEmitter(e)}}]),SphereEmitter}(),_e=function(){function HemisphereEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,HemisphereEmitter),_defineProperty(this,"type","sphere"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(HemisphereEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=Math.acos(r),s=Math.sin(o),l=Math.cos(o),u=Math.sin(a),c=Math.cos(a);e.position.x=u*l,e.position.y=u*s,e.position.z=c,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*n)}},{key:"toJSON",value:function toJSON(){return{type:"hemisphere",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new HemisphereEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new HemisphereEmitter(e)}}]),HemisphereEmitter}(),we=function(){function GridEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,GridEmitter),_defineProperty(this,"type","grid"),_defineProperty(this,"width",void 0),_defineProperty(this,"height",void 0),_defineProperty(this,"column",void 0),_defineProperty(this,"row",void 0),this.width=null!==(e=n.width)&&void 0!==e?e:1,this.height=null!==(t=n.height)&&void 0!==t?t:1,this.column=null!==(i=n.column)&&void 0!==i?i:10,this.row=null!==(r=n.row)&&void 0!==r?r:10}return _createClass(GridEmitter,[{key:"initialize",value:function initialize(e){var t=Math.floor(Math.random()*this.row),i=Math.floor(Math.random()*this.column);e.position.x=i*this.width/this.column-this.width/2,e.position.y=t*this.height/this.row-this.height/2,e.position.z=0,e.velocity.set(0,0,e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"grid",width:this.width,height:this.height,column:this.column,row:this.row}}},{key:"clone",value:function clone(){return new GridEmitter({width:this.width,height:this.height,column:this.column,row:this.row})}}],[{key:"fromJSON",value:function fromJSON(e){return new GridEmitter(e)}}]),GridEmitter}(),Oe=function(){function MeshSurfaceEmitter(e){_classCallCheck(this,MeshSurfaceEmitter),_defineProperty(this,"type","mesh_surface"),_defineProperty(this,"_triangleIndexToArea",[]),_defineProperty(this,"_geometry",void 0),_defineProperty(this,"_tempA",new t.Vector3),_defineProperty(this,"_tempB",new t.Vector3),_defineProperty(this,"_tempC",new t.Vector3),e&&(this.geometry=e)}return _createClass(MeshSurfaceEmitter,[{key:"geometry",get:function get(){return this._geometry},set:function set(e){if(this._geometry=e,void 0!==e&&"string"!=typeof e){var i=new t.Triangle;this._triangleIndexToArea.length=0;var r=0;if(e.getIndex()){var n=e.getIndex().array,o=n.length/3;this._triangleIndexToArea.push(0);for(var a=0;a<o;a++)i.setFromAttributeAndIndices(e.getAttribute("position"),n[3*a],n[3*a+1],n[3*a+2]),r+=i.getArea(),this._triangleIndexToArea.push(r);e.userData.triangleIndexToArea=this._triangleIndexToArea}}}},{key:"initialize",value:function initialize(e){var t=this._geometry;if(!t||null===t.getIndex())return e.position.set(0,0,0),void e.velocity.set(0,0,1).multiplyScalar(e.startSpeed);for(var i=this._triangleIndexToArea.length-1,r=0,n=i,o=Math.random()*this._triangleIndexToArea[i];r+1<n;){var a=Math.floor((r+n)/2);o<this._triangleIndexToArea[a]?n=a:r=a}var s=Math.random(),l=Math.random();s+l>1&&(s=1-s,l=1-l);var u=t.getIndex().array[3*r],c=t.getIndex().array[3*r+1],d=t.getIndex().array[3*r+2],h=t.getAttribute("position");this._tempA.fromBufferAttribute(h,u),this._tempB.fromBufferAttribute(h,c),this._tempC.fromBufferAttribute(h,d),this._tempB.sub(this._tempA),this._tempC.sub(this._tempA),this._tempA.addScaledVector(this._tempB,s).addScaledVector(this._tempC,l),e.position.copy(this._tempA),this._tempA.copy(this._tempB).cross(this._tempC).normalize(),e.velocity.copy(this._tempA).normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"mesh_surface",mesh:this._geometry?this._geometry.uuid:""}}},{key:"clone",value:function clone(){return new MeshSurfaceEmitter(this._geometry)}}],[{key:"fromJSON",value:function fromJSON(e,t){return new MeshSurfaceEmitter(t.geometries[e.geometry])}}]),MeshSurfaceEmitter}(),xe={circle:{type:"circle",params:[["radius","number"],["arc","radian"],["thickness","number"]],constructor:ye,loadJSON:ye.fromJSON},cone:{type:"cone",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:me,loadJSON:me.fromJSON},donut:{type:"donut",params:[["radius","number"],["arc","radian"],["thickness","number"],["donutRadius","number"]],constructor:ve,loadJSON:ve.fromJSON},point:{type:"point",params:[],constructor:ge,loadJSON:ge.fromJSON},sphere:{type:"sphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:Se,loadJSON:Se.fromJSON},hemisphere:{type:"hemisphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:_e,loadJSON:_e.fromJSON},grid:{type:"grid",params:[["width","number"],["height","number"],["rows","number"],["column","number"]],constructor:we,loadJSON:we.fromJSON},mesh_surface:{type:"mesh_surface",params:[["geometry","geometry"]],constructor:Oe,loadJSON:Oe.fromJSON}};function EmitterFromJSON(e,t){return xe[e.type].loadJSON(e,t)}var be=function(e){return e[e.BillBoard=0]="BillBoard",e[e.StretchedBillBoard=1]="StretchedBillBoard",e[e.Mesh=2]="Mesh",e[e.Trail=3]="Trail",e[e.HorizontalBillBoard=4]="HorizontalBillBoard",e[e.VerticalBillBoard=5]="VerticalBillBoard",e}({}),Ne=function(e){_inherits(VFXBatch,e);var i=_createSuper(VFXBatch);function VFXBatch(e){var r;_classCallCheck(this,VFXBatch),_defineProperty(_assertThisInitialized(r=i.call(this)),"type","VFXBatch"),_defineProperty(_assertThisInitialized(r),"systems",void 0),_defineProperty(_assertThisInitialized(r),"settings",void 0),_defineProperty(_assertThisInitialized(r),"maxParticles",void 0),r.maxParticles=1e3,r.systems=new Set;var n=new t.Layers;n.mask=e.layers.mask;var o=e.material.clone();return o.defines={},Object.assign(o.defines,e.material.defines),r.settings={instancingGeometry:e.instancingGeometry,renderMode:e.renderMode,renderOrder:e.renderOrder,material:o,uTileCount:e.uTileCount,vTileCount:e.vTileCount,layers:n},r.frustumCulled=!1,r.renderOrder=r.settings.renderOrder,r}return _createClass(VFXBatch,[{key:"addSystem",value:function addSystem(e){this.systems.add(e)}},{key:"removeSystem",value:function removeSystem(e){this.systems.delete(e)}}]),VFXBatch}(t.Mesh),Pe=new t.Vector3(0,0,1),ke=new t.Quaternion,Me=new t.Vector3,Ce=new t.Vector3;new t.Vector3;var Ve=new t.PlaneGeometry(1,1,1,1),Be=function(){function ParticleSystem(e){var r,n,o,a,s,l,u,c,d,h,f,p,m,y,v,g,S,_,x,b;if(_classCallCheck(this,ParticleSystem),_defineProperty(this,"autoDestroy",void 0),_defineProperty(this,"prewarm",void 0),_defineProperty(this,"looping",void 0),_defineProperty(this,"duration",void 0),_defineProperty(this,"startLife",void 0),_defineProperty(this,"startSpeed",void 0),_defineProperty(this,"startRotation",void 0),_defineProperty(this,"startSize",void 0),_defineProperty(this,"startColor",void 0),_defineProperty(this,"startTileIndex",void 0),_defineProperty(this,"rendererEmitterSettings",void 0),_defineProperty(this,"emissionOverTime",void 0),_defineProperty(this,"emissionOverDistance",void 0),_defineProperty(this,"emissionBursts",void 0),_defineProperty(this,"onlyUsedByOther",void 0),_defineProperty(this,"worldSpace",void 0),_defineProperty(this,"particleNum",void 0),_defineProperty(this,"paused",void 0),_defineProperty(this,"particles",void 0),_defineProperty(this,"emitterShape",void 0),_defineProperty(this,"emitter",void 0),_defineProperty(this,"rendererSettings",void 0),_defineProperty(this,"neededToUpdateRender",void 0),_defineProperty(this,"behaviors",void 0),_defineProperty(this,"prewarmed",void 0),_defineProperty(this,"emissionState",void 0),_defineProperty(this,"emitEnded",void 0),_defineProperty(this,"markForDestroy",void 0),_defineProperty(this,"previousWorldPos",void 0),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"travelDistance",0),_defineProperty(this,"normalMatrix",new t.Matrix3),_defineProperty(this,"_renderer",void 0),this.autoDestroy=void 0!==e.autoDestroy&&e.autoDestroy,this.duration=null!==(r=e.duration)&&void 0!==r?r:1,this.looping=void 0===e.looping||e.looping,this.prewarm=void 0!==e.prewarm&&e.prewarm,this.startLife=null!==(n=e.startLife)&&void 0!==n?n:new O(5),this.startSpeed=null!==(o=e.startSpeed)&&void 0!==o?o:new O(0),this.startRotation=null!==(a=e.startRotation)&&void 0!==a?a:new O(0),this.startSize=null!==(s=e.startSize)&&void 0!==s?s:new O(1),this.startColor=null!==(l=e.startColor)&&void 0!==l?l:new w(new t.Vector4(1,1,1,1)),this.emissionOverTime=null!==(u=e.emissionOverTime)&&void 0!==u?u:new O(10),this.emissionOverDistance=null!==(c=e.emissionOverDistance)&&void 0!==c?c:new O(0),this.emissionBursts=null!==(d=e.emissionBursts)&&void 0!==d?d:[],this.onlyUsedByOther=null!==(h=e.onlyUsedByOther)&&void 0!==h&&h,this.emitterShape=null!==(f=e.shape)&&void 0!==f?f:new Se,this.behaviors=null!==(p=e.behaviors)&&void 0!==p?p:new Array,this.worldSpace=null!==(m=e.worldSpace)&&void 0!==m&&m,this.rendererEmitterSettings=null!==(y=e.rendererEmitterSettings)&&void 0!==y?y:{},e.renderMode===be.StretchedBillBoard){var N,P,k=this.rendererEmitterSettings;void 0!==e.speedFactor&&(k.speedFactor=e.speedFactor),k.speedFactor=null!==(N=k.speedFactor)&&void 0!==N?N:0,k.lengthFactor=null!==(P=k.lengthFactor)&&void 0!==P?P:0}this.rendererSettings={instancingGeometry:null!==(v=e.instancingGeometry)&&void 0!==v?v:Ve,renderMode:null!==(g=e.renderMode)&&void 0!==g?g:be.BillBoard,renderOrder:null!==(S=e.renderOrder)&&void 0!==S?S:0,material:e.material,uTileCount:null!==(_=e.uTileCount)&&void 0!==_?_:1,vTileCount:null!==(x=e.vTileCount)&&void 0!==x?x:1,layers:null!==(b=e.layers)&&void 0!==b?b:new t.Layers},this.neededToUpdateRender=!0,this.particles=new Array,this.startTileIndex=e.startTileIndex||new O(0),this.emitter=new i(this),this.paused=!1,this.particleNum=0,this.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,travelDistance:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return _createClass(ParticleSystem,[{key:"time",get:function get(){return this.emissionState.time},set:function set(e){this.emissionState.time=e}},{key:"layers",get:function get(){return this.rendererSettings.layers}},{key:"texture",get:function get(){return this.rendererSettings.material.map},set:function set(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function get(){return this.rendererSettings.material},set:function set(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"uTileCount",get:function get(){return this.rendererSettings.uTileCount},set:function set(e){this.rendererSettings.uTileCount=e,this.neededToUpdateRender=!0}},{key:"vTileCount",get:function get(){return this.rendererSettings.vTileCount},set:function set(e){this.rendererSettings.vTileCount=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function get(){return this.rendererSettings.instancingGeometry},set:function set(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function get(){return this.rendererSettings.renderMode},set:function set(e){if((this.rendererSettings.renderMode!=be.Trail&&e===be.Trail||this.rendererSettings.renderMode==be.Trail&&e!==be.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==e)switch(e){case be.Trail:this.rendererEmitterSettings={startLength:new O(30),followLocalOrigin:!1};break;case be.Mesh:this.rendererEmitterSettings={geometry:new t.PlaneGeometry(1,1)},this.startRotation=new k(new t.Vector3(0,1,0),new O(0));break;case be.StretchedBillBoard:this.rendererEmitterSettings={speedFactor:0,lengthFactor:2},this.rendererSettings.renderMode===be.Mesh&&(this.startRotation=new O(0));break;case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:this.rendererEmitterSettings={},this.rendererSettings.renderMode===be.Mesh&&(this.startRotation=new O(0))}this.rendererSettings.renderMode=e,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function get(){return this.rendererSettings.renderOrder},set:function set(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function get(){return this.rendererSettings.material.blending},set:function set(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function pause(){this.paused=!0}},{key:"play",value:function play(){this.paused=!1}},{key:"spawn",value:function spawn(e,i,r){ke.setFromRotationMatrix(r);var n=Me,o=ke,s=Ce;r.decompose(n,o,s);for(var u=0;u<e;u++){for(this.particleNum++;this.particles.length<this.particleNum;)this.rendererSettings.renderMode===be.Trail?this.particles.push(new l):this.particles.push(new a);var c=this.particles[this.particleNum-1];if(this.startColor.genColor(c.startColor,this.emissionState.time,{}),c.color.copy(c.startColor),c.startSpeed=this.startSpeed.genValue(i.time/this.duration),c.life=this.startLife.genValue(i.time/this.duration),c.age=0,c.startSize=this.startSize.genValue(i.time/this.duration),c.uvTile=Math.floor(this.startTileIndex.genValue()),c.size=c.startSize,this.rendererSettings.renderMode===be.Mesh||this.rendererSettings.renderMode===be.BillBoard||this.rendererSettings.renderMode===be.VerticalBillBoard||this.rendererSettings.renderMode===be.HorizontalBillBoard||this.rendererSettings.renderMode===be.StretchedBillBoard){var d=c;this.rendererSettings.renderMode===be.Mesh?(d.rotation instanceof t.Quaternion||(d.rotation=new t.Quaternion),"rotation"===this.startRotation.type?this.startRotation.genValue(d.rotation,i.time/this.duration):d.rotation.setFromAxisAngle(Pe,this.startRotation.genValue(i.time/this.duration))):"rotation"===this.startRotation.type?d.rotation=0:d.rotation=this.startRotation.genValue(i.time/this.duration)}else if(this.rendererSettings.renderMode===be.Trail){var h=c;h.length=this.rendererEmitterSettings.startLength.genValue(i.time/this.duration),h.reset()}if(this.emitterShape.initialize(c),this.rendererSettings.renderMode===be.Trail&&this.rendererEmitterSettings.followLocalOrigin){var f=c;f.localPosition=(new t.Vector3).copy(f.position)}this.worldSpace?(c.position.applyMatrix4(r),c.startSize=c.startSize*(Math.abs(s.x)+Math.abs(s.y)+Math.abs(s.z))/3,c.size=c.startSize,c.velocity.multiply(s).applyMatrix3(this.normalMatrix),c.rotation&&c.rotation instanceof t.Quaternion&&c.rotation.multiplyQuaternions(ke,c.rotation)):this.onlyUsedByOther&&(c.parentMatrix=r);for(var p=0;p<this.behaviors.length;p++)this.behaviors[p].initialize(c)}}},{key:"endEmit",value:function endEmit(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function dispose(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function restart(){this.paused=!1,this.particleNum=0,this.emissionState.burstIndex=0,this.emissionState.burstWaveIndex=0,this.emissionState.time=0,this.emissionState.waitEmiting=0,this.behaviors.forEach((function(e){e.reset()})),this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function update(e){if(!this.paused){for(var t=this.emitter;t.parent;)t=t.parent;if("Scene"===t.type)if(this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var i=0;i<60*this.duration;i++)this.update(1/60)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.onlyUsedByOther||this.emit(e,this.emissionState,this.emitter.matrixWorld);for(var r=0;r<this.behaviors.length;r++){for(var n=0;n<this.particleNum;n++)this.particles[n].died||this.behaviors[r].update(this.particles[n],e);this.behaviors[r].frameUpdate(e)}for(var o=0;o<this.particleNum;o++){if(this.rendererEmitterSettings.followLocalOrigin&&this.particles[o].localPosition)this.particles[o].position.copy(this.particles[o].localPosition),this.particles[o].parentMatrix?this.particles[o].position.applyMatrix4(this.particles[o].parentMatrix):this.particles[o].position.applyMatrix4(this.emitter.matrixWorld);else{var a,s=null!==(a=this.particles[o].speedModifier)&&void 0!==a?a:1;this.particles[o].position.addScaledVector(this.particles[o].velocity,e*s)}this.particles[o].age+=e}if(this.rendererSettings.renderMode===be.Trail)for(var u=0;u<this.particleNum;u++)this.particles[u].update();for(var c=0;c<this.particleNum;c++){var d=this.particles[c];!d.died||d instanceof l&&0!==d.previous.length||(this.particles[c]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=d,this.particleNum--,c--)}}else this.dispose()}}},{key:"emit",value:function emit(e,i,r){i.time>this.duration&&(this.looping?(i.time-=this.duration,i.burstIndex=0,this.behaviors.forEach((function(e){e.reset()}))):this.emitEnded||this.onlyUsedByOther||this.endEmit()),this.normalMatrix.getNormalMatrix(r);var n=Math.ceil(i.waitEmiting);for(this.spawn(n,i,r),i.waitEmiting-=n;i.burstIndex<this.emissionBursts.length&&this.emissionBursts[i.burstIndex].time<=i.time;){if(Math.random()<this.emissionBursts[i.burstIndex].probability){var o=this.emissionBursts[i.burstIndex].count.genValue(this.time);this.spawn(o,i,r)}i.burstIndex++}if(!this.emitEnded&&(i.waitEmiting+=e*this.emissionOverTime.genValue(i.time/this.duration),null!=i.previousWorldPos)){this.temp.set(r.elements[12],r.elements[13],r.elements[14]),i.travelDistance+=i.previousWorldPos.distanceTo(this.temp);var a=this.emissionOverDistance.genValue(i.time/this.duration);if(i.travelDistance*a>0){var s=Math.floor(i.travelDistance*a);i.travelDistance-=s/a,i.waitEmiting+=s}}void 0===i.previousWorldPos&&(i.previousWorldPos=new t.Vector3),i.previousWorldPos.set(r.elements[12],r.elements[13],r.elements[14]),i.time+=e}},{key:"toJSON",value:function toJSON(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if((void 0===e||"string"==typeof e)&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}}),e.materials[this.rendererSettings.material.uuid]=this.rendererSettings.material.toJSON(e),i.useUrlForImage&&void 0!==this.texture.source){var r=this.texture.source;e.images[r.uuid]={uuid:r.uuid,url:this.texture.image.url}}t=this.renderMode===be.Trail?{startLength:this.rendererEmitterSettings.startLength.toJSON(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:this.renderMode===be.Mesh?{}:this.renderMode===be.StretchedBillBoard?{speedFactor:this.rendererEmitterSettings.speedFactor,lengthFactor:this.rendererEmitterSettings.lengthFactor}:{};var n=this.rendererSettings.instancingGeometry;return e.geometries&&!e.geometries[n.uuid]&&(e.geometries[n.uuid]=n.toJSON()),{version:"2.0",autoDestroy:this.autoDestroy,looping:this.looping,prewarm:this.prewarm,duration:this.duration,shape:this.emitterShape.toJSON(),startLife:this.startLife.toJSON(),startSpeed:this.startSpeed.toJSON(),startRotation:this.startRotation.toJSON(),startSize:this.startSize.toJSON(),startColor:this.startColor.toJSON(),emissionOverTime:this.emissionOverTime.toJSON(),emissionOverDistance:this.emissionOverDistance.toJSON(),emissionBursts:this.emissionBursts.map((function(e){return{time:e.time,count:e.count.toJSON(),probability:e.probability,interval:e.interval,cycle:e.cycle}})),onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry.uuid,renderOrder:this.renderOrder,renderMode:this.renderMode,rendererEmitterSettings:t,material:this.rendererSettings.material.uuid,layers:this.layers.mask,startTileIndex:this.startTileIndex.toJSON(),uTileCount:this.uTileCount,vTileCount:this.vTileCount,behaviors:this.behaviors.map((function(e){return e.toJSON()})),worldSpace:this.worldSpace}}},{key:"addBehavior",value:function addBehavior(e){this.behaviors.push(e)}},{key:"getRendererSettings",value:function getRendererSettings(){return this.rendererSettings}},{key:"clone",value:function clone(){var e,i=[],r=_createForOfIteratorHelper(this.emissionBursts);try{for(r.s();!(e=r.n()).done;){var n=e.value,o={};Object.assign(o,n),i.push(o)}}catch(e){r.e(e)}finally{r.f()}var a,s,l=[],u=_createForOfIteratorHelper(this.behaviors);try{for(u.s();!(a=u.n()).done;){var c=a.value;l.push(c.clone())}}catch(e){u.e(e)}finally{u.f()}s=this.renderMode===be.Trail?{startLength:this.rendererEmitterSettings.startLength.clone(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:{};var d=new t.Layers;return d.mask=this.layers.mask,new ParticleSystem({autoDestroy:this.autoDestroy,looping:this.looping,duration:this.duration,shape:this.emitterShape.clone(),startLife:this.startLife.clone(),startSpeed:this.startSpeed.clone(),startRotation:this.startRotation.clone(),startSize:this.startSize.clone(),startColor:this.startColor.clone(),emissionOverTime:this.emissionOverTime.clone(),emissionOverDistance:this.emissionOverDistance.clone(),emissionBursts:i,onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry,renderMode:this.renderMode,renderOrder:this.renderOrder,rendererEmitterSettings:s,material:this.rendererSettings.material,startTileIndex:this.startTileIndex,uTileCount:this.uTileCount,vTileCount:this.vTileCount,behaviors:l,worldSpace:this.worldSpace,layers:d})}}],[{key:"fromJSON",value:function fromJSON(e,i,r){var n,o,a,s=EmitterFromJSON(e.shape,i);if(e.renderMode===be.Trail){var l=e.rendererEmitterSettings;a={startLength:null!=l.startLength?ValueGeneratorFromJSON(l.startLength):new O(30),followLocalOrigin:l.followLocalOrigin}}else e.renderMode===be.Mesh?a={}:e.renderMode===be.StretchedBillBoard?(a=e.rendererEmitterSettings,null!=e.speedFactor&&(a.speedFactor=e.speedFactor)):a={};var u=new t.Layers;e.layers&&(u.mask=e.layers);var c=new ParticleSystem({autoDestroy:e.autoDestroy,looping:e.looping,prewarm:e.prewarm,duration:e.duration,shape:s,startLife:ValueGeneratorFromJSON(e.startLife),startSpeed:ValueGeneratorFromJSON(e.startSpeed),startRotation:GeneratorFromJSON(e.startRotation),startSize:ValueGeneratorFromJSON(e.startSize),startColor:ColorGeneratorFromJSON(e.startColor),emissionOverTime:ValueGeneratorFromJSON(e.emissionOverTime),emissionOverDistance:ValueGeneratorFromJSON(e.emissionOverDistance),emissionBursts:null===(n=e.emissionBursts)||void 0===n?void 0:n.map((function(e){return{time:e.time,count:"number"==typeof e.count?new O(e.count):ValueGeneratorFromJSON(e.count),probability:e.probability,interval:e.interval,cycle:e.cycle}})),onlyUsedByOther:e.onlyUsedByOther,instancingGeometry:i.geometries[e.instancingGeometry],renderMode:e.renderMode,rendererEmitterSettings:a,renderOrder:e.renderOrder,layers:u,material:e.material?i.materials[e.material]:e.texture?new t.MeshBasicMaterial({map:i.textures[e.texture],transparent:null===(o=e.transparent)||void 0===o||o,blending:e.blending,side:t.DoubleSide}):new t.MeshBasicMaterial({color:16777215,transparent:!0,blending:t.AdditiveBlending,side:t.DoubleSide}),startTileIndex:"number"==typeof e.startTileIndex?new O(e.startTileIndex):ValueGeneratorFromJSON(e.startTileIndex),uTileCount:e.uTileCount,vTileCount:e.vTileCount,behaviors:[],worldSpace:e.worldSpace});return c.behaviors=e.behaviors.map((function(e){var t=BehaviorFromJSON(e,c);return"EmitSubParticleSystem"===t.type&&(r[e.subParticleSystem]=t),t})),c}}]),ParticleSystem}(),Te="\n\n#include <common>\n#include <uv_pars_fragment>\n#include <color_pars_fragment>\n#include <map_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n#include <alphatest_pars_fragment>\n\nvoid main() {\n\n    #include <clipping_planes_fragment>\n    \n    vec3 outgoingLight = vec3( 0.0 );\n    vec4 diffuseColor = vColor;\n    \n    #include <logdepthbuf_fragment>\n    \n    #ifdef USE_MAP\n    diffuseColor *= texture2D( map, vMapUv);\n    #endif\n    \n    #include <alphatest_fragment>\n\n    outgoingLight = diffuseColor.rgb;\n    \n    #ifdef USE_COLOR_AS_ALPHA\n    gl_FragColor = vec4( outgoingLight, diffuseColor.r );\n    #else\n    gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n    #endif\n    \n    \n    #include <tonemapping_fragment>\n\n}\n",Ee="\n\n    #ifdef UV_TILE\n        float col = mod(uvTile, tileCount.x);\n        float row = (tileCount.y - floor(uvTile / tileCount.x) - 1.0);\n        \n        mat3 tileTransform = mat3(\n          1.0 / tileCount.x, 0.0, 0.0,\n          0.0, 1.0 / tileCount.y, 0.0, \n          col / tileCount.x, row / tileCount.y, 1.0);\n    #else\n        mat3 tileTransform = mat3(1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0);\n    #endif\n\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\nvUv = (tileTransform *vec3( uv, 1 )).xy;\n\n#endif\n#ifdef USE_MAP\n\nvMapUv = ( tileTransform * (mapTransform * vec3( MAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ALPHAMAP\n\nvAlphaMapUv = ( tileTransform * (alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_LIGHTMAP\n\nvLightMapUv = ( tileTransform * (lightMapTransform * vec3( LIGHTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_AOMAP\n\nvAoMapUv = ( tileTransform * (aoMapTransform * vec3( AOMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_BUMPMAP\n\nvBumpMapUv = ( tileTransform * (bumpMapTransform * vec3( BUMPMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_NORMALMAP\n\nvNormalMapUv = ( tileTransform * (normalMapTransform * vec3( NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\nvDisplacementMapUv = ( tileTransform * (displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\nvEmissiveMapUv = ( tileTransform * (emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_METALNESSMAP\n\nvMetalnessMapUv = ( tileTransform * (metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\nvRoughnessMapUv = ( tileTransform * (roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\nvAnisotropyMapUv = ( tileTransform * (anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\nvClearcoatMapUv = ( tileTransform * (clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\nvClearcoatNormalMapUv = ( tileTransform * (clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\nvClearcoatRoughnessMapUv = ( tileTransform * (clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\nvIridescenceMapUv = ( tileTransform * (iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\nvIridescenceThicknessMapUv = ( tileTransform * (iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\nvSheenColorMapUv = ( tileTransform * (sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\nvSheenRoughnessMapUv = ( tileTransform * (sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULARMAP\n\nvSpecularMapUv = ( tileTransform * (specularMapTransform * vec3( SPECULARMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\nvSpecularColorMapUv = ( tileTransform * (specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\nvSpecularIntensityMapUv = ( tileTransform * (specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\nvTransmissionMapUv = ( tileTransform * transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\nvThicknessMapUv = ( tileTransform * thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n",ze="\n#include <common>\n#include <color_pars_vertex>\n#include <uv_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nvoid main() {\n\n    ".concat(Ee,"\n\t\n    vec2 alignedPosition = ( position.xy ) * size;\n    \n    vec2 rotatedPosition;\n    rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n    rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n#ifdef HORIZONTAL\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.x += rotatedPosition.x;\n    mvPosition.z -= rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n#elif defined(VERTICAL)\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.y += rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n    mvPosition.x += rotatedPosition.x;\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    mvPosition.xy += rotatedPosition;\n#endif\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n"),Ae="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\n// attribute vec4 color;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nvoid main() {\n\n    ".concat(Ee,"\n    \n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n    \n    mat4 matrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n    \n    vec4 mvPosition = modelViewMatrix * (matrix * vec4( position, 1.0 ));\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n"),Je="\n#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n    ".concat(Ee,"\n\n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n\n    mat4 particleMatrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\n\t// replace defaultnormal_vertex\n\tvec3 transformedNormal = objectNormal;\n    mat3 m = mat3( particleMatrix );\n    transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n    transformedNormal = m * transformedNormal;\n    transformedNormal = normalMatrix * transformedNormal;\n    #ifdef FLIP_SIDED\n        transformedNormal = - transformedNormal;\n    #endif\n    #ifdef USE_TANGENT\n        vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n        #ifdef FLIP_SIDED\n        transformedTangent = - transformedTangent;\n        #endif\n    #endif\n\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\n\t// replace include <project_vertex>\n  vec4 mvPosition = vec4( transformed, 1.0 );\n  mvPosition = modelViewMatrix * (particleMatrix * mvPosition);\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n\tvViewPosition = - mvPosition.xyz;\n\t\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}\n"),Le="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute vec4 velocity;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nuniform float speedFactor;\n\nvoid main() {\n\n    ".concat(Ee,"\n    \n    float lengthFactor = velocity.w;\n#ifdef USE_SKEW\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n\n    vec3 scaledPos = vec3(position.xy * size, position.z);\n    float vlength = length(viewVelocity);\n    vec3 projVelocity =  dot(scaledPos, viewVelocity) * viewVelocity / vlength;\n    mvPosition.xyz += scaledPos + projVelocity * (speedFactor / size + lengthFactor / vlength);\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n    float vlength = length(viewVelocity); \n    mvPosition.xyz += position.y * normalize(cross(mvPosition.xyz, viewVelocity)) * size; // switch the cross to  match unity implementation\n    mvPosition.xyz -= (position.x + 0.5) * viewVelocity * (1.0 + lengthFactor / vlength) * size; // minus position.x to match unity implementation\n#endif\n\tvColor = color;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n");function getMaterialUVChannelName(e){return 0===e?"uv":"uv".concat(e)}new t.Vector3(0,0,1);var Ue=function(e){_inherits(SpriteBatch,e);var i=_createSuper(SpriteBatch);function SpriteBatch(e){var r;return _classCallCheck(this,SpriteBatch),_defineProperty(_assertThisInitialized(r=i.call(this,e)),"offsetBuffer",void 0),_defineProperty(_assertThisInitialized(r),"rotationBuffer",void 0),_defineProperty(_assertThisInitialized(r),"sizeBuffer",void 0),_defineProperty(_assertThisInitialized(r),"colorBuffer",void 0),_defineProperty(_assertThisInitialized(r),"uvTileBuffer",void 0),_defineProperty(_assertThisInitialized(r),"velocityBuffer",void 0),_defineProperty(_assertThisInitialized(r),"vector_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector2_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector3_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"quaternion_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"quaternion2_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"quaternion3_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"rotationMat_",new t.Matrix3),_defineProperty(_assertThisInitialized(r),"rotationMat2_",new t.Matrix3),r.maxParticles=1e3,r.setupBuffers(),r.rebuildMaterial(),r}return _createClass(SpriteBatch,[{key:"buildExpandableBuffers",value:function buildExpandableBuffers(){this.offsetBuffer=new t.InstancedBufferAttribute(new Float32Array(3*this.maxParticles),3),this.offsetBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("offset",this.offsetBuffer),this.colorBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.colorBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("color",this.colorBuffer),this.settings.renderMode===be.Mesh?(this.rotationBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.rotationBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("rotation",this.rotationBuffer)):this.settings.renderMode!==be.BillBoard&&this.settings.renderMode!==be.HorizontalBillBoard&&this.settings.renderMode!==be.VerticalBillBoard&&this.settings.renderMode!==be.StretchedBillBoard||(this.rotationBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.rotationBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("rotation",this.rotationBuffer)),this.sizeBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.sizeBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("size",this.sizeBuffer),this.uvTileBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.uvTileBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("uvTile",this.uvTileBuffer),this.settings.renderMode===be.StretchedBillBoard&&(this.velocityBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.velocityBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("velocity",this.velocityBuffer))}},{key:"setupBuffers",value:function setupBuffers(){this.geometry&&this.geometry.dispose(),this.geometry=new t.InstancedBufferGeometry,this.geometry.setIndex(this.settings.instancingGeometry.getIndex()),this.settings.instancingGeometry.hasAttribute("normal")&&this.geometry.setAttribute("normal",this.settings.instancingGeometry.getAttribute("normal")),this.geometry.setAttribute("position",this.settings.instancingGeometry.getAttribute("position")),this.geometry.setAttribute("uv",this.settings.instancingGeometry.getAttribute("uv")),this.buildExpandableBuffers()}},{key:"expandBuffers",value:function expandBuffers(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function rebuildMaterial(){var e;this.layers.mask=this.settings.layers.mask;var i={};if("MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type){var r=this.settings.material;(e=t.UniformsUtils.merge([t.UniformsLib.common,t.UniformsLib.envmap,t.UniformsLib.aomap,t.UniformsLib.lightmap,t.UniformsLib.emissivemap,t.UniformsLib.bumpmap,t.UniformsLib.normalmap,t.UniformsLib.displacementmap,t.UniformsLib.roughnessmap,t.UniformsLib.metalnessmap,t.UniformsLib.fog,t.UniformsLib.lights,{emissive:{value:new t.Color(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}])).diffuse.value=r.color,e.opacity.value=r.opacity,e.emissive.value=r.emissive,e.roughness.value=r.roughness,e.metalness.value=r.metalness,r.envMap&&(e.envMap.value=r.envMap,e.envMapIntensity.value=r.envMapIntensity),r.normalMap&&(e.normalMap.value=r.normalMap,e.normalScale.value=r.normalScale),r.roughnessMap&&(e.roughnessMap.value=r.roughnessMap),r.metalnessMap&&(e.metalnessMap.value=r.metalnessMap),r.map&&(e.map=new t.Uniform(r.map))}else(e={}).map=new t.Uniform(this.settings.material.map);this.settings.material.alphaTest&&(i.USE_ALPHATEST="",e.alphaTest=new t.Uniform(this.settings.material.alphaTest)),i.USE_UV="";var n=this.settings.uTileCount,o=this.settings.vTileCount;(n>1||o>1)&&(i.UV_TILE="",e.tileCount=new t.Uniform(new t.Vector2(n,o))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(i.USE_COLOR_AS_ALPHA=""),this.settings.material.normalMap&&(i.USE_NORMALMAP="",i.NORMALMAP_UV=getMaterialUVChannelName(this.settings.material.normalMap.channel),e.normalMapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.normalMap.matrix))),this.settings.material.map&&(i.USE_MAP="",i.MAP_UV=getMaterialUVChannelName(this.settings.material.map.channel),e.mapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.map.matrix))),i.USE_COLOR_ALPHA="";var a=!1;if(this.settings.renderMode===be.BillBoard||this.settings.renderMode===be.VerticalBillBoard||this.settings.renderMode===be.HorizontalBillBoard||this.settings.renderMode===be.Mesh){var s,l;this.settings.renderMode===be.Mesh?"MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type?(i.USE_COLOR="",s=Je,l="\n#define STANDARD\n#ifdef PHYSICAL\n#define IOR\n#define SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\nuniform float ior;\n#endif\n#ifdef SPECULAR\nuniform float specularIntensity;\nuniform vec3 specularColor;\n#ifdef USE_SPECULARINTENSITYMAP\nuniform sampler2D specularIntensityMap;\n#endif\n#ifdef USE_SPECULARCOLORMAP\nuniform sampler2D specularColorMap;\n#endif\n#endif\n#ifdef USE_CLEARCOAT\nuniform float clearcoat;\nuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\nuniform float iridescence;\nuniform float iridescenceIOR;\nuniform float iridescenceThicknessMinimum;\nuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\nuniform vec3 sheenColor;\nuniform float sheenRoughness;\n#ifdef USE_SHEENCOLORMAP\nuniform sampler2D sheenColorMap;\n#endif\n#ifdef USE_SHEENROUGHNESSMAP\nuniform sampler2D sheenRoughnessMap;\n#endif\n#endif\n\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n    #include <clipping_planes_fragment>\n    vec4 diffuseColor = vec4( diffuse, opacity );\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    vec3 totalEmissiveRadiance = emissive;\n    #include <logdepthbuf_fragment>\n    #include <map_fragment>\n    #include <color_fragment>\n    #include <alphamap_fragment>\n    #include <alphatest_fragment>\n    #include <roughnessmap_fragment>\n    #include <metalnessmap_fragment>\n    #include <normal_fragment_begin>\n    #include <normal_fragment_maps>\n    #include <clearcoat_normal_fragment_begin>\n    #include <clearcoat_normal_fragment_maps>\n    #include <emissivemap_fragment>\n    // accumulation\n    #include <lights_physical_fragment>\n    #include <lights_fragment_begin>\n    #include <lights_fragment_maps>\n    #include <lights_fragment_end>\n    // modulation\n    #include <aomap_fragment>\n    vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n    vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n    #include <transmission_fragment>\n    vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n    #ifdef USE_SHEEN\n    // Sheen energy compensation approximation calculation can be found at the end of\n        // https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\n        float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n        outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;\n    #endif\n    #ifdef USE_CLEARCOAT\n        float dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n        vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n        outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;\n    #endif\n    #include <output_fragment>\n    #include <tonemapping_fragment>\n    #include <encodings_fragment>\n    #include <fog_fragment>\n    #include <premultiplied_alpha_fragment>\n    #include <dithering_fragment>\n}",a=!0):(s=Ae,l=Te):(s=ze,l=Te),this.settings.renderMode===be.VerticalBillBoard?i.VERTICAL="":this.settings.renderMode===be.HorizontalBillBoard&&(i.HORIZONTAL=""),this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:s,fragmentShader:l,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest,lights:a})}else{if(this.settings.renderMode!==be.StretchedBillBoard)throw new Error("render mode unavailable");e.speedFactor=new t.Uniform(1),this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:Le,fragmentShader:Te,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest})}}},{key:"update",value:function update(){var e=this,t=0,i=0;this.systems.forEach((function(e){i+=e.particleNum})),i>this.maxParticles&&this.expandBuffers(i),this.systems.forEach((function(i){var r=i.particles,n=i.particleNum,o=e.quaternion2_,a=e.vector2_,s=e.vector3_;i.emitter.matrixWorld.decompose(a,o,s),e.rotationMat_.setFromMatrix4(i.emitter.matrixWorld);for(var l=0;l<n;l++,t++){var u=r[l];if(e.settings.renderMode===be.Mesh){var c=void 0;if(i.worldSpace)c=u.rotation;else{var d=void 0;d=u.parentMatrix?e.quaternion3_.setFromRotationMatrix(u.parentMatrix):o,(c=e.quaternion_).copy(u.rotation).multiply(d)}e.rotationBuffer.setXYZW(t,c.x,c.y,c.z,c.w)}else e.settings.renderMode!==be.StretchedBillBoard&&e.settings.renderMode!==be.VerticalBillBoard&&e.settings.renderMode!==be.HorizontalBillBoard&&e.settings.renderMode!==be.BillBoard||e.rotationBuffer.setX(t,u.rotation);var h=void 0;if(i.worldSpace?h=u.position:(h=e.vector_,u.parentMatrix?h.copy(u.position).applyMatrix4(u.parentMatrix):h.copy(u.position).applyMatrix4(i.emitter.matrixWorld)),e.offsetBuffer.setXYZ(t,h.x,h.y,h.z),e.colorBuffer.setXYZW(t,u.color.x,u.color.y,u.color.z,u.color.w),i.worldSpace||u.parentMatrix?e.sizeBuffer.setX(t,u.size):e.sizeBuffer.setX(t,u.size*(Math.abs(s.x)+Math.abs(s.y)+Math.abs(s.z))/3),e.uvTileBuffer.setX(t,u.uvTile),e.settings.renderMode===be.StretchedBillBoard&&e.velocityBuffer){var f=i.rendererEmitterSettings.speedFactor;0===f&&(f=.001);var p=i.rendererEmitterSettings.lengthFactor,m=void 0;i.worldSpace?m=u.velocity:(m=e.vector_,u.parentMatrix?(e.rotationMat2_.setFromMatrix4(u.parentMatrix),m.copy(u.velocity).applyMatrix3(e.rotationMat2_)):m.copy(u.velocity).applyMatrix3(e.rotationMat_)),e.velocityBuffer.setXYZW(t,m.x*f,m.y*f,m.z*f,p)}}})),this.geometry.instanceCount=t,t>0&&(this.offsetBuffer.updateRange.count=3*t,this.offsetBuffer.needsUpdate=!0,this.sizeBuffer.updateRange.count=t,this.sizeBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.uvTileBuffer.updateRange.count=t,this.uvTileBuffer.needsUpdate=!0,this.settings.renderMode===be.StretchedBillBoard&&this.velocityBuffer&&(this.velocityBuffer.updateRange.count=4*t,this.velocityBuffer.needsUpdate=!0),this.settings.renderMode===be.Mesh?(this.rotationBuffer.updateRange.count=4*t,this.rotationBuffer.needsUpdate=!0):this.settings.renderMode!==be.StretchedBillBoard&&this.settings.renderMode!==be.HorizontalBillBoard&&this.settings.renderMode!==be.VerticalBillBoard&&this.settings.renderMode!==be.BillBoard||(this.rotationBuffer.updateRange.count=t,this.rotationBuffer.needsUpdate=!0))}},{key:"dispose",value:function dispose(){this.geometry.dispose()}}]),SpriteBatch}(Ne),Re="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <fog_pars_vertex>\n\nattribute vec3 previous;\nattribute vec3 next;\nattribute float side;\nattribute float width;\n\nuniform vec2 resolution;\nuniform float lineWidth;\nuniform float sizeAttenuation;\n    \nvec2 fix(vec4 i, float aspect) {\n    vec2 res = i.xy / i.w;\n    res.x *= aspect;\n    return res;\n}\n    \nvoid main() {\n\n    ".concat(Ee,"\n    \n    float aspect = resolution.x / resolution.y;\n\n    vColor = color;\n\n    mat4 m = projectionMatrix * modelViewMatrix;\n    vec4 finalPosition = m * vec4( position, 1.0 );\n    vec4 prevPos = m * vec4( previous, 1.0 );\n    vec4 nextPos = m * vec4( next, 1.0 );\n\n    vec2 currentP = fix( finalPosition, aspect );\n    vec2 prevP = fix( prevPos, aspect );\n    vec2 nextP = fix( nextPos, aspect );\n\n    float w = lineWidth * width;\n\n    vec2 dir;\n    if( nextP == currentP ) dir = normalize( currentP - prevP );\n    else if( prevP == currentP ) dir = normalize( nextP - currentP );\n    else {\n        vec2 dir1 = normalize( currentP - prevP );\n        vec2 dir2 = normalize( nextP - currentP );\n        dir = normalize( dir1 + dir2 );\n\n        vec2 perp = vec2( -dir1.y, dir1.x );\n        vec2 miter = vec2( -dir.y, dir.x );\n        //w = clamp( w / dot( miter, perp ), 0., 4., * lineWidth * width );\n\n    }\n\n    //vec2 normal = ( cross( vec3( dir, 0. ) vec3( 0., 0., 1. ) ) ).xy;\n    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );\n    normal.xy *= .5 * w;\n    normal *= projectionMatrix;\n    if( sizeAttenuation == 0. ) {\n        normal.xy *= finalPosition.w;\n        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;\n    }\n\n    finalPosition.xy += normal.xy * side;\n\n    gl_Position = finalPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    \n\t#include <fog_vertex>\n}");new t.Vector3(0,0,1);var Fe=function(e){_inherits(TrailBatch,e);var i=_createSuper(TrailBatch);function TrailBatch(e){var r;return _classCallCheck(this,TrailBatch),_defineProperty(_assertThisInitialized(r=i.call(this,e)),"positionBuffer",void 0),_defineProperty(_assertThisInitialized(r),"previousBuffer",void 0),_defineProperty(_assertThisInitialized(r),"nextBuffer",void 0),_defineProperty(_assertThisInitialized(r),"uvBuffer",void 0),_defineProperty(_assertThisInitialized(r),"sideBuffer",void 0),_defineProperty(_assertThisInitialized(r),"widthBuffer",void 0),_defineProperty(_assertThisInitialized(r),"colorBuffer",void 0),_defineProperty(_assertThisInitialized(r),"indexBuffer",void 0),_defineProperty(_assertThisInitialized(r),"vector_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector2_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector3_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"quaternion_",new t.Quaternion),r.maxParticles=1e4,r.setupBuffers(),r.rebuildMaterial(),r}return _createClass(TrailBatch,[{key:"setupBuffers",value:function setupBuffers(){this.geometry&&this.geometry.dispose(),this.geometry=new t.BufferGeometry,this.indexBuffer=new t.BufferAttribute(new Uint32Array(6*this.maxParticles),1),this.indexBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setIndex(this.indexBuffer),this.positionBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.positionBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("position",this.positionBuffer),this.previousBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.previousBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("previous",this.previousBuffer),this.nextBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.nextBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("next",this.nextBuffer),this.widthBuffer=new t.BufferAttribute(new Float32Array(2*this.maxParticles),1),this.widthBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("width",this.widthBuffer),this.sideBuffer=new t.BufferAttribute(new Float32Array(2*this.maxParticles),1),this.sideBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("side",this.sideBuffer),this.uvBuffer=new t.BufferAttribute(new Float32Array(4*this.maxParticles),2),this.uvBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("uv",this.uvBuffer),this.colorBuffer=new t.BufferAttribute(new Float32Array(8*this.maxParticles),4),this.colorBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("color",this.colorBuffer)}},{key:"expandBuffers",value:function expandBuffers(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function rebuildMaterial(){this.layers.mask=this.settings.layers.mask;var e={lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},resolution:{value:new t.Vector2(1,1)},sizeAttenuation:{value:1},visibility:{value:1},alphaTest:{value:0},repeat:{value:new t.Vector2(1,1)}},i={USE_UV:"",USE_COLOR_ALPHA:""};if(this.settings.material.map&&(i.USE_MAP="",i.MAP_UV=getMaterialUVChannelName(this.settings.material.map.channel),e.map=new t.Uniform(this.settings.material.map),e.mapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.map.matrix))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(i.USE_COLOR_AS_ALPHA=""),this.settings.renderMode!==be.Trail)throw new Error("render mode unavailable");this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:Re,fragmentShader:"\n\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nuniform sampler2D alphaMap;\nuniform float useAlphaMap;\nuniform float visibility;\nuniform float alphaTest;\nuniform vec2 repeat;\n\nvarying vec4 vColor;\n    \nvoid main() {\n    #include <clipping_planes_fragment>\n    #include <logdepthbuf_fragment>\n\n    vec4 c = vColor;\n    \n    #ifdef USE_MAP\n    #ifdef USE_COLOR_AS_ALPHA\n    vec4 tex = texture2D( map, vUv * repeat );\n    c *= vec4(tex.rgb, tex.r);\n    #else\n    c *= texture2D( map, vUv * repeat );\n    #endif\n    #endif\n    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUv * repeat ).a;\n    if( c.a < alphaTest ) discard;\n    gl_FragColor = c;\n\n    #include <fog_fragment>\n    #include <tonemapping_fragment>\n}",transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,side:this.settings.material.side,blending:this.settings.material.blending||t.AdditiveBlending})}},{key:"update",value:function update(){var e=this,t=0,i=0,r=0;this.systems.forEach((function(e){for(var t=0;t<e.particleNum;t++)r+=2*e.particles[t].previous.length})),r>this.maxParticles&&this.expandBuffers(r),this.systems.forEach((function(r){var n=e.quaternion_,o=e.vector2_,a=e.vector3_;r.emitter.matrixWorld.decompose(o,n,a);for(var s=r.particles,l=r.particleNum,u=e.settings.uTileCount,c=e.settings.vTileCount,d=1/u,h=1/c,f=0;f<l;f++){var p=s[f],m=p.uvTile%c,y=Math.floor(p.uvTile/c),v=p.previous.values(),g=v.next(),S=g.value,_=S;g.done||(g=v.next());var w=void 0;w=void 0!==g.value?g.value:_;for(var O=0;O<p.previous.length;O++,t+=2){if(e.positionBuffer.setXYZ(t,_.position.x,_.position.y,_.position.z),e.positionBuffer.setXYZ(t+1,_.position.x,_.position.y,_.position.z),r.worldSpace?(e.positionBuffer.setXYZ(t,_.position.x,_.position.y,_.position.z),e.positionBuffer.setXYZ(t+1,_.position.x,_.position.y,_.position.z)):(p.parentMatrix?e.vector_.copy(_.position).applyMatrix4(p.parentMatrix):e.vector_.copy(_.position).applyMatrix4(r.emitter.matrixWorld),e.positionBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.positionBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),r.worldSpace?(e.previousBuffer.setXYZ(t,S.position.x,S.position.y,S.position.z),e.previousBuffer.setXYZ(t+1,S.position.x,S.position.y,S.position.z)):(p.parentMatrix?e.vector_.copy(S.position).applyMatrix4(p.parentMatrix):e.vector_.copy(S.position).applyMatrix4(r.emitter.matrixWorld),e.previousBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.previousBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),r.worldSpace?(e.nextBuffer.setXYZ(t,w.position.x,w.position.y,w.position.z),e.nextBuffer.setXYZ(t+1,w.position.x,w.position.y,w.position.z)):(p.parentMatrix?e.vector_.copy(w.position).applyMatrix4(p.parentMatrix):e.vector_.copy(w.position).applyMatrix4(r.emitter.matrixWorld),e.nextBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.nextBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),e.sideBuffer.setX(t,-1),e.sideBuffer.setX(t+1,1),r.worldSpace)e.widthBuffer.setX(t,_.size),e.widthBuffer.setX(t+1,_.size);else if(p.parentMatrix)e.widthBuffer.setX(t,_.size),e.widthBuffer.setX(t+1,_.size);else{var x=(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z))/3;e.widthBuffer.setX(t,_.size*x),e.widthBuffer.setX(t+1,_.size*x)}e.uvBuffer.setXY(t,(O/p.previous.length+m)*d,(c-y-1)*h),e.uvBuffer.setXY(t+1,(O/p.previous.length+m)*d,(c-y)*h),e.colorBuffer.setXYZW(t,_.color.x,_.color.y,_.color.z,_.color.w),e.colorBuffer.setXYZW(t+1,_.color.x,_.color.y,_.color.z,_.color.w),O+1<p.previous.length&&(e.indexBuffer.setX(3*i,t),e.indexBuffer.setX(3*i+1,t+1),e.indexBuffer.setX(3*i+2,t+2),i++,e.indexBuffer.setX(3*i,t+2),e.indexBuffer.setX(3*i+1,t+1),e.indexBuffer.setX(3*i+2,t+3),i++),S=_,_=w,g.done||void 0!==(g=v.next()).value&&(w=g.value)}}})),this.positionBuffer.updateRange.count=3*t,this.positionBuffer.needsUpdate=!0,this.previousBuffer.updateRange.count=3*t,this.previousBuffer.needsUpdate=!0,this.nextBuffer.updateRange.count=3*t,this.nextBuffer.needsUpdate=!0,this.sideBuffer.updateRange.count=t,this.sideBuffer.needsUpdate=!0,this.widthBuffer.updateRange.count=t,this.widthBuffer.needsUpdate=!0,this.uvBuffer.updateRange.count=2*t,this.uvBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.indexBuffer.updateRange.count=3*i,this.indexBuffer.needsUpdate=!0,this.geometry.setDrawRange(0,3*i)}},{key:"dispose",value:function dispose(){this.geometry.dispose()}}]),TrailBatch}(Ne),Ie=function(e){_inherits(BatchedRenderer,e);var t=_createSuper(BatchedRenderer);function BatchedRenderer(){var e;return _classCallCheck(this,BatchedRenderer),_defineProperty(_assertThisInitialized(e=t.call(this)),"batches",[]),_defineProperty(_assertThisInitialized(e),"systemToBatchIndex",new Map),_defineProperty(_assertThisInitialized(e),"type","BatchedRenderer"),e}return _createClass(BatchedRenderer,[{key:"addSystem",value:function addSystem(e){e._renderer=this;for(var t,i=e.getRendererSettings(),r=0;r<this.batches.length;r++)if(BatchedRenderer.equals(this.batches[r].settings,i))return this.batches[r].addSystem(e),void this.systemToBatchIndex.set(e,r);switch(i.renderMode){case be.Trail:t=new Fe(i);break;case be.Mesh:case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:case be.StretchedBillBoard:t=new Ue(i)}t.addSystem(e),this.batches.push(t),this.systemToBatchIndex.set(e,this.batches.length-1),this.add(t)}},{key:"deleteSystem",value:function deleteSystem(e){var t=this.systemToBatchIndex.get(e);null!=t&&(this.batches[t].removeSystem(e),this.systemToBatchIndex.delete(e))}},{key:"updateSystem",value:function updateSystem(e){this.deleteSystem(e),this.addSystem(e)}},{key:"update",value:function update(e){this.systemToBatchIndex.forEach((function(t,i){i.update(e)}));for(var t=0;t<this.batches.length;t++)this.batches[t].update()}}],[{key:"equals",value:function equals(e,t){return e.material.side===t.material.side&&e.material.blending===t.material.blending&&e.material.transparent===t.material.transparent&&e.material.type===t.material.type&&e.material.alphaTest===t.material.alphaTest&&e.material.map===t.material.map&&e.renderMode===t.renderMode&&e.uTileCount===t.uTileCount&&e.vTileCount===t.vTileCount&&e.instancingGeometry===t.instancingGeometry&&e.renderOrder===t.renderOrder&&e.layers.mask===t.layers.mask}}]),BatchedRenderer}(t.Object3D),Ge=Ie,De=function(e){_inherits(QuarksLoader,e);var i=_createSuper(QuarksLoader);function QuarksLoader(e){return _classCallCheck(this,QuarksLoader),i.call(this,e)}return _createClass(QuarksLoader,[{key:"linkReference",value:function linkReference(e){var t={};e.traverse((function(e){t[e.uuid]=e})),e.traverse((function(e){if("ParticleEmitter"===e.type){var i=e.system;i.emitterShape;for(var r=0;r<i.behaviors.length;r++)i.behaviors[r]instanceof j&&(i.behaviors[r].subParticleSystem=t[i.behaviors[r].subParticleSystem])}}))}},{key:"parse",value:function parse(e,t){var i=_get(_getPrototypeOf(QuarksLoader.prototype),"parse",this).call(this,e,t);return this.linkReference(i),i}},{key:"parseObject",value:function parseObject(e,i,r,n,o){var a,s,l;function getGeometry(e){return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),i[e]}function getMaterial(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],i=0,n=e.length;i<n;i++){var o=e[i];void 0===r[o]&&console.warn("THREE.ObjectLoader: Undefined material",o),t.push(r[o])}return t}return void 0===r[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),r[e]}}function getTexture(e){return void 0===n[e]&&console.warn("THREE.ObjectLoader: Undefined texture",e),n[e]}var u={textures:n,geometries:i,materials:r};switch(e.type){case"ParticleEmitter":a=Be.fromJSON(e.ps,u,{}).emitter;break;case"Scene":a=new t.Scene,void 0!==e.background&&(Number.isInteger(e.background)?a.background=new t.Color(e.background):a.background=getTexture(e.background)),void 0!==e.environment&&(a.environment=getTexture(e.environment)),void 0!==e.fog&&("Fog"===e.fog.type?a.fog=new t.Fog(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(a.fog=new t.FogExp2(e.fog.color,e.fog.density))),void 0!==e.backgroundBlurriness&&(a.backgroundBlurriness=e.backgroundBlurriness);break;case"PerspectiveCamera":a=new t.PerspectiveCamera(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(a.focus=e.focus),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.filmGauge&&(a.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(a.filmOffset=e.filmOffset),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"OrthographicCamera":a=new t.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"AmbientLight":a=new t.AmbientLight(e.color,e.intensity);break;case"DirectionalLight":a=new t.DirectionalLight(e.color,e.intensity);break;case"PointLight":a=new t.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":a=new t.RectAreaLight(e.color,e.intensity,e.width,e.height);break;case"SpotLight":a=new t.SpotLight(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay);break;case"HemisphereLight":a=new t.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"LightProbe":a=(new t.LightProbe).fromJSON(e);break;case"SkinnedMesh":s=getGeometry(e.geometry),l=getMaterial(e.material),a=new t.SkinnedMesh(s,l),void 0!==e.bindMode&&(a.bindMode=e.bindMode),void 0!==e.bindMatrix&&a.bindMatrix.fromArray(e.bindMatrix),void 0!==e.skeleton&&(a.skeleton=e.skeleton);break;case"Mesh":s=getGeometry(e.geometry),l=getMaterial(e.material),a=new t.Mesh(s,l);break;case"InstancedMesh":s=getGeometry(e.geometry),l=getMaterial(e.material);var c=e.count,d=e.instanceMatrix,h=e.instanceColor;(a=new t.InstancedMesh(s,l,c)).instanceMatrix=new t.InstancedBufferAttribute(new Float32Array(d.array),16),void 0!==h&&(a.instanceColor=new t.InstancedBufferAttribute(new Float32Array(h.array),h.itemSize));break;case"LOD":a=new t.LOD;break;case"Line":a=new t.Line(getGeometry(e.geometry),getMaterial(e.material));break;case"LineLoop":a=new t.LineLoop(getGeometry(e.geometry),getMaterial(e.material));break;case"LineSegments":a=new t.LineSegments(getGeometry(e.geometry),getMaterial(e.material));break;case"PointCloud":case"Points":a=new t.Points(getGeometry(e.geometry),getMaterial(e.material));break;case"Sprite":a=new t.Sprite(getMaterial(e.material));break;case"Group":a=new t.Group;break;case"Bone":a=new t.Bone;break;default:a=new t.Object3D}if(a.uuid=e.uuid,void 0!==e.name&&(a.name=e.name),void 0!==e.matrix?(a.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(a.matrixAutoUpdate=e.matrixAutoUpdate),a.matrixAutoUpdate&&a.matrix.decompose(a.position,a.quaternion,a.scale)):(void 0!==e.position&&a.position.fromArray(e.position),void 0!==e.rotation&&a.rotation.fromArray(e.rotation),void 0!==e.quaternion&&a.quaternion.fromArray(e.quaternion),void 0!==e.scale&&a.scale.fromArray(e.scale)),void 0!==e.castShadow&&(a.castShadow=e.castShadow),void 0!==e.receiveShadow&&(a.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(a.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(a.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(a.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&a.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(a.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(a.visible=e.visible),void 0!==e.frustumCulled&&(a.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(a.renderOrder=e.renderOrder),void 0!==e.userData&&(a.userData=e.userData),void 0!==e.layers&&(a.layers.mask=e.layers),void 0!==e.children)for(var f=e.children,p=0;p<f.length;p++)a.add(this.parseObject(f[p],i,r,n,o));if(void 0!==e.animations)for(var m=e.animations,y=0;y<m.length;y++){var v=m[y];a.animations.push(o[v])}if("LOD"===e.type){void 0!==e.autoUpdate&&(a.autoUpdate=e.autoUpdate);for(var g=e.levels,S=0;S<g.length;S++){var _=g[S],w=a.getObjectByProperty("uuid",_.object);void 0!==w&&a.addLevel(w,_.distance)}}return a}}]),QuarksLoader}(t.ObjectLoader),qe=[],Xe=function(e){return e[e.Number=0]="Number",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Boolean=4]="Boolean",e[e.AnyType=5]="AnyType",e[e.NullableAnyType=6]="NullableAnyType",e[e.EventStream=7]="EventStream",e}({}),je=function genDefaultForNodeValueType(e){switch(e){case Xe.Boolean:return!1;case Xe.Number:return 0;case Xe.Vec2:return new t.Vector2;case Xe.Vec3:return new t.Vector3;case Xe.Vec4:return new t.Vector4;case Xe.AnyType:return 0;case Xe.NullableAnyType:return}},He=function(){function Node(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck(this,Node),_defineProperty(this,"id",void 0),_defineProperty(this,"inputs",[]),_defineProperty(this,"outputs",[]),_defineProperty(this,"type",void 0),_defineProperty(this,"signatureIndex",-1),_defineProperty(this,"data",void 0),_defineProperty(this,"position",new t.Vector2),_defineProperty(this,"outputValues",[]),this.id=""+Math.round(1e5*Math.random()),this.type=e,this.signatureIndex=i,this.data=r;for(var n=-1===i?0:i,o=0;o<e.nodeTypeSignatures[n].inputTypes.length;o++)this.inputs.push(void 0);for(var a=0;a<e.nodeTypeSignatures[n].outputTypes.length;a++)this.outputs.push([]),this.outputValues.push(je(e.nodeTypeSignatures[n].outputTypes[a]))}return _createClass(Node,[{key:"inputTypes",get:function get(){var e=-1===this.signatureIndex?0:this.signatureIndex;return this.type.nodeTypeSignatures[e].inputTypes}},{key:"outputTypes",get:function get(){var e=-1===this.signatureIndex?0:this.signatureIndex;return this.type.nodeTypeSignatures[e].outputTypes}},{key:"func",value:function func(e,t,i){var r=-1===this.signatureIndex?0:this.signatureIndex;this.type.nodeTypeSignatures[r].func(e,this.data,t,i)}}]),Node}(),We=_createClass((function Wire(e,t,i,r){_classCallCheck(this,Wire),_defineProperty(this,"input",void 0),_defineProperty(this,"inputIndex",void 0),_defineProperty(this,"output",void 0),_defineProperty(this,"outputIndex",void 0),this.input=e,this.inputIndex=t,this.input.outputs[t].push(this),this.output=i,this.outputIndex=r,this.output.inputs[r]=this})),Qe=function(){function BaseCompiler(){_classCallCheck(this,BaseCompiler),_defineProperty(this,"visited",new Set),BaseCompiler.Instance=this}return _createClass(BaseCompiler,[{key:"buildExecutionOrder",value:function buildExecutionOrder(e,t){e.nodesInOrder.length=0,this.visited.clear();for(var i=0;i<e.outputNodes.length;i++){var r=e.outputNodes[i];void 0!==r.inputs[0]&&this._traverse(r,e,t)}e.compiled=!0}},{key:"_traverse",value:function _traverse(e,t,i){this.visited.add(e.id);for(var r=0;r<e.inputs.length;r++)if(e.inputs[r]instanceof We){var n=e.inputs[r].input;this.visited.has(n.id)||this._traverse(n,t,i)}else e.inputs[r];t.nodesInOrder.push(e)}}]),BaseCompiler}();_defineProperty(Qe,"Instance",void 0);var Ye=function(e){_inherits(Interpreter,e);var t=_createSuper(Interpreter);function Interpreter(){return _classCallCheck(this,Interpreter),t.call(this)}return _createClass(Interpreter,[{key:"executeCompiledGraph",value:function executeCompiledGraph(e,t){for(var i=e.nodesInOrder,r=0;r<i.length;r++){for(var n=[],o=i[r],a=0;a<o.inputs.length;a++)o.inputs[a]instanceof We?n.push(o.inputs[a].input.outputValues[o.inputs[a].inputIndex]):void 0!==o.inputs[a]?n.push(o.inputs[a].getValue(t)):n.push(void 0);o.func(t,n,o.outputValues)}}},{key:"run",value:function run(e,t){e.compiled||this.buildExecutionOrder(e,t),this.executeCompiledGraph(e,t)}}]),Interpreter}(Qe),Ze=function(){function NodeType(e){_classCallCheck(this,NodeType),_defineProperty(this,"name",void 0),_defineProperty(this,"nodeTypeSignatures",[]),this.name=e}return _createClass(NodeType,[{key:"addSignature",value:function addSignature(e,t,i){this.nodeTypeSignatures.push({inputTypes:e,outputTypes:t,func:i})}}]),NodeType}(),Ke=function(e){_inherits(GraphNodeType,e);var t=_createSuper(GraphNodeType);function GraphNodeType(e){var i;_classCallCheck(this,GraphNodeType);for(var r=[],n=0;n<e.inputNodes.length;n++)"input"===e.inputNodes[n].type.name&&r.push(e.inputNodes[n].data.type);for(var o=[],a=0;a<e.outputNodes.length;a++)"output"===e.outputNodes[a].type.name&&o.push(e.outputNodes[a].data.type);return _defineProperty(_assertThisInitialized(i=t.call(this,e.name)),"nodeGraph",void 0),i.addSignature(r,o,(function(t,i,r,n){t.inputs=r,t.outputs=n,Ye.Instance.run(e,t)})),i.nodeGraph=e,i}return _createClass(GraphNodeType)}(Ze),$e={},et=new Ze("add");et.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]+i[1]})),et.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),et.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),et.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),$e.add=et;var tt=new Ze("sub");tt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]-i[1]})),tt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),tt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),tt.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),$e.sub=tt;var it=new Ze("mul");it.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]*i[1]})),it.addSignature([Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),it.addSignature([Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),it.addSignature([Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),$e.mul=it;var rt=new Ze("div");rt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]/i[1]})),rt.addSignature([Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),rt.addSignature([Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),rt.addSignature([Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),$e.div=rt;var nt=new Ze("sin");nt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.sin(i[0])})),$e.sin=nt;var ot=new Ze("cos");ot.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.cos(i[0])})),$e.cos=ot;var at=new Ze("tan");at.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.tan(i[0])})),$e.tan=at;var st=new Ze("abs");st.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.abs(i[0])})),$e.abs=st;var lt=new Ze("min");lt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.min(i[0],i[1])})),$e.min=lt;var ut=new Ze("max");ut.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.max(i[0],i[1])})),$e.max=ut;var ct=new Ze("dot");ct.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),ct.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),ct.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),$e.dot=ct;var dt=new Ze("cross");dt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].crossVectors(i[0],i[1])})),$e.cross=dt;var ht=new Ze("length");ht.addSignature([Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),ht.addSignature([Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),ht.addSignature([Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),$e.length=ht;var ft=new Ze("lengthSq");ft.addSignature([Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),ft.addSignature([Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),ft.addSignature([Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),$e.lengthSq=ft;var pt=new Ze("normalize");pt.addSignature([Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),pt.addSignature([Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),pt.addSignature([Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),$e.normalize=pt;var mt=new Ze("distance");mt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].distanceTo(i[1])})),mt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].distanceTo(i[1])})),$e.distance=mt;var yt=new Ze("and");yt.addSignature([Xe.Boolean,Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]&&i[1]})),$e.and=yt;var vt=new Ze("or");vt.addSignature([Xe.Boolean,Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]||i[1]})),$e.or=vt;var gt=new Ze("not");gt.addSignature([Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=!i[0]})),$e.not=gt;var St=new Ze("equal");St.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]===i[1]})),St.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),St.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),St.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),$e.equal=St;var _t=new Ze("lessThan");_t.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]<i[1]})),$e.lessThan=_t;var wt=new Ze("greaterThan");wt.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]>i[1]})),$e.greaterThan=wt;var Ot=new Ze("lessThanOrEqual");Ot.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]<=i[1]})),$e.lessThanOrEqual=Ot;var xt=new Ze("greaterThanOrEqual");xt.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]>=i[1]})),$e.greaterThanOrEqual=xt;var bt=new Ze("if");bt.addSignature([Xe.Boolean,Xe.AnyType,Xe.AnyType],[Xe.AnyType],(function(e,t,i,r){r[0]=i[0]?i[1]:i[2]})),$e.if=bt;var Nt=new Ze("number");Nt.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=t.value})),$e.number=Nt;var Pt=new Ze("vec2");Pt.addSignature([Xe.Number,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1]})),$e.vec2=Pt;var kt=new Ze("vec3");kt.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1],r[0].z=i[2]})),$e.vec3=kt;var Mt=new Ze("vec4");Mt.addSignature([Xe.Number,Xe.Number,Xe.Number,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1],r[0].z=i[2],r[0].w=i[3]})),$e.vec4=Mt;var Ct=new Ze("splitVec2");Ct.addSignature([Xe.Vec2],[Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y})),$e.splitVec2=Ct;var Vt=new Ze("splitVec3");Vt.addSignature([Xe.Vec3],[Xe.Number,Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y,r[2]=i[0].z})),$e.splitVec3=Vt;var Bt=new Ze("splitVec4");Bt.addSignature([Xe.Vec4],[Xe.Number,Xe.Number,Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y,r[2]=i[0].z,r[3]=i[0].w})),$e.splitVec4=Bt;var Tt=new Ze("bool");Tt.addSignature([],[Xe.Boolean],(function(e,t,i,r){r[0]=t.value})),$e.bool=Tt;var Et=new Ze("particleProperty");Et.addSignature([Xe.NullableAnyType],[Xe.NullableAnyType],(function(e,t,i,r){void 0!==i[0]&&("object"===_typeof(i[0])?e.particle[t.property].copy(i[0]):e.particle[t.property]=i[0]),void 0!==e.particle[t.property]&&("object"===_typeof(r[0])?r[0].copy(e.particle[t.property]):r[0]=e.particle[t.property])})),$e.particleProperty=Et;var zt=new Ze("emit");zt.addSignature([Xe.EventStream],[],(function(e,t,i,r){for(var n=i[0],o=0;o<n.length;o++)e.signal(o,n[o])})),$e.emit=zt;var At=new Ze("graphProperty");At.addSignature([Xe.NullableAnyType],[Xe.NullableAnyType],(function(e,t,i,r){void 0!==i[0]&&("object"===_typeof(i[0])?e.graph[t.property].copy(i[0]):e.graph[t.property]=i[0]),void 0!==e.graph[t.property]&&("object"===_typeof(r[0])?r[0].copy(e.graph[t.property]):r[0]=e.graph[t.property])})),$e.graphProperty=At;var Jt=new Ze("startEvent");Jt.addSignature([],[Xe.EventStream],(function(e,t,i,r){r[0]=[{type:"start"}]})),$e.startEvent=Jt;var Lt=new Ze("repeater");Lt.addSignature([Xe.EventStream,Xe.Number],[Xe.EventStream],(function(e,t,i,r){for(var n=i[0],o=i[1],a=[],s=0;s<n.length;s++)for(var l=0;l<o;l++)a.push(n[s]);r[0]=a})),$e.repeater=Lt;var Ut=new Ze("time");Ut.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=e.emissionState.time})),$e.time=Ut;var Rt=new Ze("delta");Rt.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=e.delta})),$e.delta=Rt;var Ft=new Ze("output");Ft.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]})),$e.output=Ft;var It=new Ze("lerp");It.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]*(1-i[2])+i[1]*i[2]})),It.addSignature([Xe.Vec2,Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),It.addSignature([Xe.Vec3,Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),It.addSignature([Xe.Vec4,Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),$e.lerp=It;var Gt=new Ze("normDistrib");Gt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=function normalD(e){return 1/Math.sqrt(2*Math.PI)*Math.exp(e*e*-.5)}(i[0])})),$e.normDistrib=Gt;var Dt=new Ze("normcdf");Dt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){var n=i[0],o=1;n<0&&(o=-1);var a=1/(1+.3275911*(n=Math.abs(n)/Math.sqrt(2))),s=1-((((1.061405429*a-1.453152027)*a+1.421413741)*a-.284496736)*a+.254829592)*a*Math.exp(-n*n);r[0]=.5*(1+o*s)})),$e.normcdf=Dt;var qt=new Ze("normcdfInv"),Xt=function rationalApproximation(e){var t=[2.515517,.802853,.010328],i=[1.432788,.189269,.001308];return e-((t[2]*e+t[1])*e+t[0])/(((i[2]*e+i[1])*e+i[0])*e+1)},jt=function normcdfInv(e){return e<.5?-Xt(Math.sqrt(-2*Math.log(e))):Xt(Math.sqrt(-2*Math.log(1-e)))};qt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=jt(i[0])})),$e.normcdfInv=qt;var Ht=new Ze("clamp");Ht.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.max(Math.min(i[0],i[2]),i[1])})),$e.clamp=Ht;var Wt=new Ze("smoothstep");Wt.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){var n=Math.max(Math.min(i[0],i[2]),i[1]);r[0]=n*n*(3-2*n)})),$e.smoothstep=Wt;var Qt=new Ze("random");Qt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.random()*(i[1]-i[0])+i[0]})),Qt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),Qt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),Qt.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),$e.random=Qt;var Yt=new Ze("vrand");Yt.addSignature([],[Xe.Vec2],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=Math.sqrt(n*n+o*o);r[0].set(n/a,o/a)})),Yt.addSignature([],[Xe.Vec3],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=jt(Math.random()),s=Math.sqrt(n*n+o*o+a*a);r[0].set(n/s,o/s,a/s)})),Yt.addSignature([],[Xe.Vec4],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=jt(Math.random()),s=jt(Math.random()),l=Math.sqrt(n*n+o*o+a*a+s*s);r[0].set(n/l,o/l,a/l,s/l)})),$e.vrand=Yt;var Zt=new Ze("bsdf");Zt.addSignature([Xe.Vec3,Xe.Vec3,Xe.Vec3,Xe.Number],[],(function(e,t,i,r){})),$e.bsdf=Zt;var Kt=new Set(["output","particleProperty","graphProperty","emit"]),$t=function(){function NodeGraph(e){_classCallCheck(this,NodeGraph),_defineProperty(this,"uuid",void 0),_defineProperty(this,"name",void 0),_defineProperty(this,"version",void 0),_defineProperty(this,"revision",void 0),_defineProperty(this,"inputNodes",[]),_defineProperty(this,"outputNodes",[]),_defineProperty(this,"allNodes",new Map),_defineProperty(this,"wires",[]),_defineProperty(this,"compiled",!1),_defineProperty(this,"nodesInOrder",[]),this.version="1.0",this.uuid=t.MathUtils.generateUUID(),this.name=e,this.revision=0}return _createClass(NodeGraph,[{key:"addWire",value:function addWire(e){this.wires.push(e),this.revision++}},{key:"addNode",value:function addNode(e){this.allNodes.set(e.id,e),e.type===$e.input?this.inputNodes.push(e):Kt.has(e.type.name)&&this.outputNodes.push(e),this.revision++}},{key:"getNode",value:function getNode(e){return this.allNodes.get(e)}},{key:"deleteNode",value:function deleteNode(e){this.allNodes.delete(e.id),this.revision++}},{key:"deleteWire",value:function deleteWire(e){var t=e.input.outputs[e.inputIndex].indexOf(e);-1!==t&&e.input.outputs[e.inputIndex].splice(t,1),e.output.inputs[e.outputIndex]=void 0,-1!=(t=this.wires.indexOf(e))&&(this.wires[t]=this.wires[this.wires.length-1],this.wires.pop()),this.revision++}},{key:"toJSON",value:function toJSON(){throw new Error("not implemented")}},{key:"clone",value:function clone(){throw new Error("not implemented")}}]),NodeGraph}();new t.Vector3(0,0,1);var ei=new t.Quaternion,ti=new t.Vector3,ii=new t.Vector3,ri=new t.PlaneGeometry(1,1,1,1),ni=function(){function NodeVFX(e){var r,n,o,a,s,l,u;_classCallCheck(this,NodeVFX),_defineProperty(this,"emissionGraph",void 0),_defineProperty(this,"updateGraph",void 0),_defineProperty(this,"interpreter",void 0),_defineProperty(this,"autoDestroy",void 0),_defineProperty(this,"prewarm",void 0),_defineProperty(this,"looping",void 0),_defineProperty(this,"duration",void 0),_defineProperty(this,"particleNum",void 0),_defineProperty(this,"paused",void 0),_defineProperty(this,"particles",void 0),_defineProperty(this,"emitter",void 0),_defineProperty(this,"rendererSettings",void 0),_defineProperty(this,"neededToUpdateRender",void 0),_defineProperty(this,"rendererEmitterSettings",void 0),_defineProperty(this,"worldSpace",void 0),_defineProperty(this,"prewarmed",void 0),_defineProperty(this,"emissionState",void 0),_defineProperty(this,"emitEnded",void 0),_defineProperty(this,"markForDestroy",void 0),_defineProperty(this,"previousWorldPos",void 0),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"travelDistance",0),_defineProperty(this,"normalMatrix",new t.Matrix3),_defineProperty(this,"_renderer",void 0),_defineProperty(this,"speedFactor",0),this.autoDestroy=void 0!==e.autoDestroy&&e.autoDestroy,this.duration=null!==(r=e.duration)&&void 0!==r?r:1,this.looping=void 0===e.looping||e.looping,this.prewarm=void 0!==e.prewarm&&e.prewarm,this.worldSpace=null!==(n=e.worldSpace)&&void 0!==n&&n,this.rendererEmitterSettings=null!==(o=e.rendererEmitterSettings)&&void 0!==o?o:{},this.emissionGraph=e.emissionGraph,this.updateGraph=e.updateGraph,this.interpreter=new Ye,this.rendererSettings={instancingGeometry:null!==(a=e.instancingGeometry)&&void 0!==a?a:ri,renderMode:null!==(s=e.renderMode)&&void 0!==s?s:be.BillBoard,renderOrder:null!==(l=e.renderOrder)&&void 0!==l?l:0,material:e.material,layers:null!==(u=e.layers)&&void 0!==u?u:new t.Layers,uTileCount:1,vTileCount:1},this.neededToUpdateRender=!0,this.particles=new Array,this.emitter=new i(this),this.paused=!1,this.particleNum=0,this.emissionState={time:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return _createClass(NodeVFX,[{key:"time",get:function get(){return this.emissionState.time},set:function set(e){this.emissionState.time=e}},{key:"layers",get:function get(){return this.rendererSettings.layers}},{key:"texture",get:function get(){return this.rendererSettings.material.map},set:function set(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function get(){return this.rendererSettings.material},set:function set(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function get(){return this.rendererSettings.instancingGeometry},set:function set(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function get(){return this.rendererSettings.renderMode},set:function set(e){if((this.rendererSettings.renderMode!=be.Trail&&e===be.Trail||this.rendererSettings.renderMode==be.Trail&&e!==be.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==e)switch(e){case be.Trail:this.rendererEmitterSettings={startLength:30,followLocalOrigin:!1};break;case be.Mesh:this.rendererEmitterSettings={geometry:new t.PlaneGeometry(1,1)};break;case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:case be.StretchedBillBoard:this.rendererEmitterSettings={}}this.rendererSettings.renderMode=e,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function get(){return this.rendererSettings.renderOrder},set:function set(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function get(){return this.rendererSettings.material.blending},set:function set(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function pause(){this.paused=!0}},{key:"play",value:function play(){this.paused=!1}},{key:"spawn",value:function spawn(e,i){ei.setFromRotationMatrix(i);var r=ti,n=ei,a=ii;for(i.decompose(r,n,a),this.particleNum++;this.particles.length<this.particleNum;)this.particles.push(new o);var s=this.particles[this.particleNum-1];if(s.reset(),this.interpreter.run(this.updateGraph,{particle:s,emissionState:this.emissionState}),this.rendererSettings.renderMode===be.Trail&&this.rendererEmitterSettings.followLocalOrigin){var l=s;l.localPosition=(new t.Vector3).copy(l.position)}this.worldSpace&&(s.position.applyMatrix4(i),s.size*=(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z))/3,s.velocity.multiply(a).applyMatrix3(this.normalMatrix),s.rotation&&s.rotation instanceof t.Quaternion&&s.rotation.multiplyQuaternions(ei,s.rotation))}},{key:"endEmit",value:function endEmit(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function dispose(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function restart(){this.paused=!1,this.particleNum=0,this.emissionState.time=0,this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function update(e){if(!this.paused){for(var t=this.emitter;t.parent;)t=t.parent;if("Scene"===t.type)if(this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var i=0;i<60*this.duration;i++)this.update(1/60)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.emit(e,this.emissionState,this.emitter.matrixWorld);for(var r={particle:void 0,emissionState:this.emissionState,delta:e},n=0;n<this.particleNum;n++)r.particle=this.particles[n],this.interpreter.run(this.updateGraph,r);for(var o=0;o<this.particleNum;o++)this.rendererEmitterSettings.followLocalOrigin&&this.particles[o].localPosition?(this.particles[o].position.copy(this.particles[o].localPosition),this.particles[o].parentMatrix?this.particles[o].position.applyMatrix4(this.particles[o].parentMatrix):this.particles[o].position.applyMatrix4(this.emitter.matrixWorld)):this.particles[o].position.addScaledVector(this.particles[o].velocity,e),this.particles[o].age+=e;if(this.rendererSettings.renderMode===be.Trail)for(var a=0;a<this.particleNum;a++)this.particles[a].update();for(var s=0;s<this.particleNum;s++){var u=this.particles[s];!u.died||u instanceof l&&0!==u.previous.length||(this.particles[s]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=u,this.particleNum--,s--)}}else this.dispose()}}},{key:"emit",value:function emit(e,i,r){var n=this;i.time>this.duration&&(this.looping?i.time-=this.duration:this.emitEnded||this.endEmit()),this.normalMatrix.getNormalMatrix(r);var o={signal:function signal(){n.spawn(i,r)},emissionState:i,delta:e};this.emitEnded||this.interpreter.run(this.emissionGraph,o),void 0===this.previousWorldPos&&(this.previousWorldPos=new t.Vector3),this.emitter.getWorldPosition(this.previousWorldPos),i.time+=e}},{key:"toJSON",value:function toJSON(e){return{}}},{key:"getRendererSettings",value:function getRendererSettings(){return this.rendererSettings}},{key:"clone",value:function clone(){return this}}]),NodeVFX}();console.log("%c Particle system powered by three.quarks. https://quarks.art/","font-size: 16px; font-weight: bold;"),e.ApplyCollision=ue,e.ApplyForce=R,e.ApplySequences=le,e.AxisAngleGenerator=k,e.BatchedParticleRenderer=Ge,e.BatchedRenderer=Ie,e.BehaviorFromJSON=BehaviorFromJSON,e.BehaviorTypes=pe,e.Bezier=u,e.ChangeEmitDirection=G,e.CircleEmitter=ye,e.ColorBySpeed=ce,e.ColorGeneratorFromJSON=ColorGeneratorFromJSON,e.ColorOverLife=C,e.ColorRange=m,e.ConeEmitter=me,e.ConstantColor=w,e.ConstantValue=O,e.DonutEmitter=ve,e.EmitSubParticleSystem=j,e.EmitterFromJSON=EmitterFromJSON,e.EmitterShapes=xe,e.EulerGenerator=M,e.ForceOverLife=E,e.FrameOverLife=J,e.GeneratorFromJSON=GeneratorFromJSON,e.Gradient=g,e.GraphNodeType=Ke,e.GravityForce=I,e.GridEmitter=we,e.HemisphereEmitter=_e,e.Interpreter=Ye,e.IntervalValue=x,e.LimitSpeedOverLife=fe,e.MeshSurfaceEmitter=Oe,e.Node=He,e.NodeGraph=$t,e.NodeParticle=o,e.NodeType=Ze,e.NodeTypes=$e,e.NodeVFX=ni,e.NodeValueType=Xe,e.Noise=oe,e.OrbitOverLife=L,e.OutputNodeTypeNames=Kt,e.ParticleEmitter=i,e.ParticleSystem=Be,e.PiecewiseBezier=N,e.PiecewiseFunction=b,e.Plugins=qe,e.PointEmitter=ge,e.QuarksLoader=De,e.RandomColor=p,e.RandomColorBetweenGradient=_,e.RandomQuatGenerator=P,e.RecordState=s,e.RenderMode=be,e.Rotation3DOverLife=T,e.RotationBySpeed=he,e.RotationGeneratorFromJSON=RotationGeneratorFromJSON,e.RotationOverLife=V,e.SequencerFromJSON=SequencerFromJSON,e.SizeBySpeed=de,e.SizeOverLife=z,e.SpeedOverLife=A,e.SphereEmitter=Se,e.SpriteBatch=Ue,e.SpriteParticle=a,e.SubParticleEmitMode=X,e.TextureSequencer=ae,e.TrailBatch=Fe,e.TrailParticle=l,e.TurbulenceField=te,e.VFXBatch=Ne,e.ValueGeneratorFromJSON=ValueGeneratorFromJSON,e.WidthOverLength=U,e.Wire=We,e.genDefaultForNodeValueType=je,e.getPhysicsResolver=getPhysicsResolver,e.loadPlugin=function loadPlugin(e){if(!qe.find((function(t){return t.id===e.id}))){e.initialize();var t,i=_createForOfIteratorHelper(e.emitterShapes);try{for(i.s();!(t=i.n()).done;){var r=t.value;xe[r.type]||(xe[r.type]=r)}}catch(e){i.e(e)}finally{i.f()}var n,o=_createForOfIteratorHelper(e.behaviors);try{for(o.s();!(n=o.n()).done;){var a=n.value;pe[a.type]||(pe[a.type]=a)}}catch(e){o.e(e)}finally{o.f()}}},e.setPhysicsResolver=function setPhysicsResolver(e){se=e},e.unloadPlugin=function unloadPlugin(e){var t=qe.find((function(t){return t.id===e}));if(t){var i,r=_createForOfIteratorHelper(t.emitterShapes);try{for(r.s();!(i=r.n()).done;){var n=i.value;xe[n.type]&&delete xe[n.type]}}catch(e){r.e(e)}finally{r.f()}var o,a=_createForOfIteratorHelper(t.behaviors);try{for(a.s();!(o=a.n()).done;){var s=o.value;pe[s.type]&&delete pe[s.type]}}catch(e){a.e(e)}finally{a.f()}}}},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).THREE=e.THREE||{},e.THREE.QUARKS={}),e.THREE);
diff --git a/node_modules/three.quarks/dist/three.quarks.js b/node_modules/three.quarks/dist/three.quarks.js
index 457d265..e66a449 100644
--- a/node_modules/three.quarks/dist/three.quarks.js
+++ b/node_modules/three.quarks/dist/three.quarks.js
@@ -1,5 +1,5 @@
 /**
- * three.quarks v0.10.18 build Mon Oct 23 2023
+ * three.quarks v0.10.18 build Tue Oct 24 2023
  * https://github.com/Alchemist0823/three.quarks#readme
  * Copyright 2023 Alchemist0823 <the.forrest.sun@gmail.com>, MIT
  */
@@ -1213,18 +1213,18 @@
       _defineProperty(this, "type", void 0);
       this.a = a;
       this.b = b;
-      this.type = "function";
+      this.type = 'value';
     }
     _createClass(ColorRange, [{
       key: "genColor",
       value: function genColor(color, t) {
-        return color.copy(this.a).lerp(this.b, t);
+        return color.copy(this.a).lerp(this.b, Math.random());
       }
     }, {
       key: "toJSON",
       value: function toJSON() {
         return {
-          type: "ColorRange",
+          type: 'ColorRange',
           a: ColorToJSON(this.a),
           b: ColorToJSON(this.b)
         };
@@ -4631,7 +4631,7 @@
       /**
        * the emitter object that should be added in the scene.
        *
-       * @type {ParticleEmitter<BaseEvent>}
+       * @type {ParticleEmitter<Object3DEventMap>}
        */
       _defineProperty(this, "emitter", void 0);
       /**
@@ -7297,7 +7297,7 @@
       /**
        * the emitter object that should be added in the scene.
        *
-       * @type {ParticleEmitter<BaseEvent>}
+       * @type {ParticleEmitter<Object3DEventMap>}
        */
       _defineProperty(this, "emitter", void 0);
       /**
diff --git a/node_modules/three.quarks/dist/three.quarks.min.js b/node_modules/three.quarks/dist/three.quarks.min.js
index c4a3fd0..1efceb8 100644
--- a/node_modules/three.quarks/dist/three.quarks.min.js
+++ b/node_modules/three.quarks/dist/three.quarks.min.js
@@ -1 +1 @@
-!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e,t;e=void 0,t=function(e,t){function _regeneratorRuntime(){_regeneratorRuntime=function(){return t};var e,t={},i=Object.prototype,r=i.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag";function define(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{define({},"")}catch(e){define=function(e,t,i){return e[t]=i}}function wrap(e,t,i,r){var o=t&&t.prototype instanceof Generator?t:Generator,a=Object.create(o.prototype),s=new Context(r||[]);return n(a,"_invoke",{value:makeInvokeMethod(e,i,s)}),a}function tryCatch(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}t.wrap=wrap;var u="suspendedStart",c="suspendedYield",d="executing",h="completed",f={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(values([])));y&&y!==i&&r.call(y,a)&&(p=y);var v=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(e){["next","throw","return"].forEach((function(t){define(e,t,(function(e){return this._invoke(t,e)}))}))}function AsyncIterator(e,t){function invoke(i,n,o,a){var s=tryCatch(e[i],e,n);if("throw"!==s.type){var l=s.arg,u=l.value;return u&&"object"==typeof u&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){invoke("next",e,o,a)}),(function(e){invoke("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return invoke("throw",e,o,a)}))}a(s.arg)}var i;n(this,"_invoke",{value:function(e,r){function callInvokeWithMethodAndArg(){return new t((function(t,i){invoke(e,r,t,i)}))}return i=i?i.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(t,i,r){var n=u;return function(o,a){if(n===d)throw new Error("Generator is already running");if(n===h){if("throw"===o)throw a;return{value:e,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var l=maybeInvokeDelegate(s,r);if(l){if(l===f)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===u)throw n=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=d;var p=tryCatch(t,i,r);if("normal"===p.type){if(n=r.done?h:c,p.arg===f)continue;return{value:p.arg,done:r.done}}"throw"===p.type&&(n=h,r.method="throw",r.arg=p.arg)}}}function maybeInvokeDelegate(t,i){var r=i.method,n=t.iterator[r];if(n===e)return i.delegate=null,"throw"===r&&t.iterator.return&&(i.method="return",i.arg=e,maybeInvokeDelegate(t,i),"throw"===i.method)||"return"!==r&&(i.method="throw",i.arg=new TypeError("The iterator does not provide a '"+r+"' method")),f;var o=tryCatch(n,t.iterator,i.arg);if("throw"===o.type)return i.method="throw",i.arg=o.arg,i.delegate=null,f;var a=o.arg;return a?a.done?(i[t.resultName]=a.value,i.next=t.nextLoc,"return"!==i.method&&(i.method="next",i.arg=e),i.delegate=null,f):a:(i.method="throw",i.arg=new TypeError("iterator result is not an object"),i.delegate=null,f)}function pushTryEntry(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function resetTryEntry(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function Context(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t||""===t){var i=t[a];if(i)return i.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,o=function next(){for(;++n<t.length;)if(r.call(t,n))return next.value=t[n],next.done=!1,next;return next.value=e,next.done=!0,next};return o.next=o}}throw new TypeError(typeof t+" is not iterable")}return GeneratorFunction.prototype=GeneratorFunctionPrototype,n(v,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),n(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===GeneratorFunction||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,GeneratorFunctionPrototype):(e.__proto__=GeneratorFunctionPrototype,define(e,l,"GeneratorFunction")),e.prototype=Object.create(v),e},t.awrap=function(e){return{__await:e}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,s,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(e,i,r,n,o){void 0===o&&(o=Promise);var a=new AsyncIterator(wrap(e,i,r,n),o);return t.isGeneratorFunction(i)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},defineIteratorMethods(v),define(v,l,"Generator"),define(v,a,(function(){return this})),define(v,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),i=[];for(var r in t)i.push(r);return i.reverse(),function next(){for(;i.length;){var e=i.pop();if(e in t)return next.value=e,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(resetTryEntry),!t)for(var i in this)"t"===i.charAt(0)&&r.call(this,i)&&!isNaN(+i.slice(1))&&(this[i]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var i=this;function handle(r,n){return a.type="throw",a.arg=t,i.next=r,n&&(i.method="next",i.arg=e),!!n}for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n],a=o.completion;if("root"===o.tryLoc)return handle("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(s&&l){if(this.prev<o.catchLoc)return handle(o.catchLoc,!0);if(this.prev<o.finallyLoc)return handle(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return handle(o.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return handle(o.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&r.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),resetTryEntry(i),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var n=r.arg;resetTryEntry(i)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(t,i,r){return this.delegate={iterator:values(t),resultName:i,nextLoc:r},"next"===this.method&&(this.arg=e),f}},t}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _createSuper(e){var t=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var i,r=_getPrototypeOf(e);if(t){var n=_getPrototypeOf(this).constructor;i=Reflect.construct(r,arguments,n)}else i=r.apply(this,arguments);return function _possibleConstructorReturn(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}(this,i)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(e,t,i){var r=function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(arguments.length<3?e:i):n.value}},_get.apply(this,arguments)}function _slicedToArray(e,t){return function _arrayWithHoles(e){if(Array.isArray(e))return e}(e)||function _iterableToArrayLimit(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var r,n,o,a,s=[],l=!0,u=!1;try{if(o=(i=i.call(e)).next,0===t){if(Object(i)!==i)return;l=!1}else for(;!(l=(r=o.call(i)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){u=!0,n=e}finally{try{if(!l&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(u)throw n}}return s}}(e,t)||_unsupportedIterableToArray(e,t)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function _createForOfIteratorHelper(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0,F=function(){};return{s:F,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,a=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){a=!0,n=e},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw n}}}}function _toPropertyKey(e){var t=function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}var i=function(e){_inherits(ParticleEmitter,e);var t=_createSuper(ParticleEmitter);function ParticleEmitter(e){var i;return _classCallCheck(this,ParticleEmitter),_defineProperty(_assertThisInitialized(i=t.call(this)),"type","ParticleEmitter"),_defineProperty(_assertThisInitialized(i),"system",void 0),i.system=e,i}return _createClass(ParticleEmitter,[{key:"clone",value:function clone(){var e=this.system.clone();return e.emitter.copy(this,!0),e.emitter}},{key:"dispose",value:function dispose(){}},{key:"extractFromCache",value:function extractFromCache(e){var t=[];for(var i in e){var r=e[i];delete r.metadata,t.push(r)}return t}},{key:"toJSON",value:function toJSON(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=void 0===e||"string"==typeof e,r={};i&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var n={};if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),null!==this.system&&(n.ps=this.system.toJSON(e,t)),this.children.length>0){n.children=[];for(var o=0;o<this.children.length;o++)"ParticleSystemPreview"!==this.children[o].type&&n.children.push(this.children[o].toJSON(e).object)}if(i){var a=this.extractFromCache(e.geometries),s=this.extractFromCache(e.materials),l=this.extractFromCache(e.textures),u=this.extractFromCache(e.images);a.length>0&&(r.geometries=a),s.length>0&&(r.materials=s),l.length>0&&(r.textures=l),u.length>0&&(r.images=u)}return r.object=n,r}}]),ParticleEmitter}(t.Object3D),r=function(){function LinkedListNode(e){_classCallCheck(this,LinkedListNode),_defineProperty(this,"data",void 0),_defineProperty(this,"next",void 0),_defineProperty(this,"prev",void 0),this.data=e,this.next=null,this.prev=null}return _createClass(LinkedListNode,[{key:"hasPrev",value:function hasPrev(){return null!==this.prev}},{key:"hasNext",value:function hasNext(){return null!==this.next}}]),LinkedListNode}(),n=function(){function LinkedList(){_classCallCheck(this,LinkedList),_defineProperty(this,"length",void 0),_defineProperty(this,"head",void 0),_defineProperty(this,"tail",void 0),this.length=0,this.head=this.tail=null}return _createClass(LinkedList,[{key:"isEmpty",value:function isEmpty(){return null===this.head}},{key:"clear",value:function clear(){this.length=0,this.head=this.tail=null}},{key:"front",value:function front(){return null===this.head?null:this.head.data}},{key:"back",value:function back(){return null===this.tail?null:this.tail.data}},{key:"dequeue",value:function dequeue(){if(this.head){var e=this.head.data;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}}},{key:"pop",value:function pop(){if(this.tail){var e=this.tail.data;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}}},{key:"queue",value:function queue(e){var t=new r(e);this.tail||(this.tail=t),this.head&&(this.head.prev=t,t.next=this.head),this.head=t,this.length++}},{key:"push",value:function push(e){var t=new r(e);this.head||(this.head=t),this.tail&&(this.tail.next=t,t.prev=this.tail),this.tail=t,this.length++}},{key:"insertBefore",value:function insertBefore(e,t){var i=new r(t);i.next=e,i.prev=e.prev,null!==i.prev&&(i.prev.next=i),i.next.prev=i,e==this.head&&(this.head=i),this.length++}},{key:"remove",value:function remove(e){if(null!==this.head&&null!==this.tail){var t=this.head;for(e===this.head.data&&(this.head=this.head.next),e===this.tail.data&&(this.tail=this.tail.prev);null!==t.next&&t.data!==e;)t=t.next;t.data===e&&(null!==t.prev&&(t.prev.next=t.next),null!==t.next&&(t.next.prev=t.prev),this.length--)}}},{key:"values",value:_regeneratorRuntime().mark((function values(){var e;return _regeneratorRuntime().wrap((function values$(t){for(;;)switch(t.prev=t.next){case 0:e=this.head;case 1:if(null===e){t.next=7;break}return t.next=4,e.data;case 4:e=e.next,t.next=1;break;case 7:case"end":return t.stop()}}),values,this)}))}]),LinkedList}(),o=function(){function NodeParticle(){_classCallCheck(this,NodeParticle),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"angularVelocity",void 0),_defineProperty(this,"rotation",0),_defineProperty(this,"color",new t.Vector4(1,1,1,1)),_defineProperty(this,"uvTile",0)}return _createClass(NodeParticle,[{key:"died",get:function get(){return this.age>=this.life}},{key:"reset",value:function reset(){this.position.set(0,0,0),this.velocity.set(0,0,0),this.age=0,this.life=1,this.size=1,this.rotation=0,this.color.set(1,1,1,1),this.uvTile=0}}]),NodeParticle}(),a=function(){function SpriteParticle(){_classCallCheck(this,SpriteParticle),_defineProperty(this,"parentMatrix",void 0),_defineProperty(this,"startSpeed",0),_defineProperty(this,"startColor",new t.Vector4),_defineProperty(this,"startSize",1),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"angularVelocity",void 0),_defineProperty(this,"rotation",0),_defineProperty(this,"color",new t.Vector4),_defineProperty(this,"uvTile",0)}return _createClass(SpriteParticle,[{key:"died",get:function get(){return this.age>=this.life}}]),SpriteParticle}(),s=_createClass((function RecordState(e,t,i){_classCallCheck(this,RecordState),this.position=e,this.size=t,this.color=i})),l=function(){function TrailParticle(){_classCallCheck(this,TrailParticle),_defineProperty(this,"parentMatrix",void 0),_defineProperty(this,"startSpeed",0),_defineProperty(this,"startColor",new t.Vector4),_defineProperty(this,"startSize",1),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"localPosition",void 0),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"length",100),_defineProperty(this,"color",new t.Vector4),_defineProperty(this,"previous",new n),_defineProperty(this,"uvTile",0)}return _createClass(TrailParticle,[{key:"update",value:function update(){for(this.age<=this.life?this.previous.push(new s(this.position.clone(),this.size,this.color.clone())):this.previous.length>0&&this.previous.dequeue();this.previous.length>this.length;)this.previous.dequeue()}},{key:"died",get:function get(){return this.age>=this.life}},{key:"reset",value:function reset(){this.previous.clear()}}]),TrailParticle}(),u=function(){function Bezier(e,t,i,r){_classCallCheck(this,Bezier),_defineProperty(this,"p",void 0),this.p=[e,t,i,r]}return _createClass(Bezier,[{key:"genValue",value:function genValue(e){var t=e*e,i=e*e*e,r=1-e,n=r*r,o=n*r;return this.p[0]*o+this.p[1]*n*e*3+this.p[2]*r*t*3+this.p[3]*i}},{key:"derivativeCoefficients",value:function derivativeCoefficients(e){for(var t=[],i=e,r=i.length-1;r>0;r--){for(var n=[],o=0;o<r;o++){var a=r*(i[o+1]-i[o]);n.push(a)}t.push(n),i=n}return t}},{key:"getSlope",value:function getSlope(e){var t=this.derivativeCoefficients(this.p)[0],i=1-e,r=i*e*2,n=e*e;return i*i*t[0]+r*t[1]+n*t[2]}},{key:"controlCurve",value:function controlCurve(e,t){this.p[1]=e/3+this.p[0],this.p[2]=this.p[3]-t/3}},{key:"hull",value:function hull(e){var t,i=this.p,r=[],n=0,o=0,a=0,s=[];for(s[n++]=i[0],s[n++]=i[1],s[n++]=i[2],s[n++]=i[3];i.length>1;){for(r=[],o=0,a=i.length-1;o<a;o++)t=e*i[o]+(1-e)*i[o+1],s[n++]=t,r.push(t);i=r}return s}},{key:"split",value:function split(e){var t=this.hull(e);return{left:new Bezier(t[0],t[4],t[7],t[9]),right:new Bezier(t[9],t[8],t[6],t[3]),span:t}}},{key:"clone",value:function clone(){return new Bezier(this.p[0],this.p[1],this.p[2],this.p[3])}},{key:"toJSON",value:function toJSON(){return{p0:this.p[0],p1:this.p[1],p2:this.p[2],p3:this.p[3]}}}],[{key:"fromJSON",value:function fromJSON(e){return new Bezier(e.p0,e.p1,e.p2,e.p3)}}]),Bezier}(),c=function ColorToJSON(e){return{r:e.x,g:e.y,b:e.z,a:e.w}},d=function JSONToColor(e){return new t.Vector4(e.r,e.g,e.b,e.a)},h=function JSONToValue(e,i){switch(i){case"Vector3":return new t.Vector3(e.x,e.y,e.z);case"Vector4":return new t.Vector4(e.x,e.y,e.z,e.w);case"Color":return new t.Vector3(e.r,e.g,e.b);default:return e}},f=function ValueToJSON(e,t){switch(t){case"Vector3":return{x:e.x,y:e.y,z:e.z};case"Vector4":return{x:e.x,y:e.y,z:e.z,w:e.w};case"Color":return{r:e.x,g:e.y,b:e.z};default:return e}},p=function(){function RandomColor(e,t){_classCallCheck(this,RandomColor),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="value"}return _createClass(RandomColor,[{key:"genColor",value:function genColor(e){var t=Math.random();return e.copy(this.a).lerp(this.b,t)}},{key:"toJSON",value:function toJSON(){return{type:"RandomColor",a:c(this.a),b:c(this.b)}}},{key:"clone",value:function clone(){return new RandomColor(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomColor(d(e.a),d(e.b))}}]),RandomColor}(),m=function(){function ColorRange(e,t){_classCallCheck(this,ColorRange),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="function"}return _createClass(ColorRange,[{key:"genColor",value:function genColor(e,t){return e.copy(this.a).lerp(this.b,t)}},{key:"toJSON",value:function toJSON(){return{type:"ColorRange",a:c(this.a),b:c(this.b)}}},{key:"clone",value:function clone(){return new ColorRange(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorRange(d(e.a),d(e.b))}}]),ColorRange}(),y=function(){function ContinuousLinearFunction(e,t){_classCallCheck(this,ContinuousLinearFunction),_defineProperty(this,"keys",void 0),_defineProperty(this,"type",void 0),_defineProperty(this,"subType",void 0),this.subType=t,this.type="function",this.keys=e}return _createClass(ContinuousLinearFunction,[{key:"findKey",value:function findKey(e){for(var t=0,i=0,r=this.keys.length-1;i+1<r;)if(t=Math.floor((i+r)/2),e<this.getStartX(t))r=t-1;else{if(!(e>this.getEndX(t)))return t;i=t+1}for(var n=i;n<=r;n++)if(e>=this.getStartX(n)&&e<=this.getEndX(n))return n;return-1}},{key:"getStartX",value:function getStartX(e){return this.keys[e][1]}},{key:"getEndX",value:function getEndX(e){return e+1<this.keys.length?this.keys[e+1][1]:1}},{key:"genValue",value:function genValue(e,t){var i=this.findKey(t);return"Number"===this.subType?-1===i?this.keys[0][0]:i+1>=this.keys.length?this.keys[this.keys.length-1][0]:(this.keys[i+1][0]-this.keys[i][0])*((t-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))+this.keys[i][0]:-1===i?e.copy(this.keys[0][0]):i+1>=this.keys.length?e.copy(this.keys[this.keys.length-1][0]):e.copy(this.keys[i][0]).lerp(this.keys[i+1][0],(t-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))}},{key:"toJSON",value:function toJSON(){var e=this;return this.keys[0][0].constructor.name,{type:"CLinearFunction",subType:this.subType,keys:this.keys.map((function(t){var i=_slicedToArray(t,2),r=i[0],n=i[1];return{value:f(r,e.subType),pos:n}}))}}},{key:"clone",value:function clone(){return"Number"===this.subType?new ContinuousLinearFunction(this.keys.map((function(e){var t=_slicedToArray(e,2);return[t[0],t[1]]})),this.subType):new ContinuousLinearFunction(this.keys.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return[i.clone(),r]})),this.subType)}}],[{key:"fromJSON",value:function fromJSON(e){return new ContinuousLinearFunction(e.keys.map((function(t){return[h(t.value,e.subType),t.pos]})),e.subType)}}]),ContinuousLinearFunction}(),v=new t.Vector3,g=function(){function Gradient(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new t.Vector3(0,0,0),0],[new t.Vector3(1,1,1),0]],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[[1,0],[1,1]];_classCallCheck(this,Gradient),_defineProperty(this,"type",void 0),_defineProperty(this,"color",void 0),_defineProperty(this,"alpha",void 0),this.type="function",this.color=new y(e,"Color"),this.alpha=new y(i,"Number")}return _createClass(Gradient,[{key:"genColor",value:function genColor(e,t){return this.color.genValue(v,t),e.set(v.x,v.y,v.z,this.alpha.genValue(1,t))}},{key:"toJSON",value:function toJSON(){return{type:"Gradient",color:this.color.toJSON(),alpha:this.alpha.toJSON()}}},{key:"clone",value:function clone(){var e=new Gradient;return e.alpha=this.alpha.clone(),e.color=this.color.clone(),e}}],[{key:"fromJSON",value:function fromJSON(e){if(e.functions){var i=e.functions.map((function(e){return[m.fromJSON(e.function).a,e.start]}));return e.functions.length>0&&i.push([m.fromJSON(e.functions[e.functions.length-1].function).b,1]),new Gradient(i.map((function(e){return[new t.Vector3(e[0].x,e[0].y,e[0].z),e[1]]})),i.map((function(e){return[e[0].w,e[1]]})))}var r=new Gradient;return r.alpha=y.fromJSON(e.alpha),r.color=y.fromJSON(e.color),r}}]),Gradient}(),S=new t.Vector4,_=function(){function RandomColorBetweenGradient(e,t){_classCallCheck(this,RandomColorBetweenGradient),_defineProperty(this,"gradient1",void 0),_defineProperty(this,"gradient2",void 0),_defineProperty(this,"type",void 0),this.type="memorizedFunction",this.gradient1=e,this.gradient2=t}return _createClass(RandomColorBetweenGradient,[{key:"startGen",value:function startGen(e){e.rand=Math.random()}},{key:"genColor",value:function genColor(e,t,i){return this.gradient1.genColor(e,t),this.gradient2.genColor(S,t),i&&i.rand?e.lerp(S,i.rand):e.lerp(S,Math.random()),e}},{key:"toJSON",value:function toJSON(){return{type:"RandomColorBetweenGradient",gradient1:this.gradient1.toJSON(),gradient2:this.gradient2.toJSON()}}},{key:"clone",value:function clone(){return new RandomColorBetweenGradient(this.gradient1.clone(),this.gradient2.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomColorBetweenGradient(g.fromJSON(e.gradient1),g.fromJSON(e.gradient2))}}]),RandomColorBetweenGradient}(),w=function(){function ConstantColor(e){_classCallCheck(this,ConstantColor),_defineProperty(this,"type",void 0),this.color=e,this.type="value"}return _createClass(ConstantColor,[{key:"genColor",value:function genColor(e){return e.copy(this.color)}},{key:"toJSON",value:function toJSON(){return{type:"ConstantColor",color:c(this.color)}}},{key:"clone",value:function clone(){return new ConstantColor(this.color.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ConstantColor(d(e.color))}}]),ConstantColor}();function ColorGeneratorFromJSON(e){switch(e.type){case"ConstantColor":return w.fromJSON(e);case"ColorRange":return m.fromJSON(e);case"RandomColor":return p.fromJSON(e);case"Gradient":return g.fromJSON(e);case"RandomColorBetweenGradient":return _.fromJSON(e);default:return new w(new t.Vector4(1,1,1,1))}}var O=function(){function ConstantValue(e){_classCallCheck(this,ConstantValue),_defineProperty(this,"type",void 0),this.value=e,this.type="value"}return _createClass(ConstantValue,[{key:"genValue",value:function genValue(){return this.value}},{key:"toJSON",value:function toJSON(){return{type:"ConstantValue",value:this.value}}},{key:"clone",value:function clone(){return new ConstantValue(this.value)}}],[{key:"fromJSON",value:function fromJSON(e){return new ConstantValue(e.value)}}]),ConstantValue}(),x=function(){function IntervalValue(e,t){_classCallCheck(this,IntervalValue),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="value"}return _createClass(IntervalValue,[{key:"genValue",value:function genValue(){return t.MathUtils.lerp(this.a,this.b,Math.random())}},{key:"toJSON",value:function toJSON(){return{type:"IntervalValue",a:this.a,b:this.b}}},{key:"clone",value:function clone(){return new IntervalValue(this.a,this.b)}}],[{key:"fromJSON",value:function fromJSON(e){return new IntervalValue(e.a,e.b)}}]),IntervalValue}(),b=function(){function PiecewiseFunction(){_classCallCheck(this,PiecewiseFunction),_defineProperty(this,"functions",void 0),this.functions=new Array}return _createClass(PiecewiseFunction,[{key:"findFunction",value:function findFunction(e){for(var t=0,i=0,r=this.functions.length-1;i+1<r;)if(t=Math.floor((i+r)/2),e<this.getStartX(t))r=t-1;else{if(!(e>this.getEndX(t)))return t;i=t+1}for(var n=i;n<=r;n++)if(e>=this.functions[n][1]&&e<=this.getEndX(n))return n;return-1}},{key:"getStartX",value:function getStartX(e){return this.functions[e][1]}},{key:"setStartX",value:function setStartX(e,t){e>0&&(this.functions[e][1]=t)}},{key:"getEndX",value:function getEndX(e){return e+1<this.functions.length?this.functions[e+1][1]:1}},{key:"setEndX",value:function setEndX(e,t){e+1<this.functions.length&&(this.functions[e+1][1]=t)}},{key:"insertFunction",value:function insertFunction(e,t){var i=this.findFunction(e);this.functions.splice(i+1,0,[t,e])}},{key:"removeFunction",value:function removeFunction(e){return this.functions.splice(e,1)[0][0]}},{key:"getFunction",value:function getFunction(e){return this.functions[e][0]}},{key:"setFunction",value:function setFunction(e,t){this.functions[e][0]=t}},{key:"numOfFunctions",get:function get(){return this.functions.length}}]),PiecewiseFunction}(),N=function(e){_inherits(PiecewiseBezier,e);var t=_createSuper(PiecewiseBezier);function PiecewiseBezier(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new u(0,1/3,1/3*2,1),0]];return _classCallCheck(this,PiecewiseBezier),_defineProperty(_assertThisInitialized(e=t.call(this)),"type",void 0),e.type="function",e.functions=i,e}return _createClass(PiecewiseBezier,[{key:"genValue",value:function genValue(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this.findFunction(e);return-1===t?0:this.functions[t][0].genValue((e-this.getStartX(t))/(this.getEndX(t)-this.getStartX(t)))}},{key:"toSVG",value:function toSVG(e,t){if(t<1)return"";for(var i=["M",0,this.functions[0][0].p[0]].join(" "),r=1/t;r<=1;r+=1/t)i=[i,"L",r*e,this.genValue(r)].join(" ");return i}},{key:"toJSON",value:function toJSON(){return{type:"PiecewiseBezier",functions:this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return{function:i.toJSON(),start:r}}))}}},{key:"clone",value:function clone(){return new PiecewiseBezier(this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return[i.clone(),r]})))}}],[{key:"fromJSON",value:function fromJSON(e){return new PiecewiseBezier(e.functions.map((function(e){return[u.fromJSON(e.function),e.start]})))}}]),PiecewiseBezier}(b);function ValueGeneratorFromJSON(e){switch(e.type){case"ConstantValue":return O.fromJSON(e);case"IntervalValue":return x.fromJSON(e);case"PiecewiseBezier":return N.fromJSON(e);default:return new O(0)}}var P=function(){function RandomQuatGenerator(){_classCallCheck(this,RandomQuatGenerator),_defineProperty(this,"type",void 0),this.type="rotation"}return _createClass(RandomQuatGenerator,[{key:"genValue",value:function genValue(e,t){var i,r,n,o,a,s;do{n=(i=2*Math.random()-1)*i+(r=2*Math.random()-1)*r}while(n>1);do{s=(o=2*Math.random()-1)*o+(a=2*Math.random()-1)*a}while(s>1);var l=Math.sqrt((1-n)/s);return e.set(i,r,l*o,l*a),e}},{key:"toJSON",value:function toJSON(){return{type:"RandomQuat"}}},{key:"clone",value:function clone(){return new RandomQuatGenerator}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomQuatGenerator}}]),RandomQuatGenerator}(),k=function(){function AxisAngleGenerator(e,t){_classCallCheck(this,AxisAngleGenerator),_defineProperty(this,"type",void 0),this.axis=e,this.angle=t,this.type="rotation"}return _createClass(AxisAngleGenerator,[{key:"genValue",value:function genValue(e,t){return e.setFromAxisAngle(this.axis,this.angle.genValue(t))}},{key:"toJSON",value:function toJSON(){return{type:"AxisAngle",axis:{x:this.axis.x,y:this.axis.y,z:this.axis.z},angle:this.angle.toJSON()}}},{key:"clone",value:function clone(){return new AxisAngleGenerator(this.axis.clone(),this.angle.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new AxisAngleGenerator(new t.Vector3(e.axis.x,e.axis.y,e.axis.z),ValueGeneratorFromJSON(e.angle))}}]),AxisAngleGenerator}(),M=function(){function EulerGenerator(e,i,r,n){_classCallCheck(this,EulerGenerator),_defineProperty(this,"type",void 0),_defineProperty(this,"eular",void 0),this.angleX=e,this.angleY=i,this.angleZ=r,this.type="rotation",this.eular=new t.Euler(0,0,0,n)}return _createClass(EulerGenerator,[{key:"genValue",value:function genValue(e,t){return this.eular.set(this.angleX.genValue(t),this.angleY.genValue(t),this.angleZ.genValue(t)),e.setFromEuler(this.eular)}},{key:"toJSON",value:function toJSON(){return{type:"Euler",angleX:this.angleX.toJSON(),angleY:this.angleY.toJSON(),angleZ:this.angleZ.toJSON(),eulerOrder:this.eular.order}}},{key:"clone",value:function clone(){return new EulerGenerator(this.angleX,this.angleY,this.angleZ,this.eular.order)}}],[{key:"fromJSON",value:function fromJSON(e){return new EulerGenerator(ValueGeneratorFromJSON(e.angleX),ValueGeneratorFromJSON(e.angleY),ValueGeneratorFromJSON(e.angleZ),e.eulerOrder)}}]),EulerGenerator}();function RotationGeneratorFromJSON(e){switch(e.type){case"AxisAngle":return k.fromJSON(e);case"Euler":return M.fromJSON(e);case"RandomQuat":return P.fromJSON(e);default:return new P}}function GeneratorFromJSON(e){switch(e.type){case"ConstantValue":case"IntervalValue":case"PiecewiseBezier":return ValueGeneratorFromJSON(e);case"AxisAngle":case"RandomQuat":case"Euler":return RotationGeneratorFromJSON(e);default:return new O(0)}}var C=function(){function ColorOverLife(e){_classCallCheck(this,ColorOverLife),_defineProperty(this,"type","ColorOverLife"),this.color=e}return _createClass(ColorOverLife,[{key:"initialize",value:function initialize(e){"memorizedFunction"===this.color.type&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function update(e,t){"memorizedFunction"===this.color.type?this.color.genColor(e.color,e.age/e.life,e.colorOverLifeMemory):this.color.genColor(e.color,e.age/e.life),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,color:this.color.toJSON()}}},{key:"clone",value:function clone(){return new ColorOverLife(this.color.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorOverLife(ColorGeneratorFromJSON(e.color))}}]),ColorOverLife}(),V=function(){function RotationOverLife(e,i){_classCallCheck(this,RotationOverLife),_defineProperty(this,"type","RotationOverLife"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.dynamic=i}return _createClass(RotationOverLife,[{key:"initialize",value:function initialize(e){!this.dynamic&&e instanceof a&&(e.angularVelocity=this.angularVelocity.genValue())}},{key:"update",value:function update(e,t){this.dynamic?e.rotation+=t*this.angularVelocity.genValue(e.age/e.life):e instanceof a&&(e.rotation+=t*e.angularVelocity)}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new RotationOverLife(this.angularVelocity.clone(),this.dynamic)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new RotationOverLife(ValueGeneratorFromJSON(e.angularVelocity),e.dynamic)}}]),RotationOverLife}(),B=new t.Quaternion,T=function(){function Rotation3DOverLife(e,i){_classCallCheck(this,Rotation3DOverLife),_defineProperty(this,"type","Rotation3DOverLife"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.dynamic=i}return _createClass(Rotation3DOverLife,[{key:"initialize",value:function initialize(e){!this.dynamic&&e instanceof a&&(e.angularVelocity=new t.Quaternion,this.angularVelocity.genValue(e.angularVelocity))}},{key:"update",value:function update(e,t){this.dynamic?(this.angularVelocity.genValue(this.tempQuat,e.age/e.life),this.tempQuat.slerpQuaternions(B,this.tempQuat,t),e.rotation.multiply(this.tempQuat)):e instanceof a&&(this.tempQuat.slerpQuaternions(B,e.angularVelocity,t),e.rotation.multiply(this.tempQuat))}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new Rotation3DOverLife(this.angularVelocity.clone(),this.dynamic)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new Rotation3DOverLife(RotationGeneratorFromJSON(e.angularVelocity),e.dynamic)}}]),Rotation3DOverLife}(),E=function(){function ForceOverLife(e,i,r){_classCallCheck(this,ForceOverLife),_defineProperty(this,"type","ForceOverLife"),_defineProperty(this,"_temp",new t.Vector3),this.x=e,this.y=i,this.z=r}return _createClass(ForceOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this._temp.set(this.x.genValue(e.age/e.life),this.y.genValue(e.age/e.life),this.z.genValue(e.age/e.life)),e.velocity.addScaledVector(this._temp,t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,x:this.x.toJSON(),y:this.y.toJSON(),z:this.z.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new ForceOverLife(this.x.clone(),this.y.clone(),this.z.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ForceOverLife(ValueGeneratorFromJSON(e.x),ValueGeneratorFromJSON(e.y),ValueGeneratorFromJSON(e.z))}}]),ForceOverLife}(),z=function(){function SizeOverLife(e){_classCallCheck(this,SizeOverLife),_defineProperty(this,"type","SizeOverLife"),this.size=e}return _createClass(SizeOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){e.size=e.startSize*this.size.genValue(e.age/e.life)}},{key:"toJSON",value:function toJSON(){return{type:this.type,size:this.size.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SizeOverLife(this.size.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SizeOverLife(ValueGeneratorFromJSON(e.size))}}]),SizeOverLife}(),A=function(){function SpeedOverLife(e){_classCallCheck(this,SpeedOverLife),_defineProperty(this,"type","SpeedOverLife"),this.speed=e}return _createClass(SpeedOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){e.speedModifier=this.speed.genValue(e.age/e.life)}},{key:"toJSON",value:function toJSON(){return{type:this.type,speed:this.speed.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SpeedOverLife(this.speed.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SpeedOverLife(ValueGeneratorFromJSON(e.speed))}}]),SpeedOverLife}(),J=function(){function FrameOverLife(e){_classCallCheck(this,FrameOverLife),_defineProperty(this,"type","FrameOverLife"),this.frame=e}return _createClass(FrameOverLife,[{key:"initialize",value:function initialize(e){this.frame instanceof N||(e.uvTile=Math.floor(this.frame.genValue(0)))}},{key:"update",value:function update(e,t){this.frame instanceof N&&(e.uvTile=Math.floor(this.frame.genValue(e.age/e.life)))}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,frame:this.frame.toJSON()}}},{key:"clone",value:function clone(){return new FrameOverLife(this.frame.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new FrameOverLife(ValueGeneratorFromJSON(e.frame))}}]),FrameOverLife}();new t.Vector3(0,0,1);var L=function(){function OrbitOverLife(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new t.Vector3(0,1,0);_classCallCheck(this,OrbitOverLife),_defineProperty(this,"type","OrbitOverLife"),_defineProperty(this,"rotation",void 0),_defineProperty(this,"line",void 0),_defineProperty(this,"temp",new t.Vector3),this.orbitSpeed=e,this.axis=i,this.rotation=new t.Quaternion,this.line=new t.Line3}return _createClass(OrbitOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,i){this.line.set(new t.Vector3(0,0,0),this.axis),this.line.closestPointToPoint(e.position,!1,this.temp),this.rotation.setFromAxisAngle(this.axis,this.orbitSpeed.genValue(e.age/e.life)*i),e.position.sub(this.temp),e.position.applyQuaternion(this.rotation),e.position.add(this.temp)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,orbitSpeed:this.orbitSpeed.toJSON(),axis:[this.axis.x,this.axis.y,this.axis.z]}}},{key:"clone",value:function clone(){return new OrbitOverLife(this.orbitSpeed.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new OrbitOverLife(ValueGeneratorFromJSON(e.orbitSpeed),e.axis?new t.Vector3(e.axis[0],e.axis[1],e.axis[2]):void 0)}}]),OrbitOverLife}(),U=function(){function WidthOverLength(e){_classCallCheck(this,WidthOverLength),_defineProperty(this,"type","WidthOverLength"),this.width=e}return _createClass(WidthOverLength,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){if(e instanceof l)for(var t=e.previous.values(),i=0;i<e.previous.length;i++)t.next().value.size=this.width.genValue((e.previous.length-i)/e.length)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,width:this.width.toJSON()}}},{key:"clone",value:function clone(){return new WidthOverLength(this.width.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new WidthOverLength(ValueGeneratorFromJSON(e.width))}}]),WidthOverLength}(),R=function(){function ApplyForce(e,t){_classCallCheck(this,ApplyForce),_defineProperty(this,"type","ApplyForce"),_defineProperty(this,"magnitudeValue",void 0),this.direction=e,this.magnitude=t,this.magnitudeValue=this.magnitude.genValue()}return _createClass(ApplyForce,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){e.velocity.addScaledVector(this.direction,this.magnitudeValue*t)}},{key:"frameUpdate",value:function frameUpdate(e){this.magnitudeValue=this.magnitude.genValue()}},{key:"toJSON",value:function toJSON(){return{type:this.type,direction:[this.direction.x,this.direction.y,this.direction.z],magnitude:this.magnitude.toJSON()}}},{key:"clone",value:function clone(){return new ApplyForce(this.direction.clone(),this.magnitude.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){var i;return new ApplyForce(new t.Vector3(e.direction[0],e.direction[1],e.direction[2]),ValueGeneratorFromJSON(null!==(i=e.magnitude)&&void 0!==i?i:e.force))}}]),ApplyForce}(),I=function(){function GravityForce(e,i){_classCallCheck(this,GravityForce),_defineProperty(this,"type","GravityForce"),_defineProperty(this,"temp",new t.Vector3),this.center=e,this.magnitude=i}return _createClass(GravityForce,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this.temp.copy(this.center).sub(e.position).normalize(),e.velocity.addScaledVector(this.temp,this.magnitude/e.position.distanceToSquared(this.center)*t)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,center:[this.center.x,this.center.y,this.center.z],magnitude:this.magnitude}}},{key:"clone",value:function clone(){return new GravityForce(this.center.clone(),this.magnitude)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new GravityForce(new t.Vector3(e.center[0],e.center[1],e.center[2]),e.magnitude)}}]),GravityForce}();new t.Vector3(0,0,1);var G=function(){function ChangeEmitDirection(e){_classCallCheck(this,ChangeEmitDirection),_defineProperty(this,"type","ChangeEmitDirection"),_defineProperty(this,"_temp",new t.Vector3),_defineProperty(this,"_q",new t.Quaternion),this.angle=e}return _createClass(ChangeEmitDirection,[{key:"initialize",value:function initialize(e){var t=e.velocity.length();0!=t&&(e.velocity.normalize(),0===e.velocity.x&&0===e.velocity.y?this._temp.set(0,e.velocity.z,0):this._temp.set(-e.velocity.y,e.velocity.x,0),this._q.setFromAxisAngle(this._temp.normalize(),this.angle.genValue()),this._temp.copy(e.velocity),e.velocity.applyQuaternion(this._q),this._q.setFromAxisAngle(this._temp,Math.random()*Math.PI*2),e.velocity.applyQuaternion(this._q),e.velocity.setLength(t))}},{key:"update",value:function update(e,t){}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,angle:this.angle.toJSON()}}},{key:"clone",value:function clone(){return new ChangeEmitDirection(this.angle)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ChangeEmitDirection(ValueGeneratorFromJSON(e.angle))}}]),ChangeEmitDirection}(),D=new t.Vector3(1,1,1),q=new t.Vector3(0,0,1),X=function(e){return e[e.Death=0]="Death",e[e.Birth=1]="Birth",e[e.Frame=2]="Frame",e}({}),j=function(){function EmitSubParticleSystem(e,i,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:X.Frame,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;_classCallCheck(this,EmitSubParticleSystem),_defineProperty(this,"type","EmitSubParticleSystem"),_defineProperty(this,"q_",new t.Quaternion),_defineProperty(this,"v_",new t.Vector3),_defineProperty(this,"v2_",new t.Vector3),_defineProperty(this,"subEmissions",new Array),this.particleSystem=e,this.useVelocityAsBasis=i,this.subParticleSystem=r,this.mode=n,this.emitProbability=o,this.subParticleSystem&&this.subParticleSystem.system&&(this.subParticleSystem.system.onlyUsedByOther=!0)}return _createClass(EmitSubParticleSystem,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){(this.mode===X.Frame||this.mode===X.Birth&&0===e.age||this.mode===X.Death&&e.age+t>=e.life)&&this.emit(e,t)}},{key:"emit",value:function emit(e,i){if(this.subParticleSystem&&!(Math.random()>this.emitProbability)){var r=new t.Matrix4;this.setMatrixFromParticle(r,e),this.subEmissions.push({burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,matrix:r,travelDistance:0,particle:e})}}},{key:"frameUpdate",value:function frameUpdate(e){if(this.subParticleSystem)for(var t=0;t<this.subEmissions.length;t++)if(this.subEmissions[t].time>=this.subParticleSystem.system.duration)this.subEmissions[t]=this.subEmissions[this.subEmissions.length-1],this.subEmissions.length=this.subEmissions.length-1,t--;else{var i=this.subEmissions[t];i.particle&&i.particle.age<i.particle.life?this.setMatrixFromParticle(i.matrix,i.particle):i.particle=void 0,console.log(i),console.log(this.subParticleSystem.system.emissionOverDistance),this.subParticleSystem.system.emit(e,i,i.matrix)}}},{key:"toJSON",value:function toJSON(){return{type:this.type,subParticleSystem:this.subParticleSystem?this.subParticleSystem.uuid:"",useVelocityAsBasis:this.useVelocityAsBasis,mode:this.mode,emitProbability:this.emitProbability}}},{key:"clone",value:function clone(){return new EmitSubParticleSystem(this.particleSystem,this.useVelocityAsBasis,this.subParticleSystem,this.mode,this.emitProbability)}},{key:"reset",value:function reset(){}},{key:"setMatrixFromParticle",value:function setMatrixFromParticle(e,i){var r;if(void 0===i.rotation||this.useVelocityAsBasis)if(0!==i.velocity.x||0!==i.velocity.y||1!==i.velocity.z&&0!==i.velocity.z){this.v_.copy(q).cross(i.velocity),this.v2_.copy(i.velocity).cross(this.v_);var n=this.v_.length(),o=this.v2_.length();e.set(this.v_.x/n,this.v2_.x/o,i.velocity.x,i.position.x,this.v_.y/n,this.v2_.y/o,i.velocity.y,i.position.y,this.v_.z/n,this.v2_.z/o,i.velocity.z,i.position.z,0,0,0,1)}else e.set(1,0,0,i.position.x,0,1,0,i.position.y,0,0,1,i.position.z,0,0,0,1);else i.rotation instanceof t.Quaternion?r=i.rotation:(this.q_.setFromAxisAngle(q,i.rotation),r=this.q_),e.compose(i.position,r,D);this.particleSystem.worldSpace||e.multiplyMatrices(this.particleSystem.emitter.matrixWorld,e)}}],[{key:"fromJSON",value:function fromJSON(e,t){return new EmitSubParticleSystem(t,e.useVelocityAsBasis,e.subParticleSystem,e.mode,e.emitProbability)}}]),EmitSubParticleSystem}(),H=.5*(Math.sqrt(3)-1),W=(3-Math.sqrt(3))/6,Q=1/6,Y=(Math.sqrt(5)-1)/4,Z=(5-Math.sqrt(5))/20,K=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),$=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),ee=function(){function SimplexNoise(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.random;_classCallCheck(this,SimplexNoise),_defineProperty(this,"p",void 0),_defineProperty(this,"perm",void 0),_defineProperty(this,"permMod12",void 0);var t="function"==typeof e?e:function alea(e){var t=0,i=0,r=0,n=1,o=function masher(){var e=4022871197;return function(t){t=t.toString();for(var i=0;i<t.length;i++){var r=.02519603282416938*(e+=t.charCodeAt(i));r-=e=r>>>0,e=(r*=e)>>>0,e+=4294967296*(r-=e)}return 2.3283064365386963e-10*(e>>>0)}}();return t=o(" "),i=o(" "),r=o(" "),(t-=o(e))<0&&(t+=1),(i-=o(e))<0&&(i+=1),(r-=o(e))<0&&(r+=1),function(){var e=2091639*t+2.3283064365386963e-10*n;return t=i,i=r,r=e-(n=0|e)}}(e);this.p=function buildPermutationTable(e){for(var t=new Uint8Array(256),i=0;i<256;i++)t[i]=i;for(var r=0;r<255;r++){var n=r+~~(e()*(256-r)),o=t[r];t[r]=t[n],t[n]=o}return t}(t),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var i=0;i<512;i++)this.perm[i]=this.p[255&i],this.permMod12[i]=this.perm[i]%12}return _createClass(SimplexNoise,[{key:"noise2D",value:function noise2D(e,t){var i,r,n=this.permMod12,o=this.perm,a=0,s=0,l=0,u=(e+t)*H,c=Math.floor(e+u),d=Math.floor(t+u),h=(c+d)*W,f=e-(c-h),p=t-(d-h);f>p?(i=1,r=0):(i=0,r=1);var m=f-i+W,y=p-r+W,v=f-1+2*W,g=p-1+2*W,S=255&c,_=255&d,w=.5-f*f-p*p;if(w>=0){var O=3*n[S+o[_]];a=(w*=w)*w*(K[O]*f+K[O+1]*p)}var x=.5-m*m-y*y;if(x>=0){var b=3*n[S+i+o[_+r]];s=(x*=x)*x*(K[b]*m+K[b+1]*y)}var N=.5-v*v-g*g;if(N>=0){var P=3*n[S+1+o[_+1]];l=(N*=N)*N*(K[P]*v+K[P+1]*g)}return 70*(a+s+l)}},{key:"noise3D",value:function noise3D(e,t,i){var r,n,o,a,s,l,u,c,d,h,f=this.permMod12,p=this.perm,m=.3333333333333333*(e+t+i),y=Math.floor(e+m),v=Math.floor(t+m),g=Math.floor(i+m),S=(y+v+g)*Q,_=e-(y-S),w=t-(v-S),O=i-(g-S);_>=w?w>=O?(s=1,l=0,u=0,c=1,d=1,h=0):_>=O?(s=1,l=0,u=0,c=1,d=0,h=1):(s=0,l=0,u=1,c=1,d=0,h=1):w<O?(s=0,l=0,u=1,c=0,d=1,h=1):_<O?(s=0,l=1,u=0,c=0,d=1,h=1):(s=0,l=1,u=0,c=1,d=1,h=0);var x=_-s+Q,b=w-l+Q,N=O-u+Q,P=_-c+2*Q,k=w-d+2*Q,M=O-h+2*Q,C=_-1+.5,V=w-1+.5,B=O-1+.5,T=255&y,E=255&v,z=255&g,A=.6-_*_-w*w-O*O;if(A<0)r=0;else{var J=3*f[T+p[E+p[z]]];r=(A*=A)*A*(K[J]*_+K[J+1]*w+K[J+2]*O)}var L=.6-x*x-b*b-N*N;if(L<0)n=0;else{var U=3*f[T+s+p[E+l+p[z+u]]];n=(L*=L)*L*(K[U]*x+K[U+1]*b+K[U+2]*N)}var R=.6-P*P-k*k-M*M;if(R<0)o=0;else{var I=3*f[T+c+p[E+d+p[z+h]]];o=(R*=R)*R*(K[I]*P+K[I+1]*k+K[I+2]*M)}var G=.6-C*C-V*V-B*B;if(G<0)a=0;else{var D=3*f[T+1+p[E+1+p[z+1]]];a=(G*=G)*G*(K[D]*C+K[D+1]*V+K[D+2]*B)}return 32*(r+n+o+a)}},{key:"noise4D",value:function noise4D(e,t,i,r){var n,o,a,s,l,u=this.perm,c=(e+t+i+r)*Y,d=Math.floor(e+c),h=Math.floor(t+c),f=Math.floor(i+c),p=Math.floor(r+c),m=(d+h+f+p)*Z,y=e-(d-m),v=t-(h-m),g=i-(f-m),S=r-(p-m),_=0,w=0,O=0,x=0;y>v?_++:w++,y>g?_++:O++,y>S?_++:x++,v>g?w++:O++,v>S?w++:x++,g>S?O++:x++;var b=_>=3?1:0,N=w>=3?1:0,P=O>=3?1:0,k=x>=3?1:0,M=_>=2?1:0,C=w>=2?1:0,V=O>=2?1:0,B=x>=2?1:0,T=_>=1?1:0,E=w>=1?1:0,z=O>=1?1:0,A=x>=1?1:0,J=y-b+Z,L=v-N+Z,U=g-P+Z,R=S-k+Z,I=y-M+2*Z,G=v-C+2*Z,D=g-V+2*Z,q=S-B+2*Z,X=y-T+3*Z,j=v-E+3*Z,H=g-z+3*Z,W=S-A+3*Z,Q=y-1+4*Z,K=v-1+4*Z,ee=g-1+4*Z,te=S-1+4*Z,ie=255&d,re=255&h,ne=255&f,oe=255&p,ae=.6-y*y-v*v-g*g-S*S;if(ae<0)n=0;else{var se=u[ie+u[re+u[ne+u[oe]]]]%32*4;n=(ae*=ae)*ae*($[se]*y+$[se+1]*v+$[se+2]*g+$[se+3]*S)}var le=.6-J*J-L*L-U*U-R*R;if(le<0)o=0;else{var ue=u[ie+b+u[re+N+u[ne+P+u[oe+k]]]]%32*4;o=(le*=le)*le*($[ue]*J+$[ue+1]*L+$[ue+2]*U+$[ue+3]*R)}var ce=.6-I*I-G*G-D*D-q*q;if(ce<0)a=0;else{var de=u[ie+M+u[re+C+u[ne+V+u[oe+B]]]]%32*4;a=(ce*=ce)*ce*($[de]*I+$[de+1]*G+$[de+2]*D+$[de+3]*q)}var he=.6-X*X-j*j-H*H-W*W;if(he<0)s=0;else{var fe=u[ie+T+u[re+E+u[ne+z+u[oe+A]]]]%32*4;s=(he*=he)*he*($[fe]*X+$[fe+1]*j+$[fe+2]*H+$[fe+3]*W)}var pe=.6-Q*Q-K*K-ee*ee-te*te;if(pe<0)l=0;else{var me=u[ie+1+u[re+1+u[ne+1+u[oe+1]]]]%32*4;l=(pe*=pe)*pe*($[me]*Q+$[me+1]*K+$[me+2]*ee+$[me+3]*te)}return 27*(n+o+a+s+l)}}]),SimplexNoise}(),te=function(){function TurbulenceField(e,i,r,n){_classCallCheck(this,TurbulenceField),_defineProperty(this,"type","TurbulenceField"),_defineProperty(this,"generator",new ee),_defineProperty(this,"timeOffset",new t.Vector3),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"temp2",new t.Vector3),this.scale=e,this.octaves=i,this.velocityMultiplier=r,this.timeScale=n,this.timeOffset.x=Math.random()/this.scale.x*this.timeScale.x,this.timeOffset.y=Math.random()/this.scale.y*this.timeScale.y,this.timeOffset.z=Math.random()/this.scale.z*this.timeScale.z}return _createClass(TurbulenceField,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=e.position.x/this.scale.x,r=e.position.y/this.scale.y,n=e.position.z/this.scale.z;this.temp.set(0,0,0);for(var o=1,a=0;a<this.octaves;a++)this.temp2.set(this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.x*o)/o,this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.y*o)/o,this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.z*o)/o),this.temp.add(this.temp2),o*=2;this.temp.multiply(this.velocityMultiplier),e.velocity.addScaledVector(this.temp,t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,scale:[this.scale.x,this.scale.y,this.scale.z],octaves:this.octaves,velocityMultiplier:[this.velocityMultiplier.x,this.velocityMultiplier.y,this.velocityMultiplier.z],timeScale:[this.timeScale.x,this.timeScale.y,this.timeScale.z]}}},{key:"frameUpdate",value:function frameUpdate(e){this.timeOffset.x+=e*this.timeScale.x,this.timeOffset.y+=e*this.timeScale.y,this.timeOffset.z+=e*this.timeScale.z}},{key:"clone",value:function clone(){return new TurbulenceField(this.scale.clone(),this.octaves,this.velocityMultiplier.clone(),this.timeScale.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new TurbulenceField(new t.Vector3(e.scale[0],e.scale[1],e.scale[2]),e.octaves,new t.Vector3(e.velocityMultiplier[0],e.velocityMultiplier[1],e.velocityMultiplier[2]),new t.Vector3(e.timeScale[0],e.timeScale[1],e.timeScale[2]))}}]),TurbulenceField}();function randomInt(e,t){return Math.floor(Math.random()*(t-e))+e}var ie=[],re=new t.Vector3,ne=new t.Quaternion,oe=function(){function Noise(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new O(1),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new O(0);if(_classCallCheck(this,Noise),_defineProperty(this,"type","Noise"),_defineProperty(this,"duration",0),this.frequency=e,this.power=t,this.positionAmount=i,this.rotationAmount=r,0===ie.length)for(var n=0;n<100;n++)ie.push(new ee)}return _createClass(Noise,[{key:"initialize",value:function initialize(e){e.seed=10*Math.random(),e.lastPosNoise=new t.Vector3,"number"==typeof e.rotation?e.lastRotNoise=0:e.lastRotNoise=new t.Quaternion,e.generatorIndex=[randomInt(0,100),randomInt(0,100),randomInt(0,100),randomInt(0,100)]}},{key:"update",value:function update(e,t){var i=this.frequency.genValue(e.age/e.life),r=this.power.genValue(e.age/e.life),n=this.positionAmount.genValue(e.age/e.life),o=this.rotationAmount.genValue(e.age/e.life);n>0&&(e.position.sub(e.lastPosNoise),re.set(ie[e.generatorIndex[0]].noise2D(0,e.age*i)*r*n,ie[e.generatorIndex[1]].noise2D(0,e.age*i)*r*n,ie[e.generatorIndex[2]].noise2D(0,e.age*i)*r*n),e.position.add(re),e.lastPosNoise.copy(re)),o>0&&("number"==typeof e.rotation?(e.rotation-=e.lastRotNoise,e.rotation+=ie[e.generatorIndex[3]].noise2D(0,e.age*i)*Math.PI*r*o):(e.lastRotNoise.invert(),e.rotation.multiply(e.lastRotNoise),ne.set(ie[e.generatorIndex[0]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[1]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[2]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[3]].noise2D(0,e.age*i)*r*o).normalize(),e.rotation.multiply(ne),e.lastRotNoise.copy(ne)))}},{key:"toJSON",value:function toJSON(){return{type:this.type,frequency:this.frequency.toJSON(),power:this.power.toJSON(),positionAmount:this.positionAmount.toJSON(),rotationAmount:this.rotationAmount.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){this.duration+=e}},{key:"clone",value:function clone(){return new Noise(this.frequency.clone(),this.power.clone(),this.positionAmount.clone(),this.rotationAmount.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new Noise(ValueGeneratorFromJSON(e.frequency),ValueGeneratorFromJSON(e.power),ValueGeneratorFromJSON(e.positionAmount),ValueGeneratorFromJSON(e.rotationAmount))}}]),Noise}(),ae=function(){function TextureSequencer(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new t.Vector3;_classCallCheck(this,TextureSequencer),_defineProperty(this,"locations",[]),this.scaleX=e,this.scaleY=i,this.position=r}return _createClass(TextureSequencer,[{key:"transform",value:function transform(e,t){e.x=this.locations[t%this.locations.length].x*this.scaleX+this.position.x,e.y=this.locations[t%this.locations.length].y*this.scaleY+this.position.y,e.z=this.position.z}},{key:"clone",value:function clone(){var e=new TextureSequencer(this.scaleX,this.scaleY,this.position.clone());return e.locations=this.locations.map((function(e){return e.clone()})),e}},{key:"toJSON",value:function toJSON(){return{scaleX:this.scaleX,scaleY:this.scaleY,position:this.position,locations:this.locations.map((function(e){return{x:e.x,y:e.y}}))}}},{key:"fromImage",value:function fromImage(e,i){var r=document.createElement("canvas");r.width=e.width,r.height=e.height;var n=r.getContext("2d");if(n){n.drawImage(e,0,0);var o=n.getImageData(0,0,r.width,r.height,{colorSpace:"srgb"});r.remove(),this.locations.length=0;for(var a=0;a<o.height;a++)for(var s=0;s<o.width;s++)o.data[4*(a*o.width+s)+3]>i&&this.locations.push(new t.Vector2(s,o.height-a))}}}],[{key:"fromJSON",value:function fromJSON(e){var i=new TextureSequencer(e.scaleX,e.scaleY,new t.Vector3(e.position[0],e.position[1],e.position[2]));return i.locations=e.locations.map((function(e){return new t.Vector2(e.x,e.y)})),i}}]),TextureSequencer}();function SequencerFromJSON(e){return"TextureSequencer"===e.type?ae.fromJSON(e):new ae}var se,le=function(){function ApplySequences(e){_classCallCheck(this,ApplySequences),_defineProperty(this,"type","ApplySequences"),_defineProperty(this,"sequencers",[]),_defineProperty(this,"time",0),_defineProperty(this,"index",0),_defineProperty(this,"pCount",0),_defineProperty(this,"delay",void 0),_defineProperty(this,"tempV",new t.Vector3),this.delay=e}return _createClass(ApplySequences,[{key:"initialize",value:function initialize(e){e.id=this.pCount,e.dst=new t.Vector3,e.begin=new t.Vector3,e.inMotion=!1,this.pCount++}},{key:"reset",value:function reset(){this.time=0,this.index=0,this.pCount=0}},{key:"update",value:function update(e,t){var i=this.sequencers[this.index],r=e.id*this.delay;this.time>=i[0].a+r&&this.time<=i[0].b+r?(e.inMotion||(e.inMotion=!0,e.begin.copy(e.position),i[1].transform(e.dst,e.id)),e.position.lerpVectors(e.begin,e.dst,ApplySequences.BEZIER.genValue((this.time-i[0].a-r)/(i[0].b-i[0].a)))):this.time>i[0].b+r&&(e.inMotion=!1)}},{key:"frameUpdate",value:function frameUpdate(e){for(;this.index+1<this.sequencers.length&&this.time>=this.sequencers[this.index+1][0].a;)this.index++;this.time+=e}},{key:"appendSequencer",value:function appendSequencer(e,t){this.sequencers.push([e,t])}},{key:"toJSON",value:function toJSON(){return{type:this.type,delay:this.delay,sequencers:this.sequencers.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return{range:i.toJSON(),sequencer:r.toJSON()}}))}}},{key:"clone",value:function clone(){var e=new ApplySequences(this.delay);return e.sequencers=this.sequencers.map((function(e){return[e[0].clone(),e[1].clone()]})),e}}],[{key:"fromJSON",value:function fromJSON(e){var t=new ApplySequences(e.delay);return e.sequencers.forEach((function(e){t.sequencers.push([ValueGeneratorFromJSON(e.range),SequencerFromJSON(e.sequencer)])})),t}}]),ApplySequences}();function getPhysicsResolver(){return se}_defineProperty(le,"BEZIER",new u(0,0,1,1));var ue=function(){function ApplyCollision(e,i){_classCallCheck(this,ApplyCollision),_defineProperty(this,"type","ApplyCollision"),_defineProperty(this,"tempV",new t.Vector3),this.resolver=e,this.bounce=i}return _createClass(ApplyCollision,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this.resolver.resolve(e.position,this.tempV)&&e.velocity.reflect(this.tempV).multiplyScalar(this.bounce)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,bounce:this.bounce}}},{key:"clone",value:function clone(){return new ApplyCollision(this.resolver,this.bounce)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ApplyCollision(getPhysicsResolver(),e.bounce)}}]),ApplyCollision}(),ce=function(){function ColorBySpeed(e,t){_classCallCheck(this,ColorBySpeed),_defineProperty(this,"type","ColorBySpeed"),this.color=e,this.speedRange=t}return _createClass(ColorBySpeed,[{key:"initialize",value:function initialize(e){"memorizedFunction"===this.color.type&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function update(e,t){var i=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);"memorizedFunction"===this.color.type?this.color.genColor(e.color,i,e.colorOverLifeMemory):this.color.genColor(e.color,i),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,color:this.color.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"clone",value:function clone(){return new ColorBySpeed(this.color.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorBySpeed(ColorGeneratorFromJSON(e.color),x.fromJSON(e.speedRange))}}]),ColorBySpeed}(),de=function(){function SizeBySpeed(e,t){_classCallCheck(this,SizeBySpeed),_defineProperty(this,"type","SizeBySpeed"),this.size=e,this.speedRange=t}return _createClass(SizeBySpeed,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){var t=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.size=e.startSize*this.size.genValue(t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,size:this.size.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SizeBySpeed(this.size.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SizeBySpeed(ValueGeneratorFromJSON(e.size),x.fromJSON(e.speedRange))}}]),SizeBySpeed}(),he=function(){function RotationBySpeed(e,i){_classCallCheck(this,RotationBySpeed),_defineProperty(this,"type","RotationBySpeed"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.speedRange=i}return _createClass(RotationBySpeed,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.rotation+=t*this.angularVelocity.genValue(i)}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new RotationBySpeed(this.angularVelocity.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new RotationBySpeed(ValueGeneratorFromJSON(e.angularVelocity),x.fromJSON(e.speedRange))}}]),RotationBySpeed}(),fe=function(){function LimitSpeedOverLife(e,t){_classCallCheck(this,LimitSpeedOverLife),_defineProperty(this,"type","LimitSpeedOverLife"),this.speed=e,this.dampen=t}return _createClass(LimitSpeedOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=e.velocity.length(),r=this.speed.genValue(e.age/e.life);if(i>r){var n=(i-r)/i;e.velocity.multiplyScalar(1-n*this.dampen*t*20)}}},{key:"toJSON",value:function toJSON(){return{type:this.type,speed:this.speed.toJSON(),dampen:this.dampen}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new LimitSpeedOverLife(this.speed.clone(),this.dampen)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new LimitSpeedOverLife(ValueGeneratorFromJSON(e.speed),e.dampen)}}]),LimitSpeedOverLife}(),pe={ApplyForce:{type:"ApplyForce",constructor:R,params:[["direction","vec3"],["magnitude","value"]],loadJSON:R.fromJSON},Noise:{type:"Noise",constructor:oe,params:[["frequency","value"],["power","value"],["positionAmount","value"],["rotationAmount","value"]],loadJSON:oe.fromJSON},TurbulenceField:{type:"TurbulenceField",constructor:te,params:[["scale","vec3"],["octaves","number"],["velocityMultiplier","vec3"],["timeScale","vec3"]],loadJSON:te.fromJSON},GravityForce:{type:"GravityForce",constructor:I,params:[["center","vec3"],["magnitude","number"]],loadJSON:I.fromJSON},ColorOverLife:{type:"ColorOverLife",constructor:C,params:[["color","colorFunc"]],loadJSON:C.fromJSON},RotationOverLife:{type:"RotationOverLife",constructor:V,params:[["angularVelocity","valueFunc"],["dynamic","boolean"]],loadJSON:V.fromJSON},Rotation3DOverLife:{type:"Rotation3DOverLife",constructor:T,params:[["angularVelocity","rotationFunc"],["dynamic","boolean"]],loadJSON:T.fromJSON},SizeOverLife:{type:"SizeOverLife",constructor:z,params:[["size","valueFunc"]],loadJSON:z.fromJSON},ColorBySpeed:{type:"ColorBySpeed",constructor:ce,params:[["color","colorFunc"],["speedRange","range"]],loadJSON:ce.fromJSON},RotationBySpeed:{type:"RotationBySpeed",constructor:he,params:[["angularVelocity","valueFunc"],["speedRange","range"]],loadJSON:he.fromJSON},SizeBySpeed:{type:"SizeBySpeed",constructor:de,params:[["size","valueFunc"],["speedRange","range"]],loadJSON:de.fromJSON},SpeedOverLife:{type:"SpeedOverLife",constructor:A,params:[["speed","valueFunc"]],loadJSON:A.fromJSON},FrameOverLife:{type:"FrameOverLife",constructor:J,params:[["frame","valueFunc"]],loadJSON:J.fromJSON},ForceOverLife:{type:"ForceOverLife",constructor:E,params:[["x","valueFunc"],["y","valueFunc"],["z","valueFunc"]],loadJSON:E.fromJSON},OrbitOverLife:{type:"OrbitOverLife",constructor:L,params:[["orbitSpeed","valueFunc"],["axis","vec3"]],loadJSON:L.fromJSON},WidthOverLength:{type:"WidthOverLength",constructor:U,params:[["width","valueFunc"]],loadJSON:U.fromJSON},ChangeEmitDirection:{type:"ChangeEmitDirection",constructor:G,params:[["angle","value"]],loadJSON:G.fromJSON},EmitSubParticleSystem:{type:"EmitSubParticleSystem",constructor:j,params:[["particleSystem","self"],["useVelocityAsBasis","boolean"],["subParticleSystem","particleSystem"],["mode","number"],["emitProbability","number"]],loadJSON:j.fromJSON},LimitSpeedOverLife:{type:"LimitSpeedOverLife",constructor:fe,params:[["speed","valueFunc"],["dampen","number"]],loadJSON:fe.fromJSON}};function BehaviorFromJSON(e,t){return pe[e.type].loadJSON(e,t)}var me=function(){function ConeEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,ConeEmitter),_defineProperty(this,"type","cone"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),_defineProperty(this,"angle",void 0),this.radius=null!==(e=n.radius)&&void 0!==e?e:10,this.arc=null!==(t=n.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=n.thickness)&&void 0!==i?i:1,this.angle=null!==(r=n.angle)&&void 0!==r?r:Math.PI/6}return _createClass(ConeEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=t.MathUtils.lerp(1-this.thickness,1,Math.random()),n=i*this.arc,o=Math.sqrt(r),a=Math.sin(n),s=Math.cos(n);e.position.x=o*s,e.position.y=o*a,e.position.z=0;var l=this.angle*o;e.velocity.set(0,0,Math.cos(l)).addScaledVector(e.position,Math.sin(l)).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius)}},{key:"toJSON",value:function toJSON(){return{type:"cone",radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle}}},{key:"clone",value:function clone(){return new ConeEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle})}}],[{key:"fromJSON",value:function fromJSON(e){return new ConeEmitter(e)}}]),ConeEmitter}(),ye=function(){function CircleEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,CircleEmitter),_defineProperty(this,"type","circle"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(CircleEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=t.MathUtils.lerp(1-this.thickness,1,Math.random()),n=i*this.arc;e.position.x=Math.cos(n),e.position.y=Math.sin(n),e.position.z=0,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*r)}},{key:"toJSON",value:function toJSON(){return{type:"circle",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new CircleEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new CircleEmitter(e)}}]),CircleEmitter}(),ve=function(){function DonutEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,DonutEmitter),_defineProperty(this,"type","donut"),_defineProperty(this,"radius",void 0),_defineProperty(this,"donutRadius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=n.radius)&&void 0!==e?e:10,this.arc=null!==(t=n.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=n.thickness)&&void 0!==i?i:1,this.donutRadius=null!==(r=n.donutRadius)&&void 0!==r?r:.2*this.radius}return _createClass(DonutEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=r*Math.PI*2,s=Math.sin(o),l=Math.cos(o);e.position.x=this.radius*l,e.position.y=this.radius*s,e.position.z=0,e.velocity.z=this.donutRadius*n*Math.sin(a),e.velocity.x=this.donutRadius*n*Math.cos(a)*l,e.velocity.y=this.donutRadius*n*Math.cos(a)*s,e.position.add(e.velocity),e.velocity.normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"donut",radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius}}},{key:"clone",value:function clone(){return new DonutEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius})}}],[{key:"fromJSON",value:function fromJSON(e){return new DonutEmitter(e)}}]),DonutEmitter}(),ge=function(){function PointEmitter(){_classCallCheck(this,PointEmitter),_defineProperty(this,"type","point")}return _createClass(PointEmitter,[{key:"initialize",value:function initialize(e){var t=Math.random(),i=Math.random(),r=t*Math.PI*2,n=Math.acos(2*i-1),o=Math.cbrt(Math.random()),a=Math.sin(r),s=Math.cos(r),l=Math.sin(n),u=Math.cos(n);e.velocity.x=o*l*s,e.velocity.y=o*l*a,e.velocity.z=o*u,e.velocity.multiplyScalar(e.startSpeed),e.position.setScalar(0)}},{key:"toJSON",value:function toJSON(){return{type:"point"}}},{key:"clone",value:function clone(){return new PointEmitter}}],[{key:"fromJSON",value:function fromJSON(e){return new PointEmitter}}]),PointEmitter}(),Se=function(){function SphereEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,SphereEmitter),_defineProperty(this,"type","sphere"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(SphereEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=Math.acos(2*r-1),s=Math.sin(o),l=Math.cos(o),u=Math.sin(a),c=Math.cos(a);e.position.x=u*l,e.position.y=u*s,e.position.z=c,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*n)}},{key:"toJSON",value:function toJSON(){return{type:"sphere",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new SphereEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new SphereEmitter(e)}}]),SphereEmitter}(),_e=function(){function HemisphereEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,HemisphereEmitter),_defineProperty(this,"type","sphere"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(HemisphereEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=Math.acos(r),s=Math.sin(o),l=Math.cos(o),u=Math.sin(a),c=Math.cos(a);e.position.x=u*l,e.position.y=u*s,e.position.z=c,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*n)}},{key:"toJSON",value:function toJSON(){return{type:"hemisphere",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new HemisphereEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new HemisphereEmitter(e)}}]),HemisphereEmitter}(),we=function(){function GridEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,GridEmitter),_defineProperty(this,"type","grid"),_defineProperty(this,"width",void 0),_defineProperty(this,"height",void 0),_defineProperty(this,"column",void 0),_defineProperty(this,"row",void 0),this.width=null!==(e=n.width)&&void 0!==e?e:1,this.height=null!==(t=n.height)&&void 0!==t?t:1,this.column=null!==(i=n.column)&&void 0!==i?i:10,this.row=null!==(r=n.row)&&void 0!==r?r:10}return _createClass(GridEmitter,[{key:"initialize",value:function initialize(e){var t=Math.floor(Math.random()*this.row),i=Math.floor(Math.random()*this.column);e.position.x=i*this.width/this.column-this.width/2,e.position.y=t*this.height/this.row-this.height/2,e.position.z=0,e.velocity.set(0,0,e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"grid",width:this.width,height:this.height,column:this.column,row:this.row}}},{key:"clone",value:function clone(){return new GridEmitter({width:this.width,height:this.height,column:this.column,row:this.row})}}],[{key:"fromJSON",value:function fromJSON(e){return new GridEmitter(e)}}]),GridEmitter}(),Oe=function(){function MeshSurfaceEmitter(e){_classCallCheck(this,MeshSurfaceEmitter),_defineProperty(this,"type","mesh_surface"),_defineProperty(this,"_triangleIndexToArea",[]),_defineProperty(this,"_geometry",void 0),_defineProperty(this,"_tempA",new t.Vector3),_defineProperty(this,"_tempB",new t.Vector3),_defineProperty(this,"_tempC",new t.Vector3),e&&(this.geometry=e)}return _createClass(MeshSurfaceEmitter,[{key:"geometry",get:function get(){return this._geometry},set:function set(e){if(this._geometry=e,void 0!==e&&"string"!=typeof e){var i=new t.Triangle;this._triangleIndexToArea.length=0;var r=0;if(e.getIndex()){var n=e.getIndex().array,o=n.length/3;this._triangleIndexToArea.push(0);for(var a=0;a<o;a++)i.setFromAttributeAndIndices(e.getAttribute("position"),n[3*a],n[3*a+1],n[3*a+2]),r+=i.getArea(),this._triangleIndexToArea.push(r);e.userData.triangleIndexToArea=this._triangleIndexToArea}}}},{key:"initialize",value:function initialize(e){var t=this._geometry;if(!t||null===t.getIndex())return e.position.set(0,0,0),void e.velocity.set(0,0,1).multiplyScalar(e.startSpeed);for(var i=this._triangleIndexToArea.length-1,r=0,n=i,o=Math.random()*this._triangleIndexToArea[i];r+1<n;){var a=Math.floor((r+n)/2);o<this._triangleIndexToArea[a]?n=a:r=a}var s=Math.random(),l=Math.random();s+l>1&&(s=1-s,l=1-l);var u=t.getIndex().array[3*r],c=t.getIndex().array[3*r+1],d=t.getIndex().array[3*r+2],h=t.getAttribute("position");this._tempA.fromBufferAttribute(h,u),this._tempB.fromBufferAttribute(h,c),this._tempC.fromBufferAttribute(h,d),this._tempB.sub(this._tempA),this._tempC.sub(this._tempA),this._tempA.addScaledVector(this._tempB,s).addScaledVector(this._tempC,l),e.position.copy(this._tempA),this._tempA.copy(this._tempB).cross(this._tempC).normalize(),e.velocity.copy(this._tempA).normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"mesh_surface",mesh:this._geometry?this._geometry.uuid:""}}},{key:"clone",value:function clone(){return new MeshSurfaceEmitter(this._geometry)}}],[{key:"fromJSON",value:function fromJSON(e,t){return new MeshSurfaceEmitter(t.geometries[e.geometry])}}]),MeshSurfaceEmitter}(),xe={circle:{type:"circle",params:[["radius","number"],["arc","radian"],["thickness","number"]],constructor:ye,loadJSON:ye.fromJSON},cone:{type:"cone",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:me,loadJSON:me.fromJSON},donut:{type:"donut",params:[["radius","number"],["arc","radian"],["thickness","number"],["donutRadius","number"]],constructor:ve,loadJSON:ve.fromJSON},point:{type:"point",params:[],constructor:ge,loadJSON:ge.fromJSON},sphere:{type:"sphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:Se,loadJSON:Se.fromJSON},hemisphere:{type:"hemisphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:_e,loadJSON:_e.fromJSON},grid:{type:"grid",params:[["width","number"],["height","number"],["rows","number"],["column","number"]],constructor:we,loadJSON:we.fromJSON},mesh_surface:{type:"mesh_surface",params:[["geometry","geometry"]],constructor:Oe,loadJSON:Oe.fromJSON}};function EmitterFromJSON(e,t){return xe[e.type].loadJSON(e,t)}var be=function(e){return e[e.BillBoard=0]="BillBoard",e[e.StretchedBillBoard=1]="StretchedBillBoard",e[e.Mesh=2]="Mesh",e[e.Trail=3]="Trail",e[e.HorizontalBillBoard=4]="HorizontalBillBoard",e[e.VerticalBillBoard=5]="VerticalBillBoard",e}({}),Ne=function(e){_inherits(VFXBatch,e);var i=_createSuper(VFXBatch);function VFXBatch(e){var r;_classCallCheck(this,VFXBatch),_defineProperty(_assertThisInitialized(r=i.call(this)),"type","VFXBatch"),_defineProperty(_assertThisInitialized(r),"systems",void 0),_defineProperty(_assertThisInitialized(r),"settings",void 0),_defineProperty(_assertThisInitialized(r),"maxParticles",void 0),r.maxParticles=1e3,r.systems=new Set;var n=new t.Layers;n.mask=e.layers.mask;var o=e.material.clone();return o.defines={},Object.assign(o.defines,e.material.defines),r.settings={instancingGeometry:e.instancingGeometry,renderMode:e.renderMode,renderOrder:e.renderOrder,material:o,uTileCount:e.uTileCount,vTileCount:e.vTileCount,layers:n},r.frustumCulled=!1,r.renderOrder=r.settings.renderOrder,r}return _createClass(VFXBatch,[{key:"addSystem",value:function addSystem(e){this.systems.add(e)}},{key:"removeSystem",value:function removeSystem(e){this.systems.delete(e)}}]),VFXBatch}(t.Mesh),Pe=new t.Vector3(0,0,1),ke=new t.Quaternion,Me=new t.Vector3,Ce=new t.Vector3;new t.Vector3;var Ve=new t.PlaneGeometry(1,1,1,1),Be=function(){function ParticleSystem(e){var r,n,o,a,s,l,u,c,d,h,f,p,m,y,v,g,S,_,x,b;if(_classCallCheck(this,ParticleSystem),_defineProperty(this,"autoDestroy",void 0),_defineProperty(this,"prewarm",void 0),_defineProperty(this,"looping",void 0),_defineProperty(this,"duration",void 0),_defineProperty(this,"startLife",void 0),_defineProperty(this,"startSpeed",void 0),_defineProperty(this,"startRotation",void 0),_defineProperty(this,"startSize",void 0),_defineProperty(this,"startColor",void 0),_defineProperty(this,"startTileIndex",void 0),_defineProperty(this,"rendererEmitterSettings",void 0),_defineProperty(this,"emissionOverTime",void 0),_defineProperty(this,"emissionOverDistance",void 0),_defineProperty(this,"emissionBursts",void 0),_defineProperty(this,"onlyUsedByOther",void 0),_defineProperty(this,"worldSpace",void 0),_defineProperty(this,"particleNum",void 0),_defineProperty(this,"paused",void 0),_defineProperty(this,"particles",void 0),_defineProperty(this,"emitterShape",void 0),_defineProperty(this,"emitter",void 0),_defineProperty(this,"rendererSettings",void 0),_defineProperty(this,"neededToUpdateRender",void 0),_defineProperty(this,"behaviors",void 0),_defineProperty(this,"prewarmed",void 0),_defineProperty(this,"emissionState",void 0),_defineProperty(this,"emitEnded",void 0),_defineProperty(this,"markForDestroy",void 0),_defineProperty(this,"previousWorldPos",void 0),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"travelDistance",0),_defineProperty(this,"normalMatrix",new t.Matrix3),_defineProperty(this,"_renderer",void 0),this.autoDestroy=void 0!==e.autoDestroy&&e.autoDestroy,this.duration=null!==(r=e.duration)&&void 0!==r?r:1,this.looping=void 0===e.looping||e.looping,this.prewarm=void 0!==e.prewarm&&e.prewarm,this.startLife=null!==(n=e.startLife)&&void 0!==n?n:new O(5),this.startSpeed=null!==(o=e.startSpeed)&&void 0!==o?o:new O(0),this.startRotation=null!==(a=e.startRotation)&&void 0!==a?a:new O(0),this.startSize=null!==(s=e.startSize)&&void 0!==s?s:new O(1),this.startColor=null!==(l=e.startColor)&&void 0!==l?l:new w(new t.Vector4(1,1,1,1)),this.emissionOverTime=null!==(u=e.emissionOverTime)&&void 0!==u?u:new O(10),this.emissionOverDistance=null!==(c=e.emissionOverDistance)&&void 0!==c?c:new O(0),this.emissionBursts=null!==(d=e.emissionBursts)&&void 0!==d?d:[],this.onlyUsedByOther=null!==(h=e.onlyUsedByOther)&&void 0!==h&&h,this.emitterShape=null!==(f=e.shape)&&void 0!==f?f:new Se,this.behaviors=null!==(p=e.behaviors)&&void 0!==p?p:new Array,this.worldSpace=null!==(m=e.worldSpace)&&void 0!==m&&m,this.rendererEmitterSettings=null!==(y=e.rendererEmitterSettings)&&void 0!==y?y:{},e.renderMode===be.StretchedBillBoard){var N,P,k=this.rendererEmitterSettings;void 0!==e.speedFactor&&(k.speedFactor=e.speedFactor),k.speedFactor=null!==(N=k.speedFactor)&&void 0!==N?N:0,k.lengthFactor=null!==(P=k.lengthFactor)&&void 0!==P?P:0}this.rendererSettings={instancingGeometry:null!==(v=e.instancingGeometry)&&void 0!==v?v:Ve,renderMode:null!==(g=e.renderMode)&&void 0!==g?g:be.BillBoard,renderOrder:null!==(S=e.renderOrder)&&void 0!==S?S:0,material:e.material,uTileCount:null!==(_=e.uTileCount)&&void 0!==_?_:1,vTileCount:null!==(x=e.vTileCount)&&void 0!==x?x:1,layers:null!==(b=e.layers)&&void 0!==b?b:new t.Layers},this.neededToUpdateRender=!0,this.particles=new Array,this.startTileIndex=e.startTileIndex||new O(0),this.emitter=new i(this),this.paused=!1,this.particleNum=0,this.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,travelDistance:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return _createClass(ParticleSystem,[{key:"time",get:function get(){return this.emissionState.time},set:function set(e){this.emissionState.time=e}},{key:"layers",get:function get(){return this.rendererSettings.layers}},{key:"texture",get:function get(){return this.rendererSettings.material.map},set:function set(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function get(){return this.rendererSettings.material},set:function set(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"uTileCount",get:function get(){return this.rendererSettings.uTileCount},set:function set(e){this.rendererSettings.uTileCount=e,this.neededToUpdateRender=!0}},{key:"vTileCount",get:function get(){return this.rendererSettings.vTileCount},set:function set(e){this.rendererSettings.vTileCount=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function get(){return this.rendererSettings.instancingGeometry},set:function set(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function get(){return this.rendererSettings.renderMode},set:function set(e){if((this.rendererSettings.renderMode!=be.Trail&&e===be.Trail||this.rendererSettings.renderMode==be.Trail&&e!==be.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==e)switch(e){case be.Trail:this.rendererEmitterSettings={startLength:new O(30),followLocalOrigin:!1};break;case be.Mesh:this.rendererEmitterSettings={geometry:new t.PlaneGeometry(1,1)},this.startRotation=new k(new t.Vector3(0,1,0),new O(0));break;case be.StretchedBillBoard:this.rendererEmitterSettings={speedFactor:0,lengthFactor:2},this.rendererSettings.renderMode===be.Mesh&&(this.startRotation=new O(0));break;case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:this.rendererEmitterSettings={},this.rendererSettings.renderMode===be.Mesh&&(this.startRotation=new O(0))}this.rendererSettings.renderMode=e,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function get(){return this.rendererSettings.renderOrder},set:function set(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function get(){return this.rendererSettings.material.blending},set:function set(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function pause(){this.paused=!0}},{key:"play",value:function play(){this.paused=!1}},{key:"spawn",value:function spawn(e,i,r){ke.setFromRotationMatrix(r);var n=Me,o=ke,s=Ce;r.decompose(n,o,s);for(var u=0;u<e;u++){for(this.particleNum++;this.particles.length<this.particleNum;)this.rendererSettings.renderMode===be.Trail?this.particles.push(new l):this.particles.push(new a);var c=this.particles[this.particleNum-1];if(this.startColor.genColor(c.startColor,this.emissionState.time,{}),c.color.copy(c.startColor),c.startSpeed=this.startSpeed.genValue(i.time/this.duration),c.life=this.startLife.genValue(i.time/this.duration),c.age=0,c.startSize=this.startSize.genValue(i.time/this.duration),c.uvTile=Math.floor(this.startTileIndex.genValue()),c.size=c.startSize,this.rendererSettings.renderMode===be.Mesh||this.rendererSettings.renderMode===be.BillBoard||this.rendererSettings.renderMode===be.VerticalBillBoard||this.rendererSettings.renderMode===be.HorizontalBillBoard||this.rendererSettings.renderMode===be.StretchedBillBoard){var d=c;this.rendererSettings.renderMode===be.Mesh?(d.rotation instanceof t.Quaternion||(d.rotation=new t.Quaternion),"rotation"===this.startRotation.type?this.startRotation.genValue(d.rotation,i.time/this.duration):d.rotation.setFromAxisAngle(Pe,this.startRotation.genValue(i.time/this.duration))):"rotation"===this.startRotation.type?d.rotation=0:d.rotation=this.startRotation.genValue(i.time/this.duration)}else if(this.rendererSettings.renderMode===be.Trail){var h=c;h.length=this.rendererEmitterSettings.startLength.genValue(i.time/this.duration),h.reset()}if(this.emitterShape.initialize(c),this.rendererSettings.renderMode===be.Trail&&this.rendererEmitterSettings.followLocalOrigin){var f=c;f.localPosition=(new t.Vector3).copy(f.position)}this.worldSpace?(c.position.applyMatrix4(r),c.startSize=c.startSize*(Math.abs(s.x)+Math.abs(s.y)+Math.abs(s.z))/3,c.size=c.startSize,c.velocity.multiply(s).applyMatrix3(this.normalMatrix),c.rotation&&c.rotation instanceof t.Quaternion&&c.rotation.multiplyQuaternions(ke,c.rotation)):this.onlyUsedByOther&&(c.parentMatrix=r);for(var p=0;p<this.behaviors.length;p++)this.behaviors[p].initialize(c)}}},{key:"endEmit",value:function endEmit(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function dispose(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function restart(){this.paused=!1,this.particleNum=0,this.emissionState.burstIndex=0,this.emissionState.burstWaveIndex=0,this.emissionState.time=0,this.emissionState.waitEmiting=0,this.behaviors.forEach((function(e){e.reset()})),this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function update(e){if(!this.paused){for(var t=this.emitter;t.parent;)t=t.parent;if("Scene"===t.type)if(this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var i=0;i<60*this.duration;i++)this.update(1/60)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.onlyUsedByOther||this.emit(e,this.emissionState,this.emitter.matrixWorld);for(var r=0;r<this.behaviors.length;r++){for(var n=0;n<this.particleNum;n++)this.particles[n].died||this.behaviors[r].update(this.particles[n],e);this.behaviors[r].frameUpdate(e)}for(var o=0;o<this.particleNum;o++){if(this.rendererEmitterSettings.followLocalOrigin&&this.particles[o].localPosition)this.particles[o].position.copy(this.particles[o].localPosition),this.particles[o].parentMatrix?this.particles[o].position.applyMatrix4(this.particles[o].parentMatrix):this.particles[o].position.applyMatrix4(this.emitter.matrixWorld);else{var a,s=null!==(a=this.particles[o].speedModifier)&&void 0!==a?a:1;this.particles[o].position.addScaledVector(this.particles[o].velocity,e*s)}this.particles[o].age+=e}if(this.rendererSettings.renderMode===be.Trail)for(var u=0;u<this.particleNum;u++)this.particles[u].update();for(var c=0;c<this.particleNum;c++){var d=this.particles[c];!d.died||d instanceof l&&0!==d.previous.length||(this.particles[c]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=d,this.particleNum--,c--)}}else this.dispose()}}},{key:"emit",value:function emit(e,i,r){i.time>this.duration&&(this.looping?(i.time-=this.duration,i.burstIndex=0,this.behaviors.forEach((function(e){e.reset()}))):this.emitEnded||this.onlyUsedByOther||this.endEmit()),this.normalMatrix.getNormalMatrix(r);var n=Math.ceil(i.waitEmiting);for(this.spawn(n,i,r),i.waitEmiting-=n;i.burstIndex<this.emissionBursts.length&&this.emissionBursts[i.burstIndex].time<=i.time;){if(Math.random()<this.emissionBursts[i.burstIndex].probability){var o=this.emissionBursts[i.burstIndex].count.genValue(this.time);this.spawn(o,i,r)}i.burstIndex++}if(!this.emitEnded&&(i.waitEmiting+=e*this.emissionOverTime.genValue(i.time/this.duration),null!=i.previousWorldPos)){this.temp.set(r.elements[12],r.elements[13],r.elements[14]),i.travelDistance+=i.previousWorldPos.distanceTo(this.temp);var a=this.emissionOverDistance.genValue(i.time/this.duration);if(i.travelDistance*a>0){var s=Math.floor(i.travelDistance*a);i.travelDistance-=s/a,i.waitEmiting+=s}}void 0===i.previousWorldPos&&(i.previousWorldPos=new t.Vector3),i.previousWorldPos.set(r.elements[12],r.elements[13],r.elements[14]),i.time+=e}},{key:"toJSON",value:function toJSON(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if((void 0===e||"string"==typeof e)&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}}),e.materials[this.rendererSettings.material.uuid]=this.rendererSettings.material.toJSON(e),i.useUrlForImage&&void 0!==this.texture.source){var r=this.texture.source;e.images[r.uuid]={uuid:r.uuid,url:this.texture.image.url}}t=this.renderMode===be.Trail?{startLength:this.rendererEmitterSettings.startLength.toJSON(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:this.renderMode===be.Mesh?{}:this.renderMode===be.StretchedBillBoard?{speedFactor:this.rendererEmitterSettings.speedFactor,lengthFactor:this.rendererEmitterSettings.lengthFactor}:{};var n=this.rendererSettings.instancingGeometry;return e.geometries&&!e.geometries[n.uuid]&&(e.geometries[n.uuid]=n.toJSON()),{version:"2.0",autoDestroy:this.autoDestroy,looping:this.looping,prewarm:this.prewarm,duration:this.duration,shape:this.emitterShape.toJSON(),startLife:this.startLife.toJSON(),startSpeed:this.startSpeed.toJSON(),startRotation:this.startRotation.toJSON(),startSize:this.startSize.toJSON(),startColor:this.startColor.toJSON(),emissionOverTime:this.emissionOverTime.toJSON(),emissionOverDistance:this.emissionOverDistance.toJSON(),emissionBursts:this.emissionBursts.map((function(e){return{time:e.time,count:e.count.toJSON(),probability:e.probability,interval:e.interval,cycle:e.cycle}})),onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry.uuid,renderOrder:this.renderOrder,renderMode:this.renderMode,rendererEmitterSettings:t,material:this.rendererSettings.material.uuid,layers:this.layers.mask,startTileIndex:this.startTileIndex.toJSON(),uTileCount:this.uTileCount,vTileCount:this.vTileCount,behaviors:this.behaviors.map((function(e){return e.toJSON()})),worldSpace:this.worldSpace}}},{key:"addBehavior",value:function addBehavior(e){this.behaviors.push(e)}},{key:"getRendererSettings",value:function getRendererSettings(){return this.rendererSettings}},{key:"clone",value:function clone(){var e,i=[],r=_createForOfIteratorHelper(this.emissionBursts);try{for(r.s();!(e=r.n()).done;){var n=e.value,o={};Object.assign(o,n),i.push(o)}}catch(e){r.e(e)}finally{r.f()}var a,s,l=[],u=_createForOfIteratorHelper(this.behaviors);try{for(u.s();!(a=u.n()).done;){var c=a.value;l.push(c.clone())}}catch(e){u.e(e)}finally{u.f()}s=this.renderMode===be.Trail?{startLength:this.rendererEmitterSettings.startLength.clone(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:{};var d=new t.Layers;return d.mask=this.layers.mask,new ParticleSystem({autoDestroy:this.autoDestroy,looping:this.looping,duration:this.duration,shape:this.emitterShape.clone(),startLife:this.startLife.clone(),startSpeed:this.startSpeed.clone(),startRotation:this.startRotation.clone(),startSize:this.startSize.clone(),startColor:this.startColor.clone(),emissionOverTime:this.emissionOverTime.clone(),emissionOverDistance:this.emissionOverDistance.clone(),emissionBursts:i,onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry,renderMode:this.renderMode,renderOrder:this.renderOrder,rendererEmitterSettings:s,material:this.rendererSettings.material,startTileIndex:this.startTileIndex,uTileCount:this.uTileCount,vTileCount:this.vTileCount,behaviors:l,worldSpace:this.worldSpace,layers:d})}}],[{key:"fromJSON",value:function fromJSON(e,i,r){var n,o,a,s=EmitterFromJSON(e.shape,i);if(e.renderMode===be.Trail){var l=e.rendererEmitterSettings;a={startLength:null!=l.startLength?ValueGeneratorFromJSON(l.startLength):new O(30),followLocalOrigin:l.followLocalOrigin}}else e.renderMode===be.Mesh?a={}:e.renderMode===be.StretchedBillBoard?(a=e.rendererEmitterSettings,null!=e.speedFactor&&(a.speedFactor=e.speedFactor)):a={};var u=new t.Layers;e.layers&&(u.mask=e.layers);var c=new ParticleSystem({autoDestroy:e.autoDestroy,looping:e.looping,prewarm:e.prewarm,duration:e.duration,shape:s,startLife:ValueGeneratorFromJSON(e.startLife),startSpeed:ValueGeneratorFromJSON(e.startSpeed),startRotation:GeneratorFromJSON(e.startRotation),startSize:ValueGeneratorFromJSON(e.startSize),startColor:ColorGeneratorFromJSON(e.startColor),emissionOverTime:ValueGeneratorFromJSON(e.emissionOverTime),emissionOverDistance:ValueGeneratorFromJSON(e.emissionOverDistance),emissionBursts:null===(n=e.emissionBursts)||void 0===n?void 0:n.map((function(e){return{time:e.time,count:"number"==typeof e.count?new O(e.count):ValueGeneratorFromJSON(e.count),probability:e.probability,interval:e.interval,cycle:e.cycle}})),onlyUsedByOther:e.onlyUsedByOther,instancingGeometry:i.geometries[e.instancingGeometry],renderMode:e.renderMode,rendererEmitterSettings:a,renderOrder:e.renderOrder,layers:u,material:e.material?i.materials[e.material]:e.texture?new t.MeshBasicMaterial({map:i.textures[e.texture],transparent:null===(o=e.transparent)||void 0===o||o,blending:e.blending,side:t.DoubleSide}):new t.MeshBasicMaterial({color:16777215,transparent:!0,blending:t.AdditiveBlending,side:t.DoubleSide}),startTileIndex:"number"==typeof e.startTileIndex?new O(e.startTileIndex):ValueGeneratorFromJSON(e.startTileIndex),uTileCount:e.uTileCount,vTileCount:e.vTileCount,behaviors:[],worldSpace:e.worldSpace});return c.behaviors=e.behaviors.map((function(e){var t=BehaviorFromJSON(e,c);return"EmitSubParticleSystem"===t.type&&(r[e.subParticleSystem]=t),t})),c}}]),ParticleSystem}(),Te="\n\n#include <common>\n#include <uv_pars_fragment>\n#include <color_pars_fragment>\n#include <map_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n#include <alphatest_pars_fragment>\n\nvoid main() {\n\n    #include <clipping_planes_fragment>\n    \n    vec3 outgoingLight = vec3( 0.0 );\n    vec4 diffuseColor = vColor;\n    \n    #include <logdepthbuf_fragment>\n    \n    #ifdef USE_MAP\n    diffuseColor *= texture2D( map, vMapUv);\n    #endif\n    \n    #include <alphatest_fragment>\n\n    outgoingLight = diffuseColor.rgb;\n    \n    #ifdef USE_COLOR_AS_ALPHA\n    gl_FragColor = vec4( outgoingLight, diffuseColor.r );\n    #else\n    gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n    #endif\n    \n    \n    #include <tonemapping_fragment>\n\n}\n",Ee="\n\n    #ifdef UV_TILE\n        float col = mod(uvTile, tileCount.x);\n        float row = (tileCount.y - floor(uvTile / tileCount.x) - 1.0);\n        \n        mat3 tileTransform = mat3(\n          1.0 / tileCount.x, 0.0, 0.0,\n          0.0, 1.0 / tileCount.y, 0.0, \n          col / tileCount.x, row / tileCount.y, 1.0);\n    #else\n        mat3 tileTransform = mat3(1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0);\n    #endif\n\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\nvUv = (tileTransform *vec3( uv, 1 )).xy;\n\n#endif\n#ifdef USE_MAP\n\nvMapUv = ( tileTransform * (mapTransform * vec3( MAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ALPHAMAP\n\nvAlphaMapUv = ( tileTransform * (alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_LIGHTMAP\n\nvLightMapUv = ( tileTransform * (lightMapTransform * vec3( LIGHTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_AOMAP\n\nvAoMapUv = ( tileTransform * (aoMapTransform * vec3( AOMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_BUMPMAP\n\nvBumpMapUv = ( tileTransform * (bumpMapTransform * vec3( BUMPMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_NORMALMAP\n\nvNormalMapUv = ( tileTransform * (normalMapTransform * vec3( NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\nvDisplacementMapUv = ( tileTransform * (displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\nvEmissiveMapUv = ( tileTransform * (emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_METALNESSMAP\n\nvMetalnessMapUv = ( tileTransform * (metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\nvRoughnessMapUv = ( tileTransform * (roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\nvAnisotropyMapUv = ( tileTransform * (anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\nvClearcoatMapUv = ( tileTransform * (clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\nvClearcoatNormalMapUv = ( tileTransform * (clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\nvClearcoatRoughnessMapUv = ( tileTransform * (clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\nvIridescenceMapUv = ( tileTransform * (iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\nvIridescenceThicknessMapUv = ( tileTransform * (iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\nvSheenColorMapUv = ( tileTransform * (sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\nvSheenRoughnessMapUv = ( tileTransform * (sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULARMAP\n\nvSpecularMapUv = ( tileTransform * (specularMapTransform * vec3( SPECULARMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\nvSpecularColorMapUv = ( tileTransform * (specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\nvSpecularIntensityMapUv = ( tileTransform * (specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\nvTransmissionMapUv = ( tileTransform * transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\nvThicknessMapUv = ( tileTransform * thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n",ze="\n#include <common>\n#include <color_pars_vertex>\n#include <uv_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nvoid main() {\n\n    ".concat(Ee,"\n\t\n    vec2 alignedPosition = ( position.xy ) * size;\n    \n    vec2 rotatedPosition;\n    rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n    rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n#ifdef HORIZONTAL\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.x += rotatedPosition.x;\n    mvPosition.z -= rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n#elif defined(VERTICAL)\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.y += rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n    mvPosition.x += rotatedPosition.x;\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    mvPosition.xy += rotatedPosition;\n#endif\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n"),Ae="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\n// attribute vec4 color;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nvoid main() {\n\n    ".concat(Ee,"\n    \n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n    \n    mat4 matrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n    \n    vec4 mvPosition = modelViewMatrix * (matrix * vec4( position, 1.0 ));\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n"),Je="\n#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n    ".concat(Ee,"\n\n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n\n    mat4 particleMatrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\n\t// replace defaultnormal_vertex\n\tvec3 transformedNormal = objectNormal;\n    mat3 m = mat3( particleMatrix );\n    transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n    transformedNormal = m * transformedNormal;\n    transformedNormal = normalMatrix * transformedNormal;\n    #ifdef FLIP_SIDED\n        transformedNormal = - transformedNormal;\n    #endif\n    #ifdef USE_TANGENT\n        vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n        #ifdef FLIP_SIDED\n        transformedTangent = - transformedTangent;\n        #endif\n    #endif\n\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\n\t// replace include <project_vertex>\n  vec4 mvPosition = vec4( transformed, 1.0 );\n  mvPosition = modelViewMatrix * (particleMatrix * mvPosition);\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n\tvViewPosition = - mvPosition.xyz;\n\t\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}\n"),Le="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute vec4 velocity;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nuniform float speedFactor;\n\nvoid main() {\n\n    ".concat(Ee,"\n    \n    float lengthFactor = velocity.w;\n#ifdef USE_SKEW\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n\n    vec3 scaledPos = vec3(position.xy * size, position.z);\n    float vlength = length(viewVelocity);\n    vec3 projVelocity =  dot(scaledPos, viewVelocity) * viewVelocity / vlength;\n    mvPosition.xyz += scaledPos + projVelocity * (speedFactor / size + lengthFactor / vlength);\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n    float vlength = length(viewVelocity); \n    mvPosition.xyz += position.y * normalize(cross(mvPosition.xyz, viewVelocity)) * size; // switch the cross to  match unity implementation\n    mvPosition.xyz -= (position.x + 0.5) * viewVelocity * (1.0 + lengthFactor / vlength) * size; // minus position.x to match unity implementation\n#endif\n\tvColor = color;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n");function getMaterialUVChannelName(e){return 0===e?"uv":"uv".concat(e)}new t.Vector3(0,0,1);var Ue=function(e){_inherits(SpriteBatch,e);var i=_createSuper(SpriteBatch);function SpriteBatch(e){var r;return _classCallCheck(this,SpriteBatch),_defineProperty(_assertThisInitialized(r=i.call(this,e)),"offsetBuffer",void 0),_defineProperty(_assertThisInitialized(r),"rotationBuffer",void 0),_defineProperty(_assertThisInitialized(r),"sizeBuffer",void 0),_defineProperty(_assertThisInitialized(r),"colorBuffer",void 0),_defineProperty(_assertThisInitialized(r),"uvTileBuffer",void 0),_defineProperty(_assertThisInitialized(r),"velocityBuffer",void 0),_defineProperty(_assertThisInitialized(r),"vector_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector2_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector3_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"quaternion_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"quaternion2_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"quaternion3_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"rotationMat_",new t.Matrix3),_defineProperty(_assertThisInitialized(r),"rotationMat2_",new t.Matrix3),r.maxParticles=1e3,r.setupBuffers(),r.rebuildMaterial(),r}return _createClass(SpriteBatch,[{key:"buildExpandableBuffers",value:function buildExpandableBuffers(){this.offsetBuffer=new t.InstancedBufferAttribute(new Float32Array(3*this.maxParticles),3),this.offsetBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("offset",this.offsetBuffer),this.colorBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.colorBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("color",this.colorBuffer),this.settings.renderMode===be.Mesh?(this.rotationBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.rotationBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("rotation",this.rotationBuffer)):this.settings.renderMode!==be.BillBoard&&this.settings.renderMode!==be.HorizontalBillBoard&&this.settings.renderMode!==be.VerticalBillBoard&&this.settings.renderMode!==be.StretchedBillBoard||(this.rotationBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.rotationBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("rotation",this.rotationBuffer)),this.sizeBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.sizeBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("size",this.sizeBuffer),this.uvTileBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.uvTileBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("uvTile",this.uvTileBuffer),this.settings.renderMode===be.StretchedBillBoard&&(this.velocityBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.velocityBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("velocity",this.velocityBuffer))}},{key:"setupBuffers",value:function setupBuffers(){this.geometry&&this.geometry.dispose(),this.geometry=new t.InstancedBufferGeometry,this.geometry.setIndex(this.settings.instancingGeometry.getIndex()),this.settings.instancingGeometry.hasAttribute("normal")&&this.geometry.setAttribute("normal",this.settings.instancingGeometry.getAttribute("normal")),this.geometry.setAttribute("position",this.settings.instancingGeometry.getAttribute("position")),this.geometry.setAttribute("uv",this.settings.instancingGeometry.getAttribute("uv")),this.buildExpandableBuffers()}},{key:"expandBuffers",value:function expandBuffers(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function rebuildMaterial(){var e;this.layers.mask=this.settings.layers.mask;var i={};if("MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type){var r=this.settings.material;(e=t.UniformsUtils.merge([t.UniformsLib.common,t.UniformsLib.envmap,t.UniformsLib.aomap,t.UniformsLib.lightmap,t.UniformsLib.emissivemap,t.UniformsLib.bumpmap,t.UniformsLib.normalmap,t.UniformsLib.displacementmap,t.UniformsLib.roughnessmap,t.UniformsLib.metalnessmap,t.UniformsLib.fog,t.UniformsLib.lights,{emissive:{value:new t.Color(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}])).diffuse.value=r.color,e.opacity.value=r.opacity,e.emissive.value=r.emissive,e.roughness.value=r.roughness,e.metalness.value=r.metalness,r.envMap&&(e.envMap.value=r.envMap,e.envMapIntensity.value=r.envMapIntensity),r.normalMap&&(e.normalMap.value=r.normalMap,e.normalScale.value=r.normalScale),r.roughnessMap&&(e.roughnessMap.value=r.roughnessMap),r.metalnessMap&&(e.metalnessMap.value=r.metalnessMap),r.map&&(e.map=new t.Uniform(r.map))}else(e={}).map=new t.Uniform(this.settings.material.map);this.settings.material.alphaTest&&(i.USE_ALPHATEST="",e.alphaTest=new t.Uniform(this.settings.material.alphaTest)),i.USE_UV="";var n=this.settings.uTileCount,o=this.settings.vTileCount;(n>1||o>1)&&(i.UV_TILE="",e.tileCount=new t.Uniform(new t.Vector2(n,o))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(i.USE_COLOR_AS_ALPHA=""),this.settings.material.normalMap&&(i.USE_NORMALMAP="",i.NORMALMAP_UV=getMaterialUVChannelName(this.settings.material.normalMap.channel),e.normalMapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.normalMap.matrix))),this.settings.material.map&&(i.USE_MAP="",i.MAP_UV=getMaterialUVChannelName(this.settings.material.map.channel),e.mapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.map.matrix))),i.USE_COLOR_ALPHA="";var a=!1;if(this.settings.renderMode===be.BillBoard||this.settings.renderMode===be.VerticalBillBoard||this.settings.renderMode===be.HorizontalBillBoard||this.settings.renderMode===be.Mesh){var s,l;this.settings.renderMode===be.Mesh?"MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type?(i.USE_COLOR="",s=Je,l="\n#define STANDARD\n#ifdef PHYSICAL\n#define IOR\n#define SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\nuniform float ior;\n#endif\n#ifdef SPECULAR\nuniform float specularIntensity;\nuniform vec3 specularColor;\n#ifdef USE_SPECULARINTENSITYMAP\nuniform sampler2D specularIntensityMap;\n#endif\n#ifdef USE_SPECULARCOLORMAP\nuniform sampler2D specularColorMap;\n#endif\n#endif\n#ifdef USE_CLEARCOAT\nuniform float clearcoat;\nuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\nuniform float iridescence;\nuniform float iridescenceIOR;\nuniform float iridescenceThicknessMinimum;\nuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\nuniform vec3 sheenColor;\nuniform float sheenRoughness;\n#ifdef USE_SHEENCOLORMAP\nuniform sampler2D sheenColorMap;\n#endif\n#ifdef USE_SHEENROUGHNESSMAP\nuniform sampler2D sheenRoughnessMap;\n#endif\n#endif\n\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n    #include <clipping_planes_fragment>\n    vec4 diffuseColor = vec4( diffuse, opacity );\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    vec3 totalEmissiveRadiance = emissive;\n    #include <logdepthbuf_fragment>\n    #include <map_fragment>\n    #include <color_fragment>\n    #include <alphamap_fragment>\n    #include <alphatest_fragment>\n    #include <roughnessmap_fragment>\n    #include <metalnessmap_fragment>\n    #include <normal_fragment_begin>\n    #include <normal_fragment_maps>\n    #include <clearcoat_normal_fragment_begin>\n    #include <clearcoat_normal_fragment_maps>\n    #include <emissivemap_fragment>\n    // accumulation\n    #include <lights_physical_fragment>\n    #include <lights_fragment_begin>\n    #include <lights_fragment_maps>\n    #include <lights_fragment_end>\n    // modulation\n    #include <aomap_fragment>\n    vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n    vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n    #include <transmission_fragment>\n    vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n    #ifdef USE_SHEEN\n    // Sheen energy compensation approximation calculation can be found at the end of\n        // https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\n        float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n        outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;\n    #endif\n    #ifdef USE_CLEARCOAT\n        float dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n        vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n        outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;\n    #endif\n    #include <output_fragment>\n    #include <tonemapping_fragment>\n    #include <encodings_fragment>\n    #include <fog_fragment>\n    #include <premultiplied_alpha_fragment>\n    #include <dithering_fragment>\n}",a=!0):(s=Ae,l=Te):(s=ze,l=Te),this.settings.renderMode===be.VerticalBillBoard?i.VERTICAL="":this.settings.renderMode===be.HorizontalBillBoard&&(i.HORIZONTAL=""),this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:s,fragmentShader:l,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest,lights:a})}else{if(this.settings.renderMode!==be.StretchedBillBoard)throw new Error("render mode unavailable");e.speedFactor=new t.Uniform(1),this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:Le,fragmentShader:Te,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest})}}},{key:"update",value:function update(){var e=this,t=0,i=0;this.systems.forEach((function(e){i+=e.particleNum})),i>this.maxParticles&&this.expandBuffers(i),this.systems.forEach((function(i){var r=i.particles,n=i.particleNum,o=e.quaternion2_,a=e.vector2_,s=e.vector3_;i.emitter.matrixWorld.decompose(a,o,s),e.rotationMat_.setFromMatrix4(i.emitter.matrixWorld);for(var l=0;l<n;l++,t++){var u=r[l];if(e.settings.renderMode===be.Mesh){var c=void 0;if(i.worldSpace)c=u.rotation;else{var d=void 0;d=u.parentMatrix?e.quaternion3_.setFromRotationMatrix(u.parentMatrix):o,(c=e.quaternion_).copy(u.rotation).multiply(d)}e.rotationBuffer.setXYZW(t,c.x,c.y,c.z,c.w)}else e.settings.renderMode!==be.StretchedBillBoard&&e.settings.renderMode!==be.VerticalBillBoard&&e.settings.renderMode!==be.HorizontalBillBoard&&e.settings.renderMode!==be.BillBoard||e.rotationBuffer.setX(t,u.rotation);var h=void 0;if(i.worldSpace?h=u.position:(h=e.vector_,u.parentMatrix?h.copy(u.position).applyMatrix4(u.parentMatrix):h.copy(u.position).applyMatrix4(i.emitter.matrixWorld)),e.offsetBuffer.setXYZ(t,h.x,h.y,h.z),e.colorBuffer.setXYZW(t,u.color.x,u.color.y,u.color.z,u.color.w),i.worldSpace||u.parentMatrix?e.sizeBuffer.setX(t,u.size):e.sizeBuffer.setX(t,u.size*(Math.abs(s.x)+Math.abs(s.y)+Math.abs(s.z))/3),e.uvTileBuffer.setX(t,u.uvTile),e.settings.renderMode===be.StretchedBillBoard&&e.velocityBuffer){var f=i.rendererEmitterSettings.speedFactor;0===f&&(f=.001);var p=i.rendererEmitterSettings.lengthFactor,m=void 0;i.worldSpace?m=u.velocity:(m=e.vector_,u.parentMatrix?(e.rotationMat2_.setFromMatrix4(u.parentMatrix),m.copy(u.velocity).applyMatrix3(e.rotationMat2_)):m.copy(u.velocity).applyMatrix3(e.rotationMat_)),e.velocityBuffer.setXYZW(t,m.x*f,m.y*f,m.z*f,p)}}})),this.geometry.instanceCount=t,t>0&&(this.offsetBuffer.updateRange.count=3*t,this.offsetBuffer.needsUpdate=!0,this.sizeBuffer.updateRange.count=t,this.sizeBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.uvTileBuffer.updateRange.count=t,this.uvTileBuffer.needsUpdate=!0,this.settings.renderMode===be.StretchedBillBoard&&this.velocityBuffer&&(this.velocityBuffer.updateRange.count=4*t,this.velocityBuffer.needsUpdate=!0),this.settings.renderMode===be.Mesh?(this.rotationBuffer.updateRange.count=4*t,this.rotationBuffer.needsUpdate=!0):this.settings.renderMode!==be.StretchedBillBoard&&this.settings.renderMode!==be.HorizontalBillBoard&&this.settings.renderMode!==be.VerticalBillBoard&&this.settings.renderMode!==be.BillBoard||(this.rotationBuffer.updateRange.count=t,this.rotationBuffer.needsUpdate=!0))}},{key:"dispose",value:function dispose(){this.geometry.dispose()}}]),SpriteBatch}(Ne),Re="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <fog_pars_vertex>\n\nattribute vec3 previous;\nattribute vec3 next;\nattribute float side;\nattribute float width;\n\nuniform vec2 resolution;\nuniform float lineWidth;\nuniform float sizeAttenuation;\n    \nvec2 fix(vec4 i, float aspect) {\n    vec2 res = i.xy / i.w;\n    res.x *= aspect;\n    return res;\n}\n    \nvoid main() {\n\n    ".concat(Ee,"\n    \n    float aspect = resolution.x / resolution.y;\n\n    vColor = color;\n\n    mat4 m = projectionMatrix * modelViewMatrix;\n    vec4 finalPosition = m * vec4( position, 1.0 );\n    vec4 prevPos = m * vec4( previous, 1.0 );\n    vec4 nextPos = m * vec4( next, 1.0 );\n\n    vec2 currentP = fix( finalPosition, aspect );\n    vec2 prevP = fix( prevPos, aspect );\n    vec2 nextP = fix( nextPos, aspect );\n\n    float w = lineWidth * width;\n\n    vec2 dir;\n    if( nextP == currentP ) dir = normalize( currentP - prevP );\n    else if( prevP == currentP ) dir = normalize( nextP - currentP );\n    else {\n        vec2 dir1 = normalize( currentP - prevP );\n        vec2 dir2 = normalize( nextP - currentP );\n        dir = normalize( dir1 + dir2 );\n\n        vec2 perp = vec2( -dir1.y, dir1.x );\n        vec2 miter = vec2( -dir.y, dir.x );\n        //w = clamp( w / dot( miter, perp ), 0., 4., * lineWidth * width );\n\n    }\n\n    //vec2 normal = ( cross( vec3( dir, 0. ) vec3( 0., 0., 1. ) ) ).xy;\n    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );\n    normal.xy *= .5 * w;\n    normal *= projectionMatrix;\n    if( sizeAttenuation == 0. ) {\n        normal.xy *= finalPosition.w;\n        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;\n    }\n\n    finalPosition.xy += normal.xy * side;\n\n    gl_Position = finalPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    \n\t#include <fog_vertex>\n}");new t.Vector3(0,0,1);var Fe=function(e){_inherits(TrailBatch,e);var i=_createSuper(TrailBatch);function TrailBatch(e){var r;return _classCallCheck(this,TrailBatch),_defineProperty(_assertThisInitialized(r=i.call(this,e)),"positionBuffer",void 0),_defineProperty(_assertThisInitialized(r),"previousBuffer",void 0),_defineProperty(_assertThisInitialized(r),"nextBuffer",void 0),_defineProperty(_assertThisInitialized(r),"uvBuffer",void 0),_defineProperty(_assertThisInitialized(r),"sideBuffer",void 0),_defineProperty(_assertThisInitialized(r),"widthBuffer",void 0),_defineProperty(_assertThisInitialized(r),"colorBuffer",void 0),_defineProperty(_assertThisInitialized(r),"indexBuffer",void 0),_defineProperty(_assertThisInitialized(r),"vector_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector2_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector3_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"quaternion_",new t.Quaternion),r.maxParticles=1e4,r.setupBuffers(),r.rebuildMaterial(),r}return _createClass(TrailBatch,[{key:"setupBuffers",value:function setupBuffers(){this.geometry&&this.geometry.dispose(),this.geometry=new t.BufferGeometry,this.indexBuffer=new t.BufferAttribute(new Uint32Array(6*this.maxParticles),1),this.indexBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setIndex(this.indexBuffer),this.positionBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.positionBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("position",this.positionBuffer),this.previousBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.previousBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("previous",this.previousBuffer),this.nextBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.nextBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("next",this.nextBuffer),this.widthBuffer=new t.BufferAttribute(new Float32Array(2*this.maxParticles),1),this.widthBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("width",this.widthBuffer),this.sideBuffer=new t.BufferAttribute(new Float32Array(2*this.maxParticles),1),this.sideBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("side",this.sideBuffer),this.uvBuffer=new t.BufferAttribute(new Float32Array(4*this.maxParticles),2),this.uvBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("uv",this.uvBuffer),this.colorBuffer=new t.BufferAttribute(new Float32Array(8*this.maxParticles),4),this.colorBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("color",this.colorBuffer)}},{key:"expandBuffers",value:function expandBuffers(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function rebuildMaterial(){this.layers.mask=this.settings.layers.mask;var e={lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},resolution:{value:new t.Vector2(1,1)},sizeAttenuation:{value:1},visibility:{value:1},alphaTest:{value:0},repeat:{value:new t.Vector2(1,1)}},i={USE_UV:"",USE_COLOR_ALPHA:""};if(this.settings.material.map&&(i.USE_MAP="",i.MAP_UV=getMaterialUVChannelName(this.settings.material.map.channel),e.map=new t.Uniform(this.settings.material.map),e.mapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.map.matrix))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(i.USE_COLOR_AS_ALPHA=""),this.settings.renderMode!==be.Trail)throw new Error("render mode unavailable");this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:Re,fragmentShader:"\n\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nuniform sampler2D alphaMap;\nuniform float useAlphaMap;\nuniform float visibility;\nuniform float alphaTest;\nuniform vec2 repeat;\n\nvarying vec4 vColor;\n    \nvoid main() {\n    #include <clipping_planes_fragment>\n    #include <logdepthbuf_fragment>\n\n    vec4 c = vColor;\n    \n    #ifdef USE_MAP\n    #ifdef USE_COLOR_AS_ALPHA\n    vec4 tex = texture2D( map, vUv * repeat );\n    c *= vec4(tex.rgb, tex.r);\n    #else\n    c *= texture2D( map, vUv * repeat );\n    #endif\n    #endif\n    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUv * repeat ).a;\n    if( c.a < alphaTest ) discard;\n    gl_FragColor = c;\n\n    #include <fog_fragment>\n    #include <tonemapping_fragment>\n}",transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,side:this.settings.material.side,blending:this.settings.material.blending||t.AdditiveBlending})}},{key:"update",value:function update(){var e=this,t=0,i=0,r=0;this.systems.forEach((function(e){for(var t=0;t<e.particleNum;t++)r+=2*e.particles[t].previous.length})),r>this.maxParticles&&this.expandBuffers(r),this.systems.forEach((function(r){var n=e.quaternion_,o=e.vector2_,a=e.vector3_;r.emitter.matrixWorld.decompose(o,n,a);for(var s=r.particles,l=r.particleNum,u=e.settings.uTileCount,c=e.settings.vTileCount,d=1/u,h=1/c,f=0;f<l;f++){var p=s[f],m=p.uvTile%c,y=Math.floor(p.uvTile/c),v=p.previous.values(),g=v.next(),S=g.value,_=S;g.done||(g=v.next());var w=void 0;w=void 0!==g.value?g.value:_;for(var O=0;O<p.previous.length;O++,t+=2){if(e.positionBuffer.setXYZ(t,_.position.x,_.position.y,_.position.z),e.positionBuffer.setXYZ(t+1,_.position.x,_.position.y,_.position.z),r.worldSpace?(e.positionBuffer.setXYZ(t,_.position.x,_.position.y,_.position.z),e.positionBuffer.setXYZ(t+1,_.position.x,_.position.y,_.position.z)):(p.parentMatrix?e.vector_.copy(_.position).applyMatrix4(p.parentMatrix):e.vector_.copy(_.position).applyMatrix4(r.emitter.matrixWorld),e.positionBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.positionBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),r.worldSpace?(e.previousBuffer.setXYZ(t,S.position.x,S.position.y,S.position.z),e.previousBuffer.setXYZ(t+1,S.position.x,S.position.y,S.position.z)):(p.parentMatrix?e.vector_.copy(S.position).applyMatrix4(p.parentMatrix):e.vector_.copy(S.position).applyMatrix4(r.emitter.matrixWorld),e.previousBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.previousBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),r.worldSpace?(e.nextBuffer.setXYZ(t,w.position.x,w.position.y,w.position.z),e.nextBuffer.setXYZ(t+1,w.position.x,w.position.y,w.position.z)):(p.parentMatrix?e.vector_.copy(w.position).applyMatrix4(p.parentMatrix):e.vector_.copy(w.position).applyMatrix4(r.emitter.matrixWorld),e.nextBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.nextBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),e.sideBuffer.setX(t,-1),e.sideBuffer.setX(t+1,1),r.worldSpace)e.widthBuffer.setX(t,_.size),e.widthBuffer.setX(t+1,_.size);else if(p.parentMatrix)e.widthBuffer.setX(t,_.size),e.widthBuffer.setX(t+1,_.size);else{var x=(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z))/3;e.widthBuffer.setX(t,_.size*x),e.widthBuffer.setX(t+1,_.size*x)}e.uvBuffer.setXY(t,(O/p.previous.length+m)*d,(c-y-1)*h),e.uvBuffer.setXY(t+1,(O/p.previous.length+m)*d,(c-y)*h),e.colorBuffer.setXYZW(t,_.color.x,_.color.y,_.color.z,_.color.w),e.colorBuffer.setXYZW(t+1,_.color.x,_.color.y,_.color.z,_.color.w),O+1<p.previous.length&&(e.indexBuffer.setX(3*i,t),e.indexBuffer.setX(3*i+1,t+1),e.indexBuffer.setX(3*i+2,t+2),i++,e.indexBuffer.setX(3*i,t+2),e.indexBuffer.setX(3*i+1,t+1),e.indexBuffer.setX(3*i+2,t+3),i++),S=_,_=w,g.done||void 0!==(g=v.next()).value&&(w=g.value)}}})),this.positionBuffer.updateRange.count=3*t,this.positionBuffer.needsUpdate=!0,this.previousBuffer.updateRange.count=3*t,this.previousBuffer.needsUpdate=!0,this.nextBuffer.updateRange.count=3*t,this.nextBuffer.needsUpdate=!0,this.sideBuffer.updateRange.count=t,this.sideBuffer.needsUpdate=!0,this.widthBuffer.updateRange.count=t,this.widthBuffer.needsUpdate=!0,this.uvBuffer.updateRange.count=2*t,this.uvBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.indexBuffer.updateRange.count=3*i,this.indexBuffer.needsUpdate=!0,this.geometry.setDrawRange(0,3*i)}},{key:"dispose",value:function dispose(){this.geometry.dispose()}}]),TrailBatch}(Ne),Ie=function(e){_inherits(BatchedRenderer,e);var t=_createSuper(BatchedRenderer);function BatchedRenderer(){var e;return _classCallCheck(this,BatchedRenderer),_defineProperty(_assertThisInitialized(e=t.call(this)),"batches",[]),_defineProperty(_assertThisInitialized(e),"systemToBatchIndex",new Map),_defineProperty(_assertThisInitialized(e),"type","BatchedRenderer"),e}return _createClass(BatchedRenderer,[{key:"addSystem",value:function addSystem(e){e._renderer=this;for(var t,i=e.getRendererSettings(),r=0;r<this.batches.length;r++)if(BatchedRenderer.equals(this.batches[r].settings,i))return this.batches[r].addSystem(e),void this.systemToBatchIndex.set(e,r);switch(i.renderMode){case be.Trail:t=new Fe(i);break;case be.Mesh:case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:case be.StretchedBillBoard:t=new Ue(i)}t.addSystem(e),this.batches.push(t),this.systemToBatchIndex.set(e,this.batches.length-1),this.add(t)}},{key:"deleteSystem",value:function deleteSystem(e){var t=this.systemToBatchIndex.get(e);null!=t&&(this.batches[t].removeSystem(e),this.systemToBatchIndex.delete(e))}},{key:"updateSystem",value:function updateSystem(e){this.deleteSystem(e),this.addSystem(e)}},{key:"update",value:function update(e){this.systemToBatchIndex.forEach((function(t,i){i.update(e)}));for(var t=0;t<this.batches.length;t++)this.batches[t].update()}}],[{key:"equals",value:function equals(e,t){return e.material.side===t.material.side&&e.material.blending===t.material.blending&&e.material.transparent===t.material.transparent&&e.material.type===t.material.type&&e.material.alphaTest===t.material.alphaTest&&e.material.map===t.material.map&&e.renderMode===t.renderMode&&e.uTileCount===t.uTileCount&&e.vTileCount===t.vTileCount&&e.instancingGeometry===t.instancingGeometry&&e.renderOrder===t.renderOrder&&e.layers.mask===t.layers.mask}}]),BatchedRenderer}(t.Object3D),Ge=Ie,De=function(e){_inherits(QuarksLoader,e);var i=_createSuper(QuarksLoader);function QuarksLoader(e){return _classCallCheck(this,QuarksLoader),i.call(this,e)}return _createClass(QuarksLoader,[{key:"linkReference",value:function linkReference(e){var t={};e.traverse((function(e){t[e.uuid]=e})),e.traverse((function(e){if("ParticleEmitter"===e.type){var i=e.system;i.emitterShape;for(var r=0;r<i.behaviors.length;r++)i.behaviors[r]instanceof j&&(i.behaviors[r].subParticleSystem=t[i.behaviors[r].subParticleSystem])}}))}},{key:"parse",value:function parse(e,t){var i=_get(_getPrototypeOf(QuarksLoader.prototype),"parse",this).call(this,e,t);return this.linkReference(i),i}},{key:"parseObject",value:function parseObject(e,i,r,n,o){var a,s,l;function getGeometry(e){return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),i[e]}function getMaterial(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],i=0,n=e.length;i<n;i++){var o=e[i];void 0===r[o]&&console.warn("THREE.ObjectLoader: Undefined material",o),t.push(r[o])}return t}return void 0===r[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),r[e]}}function getTexture(e){return void 0===n[e]&&console.warn("THREE.ObjectLoader: Undefined texture",e),n[e]}var u={textures:n,geometries:i,materials:r};switch(e.type){case"ParticleEmitter":a=Be.fromJSON(e.ps,u,{}).emitter;break;case"Scene":a=new t.Scene,void 0!==e.background&&(Number.isInteger(e.background)?a.background=new t.Color(e.background):a.background=getTexture(e.background)),void 0!==e.environment&&(a.environment=getTexture(e.environment)),void 0!==e.fog&&("Fog"===e.fog.type?a.fog=new t.Fog(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(a.fog=new t.FogExp2(e.fog.color,e.fog.density))),void 0!==e.backgroundBlurriness&&(a.backgroundBlurriness=e.backgroundBlurriness);break;case"PerspectiveCamera":a=new t.PerspectiveCamera(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(a.focus=e.focus),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.filmGauge&&(a.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(a.filmOffset=e.filmOffset),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"OrthographicCamera":a=new t.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"AmbientLight":a=new t.AmbientLight(e.color,e.intensity);break;case"DirectionalLight":a=new t.DirectionalLight(e.color,e.intensity);break;case"PointLight":a=new t.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":a=new t.RectAreaLight(e.color,e.intensity,e.width,e.height);break;case"SpotLight":a=new t.SpotLight(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay);break;case"HemisphereLight":a=new t.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"LightProbe":a=(new t.LightProbe).fromJSON(e);break;case"SkinnedMesh":s=getGeometry(e.geometry),l=getMaterial(e.material),a=new t.SkinnedMesh(s,l),void 0!==e.bindMode&&(a.bindMode=e.bindMode),void 0!==e.bindMatrix&&a.bindMatrix.fromArray(e.bindMatrix),void 0!==e.skeleton&&(a.skeleton=e.skeleton);break;case"Mesh":s=getGeometry(e.geometry),l=getMaterial(e.material),a=new t.Mesh(s,l);break;case"InstancedMesh":s=getGeometry(e.geometry),l=getMaterial(e.material);var c=e.count,d=e.instanceMatrix,h=e.instanceColor;(a=new t.InstancedMesh(s,l,c)).instanceMatrix=new t.InstancedBufferAttribute(new Float32Array(d.array),16),void 0!==h&&(a.instanceColor=new t.InstancedBufferAttribute(new Float32Array(h.array),h.itemSize));break;case"LOD":a=new t.LOD;break;case"Line":a=new t.Line(getGeometry(e.geometry),getMaterial(e.material));break;case"LineLoop":a=new t.LineLoop(getGeometry(e.geometry),getMaterial(e.material));break;case"LineSegments":a=new t.LineSegments(getGeometry(e.geometry),getMaterial(e.material));break;case"PointCloud":case"Points":a=new t.Points(getGeometry(e.geometry),getMaterial(e.material));break;case"Sprite":a=new t.Sprite(getMaterial(e.material));break;case"Group":a=new t.Group;break;case"Bone":a=new t.Bone;break;default:a=new t.Object3D}if(a.uuid=e.uuid,void 0!==e.name&&(a.name=e.name),void 0!==e.matrix?(a.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(a.matrixAutoUpdate=e.matrixAutoUpdate),a.matrixAutoUpdate&&a.matrix.decompose(a.position,a.quaternion,a.scale)):(void 0!==e.position&&a.position.fromArray(e.position),void 0!==e.rotation&&a.rotation.fromArray(e.rotation),void 0!==e.quaternion&&a.quaternion.fromArray(e.quaternion),void 0!==e.scale&&a.scale.fromArray(e.scale)),void 0!==e.castShadow&&(a.castShadow=e.castShadow),void 0!==e.receiveShadow&&(a.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(a.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(a.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(a.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&a.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(a.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(a.visible=e.visible),void 0!==e.frustumCulled&&(a.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(a.renderOrder=e.renderOrder),void 0!==e.userData&&(a.userData=e.userData),void 0!==e.layers&&(a.layers.mask=e.layers),void 0!==e.children)for(var f=e.children,p=0;p<f.length;p++)a.add(this.parseObject(f[p],i,r,n,o));if(void 0!==e.animations)for(var m=e.animations,y=0;y<m.length;y++){var v=m[y];a.animations.push(o[v])}if("LOD"===e.type){void 0!==e.autoUpdate&&(a.autoUpdate=e.autoUpdate);for(var g=e.levels,S=0;S<g.length;S++){var _=g[S],w=a.getObjectByProperty("uuid",_.object);void 0!==w&&a.addLevel(w,_.distance)}}return a}}]),QuarksLoader}(t.ObjectLoader),qe=[],Xe=function(e){return e[e.Number=0]="Number",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Boolean=4]="Boolean",e[e.AnyType=5]="AnyType",e[e.NullableAnyType=6]="NullableAnyType",e[e.EventStream=7]="EventStream",e}({}),je=function genDefaultForNodeValueType(e){switch(e){case Xe.Boolean:return!1;case Xe.Number:return 0;case Xe.Vec2:return new t.Vector2;case Xe.Vec3:return new t.Vector3;case Xe.Vec4:return new t.Vector4;case Xe.AnyType:return 0;case Xe.NullableAnyType:return}},He=function(){function Node(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck(this,Node),_defineProperty(this,"id",void 0),_defineProperty(this,"inputs",[]),_defineProperty(this,"outputs",[]),_defineProperty(this,"type",void 0),_defineProperty(this,"signatureIndex",-1),_defineProperty(this,"data",void 0),_defineProperty(this,"position",new t.Vector2),_defineProperty(this,"outputValues",[]),this.id=""+Math.round(1e5*Math.random()),this.type=e,this.signatureIndex=i,this.data=r;for(var n=-1===i?0:i,o=0;o<e.nodeTypeSignatures[n].inputTypes.length;o++)this.inputs.push(void 0);for(var a=0;a<e.nodeTypeSignatures[n].outputTypes.length;a++)this.outputs.push([]),this.outputValues.push(je(e.nodeTypeSignatures[n].outputTypes[a]))}return _createClass(Node,[{key:"inputTypes",get:function get(){var e=-1===this.signatureIndex?0:this.signatureIndex;return this.type.nodeTypeSignatures[e].inputTypes}},{key:"outputTypes",get:function get(){var e=-1===this.signatureIndex?0:this.signatureIndex;return this.type.nodeTypeSignatures[e].outputTypes}},{key:"func",value:function func(e,t,i){var r=-1===this.signatureIndex?0:this.signatureIndex;this.type.nodeTypeSignatures[r].func(e,this.data,t,i)}}]),Node}(),We=_createClass((function Wire(e,t,i,r){_classCallCheck(this,Wire),_defineProperty(this,"input",void 0),_defineProperty(this,"inputIndex",void 0),_defineProperty(this,"output",void 0),_defineProperty(this,"outputIndex",void 0),this.input=e,this.inputIndex=t,this.input.outputs[t].push(this),this.output=i,this.outputIndex=r,this.output.inputs[r]=this})),Qe=function(){function BaseCompiler(){_classCallCheck(this,BaseCompiler),_defineProperty(this,"visited",new Set),BaseCompiler.Instance=this}return _createClass(BaseCompiler,[{key:"buildExecutionOrder",value:function buildExecutionOrder(e,t){e.nodesInOrder.length=0,this.visited.clear();for(var i=0;i<e.outputNodes.length;i++){var r=e.outputNodes[i];void 0!==r.inputs[0]&&this._traverse(r,e,t)}e.compiled=!0}},{key:"_traverse",value:function _traverse(e,t,i){this.visited.add(e.id);for(var r=0;r<e.inputs.length;r++)if(e.inputs[r]instanceof We){var n=e.inputs[r].input;this.visited.has(n.id)||this._traverse(n,t,i)}else e.inputs[r];t.nodesInOrder.push(e)}}]),BaseCompiler}();_defineProperty(Qe,"Instance",void 0);var Ye=function(e){_inherits(Interpreter,e);var t=_createSuper(Interpreter);function Interpreter(){return _classCallCheck(this,Interpreter),t.call(this)}return _createClass(Interpreter,[{key:"executeCompiledGraph",value:function executeCompiledGraph(e,t){for(var i=e.nodesInOrder,r=0;r<i.length;r++){for(var n=[],o=i[r],a=0;a<o.inputs.length;a++)o.inputs[a]instanceof We?n.push(o.inputs[a].input.outputValues[o.inputs[a].inputIndex]):void 0!==o.inputs[a]?n.push(o.inputs[a].getValue(t)):n.push(void 0);o.func(t,n,o.outputValues)}}},{key:"run",value:function run(e,t){e.compiled||this.buildExecutionOrder(e,t),this.executeCompiledGraph(e,t)}}]),Interpreter}(Qe),Ze=function(){function NodeType(e){_classCallCheck(this,NodeType),_defineProperty(this,"name",void 0),_defineProperty(this,"nodeTypeSignatures",[]),this.name=e}return _createClass(NodeType,[{key:"addSignature",value:function addSignature(e,t,i){this.nodeTypeSignatures.push({inputTypes:e,outputTypes:t,func:i})}}]),NodeType}(),Ke=function(e){_inherits(GraphNodeType,e);var t=_createSuper(GraphNodeType);function GraphNodeType(e){var i;_classCallCheck(this,GraphNodeType);for(var r=[],n=0;n<e.inputNodes.length;n++)"input"===e.inputNodes[n].type.name&&r.push(e.inputNodes[n].data.type);for(var o=[],a=0;a<e.outputNodes.length;a++)"output"===e.outputNodes[a].type.name&&o.push(e.outputNodes[a].data.type);return _defineProperty(_assertThisInitialized(i=t.call(this,e.name)),"nodeGraph",void 0),i.addSignature(r,o,(function(t,i,r,n){t.inputs=r,t.outputs=n,Ye.Instance.run(e,t)})),i.nodeGraph=e,i}return _createClass(GraphNodeType)}(Ze),$e={},et=new Ze("add");et.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]+i[1]})),et.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),et.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),et.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),$e.add=et;var tt=new Ze("sub");tt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]-i[1]})),tt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),tt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),tt.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),$e.sub=tt;var it=new Ze("mul");it.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]*i[1]})),it.addSignature([Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),it.addSignature([Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),it.addSignature([Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),$e.mul=it;var rt=new Ze("div");rt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]/i[1]})),rt.addSignature([Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),rt.addSignature([Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),rt.addSignature([Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),$e.div=rt;var nt=new Ze("sin");nt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.sin(i[0])})),$e.sin=nt;var ot=new Ze("cos");ot.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.cos(i[0])})),$e.cos=ot;var at=new Ze("tan");at.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.tan(i[0])})),$e.tan=at;var st=new Ze("abs");st.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.abs(i[0])})),$e.abs=st;var lt=new Ze("min");lt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.min(i[0],i[1])})),$e.min=lt;var ut=new Ze("max");ut.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.max(i[0],i[1])})),$e.max=ut;var ct=new Ze("dot");ct.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),ct.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),ct.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),$e.dot=ct;var dt=new Ze("cross");dt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].crossVectors(i[0],i[1])})),$e.cross=dt;var ht=new Ze("length");ht.addSignature([Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),ht.addSignature([Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),ht.addSignature([Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),$e.length=ht;var ft=new Ze("lengthSq");ft.addSignature([Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),ft.addSignature([Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),ft.addSignature([Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),$e.lengthSq=ft;var pt=new Ze("normalize");pt.addSignature([Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),pt.addSignature([Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),pt.addSignature([Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),$e.normalize=pt;var mt=new Ze("distance");mt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].distanceTo(i[1])})),mt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].distanceTo(i[1])})),$e.distance=mt;var yt=new Ze("and");yt.addSignature([Xe.Boolean,Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]&&i[1]})),$e.and=yt;var vt=new Ze("or");vt.addSignature([Xe.Boolean,Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]||i[1]})),$e.or=vt;var gt=new Ze("not");gt.addSignature([Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=!i[0]})),$e.not=gt;var St=new Ze("equal");St.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]===i[1]})),St.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),St.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),St.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),$e.equal=St;var _t=new Ze("lessThan");_t.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]<i[1]})),$e.lessThan=_t;var wt=new Ze("greaterThan");wt.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]>i[1]})),$e.greaterThan=wt;var Ot=new Ze("lessThanOrEqual");Ot.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]<=i[1]})),$e.lessThanOrEqual=Ot;var xt=new Ze("greaterThanOrEqual");xt.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]>=i[1]})),$e.greaterThanOrEqual=xt;var bt=new Ze("if");bt.addSignature([Xe.Boolean,Xe.AnyType,Xe.AnyType],[Xe.AnyType],(function(e,t,i,r){r[0]=i[0]?i[1]:i[2]})),$e.if=bt;var Nt=new Ze("number");Nt.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=t.value})),$e.number=Nt;var Pt=new Ze("vec2");Pt.addSignature([Xe.Number,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1]})),$e.vec2=Pt;var kt=new Ze("vec3");kt.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1],r[0].z=i[2]})),$e.vec3=kt;var Mt=new Ze("vec4");Mt.addSignature([Xe.Number,Xe.Number,Xe.Number,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1],r[0].z=i[2],r[0].w=i[3]})),$e.vec4=Mt;var Ct=new Ze("splitVec2");Ct.addSignature([Xe.Vec2],[Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y})),$e.splitVec2=Ct;var Vt=new Ze("splitVec3");Vt.addSignature([Xe.Vec3],[Xe.Number,Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y,r[2]=i[0].z})),$e.splitVec3=Vt;var Bt=new Ze("splitVec4");Bt.addSignature([Xe.Vec4],[Xe.Number,Xe.Number,Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y,r[2]=i[0].z,r[3]=i[0].w})),$e.splitVec4=Bt;var Tt=new Ze("bool");Tt.addSignature([],[Xe.Boolean],(function(e,t,i,r){r[0]=t.value})),$e.bool=Tt;var Et=new Ze("particleProperty");Et.addSignature([Xe.NullableAnyType],[Xe.NullableAnyType],(function(e,t,i,r){void 0!==i[0]&&("object"===_typeof(i[0])?e.particle[t.property].copy(i[0]):e.particle[t.property]=i[0]),void 0!==e.particle[t.property]&&("object"===_typeof(r[0])?r[0].copy(e.particle[t.property]):r[0]=e.particle[t.property])})),$e.particleProperty=Et;var zt=new Ze("emit");zt.addSignature([Xe.EventStream],[],(function(e,t,i,r){for(var n=i[0],o=0;o<n.length;o++)e.signal(o,n[o])})),$e.emit=zt;var At=new Ze("graphProperty");At.addSignature([Xe.NullableAnyType],[Xe.NullableAnyType],(function(e,t,i,r){void 0!==i[0]&&("object"===_typeof(i[0])?e.graph[t.property].copy(i[0]):e.graph[t.property]=i[0]),void 0!==e.graph[t.property]&&("object"===_typeof(r[0])?r[0].copy(e.graph[t.property]):r[0]=e.graph[t.property])})),$e.graphProperty=At;var Jt=new Ze("startEvent");Jt.addSignature([],[Xe.EventStream],(function(e,t,i,r){r[0]=[{type:"start"}]})),$e.startEvent=Jt;var Lt=new Ze("repeater");Lt.addSignature([Xe.EventStream,Xe.Number],[Xe.EventStream],(function(e,t,i,r){for(var n=i[0],o=i[1],a=[],s=0;s<n.length;s++)for(var l=0;l<o;l++)a.push(n[s]);r[0]=a})),$e.repeater=Lt;var Ut=new Ze("time");Ut.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=e.emissionState.time})),$e.time=Ut;var Rt=new Ze("delta");Rt.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=e.delta})),$e.delta=Rt;var Ft=new Ze("output");Ft.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]})),$e.output=Ft;var It=new Ze("lerp");It.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]*(1-i[2])+i[1]*i[2]})),It.addSignature([Xe.Vec2,Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),It.addSignature([Xe.Vec3,Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),It.addSignature([Xe.Vec4,Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),$e.lerp=It;var Gt=new Ze("normDistrib");Gt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=function normalD(e){return 1/Math.sqrt(2*Math.PI)*Math.exp(e*e*-.5)}(i[0])})),$e.normDistrib=Gt;var Dt=new Ze("normcdf");Dt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){var n=i[0],o=1;n<0&&(o=-1);var a=1/(1+.3275911*(n=Math.abs(n)/Math.sqrt(2))),s=1-((((1.061405429*a-1.453152027)*a+1.421413741)*a-.284496736)*a+.254829592)*a*Math.exp(-n*n);r[0]=.5*(1+o*s)})),$e.normcdf=Dt;var qt=new Ze("normcdfInv"),Xt=function rationalApproximation(e){var t=[2.515517,.802853,.010328],i=[1.432788,.189269,.001308];return e-((t[2]*e+t[1])*e+t[0])/(((i[2]*e+i[1])*e+i[0])*e+1)},jt=function normcdfInv(e){return e<.5?-Xt(Math.sqrt(-2*Math.log(e))):Xt(Math.sqrt(-2*Math.log(1-e)))};qt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=jt(i[0])})),$e.normcdfInv=qt;var Ht=new Ze("clamp");Ht.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.max(Math.min(i[0],i[2]),i[1])})),$e.clamp=Ht;var Wt=new Ze("smoothstep");Wt.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){var n=Math.max(Math.min(i[0],i[2]),i[1]);r[0]=n*n*(3-2*n)})),$e.smoothstep=Wt;var Qt=new Ze("random");Qt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.random()*(i[1]-i[0])+i[0]})),Qt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),Qt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),Qt.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),$e.random=Qt;var Yt=new Ze("vrand");Yt.addSignature([],[Xe.Vec2],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=Math.sqrt(n*n+o*o);r[0].set(n/a,o/a)})),Yt.addSignature([],[Xe.Vec3],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=jt(Math.random()),s=Math.sqrt(n*n+o*o+a*a);r[0].set(n/s,o/s,a/s)})),Yt.addSignature([],[Xe.Vec4],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=jt(Math.random()),s=jt(Math.random()),l=Math.sqrt(n*n+o*o+a*a+s*s);r[0].set(n/l,o/l,a/l,s/l)})),$e.vrand=Yt;var Zt=new Ze("bsdf");Zt.addSignature([Xe.Vec3,Xe.Vec3,Xe.Vec3,Xe.Number],[],(function(e,t,i,r){})),$e.bsdf=Zt;var Kt=new Set(["output","particleProperty","graphProperty","emit"]),$t=function(){function NodeGraph(e){_classCallCheck(this,NodeGraph),_defineProperty(this,"uuid",void 0),_defineProperty(this,"name",void 0),_defineProperty(this,"version",void 0),_defineProperty(this,"revision",void 0),_defineProperty(this,"inputNodes",[]),_defineProperty(this,"outputNodes",[]),_defineProperty(this,"allNodes",new Map),_defineProperty(this,"wires",[]),_defineProperty(this,"compiled",!1),_defineProperty(this,"nodesInOrder",[]),this.version="1.0",this.uuid=t.MathUtils.generateUUID(),this.name=e,this.revision=0}return _createClass(NodeGraph,[{key:"addWire",value:function addWire(e){this.wires.push(e),this.revision++}},{key:"addNode",value:function addNode(e){this.allNodes.set(e.id,e),e.type===$e.input?this.inputNodes.push(e):Kt.has(e.type.name)&&this.outputNodes.push(e),this.revision++}},{key:"getNode",value:function getNode(e){return this.allNodes.get(e)}},{key:"deleteNode",value:function deleteNode(e){this.allNodes.delete(e.id),this.revision++}},{key:"deleteWire",value:function deleteWire(e){var t=e.input.outputs[e.inputIndex].indexOf(e);-1!==t&&e.input.outputs[e.inputIndex].splice(t,1),e.output.inputs[e.outputIndex]=void 0,-1!=(t=this.wires.indexOf(e))&&(this.wires[t]=this.wires[this.wires.length-1],this.wires.pop()),this.revision++}},{key:"toJSON",value:function toJSON(){throw new Error("not implemented")}},{key:"clone",value:function clone(){throw new Error("not implemented")}}]),NodeGraph}();new t.Vector3(0,0,1);var ei=new t.Quaternion,ti=new t.Vector3,ii=new t.Vector3,ri=new t.PlaneGeometry(1,1,1,1),ni=function(){function NodeVFX(e){var r,n,o,a,s,l,u;_classCallCheck(this,NodeVFX),_defineProperty(this,"emissionGraph",void 0),_defineProperty(this,"updateGraph",void 0),_defineProperty(this,"interpreter",void 0),_defineProperty(this,"autoDestroy",void 0),_defineProperty(this,"prewarm",void 0),_defineProperty(this,"looping",void 0),_defineProperty(this,"duration",void 0),_defineProperty(this,"particleNum",void 0),_defineProperty(this,"paused",void 0),_defineProperty(this,"particles",void 0),_defineProperty(this,"emitter",void 0),_defineProperty(this,"rendererSettings",void 0),_defineProperty(this,"neededToUpdateRender",void 0),_defineProperty(this,"rendererEmitterSettings",void 0),_defineProperty(this,"worldSpace",void 0),_defineProperty(this,"prewarmed",void 0),_defineProperty(this,"emissionState",void 0),_defineProperty(this,"emitEnded",void 0),_defineProperty(this,"markForDestroy",void 0),_defineProperty(this,"previousWorldPos",void 0),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"travelDistance",0),_defineProperty(this,"normalMatrix",new t.Matrix3),_defineProperty(this,"_renderer",void 0),_defineProperty(this,"speedFactor",0),this.autoDestroy=void 0!==e.autoDestroy&&e.autoDestroy,this.duration=null!==(r=e.duration)&&void 0!==r?r:1,this.looping=void 0===e.looping||e.looping,this.prewarm=void 0!==e.prewarm&&e.prewarm,this.worldSpace=null!==(n=e.worldSpace)&&void 0!==n&&n,this.rendererEmitterSettings=null!==(o=e.rendererEmitterSettings)&&void 0!==o?o:{},this.emissionGraph=e.emissionGraph,this.updateGraph=e.updateGraph,this.interpreter=new Ye,this.rendererSettings={instancingGeometry:null!==(a=e.instancingGeometry)&&void 0!==a?a:ri,renderMode:null!==(s=e.renderMode)&&void 0!==s?s:be.BillBoard,renderOrder:null!==(l=e.renderOrder)&&void 0!==l?l:0,material:e.material,layers:null!==(u=e.layers)&&void 0!==u?u:new t.Layers,uTileCount:1,vTileCount:1},this.neededToUpdateRender=!0,this.particles=new Array,this.emitter=new i(this),this.paused=!1,this.particleNum=0,this.emissionState={time:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return _createClass(NodeVFX,[{key:"time",get:function get(){return this.emissionState.time},set:function set(e){this.emissionState.time=e}},{key:"layers",get:function get(){return this.rendererSettings.layers}},{key:"texture",get:function get(){return this.rendererSettings.material.map},set:function set(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function get(){return this.rendererSettings.material},set:function set(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function get(){return this.rendererSettings.instancingGeometry},set:function set(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function get(){return this.rendererSettings.renderMode},set:function set(e){if((this.rendererSettings.renderMode!=be.Trail&&e===be.Trail||this.rendererSettings.renderMode==be.Trail&&e!==be.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==e)switch(e){case be.Trail:this.rendererEmitterSettings={startLength:30,followLocalOrigin:!1};break;case be.Mesh:this.rendererEmitterSettings={geometry:new t.PlaneGeometry(1,1)};break;case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:case be.StretchedBillBoard:this.rendererEmitterSettings={}}this.rendererSettings.renderMode=e,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function get(){return this.rendererSettings.renderOrder},set:function set(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function get(){return this.rendererSettings.material.blending},set:function set(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function pause(){this.paused=!0}},{key:"play",value:function play(){this.paused=!1}},{key:"spawn",value:function spawn(e,i){ei.setFromRotationMatrix(i);var r=ti,n=ei,a=ii;for(i.decompose(r,n,a),this.particleNum++;this.particles.length<this.particleNum;)this.particles.push(new o);var s=this.particles[this.particleNum-1];if(s.reset(),this.interpreter.run(this.updateGraph,{particle:s,emissionState:this.emissionState}),this.rendererSettings.renderMode===be.Trail&&this.rendererEmitterSettings.followLocalOrigin){var l=s;l.localPosition=(new t.Vector3).copy(l.position)}this.worldSpace&&(s.position.applyMatrix4(i),s.size*=(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z))/3,s.velocity.multiply(a).applyMatrix3(this.normalMatrix),s.rotation&&s.rotation instanceof t.Quaternion&&s.rotation.multiplyQuaternions(ei,s.rotation))}},{key:"endEmit",value:function endEmit(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function dispose(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function restart(){this.paused=!1,this.particleNum=0,this.emissionState.time=0,this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function update(e){if(!this.paused){for(var t=this.emitter;t.parent;)t=t.parent;if("Scene"===t.type)if(this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var i=0;i<60*this.duration;i++)this.update(1/60)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.emit(e,this.emissionState,this.emitter.matrixWorld);for(var r={particle:void 0,emissionState:this.emissionState,delta:e},n=0;n<this.particleNum;n++)r.particle=this.particles[n],this.interpreter.run(this.updateGraph,r);for(var o=0;o<this.particleNum;o++)this.rendererEmitterSettings.followLocalOrigin&&this.particles[o].localPosition?(this.particles[o].position.copy(this.particles[o].localPosition),this.particles[o].parentMatrix?this.particles[o].position.applyMatrix4(this.particles[o].parentMatrix):this.particles[o].position.applyMatrix4(this.emitter.matrixWorld)):this.particles[o].position.addScaledVector(this.particles[o].velocity,e),this.particles[o].age+=e;if(this.rendererSettings.renderMode===be.Trail)for(var a=0;a<this.particleNum;a++)this.particles[a].update();for(var s=0;s<this.particleNum;s++){var u=this.particles[s];!u.died||u instanceof l&&0!==u.previous.length||(this.particles[s]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=u,this.particleNum--,s--)}}else this.dispose()}}},{key:"emit",value:function emit(e,i,r){var n=this;i.time>this.duration&&(this.looping?i.time-=this.duration:this.emitEnded||this.endEmit()),this.normalMatrix.getNormalMatrix(r);var o={signal:function signal(){n.spawn(i,r)},emissionState:i,delta:e};this.emitEnded||this.interpreter.run(this.emissionGraph,o),void 0===this.previousWorldPos&&(this.previousWorldPos=new t.Vector3),this.emitter.getWorldPosition(this.previousWorldPos),i.time+=e}},{key:"toJSON",value:function toJSON(e){return{}}},{key:"getRendererSettings",value:function getRendererSettings(){return this.rendererSettings}},{key:"clone",value:function clone(){return this}}]),NodeVFX}();console.log("%c Particle system powered by three.quarks. https://quarks.art/","font-size: 16px; font-weight: bold;"),e.ApplyCollision=ue,e.ApplyForce=R,e.ApplySequences=le,e.AxisAngleGenerator=k,e.BatchedParticleRenderer=Ge,e.BatchedRenderer=Ie,e.BehaviorFromJSON=BehaviorFromJSON,e.BehaviorTypes=pe,e.Bezier=u,e.ChangeEmitDirection=G,e.CircleEmitter=ye,e.ColorBySpeed=ce,e.ColorGeneratorFromJSON=ColorGeneratorFromJSON,e.ColorOverLife=C,e.ColorRange=m,e.ConeEmitter=me,e.ConstantColor=w,e.ConstantValue=O,e.DonutEmitter=ve,e.EmitSubParticleSystem=j,e.EmitterFromJSON=EmitterFromJSON,e.EmitterShapes=xe,e.EulerGenerator=M,e.ForceOverLife=E,e.FrameOverLife=J,e.GeneratorFromJSON=GeneratorFromJSON,e.Gradient=g,e.GraphNodeType=Ke,e.GravityForce=I,e.GridEmitter=we,e.HemisphereEmitter=_e,e.Interpreter=Ye,e.IntervalValue=x,e.LimitSpeedOverLife=fe,e.MeshSurfaceEmitter=Oe,e.Node=He,e.NodeGraph=$t,e.NodeParticle=o,e.NodeType=Ze,e.NodeTypes=$e,e.NodeVFX=ni,e.NodeValueType=Xe,e.Noise=oe,e.OrbitOverLife=L,e.OutputNodeTypeNames=Kt,e.ParticleEmitter=i,e.ParticleSystem=Be,e.PiecewiseBezier=N,e.PiecewiseFunction=b,e.Plugins=qe,e.PointEmitter=ge,e.QuarksLoader=De,e.RandomColor=p,e.RandomColorBetweenGradient=_,e.RandomQuatGenerator=P,e.RecordState=s,e.RenderMode=be,e.Rotation3DOverLife=T,e.RotationBySpeed=he,e.RotationGeneratorFromJSON=RotationGeneratorFromJSON,e.RotationOverLife=V,e.SequencerFromJSON=SequencerFromJSON,e.SizeBySpeed=de,e.SizeOverLife=z,e.SpeedOverLife=A,e.SphereEmitter=Se,e.SpriteBatch=Ue,e.SpriteParticle=a,e.SubParticleEmitMode=X,e.TextureSequencer=ae,e.TrailBatch=Fe,e.TrailParticle=l,e.TurbulenceField=te,e.VFXBatch=Ne,e.ValueGeneratorFromJSON=ValueGeneratorFromJSON,e.WidthOverLength=U,e.Wire=We,e.genDefaultForNodeValueType=je,e.getPhysicsResolver=getPhysicsResolver,e.loadPlugin=function loadPlugin(e){if(!qe.find((function(t){return t.id===e.id}))){e.initialize();var t,i=_createForOfIteratorHelper(e.emitterShapes);try{for(i.s();!(t=i.n()).done;){var r=t.value;xe[r.type]||(xe[r.type]=r)}}catch(e){i.e(e)}finally{i.f()}var n,o=_createForOfIteratorHelper(e.behaviors);try{for(o.s();!(n=o.n()).done;){var a=n.value;pe[a.type]||(pe[a.type]=a)}}catch(e){o.e(e)}finally{o.f()}}},e.setPhysicsResolver=function setPhysicsResolver(e){se=e},e.unloadPlugin=function unloadPlugin(e){var t=qe.find((function(t){return t.id===e}));if(t){var i,r=_createForOfIteratorHelper(t.emitterShapes);try{for(r.s();!(i=r.n()).done;){var n=i.value;xe[n.type]&&delete xe[n.type]}}catch(e){r.e(e)}finally{r.f()}var o,a=_createForOfIteratorHelper(t.behaviors);try{for(a.s();!(o=a.n()).done;){var s=o.value;pe[s.type]&&delete pe[s.type]}}catch(e){a.e(e)}finally{a.f()}}}},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).THREE=e.THREE||{},e.THREE.QUARKS={}),e.THREE)}));
+!function(e){"function"==typeof define&&define.amd?define(e):e()}((function(){"use strict";var e,t;e=void 0,t=function(e,t){function _regeneratorRuntime(){_regeneratorRuntime=function(){return t};var e,t={},i=Object.prototype,r=i.hasOwnProperty,n=Object.defineProperty||function(e,t,i){e[t]=i.value},o="function"==typeof Symbol?Symbol:{},a=o.iterator||"@@iterator",s=o.asyncIterator||"@@asyncIterator",l=o.toStringTag||"@@toStringTag";function define(e,t,i){return Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}),e[t]}try{define({},"")}catch(e){define=function(e,t,i){return e[t]=i}}function wrap(e,t,i,r){var o=t&&t.prototype instanceof Generator?t:Generator,a=Object.create(o.prototype),s=new Context(r||[]);return n(a,"_invoke",{value:makeInvokeMethod(e,i,s)}),a}function tryCatch(e,t,i){try{return{type:"normal",arg:e.call(t,i)}}catch(e){return{type:"throw",arg:e}}}t.wrap=wrap;var u="suspendedStart",c="suspendedYield",d="executing",h="completed",f={};function Generator(){}function GeneratorFunction(){}function GeneratorFunctionPrototype(){}var p={};define(p,a,(function(){return this}));var m=Object.getPrototypeOf,y=m&&m(m(values([])));y&&y!==i&&r.call(y,a)&&(p=y);var v=GeneratorFunctionPrototype.prototype=Generator.prototype=Object.create(p);function defineIteratorMethods(e){["next","throw","return"].forEach((function(t){define(e,t,(function(e){return this._invoke(t,e)}))}))}function AsyncIterator(e,t){function invoke(i,n,o,a){var s=tryCatch(e[i],e,n);if("throw"!==s.type){var l=s.arg,u=l.value;return u&&"object"==typeof u&&r.call(u,"__await")?t.resolve(u.__await).then((function(e){invoke("next",e,o,a)}),(function(e){invoke("throw",e,o,a)})):t.resolve(u).then((function(e){l.value=e,o(l)}),(function(e){return invoke("throw",e,o,a)}))}a(s.arg)}var i;n(this,"_invoke",{value:function(e,r){function callInvokeWithMethodAndArg(){return new t((function(t,i){invoke(e,r,t,i)}))}return i=i?i.then(callInvokeWithMethodAndArg,callInvokeWithMethodAndArg):callInvokeWithMethodAndArg()}})}function makeInvokeMethod(t,i,r){var n=u;return function(o,a){if(n===d)throw new Error("Generator is already running");if(n===h){if("throw"===o)throw a;return{value:e,done:!0}}for(r.method=o,r.arg=a;;){var s=r.delegate;if(s){var l=maybeInvokeDelegate(s,r);if(l){if(l===f)continue;return l}}if("next"===r.method)r.sent=r._sent=r.arg;else if("throw"===r.method){if(n===u)throw n=h,r.arg;r.dispatchException(r.arg)}else"return"===r.method&&r.abrupt("return",r.arg);n=d;var p=tryCatch(t,i,r);if("normal"===p.type){if(n=r.done?h:c,p.arg===f)continue;return{value:p.arg,done:r.done}}"throw"===p.type&&(n=h,r.method="throw",r.arg=p.arg)}}}function maybeInvokeDelegate(t,i){var r=i.method,n=t.iterator[r];if(n===e)return i.delegate=null,"throw"===r&&t.iterator.return&&(i.method="return",i.arg=e,maybeInvokeDelegate(t,i),"throw"===i.method)||"return"!==r&&(i.method="throw",i.arg=new TypeError("The iterator does not provide a '"+r+"' method")),f;var o=tryCatch(n,t.iterator,i.arg);if("throw"===o.type)return i.method="throw",i.arg=o.arg,i.delegate=null,f;var a=o.arg;return a?a.done?(i[t.resultName]=a.value,i.next=t.nextLoc,"return"!==i.method&&(i.method="next",i.arg=e),i.delegate=null,f):a:(i.method="throw",i.arg=new TypeError("iterator result is not an object"),i.delegate=null,f)}function pushTryEntry(e){var t={tryLoc:e[0]};1 in e&&(t.catchLoc=e[1]),2 in e&&(t.finallyLoc=e[2],t.afterLoc=e[3]),this.tryEntries.push(t)}function resetTryEntry(e){var t=e.completion||{};t.type="normal",delete t.arg,e.completion=t}function Context(e){this.tryEntries=[{tryLoc:"root"}],e.forEach(pushTryEntry,this),this.reset(!0)}function values(t){if(t||""===t){var i=t[a];if(i)return i.call(t);if("function"==typeof t.next)return t;if(!isNaN(t.length)){var n=-1,o=function next(){for(;++n<t.length;)if(r.call(t,n))return next.value=t[n],next.done=!1,next;return next.value=e,next.done=!0,next};return o.next=o}}throw new TypeError(typeof t+" is not iterable")}return GeneratorFunction.prototype=GeneratorFunctionPrototype,n(v,"constructor",{value:GeneratorFunctionPrototype,configurable:!0}),n(GeneratorFunctionPrototype,"constructor",{value:GeneratorFunction,configurable:!0}),GeneratorFunction.displayName=define(GeneratorFunctionPrototype,l,"GeneratorFunction"),t.isGeneratorFunction=function(e){var t="function"==typeof e&&e.constructor;return!!t&&(t===GeneratorFunction||"GeneratorFunction"===(t.displayName||t.name))},t.mark=function(e){return Object.setPrototypeOf?Object.setPrototypeOf(e,GeneratorFunctionPrototype):(e.__proto__=GeneratorFunctionPrototype,define(e,l,"GeneratorFunction")),e.prototype=Object.create(v),e},t.awrap=function(e){return{__await:e}},defineIteratorMethods(AsyncIterator.prototype),define(AsyncIterator.prototype,s,(function(){return this})),t.AsyncIterator=AsyncIterator,t.async=function(e,i,r,n,o){void 0===o&&(o=Promise);var a=new AsyncIterator(wrap(e,i,r,n),o);return t.isGeneratorFunction(i)?a:a.next().then((function(e){return e.done?e.value:a.next()}))},defineIteratorMethods(v),define(v,l,"Generator"),define(v,a,(function(){return this})),define(v,"toString",(function(){return"[object Generator]"})),t.keys=function(e){var t=Object(e),i=[];for(var r in t)i.push(r);return i.reverse(),function next(){for(;i.length;){var e=i.pop();if(e in t)return next.value=e,next.done=!1,next}return next.done=!0,next}},t.values=values,Context.prototype={constructor:Context,reset:function(t){if(this.prev=0,this.next=0,this.sent=this._sent=e,this.done=!1,this.delegate=null,this.method="next",this.arg=e,this.tryEntries.forEach(resetTryEntry),!t)for(var i in this)"t"===i.charAt(0)&&r.call(this,i)&&!isNaN(+i.slice(1))&&(this[i]=e)},stop:function(){this.done=!0;var e=this.tryEntries[0].completion;if("throw"===e.type)throw e.arg;return this.rval},dispatchException:function(t){if(this.done)throw t;var i=this;function handle(r,n){return a.type="throw",a.arg=t,i.next=r,n&&(i.method="next",i.arg=e),!!n}for(var n=this.tryEntries.length-1;n>=0;--n){var o=this.tryEntries[n],a=o.completion;if("root"===o.tryLoc)return handle("end");if(o.tryLoc<=this.prev){var s=r.call(o,"catchLoc"),l=r.call(o,"finallyLoc");if(s&&l){if(this.prev<o.catchLoc)return handle(o.catchLoc,!0);if(this.prev<o.finallyLoc)return handle(o.finallyLoc)}else if(s){if(this.prev<o.catchLoc)return handle(o.catchLoc,!0)}else{if(!l)throw new Error("try statement without catch or finally");if(this.prev<o.finallyLoc)return handle(o.finallyLoc)}}}},abrupt:function(e,t){for(var i=this.tryEntries.length-1;i>=0;--i){var n=this.tryEntries[i];if(n.tryLoc<=this.prev&&r.call(n,"finallyLoc")&&this.prev<n.finallyLoc){var o=n;break}}o&&("break"===e||"continue"===e)&&o.tryLoc<=t&&t<=o.finallyLoc&&(o=null);var a=o?o.completion:{};return a.type=e,a.arg=t,o?(this.method="next",this.next=o.finallyLoc,f):this.complete(a)},complete:function(e,t){if("throw"===e.type)throw e.arg;return"break"===e.type||"continue"===e.type?this.next=e.arg:"return"===e.type?(this.rval=this.arg=e.arg,this.method="return",this.next="end"):"normal"===e.type&&t&&(this.next=t),f},finish:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.finallyLoc===e)return this.complete(i.completion,i.afterLoc),resetTryEntry(i),f}},catch:function(e){for(var t=this.tryEntries.length-1;t>=0;--t){var i=this.tryEntries[t];if(i.tryLoc===e){var r=i.completion;if("throw"===r.type){var n=r.arg;resetTryEntry(i)}return n}}throw new Error("illegal catch attempt")},delegateYield:function(t,i,r){return this.delegate={iterator:values(t),resultName:i,nextLoc:r},"next"===this.method&&(this.arg=e),f}},t}function _typeof(e){return _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},_typeof(e)}function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperties(e,t){for(var i=0;i<t.length;i++){var r=t[i];r.enumerable=r.enumerable||!1,r.configurable=!0,"value"in r&&(r.writable=!0),Object.defineProperty(e,_toPropertyKey(r.key),r)}}function _createClass(e,t,i){return t&&_defineProperties(e.prototype,t),i&&_defineProperties(e,i),Object.defineProperty(e,"prototype",{writable:!1}),e}function _defineProperty(e,t,i){return(t=_toPropertyKey(t))in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}function _inherits(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),Object.defineProperty(e,"prototype",{writable:!1}),t&&_setPrototypeOf(e,t)}function _getPrototypeOf(e){return _getPrototypeOf=Object.setPrototypeOf?Object.getPrototypeOf.bind():function _getPrototypeOf(e){return e.__proto__||Object.getPrototypeOf(e)},_getPrototypeOf(e)}function _setPrototypeOf(e,t){return _setPrototypeOf=Object.setPrototypeOf?Object.setPrototypeOf.bind():function _setPrototypeOf(e,t){return e.__proto__=t,e},_setPrototypeOf(e,t)}function _assertThisInitialized(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}function _createSuper(e){var t=function _isNativeReflectConstruct(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function _createSuperInternal(){var i,r=_getPrototypeOf(e);if(t){var n=_getPrototypeOf(this).constructor;i=Reflect.construct(r,arguments,n)}else i=r.apply(this,arguments);return function _possibleConstructorReturn(e,t){if(t&&("object"==typeof t||"function"==typeof t))return t;if(void 0!==t)throw new TypeError("Derived constructors may only return object or undefined");return _assertThisInitialized(e)}(this,i)}}function _get(){return _get="undefined"!=typeof Reflect&&Reflect.get?Reflect.get.bind():function _get(e,t,i){var r=function _superPropBase(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=_getPrototypeOf(e)););return e}(e,t);if(r){var n=Object.getOwnPropertyDescriptor(r,t);return n.get?n.get.call(arguments.length<3?e:i):n.value}},_get.apply(this,arguments)}function _slicedToArray(e,t){return function _arrayWithHoles(e){if(Array.isArray(e))return e}(e)||function _iterableToArrayLimit(e,t){var i=null==e?null:"undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(null!=i){var r,n,o,a,s=[],l=!0,u=!1;try{if(o=(i=i.call(e)).next,0===t){if(Object(i)!==i)return;l=!1}else for(;!(l=(r=o.call(i)).done)&&(s.push(r.value),s.length!==t);l=!0);}catch(e){u=!0,n=e}finally{try{if(!l&&null!=i.return&&(a=i.return(),Object(a)!==a))return}finally{if(u)throw n}}return s}}(e,t)||_unsupportedIterableToArray(e,t)||function _nonIterableRest(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function _unsupportedIterableToArray(e,t){if(e){if("string"==typeof e)return _arrayLikeToArray(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);return"Object"===i&&e.constructor&&(i=e.constructor.name),"Map"===i||"Set"===i?Array.from(e):"Arguments"===i||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i)?_arrayLikeToArray(e,t):void 0}}function _arrayLikeToArray(e,t){(null==t||t>e.length)&&(t=e.length);for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function _createForOfIteratorHelper(e,t){var i="undefined"!=typeof Symbol&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_unsupportedIterableToArray(e))||t&&e&&"number"==typeof e.length){i&&(e=i);var r=0,F=function(){};return{s:F,n:function(){return r>=e.length?{done:!0}:{done:!1,value:e[r++]}},e:function(e){throw e},f:F}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var n,o=!0,a=!1;return{s:function(){i=i.call(e)},n:function(){var e=i.next();return o=e.done,e},e:function(e){a=!0,n=e},f:function(){try{o||null==i.return||i.return()}finally{if(a)throw n}}}}function _toPropertyKey(e){var t=function _toPrimitive(e,t){if("object"!=typeof e||null===e)return e;var i=e[Symbol.toPrimitive];if(void 0!==i){var r=i.call(e,t||"default");if("object"!=typeof r)return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===t?String:Number)(e)}(e,"string");return"symbol"==typeof t?t:String(t)}var i=function(e){_inherits(ParticleEmitter,e);var t=_createSuper(ParticleEmitter);function ParticleEmitter(e){var i;return _classCallCheck(this,ParticleEmitter),_defineProperty(_assertThisInitialized(i=t.call(this)),"type","ParticleEmitter"),_defineProperty(_assertThisInitialized(i),"system",void 0),i.system=e,i}return _createClass(ParticleEmitter,[{key:"clone",value:function clone(){var e=this.system.clone();return e.emitter.copy(this,!0),e.emitter}},{key:"dispose",value:function dispose(){}},{key:"extractFromCache",value:function extractFromCache(e){var t=[];for(var i in e){var r=e[i];delete r.metadata,t.push(r)}return t}},{key:"toJSON",value:function toJSON(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=void 0===e||"string"==typeof e,r={};i&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}},r.metadata={version:4.5,type:"Object",generator:"Object3D.toJSON"});var n={};if(n.uuid=this.uuid,n.type=this.type,""!==this.name&&(n.name=this.name),!0===this.castShadow&&(n.castShadow=!0),!0===this.receiveShadow&&(n.receiveShadow=!0),!1===this.visible&&(n.visible=!1),!1===this.frustumCulled&&(n.frustumCulled=!1),0!==this.renderOrder&&(n.renderOrder=this.renderOrder),"{}"!==JSON.stringify(this.userData)&&(n.userData=this.userData),n.layers=this.layers.mask,n.matrix=this.matrix.toArray(),!1===this.matrixAutoUpdate&&(n.matrixAutoUpdate=!1),null!==this.system&&(n.ps=this.system.toJSON(e,t)),this.children.length>0){n.children=[];for(var o=0;o<this.children.length;o++)"ParticleSystemPreview"!==this.children[o].type&&n.children.push(this.children[o].toJSON(e).object)}if(i){var a=this.extractFromCache(e.geometries),s=this.extractFromCache(e.materials),l=this.extractFromCache(e.textures),u=this.extractFromCache(e.images);a.length>0&&(r.geometries=a),s.length>0&&(r.materials=s),l.length>0&&(r.textures=l),u.length>0&&(r.images=u)}return r.object=n,r}}]),ParticleEmitter}(t.Object3D),r=function(){function LinkedListNode(e){_classCallCheck(this,LinkedListNode),_defineProperty(this,"data",void 0),_defineProperty(this,"next",void 0),_defineProperty(this,"prev",void 0),this.data=e,this.next=null,this.prev=null}return _createClass(LinkedListNode,[{key:"hasPrev",value:function hasPrev(){return null!==this.prev}},{key:"hasNext",value:function hasNext(){return null!==this.next}}]),LinkedListNode}(),n=function(){function LinkedList(){_classCallCheck(this,LinkedList),_defineProperty(this,"length",void 0),_defineProperty(this,"head",void 0),_defineProperty(this,"tail",void 0),this.length=0,this.head=this.tail=null}return _createClass(LinkedList,[{key:"isEmpty",value:function isEmpty(){return null===this.head}},{key:"clear",value:function clear(){this.length=0,this.head=this.tail=null}},{key:"front",value:function front(){return null===this.head?null:this.head.data}},{key:"back",value:function back(){return null===this.tail?null:this.tail.data}},{key:"dequeue",value:function dequeue(){if(this.head){var e=this.head.data;return this.head=this.head.next,this.head?this.head.prev=null:this.tail=null,this.length--,e}}},{key:"pop",value:function pop(){if(this.tail){var e=this.tail.data;return this.tail=this.tail.prev,this.tail?this.tail.next=null:this.head=null,this.length--,e}}},{key:"queue",value:function queue(e){var t=new r(e);this.tail||(this.tail=t),this.head&&(this.head.prev=t,t.next=this.head),this.head=t,this.length++}},{key:"push",value:function push(e){var t=new r(e);this.head||(this.head=t),this.tail&&(this.tail.next=t,t.prev=this.tail),this.tail=t,this.length++}},{key:"insertBefore",value:function insertBefore(e,t){var i=new r(t);i.next=e,i.prev=e.prev,null!==i.prev&&(i.prev.next=i),i.next.prev=i,e==this.head&&(this.head=i),this.length++}},{key:"remove",value:function remove(e){if(null!==this.head&&null!==this.tail){var t=this.head;for(e===this.head.data&&(this.head=this.head.next),e===this.tail.data&&(this.tail=this.tail.prev);null!==t.next&&t.data!==e;)t=t.next;t.data===e&&(null!==t.prev&&(t.prev.next=t.next),null!==t.next&&(t.next.prev=t.prev),this.length--)}}},{key:"values",value:_regeneratorRuntime().mark((function values(){var e;return _regeneratorRuntime().wrap((function values$(t){for(;;)switch(t.prev=t.next){case 0:e=this.head;case 1:if(null===e){t.next=7;break}return t.next=4,e.data;case 4:e=e.next,t.next=1;break;case 7:case"end":return t.stop()}}),values,this)}))}]),LinkedList}(),o=function(){function NodeParticle(){_classCallCheck(this,NodeParticle),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"angularVelocity",void 0),_defineProperty(this,"rotation",0),_defineProperty(this,"color",new t.Vector4(1,1,1,1)),_defineProperty(this,"uvTile",0)}return _createClass(NodeParticle,[{key:"died",get:function get(){return this.age>=this.life}},{key:"reset",value:function reset(){this.position.set(0,0,0),this.velocity.set(0,0,0),this.age=0,this.life=1,this.size=1,this.rotation=0,this.color.set(1,1,1,1),this.uvTile=0}}]),NodeParticle}(),a=function(){function SpriteParticle(){_classCallCheck(this,SpriteParticle),_defineProperty(this,"parentMatrix",void 0),_defineProperty(this,"startSpeed",0),_defineProperty(this,"startColor",new t.Vector4),_defineProperty(this,"startSize",1),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"angularVelocity",void 0),_defineProperty(this,"rotation",0),_defineProperty(this,"color",new t.Vector4),_defineProperty(this,"uvTile",0)}return _createClass(SpriteParticle,[{key:"died",get:function get(){return this.age>=this.life}}]),SpriteParticle}(),s=_createClass((function RecordState(e,t,i){_classCallCheck(this,RecordState),this.position=e,this.size=t,this.color=i})),l=function(){function TrailParticle(){_classCallCheck(this,TrailParticle),_defineProperty(this,"parentMatrix",void 0),_defineProperty(this,"startSpeed",0),_defineProperty(this,"startColor",new t.Vector4),_defineProperty(this,"startSize",1),_defineProperty(this,"position",new t.Vector3),_defineProperty(this,"localPosition",void 0),_defineProperty(this,"velocity",new t.Vector3),_defineProperty(this,"age",0),_defineProperty(this,"life",1),_defineProperty(this,"size",1),_defineProperty(this,"length",100),_defineProperty(this,"color",new t.Vector4),_defineProperty(this,"previous",new n),_defineProperty(this,"uvTile",0)}return _createClass(TrailParticle,[{key:"update",value:function update(){for(this.age<=this.life?this.previous.push(new s(this.position.clone(),this.size,this.color.clone())):this.previous.length>0&&this.previous.dequeue();this.previous.length>this.length;)this.previous.dequeue()}},{key:"died",get:function get(){return this.age>=this.life}},{key:"reset",value:function reset(){this.previous.clear()}}]),TrailParticle}(),u=function(){function Bezier(e,t,i,r){_classCallCheck(this,Bezier),_defineProperty(this,"p",void 0),this.p=[e,t,i,r]}return _createClass(Bezier,[{key:"genValue",value:function genValue(e){var t=e*e,i=e*e*e,r=1-e,n=r*r,o=n*r;return this.p[0]*o+this.p[1]*n*e*3+this.p[2]*r*t*3+this.p[3]*i}},{key:"derivativeCoefficients",value:function derivativeCoefficients(e){for(var t=[],i=e,r=i.length-1;r>0;r--){for(var n=[],o=0;o<r;o++){var a=r*(i[o+1]-i[o]);n.push(a)}t.push(n),i=n}return t}},{key:"getSlope",value:function getSlope(e){var t=this.derivativeCoefficients(this.p)[0],i=1-e,r=i*e*2,n=e*e;return i*i*t[0]+r*t[1]+n*t[2]}},{key:"controlCurve",value:function controlCurve(e,t){this.p[1]=e/3+this.p[0],this.p[2]=this.p[3]-t/3}},{key:"hull",value:function hull(e){var t,i=this.p,r=[],n=0,o=0,a=0,s=[];for(s[n++]=i[0],s[n++]=i[1],s[n++]=i[2],s[n++]=i[3];i.length>1;){for(r=[],o=0,a=i.length-1;o<a;o++)t=e*i[o]+(1-e)*i[o+1],s[n++]=t,r.push(t);i=r}return s}},{key:"split",value:function split(e){var t=this.hull(e);return{left:new Bezier(t[0],t[4],t[7],t[9]),right:new Bezier(t[9],t[8],t[6],t[3]),span:t}}},{key:"clone",value:function clone(){return new Bezier(this.p[0],this.p[1],this.p[2],this.p[3])}},{key:"toJSON",value:function toJSON(){return{p0:this.p[0],p1:this.p[1],p2:this.p[2],p3:this.p[3]}}}],[{key:"fromJSON",value:function fromJSON(e){return new Bezier(e.p0,e.p1,e.p2,e.p3)}}]),Bezier}(),c=function ColorToJSON(e){return{r:e.x,g:e.y,b:e.z,a:e.w}},d=function JSONToColor(e){return new t.Vector4(e.r,e.g,e.b,e.a)},h=function JSONToValue(e,i){switch(i){case"Vector3":return new t.Vector3(e.x,e.y,e.z);case"Vector4":return new t.Vector4(e.x,e.y,e.z,e.w);case"Color":return new t.Vector3(e.r,e.g,e.b);default:return e}},f=function ValueToJSON(e,t){switch(t){case"Vector3":return{x:e.x,y:e.y,z:e.z};case"Vector4":return{x:e.x,y:e.y,z:e.z,w:e.w};case"Color":return{r:e.x,g:e.y,b:e.z};default:return e}},p=function(){function RandomColor(e,t){_classCallCheck(this,RandomColor),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="value"}return _createClass(RandomColor,[{key:"genColor",value:function genColor(e){var t=Math.random();return e.copy(this.a).lerp(this.b,t)}},{key:"toJSON",value:function toJSON(){return{type:"RandomColor",a:c(this.a),b:c(this.b)}}},{key:"clone",value:function clone(){return new RandomColor(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomColor(d(e.a),d(e.b))}}]),RandomColor}(),m=function(){function ColorRange(e,t){_classCallCheck(this,ColorRange),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="value"}return _createClass(ColorRange,[{key:"genColor",value:function genColor(e,t){return e.copy(this.a).lerp(this.b,Math.random())}},{key:"toJSON",value:function toJSON(){return{type:"ColorRange",a:c(this.a),b:c(this.b)}}},{key:"clone",value:function clone(){return new ColorRange(this.a.clone(),this.b.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorRange(d(e.a),d(e.b))}}]),ColorRange}(),y=function(){function ContinuousLinearFunction(e,t){_classCallCheck(this,ContinuousLinearFunction),_defineProperty(this,"keys",void 0),_defineProperty(this,"type",void 0),_defineProperty(this,"subType",void 0),this.subType=t,this.type="function",this.keys=e}return _createClass(ContinuousLinearFunction,[{key:"findKey",value:function findKey(e){for(var t=0,i=0,r=this.keys.length-1;i+1<r;)if(t=Math.floor((i+r)/2),e<this.getStartX(t))r=t-1;else{if(!(e>this.getEndX(t)))return t;i=t+1}for(var n=i;n<=r;n++)if(e>=this.getStartX(n)&&e<=this.getEndX(n))return n;return-1}},{key:"getStartX",value:function getStartX(e){return this.keys[e][1]}},{key:"getEndX",value:function getEndX(e){return e+1<this.keys.length?this.keys[e+1][1]:1}},{key:"genValue",value:function genValue(e,t){var i=this.findKey(t);return"Number"===this.subType?-1===i?this.keys[0][0]:i+1>=this.keys.length?this.keys[this.keys.length-1][0]:(this.keys[i+1][0]-this.keys[i][0])*((t-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))+this.keys[i][0]:-1===i?e.copy(this.keys[0][0]):i+1>=this.keys.length?e.copy(this.keys[this.keys.length-1][0]):e.copy(this.keys[i][0]).lerp(this.keys[i+1][0],(t-this.getStartX(i))/(this.getEndX(i)-this.getStartX(i)))}},{key:"toJSON",value:function toJSON(){var e=this;return this.keys[0][0].constructor.name,{type:"CLinearFunction",subType:this.subType,keys:this.keys.map((function(t){var i=_slicedToArray(t,2),r=i[0],n=i[1];return{value:f(r,e.subType),pos:n}}))}}},{key:"clone",value:function clone(){return"Number"===this.subType?new ContinuousLinearFunction(this.keys.map((function(e){var t=_slicedToArray(e,2);return[t[0],t[1]]})),this.subType):new ContinuousLinearFunction(this.keys.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return[i.clone(),r]})),this.subType)}}],[{key:"fromJSON",value:function fromJSON(e){return new ContinuousLinearFunction(e.keys.map((function(t){return[h(t.value,e.subType),t.pos]})),e.subType)}}]),ContinuousLinearFunction}(),v=new t.Vector3,g=function(){function Gradient(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new t.Vector3(0,0,0),0],[new t.Vector3(1,1,1),0]],i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[[1,0],[1,1]];_classCallCheck(this,Gradient),_defineProperty(this,"type",void 0),_defineProperty(this,"color",void 0),_defineProperty(this,"alpha",void 0),this.type="function",this.color=new y(e,"Color"),this.alpha=new y(i,"Number")}return _createClass(Gradient,[{key:"genColor",value:function genColor(e,t){return this.color.genValue(v,t),e.set(v.x,v.y,v.z,this.alpha.genValue(1,t))}},{key:"toJSON",value:function toJSON(){return{type:"Gradient",color:this.color.toJSON(),alpha:this.alpha.toJSON()}}},{key:"clone",value:function clone(){var e=new Gradient;return e.alpha=this.alpha.clone(),e.color=this.color.clone(),e}}],[{key:"fromJSON",value:function fromJSON(e){if(e.functions){var i=e.functions.map((function(e){return[m.fromJSON(e.function).a,e.start]}));return e.functions.length>0&&i.push([m.fromJSON(e.functions[e.functions.length-1].function).b,1]),new Gradient(i.map((function(e){return[new t.Vector3(e[0].x,e[0].y,e[0].z),e[1]]})),i.map((function(e){return[e[0].w,e[1]]})))}var r=new Gradient;return r.alpha=y.fromJSON(e.alpha),r.color=y.fromJSON(e.color),r}}]),Gradient}(),S=new t.Vector4,_=function(){function RandomColorBetweenGradient(e,t){_classCallCheck(this,RandomColorBetweenGradient),_defineProperty(this,"gradient1",void 0),_defineProperty(this,"gradient2",void 0),_defineProperty(this,"type",void 0),this.type="memorizedFunction",this.gradient1=e,this.gradient2=t}return _createClass(RandomColorBetweenGradient,[{key:"startGen",value:function startGen(e){e.rand=Math.random()}},{key:"genColor",value:function genColor(e,t,i){return this.gradient1.genColor(e,t),this.gradient2.genColor(S,t),i&&i.rand?e.lerp(S,i.rand):e.lerp(S,Math.random()),e}},{key:"toJSON",value:function toJSON(){return{type:"RandomColorBetweenGradient",gradient1:this.gradient1.toJSON(),gradient2:this.gradient2.toJSON()}}},{key:"clone",value:function clone(){return new RandomColorBetweenGradient(this.gradient1.clone(),this.gradient2.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomColorBetweenGradient(g.fromJSON(e.gradient1),g.fromJSON(e.gradient2))}}]),RandomColorBetweenGradient}(),w=function(){function ConstantColor(e){_classCallCheck(this,ConstantColor),_defineProperty(this,"type",void 0),this.color=e,this.type="value"}return _createClass(ConstantColor,[{key:"genColor",value:function genColor(e){return e.copy(this.color)}},{key:"toJSON",value:function toJSON(){return{type:"ConstantColor",color:c(this.color)}}},{key:"clone",value:function clone(){return new ConstantColor(this.color.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new ConstantColor(d(e.color))}}]),ConstantColor}();function ColorGeneratorFromJSON(e){switch(e.type){case"ConstantColor":return w.fromJSON(e);case"ColorRange":return m.fromJSON(e);case"RandomColor":return p.fromJSON(e);case"Gradient":return g.fromJSON(e);case"RandomColorBetweenGradient":return _.fromJSON(e);default:return new w(new t.Vector4(1,1,1,1))}}var O=function(){function ConstantValue(e){_classCallCheck(this,ConstantValue),_defineProperty(this,"type",void 0),this.value=e,this.type="value"}return _createClass(ConstantValue,[{key:"genValue",value:function genValue(){return this.value}},{key:"toJSON",value:function toJSON(){return{type:"ConstantValue",value:this.value}}},{key:"clone",value:function clone(){return new ConstantValue(this.value)}}],[{key:"fromJSON",value:function fromJSON(e){return new ConstantValue(e.value)}}]),ConstantValue}(),x=function(){function IntervalValue(e,t){_classCallCheck(this,IntervalValue),_defineProperty(this,"type",void 0),this.a=e,this.b=t,this.type="value"}return _createClass(IntervalValue,[{key:"genValue",value:function genValue(){return t.MathUtils.lerp(this.a,this.b,Math.random())}},{key:"toJSON",value:function toJSON(){return{type:"IntervalValue",a:this.a,b:this.b}}},{key:"clone",value:function clone(){return new IntervalValue(this.a,this.b)}}],[{key:"fromJSON",value:function fromJSON(e){return new IntervalValue(e.a,e.b)}}]),IntervalValue}(),b=function(){function PiecewiseFunction(){_classCallCheck(this,PiecewiseFunction),_defineProperty(this,"functions",void 0),this.functions=new Array}return _createClass(PiecewiseFunction,[{key:"findFunction",value:function findFunction(e){for(var t=0,i=0,r=this.functions.length-1;i+1<r;)if(t=Math.floor((i+r)/2),e<this.getStartX(t))r=t-1;else{if(!(e>this.getEndX(t)))return t;i=t+1}for(var n=i;n<=r;n++)if(e>=this.functions[n][1]&&e<=this.getEndX(n))return n;return-1}},{key:"getStartX",value:function getStartX(e){return this.functions[e][1]}},{key:"setStartX",value:function setStartX(e,t){e>0&&(this.functions[e][1]=t)}},{key:"getEndX",value:function getEndX(e){return e+1<this.functions.length?this.functions[e+1][1]:1}},{key:"setEndX",value:function setEndX(e,t){e+1<this.functions.length&&(this.functions[e+1][1]=t)}},{key:"insertFunction",value:function insertFunction(e,t){var i=this.findFunction(e);this.functions.splice(i+1,0,[t,e])}},{key:"removeFunction",value:function removeFunction(e){return this.functions.splice(e,1)[0][0]}},{key:"getFunction",value:function getFunction(e){return this.functions[e][0]}},{key:"setFunction",value:function setFunction(e,t){this.functions[e][0]=t}},{key:"numOfFunctions",get:function get(){return this.functions.length}}]),PiecewiseFunction}(),N=function(e){_inherits(PiecewiseBezier,e);var t=_createSuper(PiecewiseBezier);function PiecewiseBezier(){var e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:[[new u(0,1/3,1/3*2,1),0]];return _classCallCheck(this,PiecewiseBezier),_defineProperty(_assertThisInitialized(e=t.call(this)),"type",void 0),e.type="function",e.functions=i,e}return _createClass(PiecewiseBezier,[{key:"genValue",value:function genValue(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,t=this.findFunction(e);return-1===t?0:this.functions[t][0].genValue((e-this.getStartX(t))/(this.getEndX(t)-this.getStartX(t)))}},{key:"toSVG",value:function toSVG(e,t){if(t<1)return"";for(var i=["M",0,this.functions[0][0].p[0]].join(" "),r=1/t;r<=1;r+=1/t)i=[i,"L",r*e,this.genValue(r)].join(" ");return i}},{key:"toJSON",value:function toJSON(){return{type:"PiecewiseBezier",functions:this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return{function:i.toJSON(),start:r}}))}}},{key:"clone",value:function clone(){return new PiecewiseBezier(this.functions.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return[i.clone(),r]})))}}],[{key:"fromJSON",value:function fromJSON(e){return new PiecewiseBezier(e.functions.map((function(e){return[u.fromJSON(e.function),e.start]})))}}]),PiecewiseBezier}(b);function ValueGeneratorFromJSON(e){switch(e.type){case"ConstantValue":return O.fromJSON(e);case"IntervalValue":return x.fromJSON(e);case"PiecewiseBezier":return N.fromJSON(e);default:return new O(0)}}var P=function(){function RandomQuatGenerator(){_classCallCheck(this,RandomQuatGenerator),_defineProperty(this,"type",void 0),this.type="rotation"}return _createClass(RandomQuatGenerator,[{key:"genValue",value:function genValue(e,t){var i,r,n,o,a,s;do{n=(i=2*Math.random()-1)*i+(r=2*Math.random()-1)*r}while(n>1);do{s=(o=2*Math.random()-1)*o+(a=2*Math.random()-1)*a}while(s>1);var l=Math.sqrt((1-n)/s);return e.set(i,r,l*o,l*a),e}},{key:"toJSON",value:function toJSON(){return{type:"RandomQuat"}}},{key:"clone",value:function clone(){return new RandomQuatGenerator}}],[{key:"fromJSON",value:function fromJSON(e){return new RandomQuatGenerator}}]),RandomQuatGenerator}(),k=function(){function AxisAngleGenerator(e,t){_classCallCheck(this,AxisAngleGenerator),_defineProperty(this,"type",void 0),this.axis=e,this.angle=t,this.type="rotation"}return _createClass(AxisAngleGenerator,[{key:"genValue",value:function genValue(e,t){return e.setFromAxisAngle(this.axis,this.angle.genValue(t))}},{key:"toJSON",value:function toJSON(){return{type:"AxisAngle",axis:{x:this.axis.x,y:this.axis.y,z:this.axis.z},angle:this.angle.toJSON()}}},{key:"clone",value:function clone(){return new AxisAngleGenerator(this.axis.clone(),this.angle.clone())}}],[{key:"fromJSON",value:function fromJSON(e){return new AxisAngleGenerator(new t.Vector3(e.axis.x,e.axis.y,e.axis.z),ValueGeneratorFromJSON(e.angle))}}]),AxisAngleGenerator}(),M=function(){function EulerGenerator(e,i,r,n){_classCallCheck(this,EulerGenerator),_defineProperty(this,"type",void 0),_defineProperty(this,"eular",void 0),this.angleX=e,this.angleY=i,this.angleZ=r,this.type="rotation",this.eular=new t.Euler(0,0,0,n)}return _createClass(EulerGenerator,[{key:"genValue",value:function genValue(e,t){return this.eular.set(this.angleX.genValue(t),this.angleY.genValue(t),this.angleZ.genValue(t)),e.setFromEuler(this.eular)}},{key:"toJSON",value:function toJSON(){return{type:"Euler",angleX:this.angleX.toJSON(),angleY:this.angleY.toJSON(),angleZ:this.angleZ.toJSON(),eulerOrder:this.eular.order}}},{key:"clone",value:function clone(){return new EulerGenerator(this.angleX,this.angleY,this.angleZ,this.eular.order)}}],[{key:"fromJSON",value:function fromJSON(e){return new EulerGenerator(ValueGeneratorFromJSON(e.angleX),ValueGeneratorFromJSON(e.angleY),ValueGeneratorFromJSON(e.angleZ),e.eulerOrder)}}]),EulerGenerator}();function RotationGeneratorFromJSON(e){switch(e.type){case"AxisAngle":return k.fromJSON(e);case"Euler":return M.fromJSON(e);case"RandomQuat":return P.fromJSON(e);default:return new P}}function GeneratorFromJSON(e){switch(e.type){case"ConstantValue":case"IntervalValue":case"PiecewiseBezier":return ValueGeneratorFromJSON(e);case"AxisAngle":case"RandomQuat":case"Euler":return RotationGeneratorFromJSON(e);default:return new O(0)}}var C=function(){function ColorOverLife(e){_classCallCheck(this,ColorOverLife),_defineProperty(this,"type","ColorOverLife"),this.color=e}return _createClass(ColorOverLife,[{key:"initialize",value:function initialize(e){"memorizedFunction"===this.color.type&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function update(e,t){"memorizedFunction"===this.color.type?this.color.genColor(e.color,e.age/e.life,e.colorOverLifeMemory):this.color.genColor(e.color,e.age/e.life),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,color:this.color.toJSON()}}},{key:"clone",value:function clone(){return new ColorOverLife(this.color.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorOverLife(ColorGeneratorFromJSON(e.color))}}]),ColorOverLife}(),V=function(){function RotationOverLife(e,i){_classCallCheck(this,RotationOverLife),_defineProperty(this,"type","RotationOverLife"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.dynamic=i}return _createClass(RotationOverLife,[{key:"initialize",value:function initialize(e){!this.dynamic&&e instanceof a&&(e.angularVelocity=this.angularVelocity.genValue())}},{key:"update",value:function update(e,t){this.dynamic?e.rotation+=t*this.angularVelocity.genValue(e.age/e.life):e instanceof a&&(e.rotation+=t*e.angularVelocity)}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new RotationOverLife(this.angularVelocity.clone(),this.dynamic)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new RotationOverLife(ValueGeneratorFromJSON(e.angularVelocity),e.dynamic)}}]),RotationOverLife}(),B=new t.Quaternion,T=function(){function Rotation3DOverLife(e,i){_classCallCheck(this,Rotation3DOverLife),_defineProperty(this,"type","Rotation3DOverLife"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.dynamic=i}return _createClass(Rotation3DOverLife,[{key:"initialize",value:function initialize(e){!this.dynamic&&e instanceof a&&(e.angularVelocity=new t.Quaternion,this.angularVelocity.genValue(e.angularVelocity))}},{key:"update",value:function update(e,t){this.dynamic?(this.angularVelocity.genValue(this.tempQuat,e.age/e.life),this.tempQuat.slerpQuaternions(B,this.tempQuat,t),e.rotation.multiply(this.tempQuat)):e instanceof a&&(this.tempQuat.slerpQuaternions(B,e.angularVelocity,t),e.rotation.multiply(this.tempQuat))}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),dynamic:this.dynamic}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new Rotation3DOverLife(this.angularVelocity.clone(),this.dynamic)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new Rotation3DOverLife(RotationGeneratorFromJSON(e.angularVelocity),e.dynamic)}}]),Rotation3DOverLife}(),E=function(){function ForceOverLife(e,i,r){_classCallCheck(this,ForceOverLife),_defineProperty(this,"type","ForceOverLife"),_defineProperty(this,"_temp",new t.Vector3),this.x=e,this.y=i,this.z=r}return _createClass(ForceOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this._temp.set(this.x.genValue(e.age/e.life),this.y.genValue(e.age/e.life),this.z.genValue(e.age/e.life)),e.velocity.addScaledVector(this._temp,t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,x:this.x.toJSON(),y:this.y.toJSON(),z:this.z.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new ForceOverLife(this.x.clone(),this.y.clone(),this.z.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ForceOverLife(ValueGeneratorFromJSON(e.x),ValueGeneratorFromJSON(e.y),ValueGeneratorFromJSON(e.z))}}]),ForceOverLife}(),z=function(){function SizeOverLife(e){_classCallCheck(this,SizeOverLife),_defineProperty(this,"type","SizeOverLife"),this.size=e}return _createClass(SizeOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){e.size=e.startSize*this.size.genValue(e.age/e.life)}},{key:"toJSON",value:function toJSON(){return{type:this.type,size:this.size.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SizeOverLife(this.size.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SizeOverLife(ValueGeneratorFromJSON(e.size))}}]),SizeOverLife}(),A=function(){function SpeedOverLife(e){_classCallCheck(this,SpeedOverLife),_defineProperty(this,"type","SpeedOverLife"),this.speed=e}return _createClass(SpeedOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){e.speedModifier=this.speed.genValue(e.age/e.life)}},{key:"toJSON",value:function toJSON(){return{type:this.type,speed:this.speed.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SpeedOverLife(this.speed.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SpeedOverLife(ValueGeneratorFromJSON(e.speed))}}]),SpeedOverLife}(),J=function(){function FrameOverLife(e){_classCallCheck(this,FrameOverLife),_defineProperty(this,"type","FrameOverLife"),this.frame=e}return _createClass(FrameOverLife,[{key:"initialize",value:function initialize(e){this.frame instanceof N||(e.uvTile=Math.floor(this.frame.genValue(0)))}},{key:"update",value:function update(e,t){this.frame instanceof N&&(e.uvTile=Math.floor(this.frame.genValue(e.age/e.life)))}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,frame:this.frame.toJSON()}}},{key:"clone",value:function clone(){return new FrameOverLife(this.frame.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new FrameOverLife(ValueGeneratorFromJSON(e.frame))}}]),FrameOverLife}();new t.Vector3(0,0,1);var L=function(){function OrbitOverLife(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:new t.Vector3(0,1,0);_classCallCheck(this,OrbitOverLife),_defineProperty(this,"type","OrbitOverLife"),_defineProperty(this,"rotation",void 0),_defineProperty(this,"line",void 0),_defineProperty(this,"temp",new t.Vector3),this.orbitSpeed=e,this.axis=i,this.rotation=new t.Quaternion,this.line=new t.Line3}return _createClass(OrbitOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,i){this.line.set(new t.Vector3(0,0,0),this.axis),this.line.closestPointToPoint(e.position,!1,this.temp),this.rotation.setFromAxisAngle(this.axis,this.orbitSpeed.genValue(e.age/e.life)*i),e.position.sub(this.temp),e.position.applyQuaternion(this.rotation),e.position.add(this.temp)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,orbitSpeed:this.orbitSpeed.toJSON(),axis:[this.axis.x,this.axis.y,this.axis.z]}}},{key:"clone",value:function clone(){return new OrbitOverLife(this.orbitSpeed.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new OrbitOverLife(ValueGeneratorFromJSON(e.orbitSpeed),e.axis?new t.Vector3(e.axis[0],e.axis[1],e.axis[2]):void 0)}}]),OrbitOverLife}(),U=function(){function WidthOverLength(e){_classCallCheck(this,WidthOverLength),_defineProperty(this,"type","WidthOverLength"),this.width=e}return _createClass(WidthOverLength,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){if(e instanceof l)for(var t=e.previous.values(),i=0;i<e.previous.length;i++)t.next().value.size=this.width.genValue((e.previous.length-i)/e.length)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,width:this.width.toJSON()}}},{key:"clone",value:function clone(){return new WidthOverLength(this.width.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new WidthOverLength(ValueGeneratorFromJSON(e.width))}}]),WidthOverLength}(),R=function(){function ApplyForce(e,t){_classCallCheck(this,ApplyForce),_defineProperty(this,"type","ApplyForce"),_defineProperty(this,"magnitudeValue",void 0),this.direction=e,this.magnitude=t,this.magnitudeValue=this.magnitude.genValue()}return _createClass(ApplyForce,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){e.velocity.addScaledVector(this.direction,this.magnitudeValue*t)}},{key:"frameUpdate",value:function frameUpdate(e){this.magnitudeValue=this.magnitude.genValue()}},{key:"toJSON",value:function toJSON(){return{type:this.type,direction:[this.direction.x,this.direction.y,this.direction.z],magnitude:this.magnitude.toJSON()}}},{key:"clone",value:function clone(){return new ApplyForce(this.direction.clone(),this.magnitude.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){var i;return new ApplyForce(new t.Vector3(e.direction[0],e.direction[1],e.direction[2]),ValueGeneratorFromJSON(null!==(i=e.magnitude)&&void 0!==i?i:e.force))}}]),ApplyForce}(),I=function(){function GravityForce(e,i){_classCallCheck(this,GravityForce),_defineProperty(this,"type","GravityForce"),_defineProperty(this,"temp",new t.Vector3),this.center=e,this.magnitude=i}return _createClass(GravityForce,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this.temp.copy(this.center).sub(e.position).normalize(),e.velocity.addScaledVector(this.temp,this.magnitude/e.position.distanceToSquared(this.center)*t)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,center:[this.center.x,this.center.y,this.center.z],magnitude:this.magnitude}}},{key:"clone",value:function clone(){return new GravityForce(this.center.clone(),this.magnitude)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new GravityForce(new t.Vector3(e.center[0],e.center[1],e.center[2]),e.magnitude)}}]),GravityForce}();new t.Vector3(0,0,1);var G=function(){function ChangeEmitDirection(e){_classCallCheck(this,ChangeEmitDirection),_defineProperty(this,"type","ChangeEmitDirection"),_defineProperty(this,"_temp",new t.Vector3),_defineProperty(this,"_q",new t.Quaternion),this.angle=e}return _createClass(ChangeEmitDirection,[{key:"initialize",value:function initialize(e){var t=e.velocity.length();0!=t&&(e.velocity.normalize(),0===e.velocity.x&&0===e.velocity.y?this._temp.set(0,e.velocity.z,0):this._temp.set(-e.velocity.y,e.velocity.x,0),this._q.setFromAxisAngle(this._temp.normalize(),this.angle.genValue()),this._temp.copy(e.velocity),e.velocity.applyQuaternion(this._q),this._q.setFromAxisAngle(this._temp,Math.random()*Math.PI*2),e.velocity.applyQuaternion(this._q),e.velocity.setLength(t))}},{key:"update",value:function update(e,t){}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,angle:this.angle.toJSON()}}},{key:"clone",value:function clone(){return new ChangeEmitDirection(this.angle)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ChangeEmitDirection(ValueGeneratorFromJSON(e.angle))}}]),ChangeEmitDirection}(),D=new t.Vector3(1,1,1),q=new t.Vector3(0,0,1),X=function(e){return e[e.Death=0]="Death",e[e.Birth=1]="Birth",e[e.Frame=2]="Frame",e}({}),j=function(){function EmitSubParticleSystem(e,i,r){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:X.Frame,o=arguments.length>4&&void 0!==arguments[4]?arguments[4]:1;_classCallCheck(this,EmitSubParticleSystem),_defineProperty(this,"type","EmitSubParticleSystem"),_defineProperty(this,"q_",new t.Quaternion),_defineProperty(this,"v_",new t.Vector3),_defineProperty(this,"v2_",new t.Vector3),_defineProperty(this,"subEmissions",new Array),this.particleSystem=e,this.useVelocityAsBasis=i,this.subParticleSystem=r,this.mode=n,this.emitProbability=o,this.subParticleSystem&&this.subParticleSystem.system&&(this.subParticleSystem.system.onlyUsedByOther=!0)}return _createClass(EmitSubParticleSystem,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){(this.mode===X.Frame||this.mode===X.Birth&&0===e.age||this.mode===X.Death&&e.age+t>=e.life)&&this.emit(e,t)}},{key:"emit",value:function emit(e,i){if(this.subParticleSystem&&!(Math.random()>this.emitProbability)){var r=new t.Matrix4;this.setMatrixFromParticle(r,e),this.subEmissions.push({burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,matrix:r,travelDistance:0,particle:e})}}},{key:"frameUpdate",value:function frameUpdate(e){if(this.subParticleSystem)for(var t=0;t<this.subEmissions.length;t++)if(this.subEmissions[t].time>=this.subParticleSystem.system.duration)this.subEmissions[t]=this.subEmissions[this.subEmissions.length-1],this.subEmissions.length=this.subEmissions.length-1,t--;else{var i=this.subEmissions[t];i.particle&&i.particle.age<i.particle.life?this.setMatrixFromParticle(i.matrix,i.particle):i.particle=void 0,console.log(i),console.log(this.subParticleSystem.system.emissionOverDistance),this.subParticleSystem.system.emit(e,i,i.matrix)}}},{key:"toJSON",value:function toJSON(){return{type:this.type,subParticleSystem:this.subParticleSystem?this.subParticleSystem.uuid:"",useVelocityAsBasis:this.useVelocityAsBasis,mode:this.mode,emitProbability:this.emitProbability}}},{key:"clone",value:function clone(){return new EmitSubParticleSystem(this.particleSystem,this.useVelocityAsBasis,this.subParticleSystem,this.mode,this.emitProbability)}},{key:"reset",value:function reset(){}},{key:"setMatrixFromParticle",value:function setMatrixFromParticle(e,i){var r;if(void 0===i.rotation||this.useVelocityAsBasis)if(0!==i.velocity.x||0!==i.velocity.y||1!==i.velocity.z&&0!==i.velocity.z){this.v_.copy(q).cross(i.velocity),this.v2_.copy(i.velocity).cross(this.v_);var n=this.v_.length(),o=this.v2_.length();e.set(this.v_.x/n,this.v2_.x/o,i.velocity.x,i.position.x,this.v_.y/n,this.v2_.y/o,i.velocity.y,i.position.y,this.v_.z/n,this.v2_.z/o,i.velocity.z,i.position.z,0,0,0,1)}else e.set(1,0,0,i.position.x,0,1,0,i.position.y,0,0,1,i.position.z,0,0,0,1);else i.rotation instanceof t.Quaternion?r=i.rotation:(this.q_.setFromAxisAngle(q,i.rotation),r=this.q_),e.compose(i.position,r,D);this.particleSystem.worldSpace||e.multiplyMatrices(this.particleSystem.emitter.matrixWorld,e)}}],[{key:"fromJSON",value:function fromJSON(e,t){return new EmitSubParticleSystem(t,e.useVelocityAsBasis,e.subParticleSystem,e.mode,e.emitProbability)}}]),EmitSubParticleSystem}(),H=.5*(Math.sqrt(3)-1),W=(3-Math.sqrt(3))/6,Q=1/6,Y=(Math.sqrt(5)-1)/4,Z=(5-Math.sqrt(5))/20,K=new Float32Array([1,1,0,-1,1,0,1,-1,0,-1,-1,0,1,0,1,-1,0,1,1,0,-1,-1,0,-1,0,1,1,0,-1,1,0,1,-1,0,-1,-1]),$=new Float32Array([0,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,1,0,1,1,1,0,1,-1,1,0,-1,1,1,0,-1,-1,-1,0,1,1,-1,0,1,-1,-1,0,-1,1,-1,0,-1,-1,1,1,0,1,1,1,0,-1,1,-1,0,1,1,-1,0,-1,-1,1,0,1,-1,1,0,-1,-1,-1,0,1,-1,-1,0,-1,1,1,1,0,1,1,-1,0,1,-1,1,0,1,-1,-1,0,-1,1,1,0,-1,1,-1,0,-1,-1,1,0,-1,-1,-1,0]),ee=function(){function SimplexNoise(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:Math.random;_classCallCheck(this,SimplexNoise),_defineProperty(this,"p",void 0),_defineProperty(this,"perm",void 0),_defineProperty(this,"permMod12",void 0);var t="function"==typeof e?e:function alea(e){var t=0,i=0,r=0,n=1,o=function masher(){var e=4022871197;return function(t){t=t.toString();for(var i=0;i<t.length;i++){var r=.02519603282416938*(e+=t.charCodeAt(i));r-=e=r>>>0,e=(r*=e)>>>0,e+=4294967296*(r-=e)}return 2.3283064365386963e-10*(e>>>0)}}();return t=o(" "),i=o(" "),r=o(" "),(t-=o(e))<0&&(t+=1),(i-=o(e))<0&&(i+=1),(r-=o(e))<0&&(r+=1),function(){var e=2091639*t+2.3283064365386963e-10*n;return t=i,i=r,r=e-(n=0|e)}}(e);this.p=function buildPermutationTable(e){for(var t=new Uint8Array(256),i=0;i<256;i++)t[i]=i;for(var r=0;r<255;r++){var n=r+~~(e()*(256-r)),o=t[r];t[r]=t[n],t[n]=o}return t}(t),this.perm=new Uint8Array(512),this.permMod12=new Uint8Array(512);for(var i=0;i<512;i++)this.perm[i]=this.p[255&i],this.permMod12[i]=this.perm[i]%12}return _createClass(SimplexNoise,[{key:"noise2D",value:function noise2D(e,t){var i,r,n=this.permMod12,o=this.perm,a=0,s=0,l=0,u=(e+t)*H,c=Math.floor(e+u),d=Math.floor(t+u),h=(c+d)*W,f=e-(c-h),p=t-(d-h);f>p?(i=1,r=0):(i=0,r=1);var m=f-i+W,y=p-r+W,v=f-1+2*W,g=p-1+2*W,S=255&c,_=255&d,w=.5-f*f-p*p;if(w>=0){var O=3*n[S+o[_]];a=(w*=w)*w*(K[O]*f+K[O+1]*p)}var x=.5-m*m-y*y;if(x>=0){var b=3*n[S+i+o[_+r]];s=(x*=x)*x*(K[b]*m+K[b+1]*y)}var N=.5-v*v-g*g;if(N>=0){var P=3*n[S+1+o[_+1]];l=(N*=N)*N*(K[P]*v+K[P+1]*g)}return 70*(a+s+l)}},{key:"noise3D",value:function noise3D(e,t,i){var r,n,o,a,s,l,u,c,d,h,f=this.permMod12,p=this.perm,m=.3333333333333333*(e+t+i),y=Math.floor(e+m),v=Math.floor(t+m),g=Math.floor(i+m),S=(y+v+g)*Q,_=e-(y-S),w=t-(v-S),O=i-(g-S);_>=w?w>=O?(s=1,l=0,u=0,c=1,d=1,h=0):_>=O?(s=1,l=0,u=0,c=1,d=0,h=1):(s=0,l=0,u=1,c=1,d=0,h=1):w<O?(s=0,l=0,u=1,c=0,d=1,h=1):_<O?(s=0,l=1,u=0,c=0,d=1,h=1):(s=0,l=1,u=0,c=1,d=1,h=0);var x=_-s+Q,b=w-l+Q,N=O-u+Q,P=_-c+2*Q,k=w-d+2*Q,M=O-h+2*Q,C=_-1+.5,V=w-1+.5,B=O-1+.5,T=255&y,E=255&v,z=255&g,A=.6-_*_-w*w-O*O;if(A<0)r=0;else{var J=3*f[T+p[E+p[z]]];r=(A*=A)*A*(K[J]*_+K[J+1]*w+K[J+2]*O)}var L=.6-x*x-b*b-N*N;if(L<0)n=0;else{var U=3*f[T+s+p[E+l+p[z+u]]];n=(L*=L)*L*(K[U]*x+K[U+1]*b+K[U+2]*N)}var R=.6-P*P-k*k-M*M;if(R<0)o=0;else{var I=3*f[T+c+p[E+d+p[z+h]]];o=(R*=R)*R*(K[I]*P+K[I+1]*k+K[I+2]*M)}var G=.6-C*C-V*V-B*B;if(G<0)a=0;else{var D=3*f[T+1+p[E+1+p[z+1]]];a=(G*=G)*G*(K[D]*C+K[D+1]*V+K[D+2]*B)}return 32*(r+n+o+a)}},{key:"noise4D",value:function noise4D(e,t,i,r){var n,o,a,s,l,u=this.perm,c=(e+t+i+r)*Y,d=Math.floor(e+c),h=Math.floor(t+c),f=Math.floor(i+c),p=Math.floor(r+c),m=(d+h+f+p)*Z,y=e-(d-m),v=t-(h-m),g=i-(f-m),S=r-(p-m),_=0,w=0,O=0,x=0;y>v?_++:w++,y>g?_++:O++,y>S?_++:x++,v>g?w++:O++,v>S?w++:x++,g>S?O++:x++;var b=_>=3?1:0,N=w>=3?1:0,P=O>=3?1:0,k=x>=3?1:0,M=_>=2?1:0,C=w>=2?1:0,V=O>=2?1:0,B=x>=2?1:0,T=_>=1?1:0,E=w>=1?1:0,z=O>=1?1:0,A=x>=1?1:0,J=y-b+Z,L=v-N+Z,U=g-P+Z,R=S-k+Z,I=y-M+2*Z,G=v-C+2*Z,D=g-V+2*Z,q=S-B+2*Z,X=y-T+3*Z,j=v-E+3*Z,H=g-z+3*Z,W=S-A+3*Z,Q=y-1+4*Z,K=v-1+4*Z,ee=g-1+4*Z,te=S-1+4*Z,ie=255&d,re=255&h,ne=255&f,oe=255&p,ae=.6-y*y-v*v-g*g-S*S;if(ae<0)n=0;else{var se=u[ie+u[re+u[ne+u[oe]]]]%32*4;n=(ae*=ae)*ae*($[se]*y+$[se+1]*v+$[se+2]*g+$[se+3]*S)}var le=.6-J*J-L*L-U*U-R*R;if(le<0)o=0;else{var ue=u[ie+b+u[re+N+u[ne+P+u[oe+k]]]]%32*4;o=(le*=le)*le*($[ue]*J+$[ue+1]*L+$[ue+2]*U+$[ue+3]*R)}var ce=.6-I*I-G*G-D*D-q*q;if(ce<0)a=0;else{var de=u[ie+M+u[re+C+u[ne+V+u[oe+B]]]]%32*4;a=(ce*=ce)*ce*($[de]*I+$[de+1]*G+$[de+2]*D+$[de+3]*q)}var he=.6-X*X-j*j-H*H-W*W;if(he<0)s=0;else{var fe=u[ie+T+u[re+E+u[ne+z+u[oe+A]]]]%32*4;s=(he*=he)*he*($[fe]*X+$[fe+1]*j+$[fe+2]*H+$[fe+3]*W)}var pe=.6-Q*Q-K*K-ee*ee-te*te;if(pe<0)l=0;else{var me=u[ie+1+u[re+1+u[ne+1+u[oe+1]]]]%32*4;l=(pe*=pe)*pe*($[me]*Q+$[me+1]*K+$[me+2]*ee+$[me+3]*te)}return 27*(n+o+a+s+l)}}]),SimplexNoise}(),te=function(){function TurbulenceField(e,i,r,n){_classCallCheck(this,TurbulenceField),_defineProperty(this,"type","TurbulenceField"),_defineProperty(this,"generator",new ee),_defineProperty(this,"timeOffset",new t.Vector3),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"temp2",new t.Vector3),this.scale=e,this.octaves=i,this.velocityMultiplier=r,this.timeScale=n,this.timeOffset.x=Math.random()/this.scale.x*this.timeScale.x,this.timeOffset.y=Math.random()/this.scale.y*this.timeScale.y,this.timeOffset.z=Math.random()/this.scale.z*this.timeScale.z}return _createClass(TurbulenceField,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=e.position.x/this.scale.x,r=e.position.y/this.scale.y,n=e.position.z/this.scale.z;this.temp.set(0,0,0);for(var o=1,a=0;a<this.octaves;a++)this.temp2.set(this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.x*o)/o,this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.y*o)/o,this.generator.noise4D(i*o,r*o,n*o,this.timeOffset.z*o)/o),this.temp.add(this.temp2),o*=2;this.temp.multiply(this.velocityMultiplier),e.velocity.addScaledVector(this.temp,t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,scale:[this.scale.x,this.scale.y,this.scale.z],octaves:this.octaves,velocityMultiplier:[this.velocityMultiplier.x,this.velocityMultiplier.y,this.velocityMultiplier.z],timeScale:[this.timeScale.x,this.timeScale.y,this.timeScale.z]}}},{key:"frameUpdate",value:function frameUpdate(e){this.timeOffset.x+=e*this.timeScale.x,this.timeOffset.y+=e*this.timeScale.y,this.timeOffset.z+=e*this.timeScale.z}},{key:"clone",value:function clone(){return new TurbulenceField(this.scale.clone(),this.octaves,this.velocityMultiplier.clone(),this.timeScale.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new TurbulenceField(new t.Vector3(e.scale[0],e.scale[1],e.scale[2]),e.octaves,new t.Vector3(e.velocityMultiplier[0],e.velocityMultiplier[1],e.velocityMultiplier[2]),new t.Vector3(e.timeScale[0],e.timeScale[1],e.timeScale[2]))}}]),TurbulenceField}();function randomInt(e,t){return Math.floor(Math.random()*(t-e))+e}var ie=[],re=new t.Vector3,ne=new t.Quaternion,oe=function(){function Noise(e,t){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new O(1),r=arguments.length>3&&void 0!==arguments[3]?arguments[3]:new O(0);if(_classCallCheck(this,Noise),_defineProperty(this,"type","Noise"),_defineProperty(this,"duration",0),this.frequency=e,this.power=t,this.positionAmount=i,this.rotationAmount=r,0===ie.length)for(var n=0;n<100;n++)ie.push(new ee)}return _createClass(Noise,[{key:"initialize",value:function initialize(e){e.seed=10*Math.random(),e.lastPosNoise=new t.Vector3,"number"==typeof e.rotation?e.lastRotNoise=0:e.lastRotNoise=new t.Quaternion,e.generatorIndex=[randomInt(0,100),randomInt(0,100),randomInt(0,100),randomInt(0,100)]}},{key:"update",value:function update(e,t){var i=this.frequency.genValue(e.age/e.life),r=this.power.genValue(e.age/e.life),n=this.positionAmount.genValue(e.age/e.life),o=this.rotationAmount.genValue(e.age/e.life);n>0&&(e.position.sub(e.lastPosNoise),re.set(ie[e.generatorIndex[0]].noise2D(0,e.age*i)*r*n,ie[e.generatorIndex[1]].noise2D(0,e.age*i)*r*n,ie[e.generatorIndex[2]].noise2D(0,e.age*i)*r*n),e.position.add(re),e.lastPosNoise.copy(re)),o>0&&("number"==typeof e.rotation?(e.rotation-=e.lastRotNoise,e.rotation+=ie[e.generatorIndex[3]].noise2D(0,e.age*i)*Math.PI*r*o):(e.lastRotNoise.invert(),e.rotation.multiply(e.lastRotNoise),ne.set(ie[e.generatorIndex[0]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[1]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[2]].noise2D(0,e.age*i)*r*o,ie[e.generatorIndex[3]].noise2D(0,e.age*i)*r*o).normalize(),e.rotation.multiply(ne),e.lastRotNoise.copy(ne)))}},{key:"toJSON",value:function toJSON(){return{type:this.type,frequency:this.frequency.toJSON(),power:this.power.toJSON(),positionAmount:this.positionAmount.toJSON(),rotationAmount:this.rotationAmount.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){this.duration+=e}},{key:"clone",value:function clone(){return new Noise(this.frequency.clone(),this.power.clone(),this.positionAmount.clone(),this.rotationAmount.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new Noise(ValueGeneratorFromJSON(e.frequency),ValueGeneratorFromJSON(e.power),ValueGeneratorFromJSON(e.positionAmount),ValueGeneratorFromJSON(e.rotationAmount))}}]),Noise}(),ae=function(){function TextureSequencer(){var e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new t.Vector3;_classCallCheck(this,TextureSequencer),_defineProperty(this,"locations",[]),this.scaleX=e,this.scaleY=i,this.position=r}return _createClass(TextureSequencer,[{key:"transform",value:function transform(e,t){e.x=this.locations[t%this.locations.length].x*this.scaleX+this.position.x,e.y=this.locations[t%this.locations.length].y*this.scaleY+this.position.y,e.z=this.position.z}},{key:"clone",value:function clone(){var e=new TextureSequencer(this.scaleX,this.scaleY,this.position.clone());return e.locations=this.locations.map((function(e){return e.clone()})),e}},{key:"toJSON",value:function toJSON(){return{scaleX:this.scaleX,scaleY:this.scaleY,position:this.position,locations:this.locations.map((function(e){return{x:e.x,y:e.y}}))}}},{key:"fromImage",value:function fromImage(e,i){var r=document.createElement("canvas");r.width=e.width,r.height=e.height;var n=r.getContext("2d");if(n){n.drawImage(e,0,0);var o=n.getImageData(0,0,r.width,r.height,{colorSpace:"srgb"});r.remove(),this.locations.length=0;for(var a=0;a<o.height;a++)for(var s=0;s<o.width;s++)o.data[4*(a*o.width+s)+3]>i&&this.locations.push(new t.Vector2(s,o.height-a))}}}],[{key:"fromJSON",value:function fromJSON(e){var i=new TextureSequencer(e.scaleX,e.scaleY,new t.Vector3(e.position[0],e.position[1],e.position[2]));return i.locations=e.locations.map((function(e){return new t.Vector2(e.x,e.y)})),i}}]),TextureSequencer}();function SequencerFromJSON(e){return"TextureSequencer"===e.type?ae.fromJSON(e):new ae}var se,le=function(){function ApplySequences(e){_classCallCheck(this,ApplySequences),_defineProperty(this,"type","ApplySequences"),_defineProperty(this,"sequencers",[]),_defineProperty(this,"time",0),_defineProperty(this,"index",0),_defineProperty(this,"pCount",0),_defineProperty(this,"delay",void 0),_defineProperty(this,"tempV",new t.Vector3),this.delay=e}return _createClass(ApplySequences,[{key:"initialize",value:function initialize(e){e.id=this.pCount,e.dst=new t.Vector3,e.begin=new t.Vector3,e.inMotion=!1,this.pCount++}},{key:"reset",value:function reset(){this.time=0,this.index=0,this.pCount=0}},{key:"update",value:function update(e,t){var i=this.sequencers[this.index],r=e.id*this.delay;this.time>=i[0].a+r&&this.time<=i[0].b+r?(e.inMotion||(e.inMotion=!0,e.begin.copy(e.position),i[1].transform(e.dst,e.id)),e.position.lerpVectors(e.begin,e.dst,ApplySequences.BEZIER.genValue((this.time-i[0].a-r)/(i[0].b-i[0].a)))):this.time>i[0].b+r&&(e.inMotion=!1)}},{key:"frameUpdate",value:function frameUpdate(e){for(;this.index+1<this.sequencers.length&&this.time>=this.sequencers[this.index+1][0].a;)this.index++;this.time+=e}},{key:"appendSequencer",value:function appendSequencer(e,t){this.sequencers.push([e,t])}},{key:"toJSON",value:function toJSON(){return{type:this.type,delay:this.delay,sequencers:this.sequencers.map((function(e){var t=_slicedToArray(e,2),i=t[0],r=t[1];return{range:i.toJSON(),sequencer:r.toJSON()}}))}}},{key:"clone",value:function clone(){var e=new ApplySequences(this.delay);return e.sequencers=this.sequencers.map((function(e){return[e[0].clone(),e[1].clone()]})),e}}],[{key:"fromJSON",value:function fromJSON(e){var t=new ApplySequences(e.delay);return e.sequencers.forEach((function(e){t.sequencers.push([ValueGeneratorFromJSON(e.range),SequencerFromJSON(e.sequencer)])})),t}}]),ApplySequences}();function getPhysicsResolver(){return se}_defineProperty(le,"BEZIER",new u(0,0,1,1));var ue=function(){function ApplyCollision(e,i){_classCallCheck(this,ApplyCollision),_defineProperty(this,"type","ApplyCollision"),_defineProperty(this,"tempV",new t.Vector3),this.resolver=e,this.bounce=i}return _createClass(ApplyCollision,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){this.resolver.resolve(e.position,this.tempV)&&e.velocity.reflect(this.tempV).multiplyScalar(this.bounce)}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,bounce:this.bounce}}},{key:"clone",value:function clone(){return new ApplyCollision(this.resolver,this.bounce)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ApplyCollision(getPhysicsResolver(),e.bounce)}}]),ApplyCollision}(),ce=function(){function ColorBySpeed(e,t){_classCallCheck(this,ColorBySpeed),_defineProperty(this,"type","ColorBySpeed"),this.color=e,this.speedRange=t}return _createClass(ColorBySpeed,[{key:"initialize",value:function initialize(e){"memorizedFunction"===this.color.type&&(e.colorOverLifeMemory={},this.color.startGen(e.colorOverLifeMemory))}},{key:"update",value:function update(e,t){var i=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);"memorizedFunction"===this.color.type?this.color.genColor(e.color,i,e.colorOverLifeMemory):this.color.genColor(e.color,i),e.color.x*=e.startColor.x,e.color.y*=e.startColor.y,e.color.z*=e.startColor.z,e.color.w*=e.startColor.w}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"toJSON",value:function toJSON(){return{type:this.type,color:this.color.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"clone",value:function clone(){return new ColorBySpeed(this.color.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new ColorBySpeed(ColorGeneratorFromJSON(e.color),x.fromJSON(e.speedRange))}}]),ColorBySpeed}(),de=function(){function SizeBySpeed(e,t){_classCallCheck(this,SizeBySpeed),_defineProperty(this,"type","SizeBySpeed"),this.size=e,this.speedRange=t}return _createClass(SizeBySpeed,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e){var t=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.size=e.startSize*this.size.genValue(t)}},{key:"toJSON",value:function toJSON(){return{type:this.type,size:this.size.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new SizeBySpeed(this.size.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new SizeBySpeed(ValueGeneratorFromJSON(e.size),x.fromJSON(e.speedRange))}}]),SizeBySpeed}(),he=function(){function RotationBySpeed(e,i){_classCallCheck(this,RotationBySpeed),_defineProperty(this,"type","RotationBySpeed"),_defineProperty(this,"tempQuat",new t.Quaternion),this.angularVelocity=e,this.speedRange=i}return _createClass(RotationBySpeed,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=(e.startSpeed-this.speedRange.a)/(this.speedRange.b-this.speedRange.a);e.rotation+=t*this.angularVelocity.genValue(i)}},{key:"toJSON",value:function toJSON(){return{type:this.type,angularVelocity:this.angularVelocity.toJSON(),speedRange:this.speedRange.toJSON()}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new RotationBySpeed(this.angularVelocity.clone(),this.speedRange.clone())}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new RotationBySpeed(ValueGeneratorFromJSON(e.angularVelocity),x.fromJSON(e.speedRange))}}]),RotationBySpeed}(),fe=function(){function LimitSpeedOverLife(e,t){_classCallCheck(this,LimitSpeedOverLife),_defineProperty(this,"type","LimitSpeedOverLife"),this.speed=e,this.dampen=t}return _createClass(LimitSpeedOverLife,[{key:"initialize",value:function initialize(e){}},{key:"update",value:function update(e,t){var i=e.velocity.length(),r=this.speed.genValue(e.age/e.life);if(i>r){var n=(i-r)/i;e.velocity.multiplyScalar(1-n*this.dampen*t*20)}}},{key:"toJSON",value:function toJSON(){return{type:this.type,speed:this.speed.toJSON(),dampen:this.dampen}}},{key:"frameUpdate",value:function frameUpdate(e){}},{key:"clone",value:function clone(){return new LimitSpeedOverLife(this.speed.clone(),this.dampen)}},{key:"reset",value:function reset(){}}],[{key:"fromJSON",value:function fromJSON(e){return new LimitSpeedOverLife(ValueGeneratorFromJSON(e.speed),e.dampen)}}]),LimitSpeedOverLife}(),pe={ApplyForce:{type:"ApplyForce",constructor:R,params:[["direction","vec3"],["magnitude","value"]],loadJSON:R.fromJSON},Noise:{type:"Noise",constructor:oe,params:[["frequency","value"],["power","value"],["positionAmount","value"],["rotationAmount","value"]],loadJSON:oe.fromJSON},TurbulenceField:{type:"TurbulenceField",constructor:te,params:[["scale","vec3"],["octaves","number"],["velocityMultiplier","vec3"],["timeScale","vec3"]],loadJSON:te.fromJSON},GravityForce:{type:"GravityForce",constructor:I,params:[["center","vec3"],["magnitude","number"]],loadJSON:I.fromJSON},ColorOverLife:{type:"ColorOverLife",constructor:C,params:[["color","colorFunc"]],loadJSON:C.fromJSON},RotationOverLife:{type:"RotationOverLife",constructor:V,params:[["angularVelocity","valueFunc"],["dynamic","boolean"]],loadJSON:V.fromJSON},Rotation3DOverLife:{type:"Rotation3DOverLife",constructor:T,params:[["angularVelocity","rotationFunc"],["dynamic","boolean"]],loadJSON:T.fromJSON},SizeOverLife:{type:"SizeOverLife",constructor:z,params:[["size","valueFunc"]],loadJSON:z.fromJSON},ColorBySpeed:{type:"ColorBySpeed",constructor:ce,params:[["color","colorFunc"],["speedRange","range"]],loadJSON:ce.fromJSON},RotationBySpeed:{type:"RotationBySpeed",constructor:he,params:[["angularVelocity","valueFunc"],["speedRange","range"]],loadJSON:he.fromJSON},SizeBySpeed:{type:"SizeBySpeed",constructor:de,params:[["size","valueFunc"],["speedRange","range"]],loadJSON:de.fromJSON},SpeedOverLife:{type:"SpeedOverLife",constructor:A,params:[["speed","valueFunc"]],loadJSON:A.fromJSON},FrameOverLife:{type:"FrameOverLife",constructor:J,params:[["frame","valueFunc"]],loadJSON:J.fromJSON},ForceOverLife:{type:"ForceOverLife",constructor:E,params:[["x","valueFunc"],["y","valueFunc"],["z","valueFunc"]],loadJSON:E.fromJSON},OrbitOverLife:{type:"OrbitOverLife",constructor:L,params:[["orbitSpeed","valueFunc"],["axis","vec3"]],loadJSON:L.fromJSON},WidthOverLength:{type:"WidthOverLength",constructor:U,params:[["width","valueFunc"]],loadJSON:U.fromJSON},ChangeEmitDirection:{type:"ChangeEmitDirection",constructor:G,params:[["angle","value"]],loadJSON:G.fromJSON},EmitSubParticleSystem:{type:"EmitSubParticleSystem",constructor:j,params:[["particleSystem","self"],["useVelocityAsBasis","boolean"],["subParticleSystem","particleSystem"],["mode","number"],["emitProbability","number"]],loadJSON:j.fromJSON},LimitSpeedOverLife:{type:"LimitSpeedOverLife",constructor:fe,params:[["speed","valueFunc"],["dampen","number"]],loadJSON:fe.fromJSON}};function BehaviorFromJSON(e,t){return pe[e.type].loadJSON(e,t)}var me=function(){function ConeEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,ConeEmitter),_defineProperty(this,"type","cone"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),_defineProperty(this,"angle",void 0),this.radius=null!==(e=n.radius)&&void 0!==e?e:10,this.arc=null!==(t=n.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=n.thickness)&&void 0!==i?i:1,this.angle=null!==(r=n.angle)&&void 0!==r?r:Math.PI/6}return _createClass(ConeEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=t.MathUtils.lerp(1-this.thickness,1,Math.random()),n=i*this.arc,o=Math.sqrt(r),a=Math.sin(n),s=Math.cos(n);e.position.x=o*s,e.position.y=o*a,e.position.z=0;var l=this.angle*o;e.velocity.set(0,0,Math.cos(l)).addScaledVector(e.position,Math.sin(l)).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius)}},{key:"toJSON",value:function toJSON(){return{type:"cone",radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle}}},{key:"clone",value:function clone(){return new ConeEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness,angle:this.angle})}}],[{key:"fromJSON",value:function fromJSON(e){return new ConeEmitter(e)}}]),ConeEmitter}(),ye=function(){function CircleEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,CircleEmitter),_defineProperty(this,"type","circle"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(CircleEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=t.MathUtils.lerp(1-this.thickness,1,Math.random()),n=i*this.arc;e.position.x=Math.cos(n),e.position.y=Math.sin(n),e.position.z=0,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*r)}},{key:"toJSON",value:function toJSON(){return{type:"circle",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new CircleEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new CircleEmitter(e)}}]),CircleEmitter}(),ve=function(){function DonutEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,DonutEmitter),_defineProperty(this,"type","donut"),_defineProperty(this,"radius",void 0),_defineProperty(this,"donutRadius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=n.radius)&&void 0!==e?e:10,this.arc=null!==(t=n.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=n.thickness)&&void 0!==i?i:1,this.donutRadius=null!==(r=n.donutRadius)&&void 0!==r?r:.2*this.radius}return _createClass(DonutEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=r*Math.PI*2,s=Math.sin(o),l=Math.cos(o);e.position.x=this.radius*l,e.position.y=this.radius*s,e.position.z=0,e.velocity.z=this.donutRadius*n*Math.sin(a),e.velocity.x=this.donutRadius*n*Math.cos(a)*l,e.velocity.y=this.donutRadius*n*Math.cos(a)*s,e.position.add(e.velocity),e.velocity.normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"donut",radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius}}},{key:"clone",value:function clone(){return new DonutEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness,donutRadius:this.donutRadius})}}],[{key:"fromJSON",value:function fromJSON(e){return new DonutEmitter(e)}}]),DonutEmitter}(),ge=function(){function PointEmitter(){_classCallCheck(this,PointEmitter),_defineProperty(this,"type","point")}return _createClass(PointEmitter,[{key:"initialize",value:function initialize(e){var t=Math.random(),i=Math.random(),r=t*Math.PI*2,n=Math.acos(2*i-1),o=Math.cbrt(Math.random()),a=Math.sin(r),s=Math.cos(r),l=Math.sin(n),u=Math.cos(n);e.velocity.x=o*l*s,e.velocity.y=o*l*a,e.velocity.z=o*u,e.velocity.multiplyScalar(e.startSpeed),e.position.setScalar(0)}},{key:"toJSON",value:function toJSON(){return{type:"point"}}},{key:"clone",value:function clone(){return new PointEmitter}}],[{key:"fromJSON",value:function fromJSON(e){return new PointEmitter}}]),PointEmitter}(),Se=function(){function SphereEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,SphereEmitter),_defineProperty(this,"type","sphere"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(SphereEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=Math.acos(2*r-1),s=Math.sin(o),l=Math.cos(o),u=Math.sin(a),c=Math.cos(a);e.position.x=u*l,e.position.y=u*s,e.position.z=c,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*n)}},{key:"toJSON",value:function toJSON(){return{type:"sphere",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new SphereEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new SphereEmitter(e)}}]),SphereEmitter}(),_e=function(){function HemisphereEmitter(){var e,t,i,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,HemisphereEmitter),_defineProperty(this,"type","sphere"),_defineProperty(this,"radius",void 0),_defineProperty(this,"arc",void 0),_defineProperty(this,"thickness",void 0),this.radius=null!==(e=r.radius)&&void 0!==e?e:10,this.arc=null!==(t=r.arc)&&void 0!==t?t:2*Math.PI,this.thickness=null!==(i=r.thickness)&&void 0!==i?i:1}return _createClass(HemisphereEmitter,[{key:"initialize",value:function initialize(e){var i=Math.random(),r=Math.random(),n=t.MathUtils.lerp(1-this.thickness,1,Math.random()),o=i*this.arc,a=Math.acos(r),s=Math.sin(o),l=Math.cos(o),u=Math.sin(a),c=Math.cos(a);e.position.x=u*l,e.position.y=u*s,e.position.z=c,e.velocity.copy(e.position).multiplyScalar(e.startSpeed),e.position.multiplyScalar(this.radius*n)}},{key:"toJSON",value:function toJSON(){return{type:"hemisphere",radius:this.radius,arc:this.arc,thickness:this.thickness}}},{key:"clone",value:function clone(){return new HemisphereEmitter({radius:this.radius,arc:this.arc,thickness:this.thickness})}}],[{key:"fromJSON",value:function fromJSON(e){return new HemisphereEmitter(e)}}]),HemisphereEmitter}(),we=function(){function GridEmitter(){var e,t,i,r,n=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};_classCallCheck(this,GridEmitter),_defineProperty(this,"type","grid"),_defineProperty(this,"width",void 0),_defineProperty(this,"height",void 0),_defineProperty(this,"column",void 0),_defineProperty(this,"row",void 0),this.width=null!==(e=n.width)&&void 0!==e?e:1,this.height=null!==(t=n.height)&&void 0!==t?t:1,this.column=null!==(i=n.column)&&void 0!==i?i:10,this.row=null!==(r=n.row)&&void 0!==r?r:10}return _createClass(GridEmitter,[{key:"initialize",value:function initialize(e){var t=Math.floor(Math.random()*this.row),i=Math.floor(Math.random()*this.column);e.position.x=i*this.width/this.column-this.width/2,e.position.y=t*this.height/this.row-this.height/2,e.position.z=0,e.velocity.set(0,0,e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"grid",width:this.width,height:this.height,column:this.column,row:this.row}}},{key:"clone",value:function clone(){return new GridEmitter({width:this.width,height:this.height,column:this.column,row:this.row})}}],[{key:"fromJSON",value:function fromJSON(e){return new GridEmitter(e)}}]),GridEmitter}(),Oe=function(){function MeshSurfaceEmitter(e){_classCallCheck(this,MeshSurfaceEmitter),_defineProperty(this,"type","mesh_surface"),_defineProperty(this,"_triangleIndexToArea",[]),_defineProperty(this,"_geometry",void 0),_defineProperty(this,"_tempA",new t.Vector3),_defineProperty(this,"_tempB",new t.Vector3),_defineProperty(this,"_tempC",new t.Vector3),e&&(this.geometry=e)}return _createClass(MeshSurfaceEmitter,[{key:"geometry",get:function get(){return this._geometry},set:function set(e){if(this._geometry=e,void 0!==e&&"string"!=typeof e){var i=new t.Triangle;this._triangleIndexToArea.length=0;var r=0;if(e.getIndex()){var n=e.getIndex().array,o=n.length/3;this._triangleIndexToArea.push(0);for(var a=0;a<o;a++)i.setFromAttributeAndIndices(e.getAttribute("position"),n[3*a],n[3*a+1],n[3*a+2]),r+=i.getArea(),this._triangleIndexToArea.push(r);e.userData.triangleIndexToArea=this._triangleIndexToArea}}}},{key:"initialize",value:function initialize(e){var t=this._geometry;if(!t||null===t.getIndex())return e.position.set(0,0,0),void e.velocity.set(0,0,1).multiplyScalar(e.startSpeed);for(var i=this._triangleIndexToArea.length-1,r=0,n=i,o=Math.random()*this._triangleIndexToArea[i];r+1<n;){var a=Math.floor((r+n)/2);o<this._triangleIndexToArea[a]?n=a:r=a}var s=Math.random(),l=Math.random();s+l>1&&(s=1-s,l=1-l);var u=t.getIndex().array[3*r],c=t.getIndex().array[3*r+1],d=t.getIndex().array[3*r+2],h=t.getAttribute("position");this._tempA.fromBufferAttribute(h,u),this._tempB.fromBufferAttribute(h,c),this._tempC.fromBufferAttribute(h,d),this._tempB.sub(this._tempA),this._tempC.sub(this._tempA),this._tempA.addScaledVector(this._tempB,s).addScaledVector(this._tempC,l),e.position.copy(this._tempA),this._tempA.copy(this._tempB).cross(this._tempC).normalize(),e.velocity.copy(this._tempA).normalize().multiplyScalar(e.startSpeed)}},{key:"toJSON",value:function toJSON(){return{type:"mesh_surface",mesh:this._geometry?this._geometry.uuid:""}}},{key:"clone",value:function clone(){return new MeshSurfaceEmitter(this._geometry)}}],[{key:"fromJSON",value:function fromJSON(e,t){return new MeshSurfaceEmitter(t.geometries[e.geometry])}}]),MeshSurfaceEmitter}(),xe={circle:{type:"circle",params:[["radius","number"],["arc","radian"],["thickness","number"]],constructor:ye,loadJSON:ye.fromJSON},cone:{type:"cone",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:me,loadJSON:me.fromJSON},donut:{type:"donut",params:[["radius","number"],["arc","radian"],["thickness","number"],["donutRadius","number"]],constructor:ve,loadJSON:ve.fromJSON},point:{type:"point",params:[],constructor:ge,loadJSON:ge.fromJSON},sphere:{type:"sphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:Se,loadJSON:Se.fromJSON},hemisphere:{type:"hemisphere",params:[["radius","number"],["arc","radian"],["thickness","number"],["angle","radian"]],constructor:_e,loadJSON:_e.fromJSON},grid:{type:"grid",params:[["width","number"],["height","number"],["rows","number"],["column","number"]],constructor:we,loadJSON:we.fromJSON},mesh_surface:{type:"mesh_surface",params:[["geometry","geometry"]],constructor:Oe,loadJSON:Oe.fromJSON}};function EmitterFromJSON(e,t){return xe[e.type].loadJSON(e,t)}var be=function(e){return e[e.BillBoard=0]="BillBoard",e[e.StretchedBillBoard=1]="StretchedBillBoard",e[e.Mesh=2]="Mesh",e[e.Trail=3]="Trail",e[e.HorizontalBillBoard=4]="HorizontalBillBoard",e[e.VerticalBillBoard=5]="VerticalBillBoard",e}({}),Ne=function(e){_inherits(VFXBatch,e);var i=_createSuper(VFXBatch);function VFXBatch(e){var r;_classCallCheck(this,VFXBatch),_defineProperty(_assertThisInitialized(r=i.call(this)),"type","VFXBatch"),_defineProperty(_assertThisInitialized(r),"systems",void 0),_defineProperty(_assertThisInitialized(r),"settings",void 0),_defineProperty(_assertThisInitialized(r),"maxParticles",void 0),r.maxParticles=1e3,r.systems=new Set;var n=new t.Layers;n.mask=e.layers.mask;var o=e.material.clone();return o.defines={},Object.assign(o.defines,e.material.defines),r.settings={instancingGeometry:e.instancingGeometry,renderMode:e.renderMode,renderOrder:e.renderOrder,material:o,uTileCount:e.uTileCount,vTileCount:e.vTileCount,layers:n},r.frustumCulled=!1,r.renderOrder=r.settings.renderOrder,r}return _createClass(VFXBatch,[{key:"addSystem",value:function addSystem(e){this.systems.add(e)}},{key:"removeSystem",value:function removeSystem(e){this.systems.delete(e)}}]),VFXBatch}(t.Mesh),Pe=new t.Vector3(0,0,1),ke=new t.Quaternion,Me=new t.Vector3,Ce=new t.Vector3;new t.Vector3;var Ve=new t.PlaneGeometry(1,1,1,1),Be=function(){function ParticleSystem(e){var r,n,o,a,s,l,u,c,d,h,f,p,m,y,v,g,S,_,x,b;if(_classCallCheck(this,ParticleSystem),_defineProperty(this,"autoDestroy",void 0),_defineProperty(this,"prewarm",void 0),_defineProperty(this,"looping",void 0),_defineProperty(this,"duration",void 0),_defineProperty(this,"startLife",void 0),_defineProperty(this,"startSpeed",void 0),_defineProperty(this,"startRotation",void 0),_defineProperty(this,"startSize",void 0),_defineProperty(this,"startColor",void 0),_defineProperty(this,"startTileIndex",void 0),_defineProperty(this,"rendererEmitterSettings",void 0),_defineProperty(this,"emissionOverTime",void 0),_defineProperty(this,"emissionOverDistance",void 0),_defineProperty(this,"emissionBursts",void 0),_defineProperty(this,"onlyUsedByOther",void 0),_defineProperty(this,"worldSpace",void 0),_defineProperty(this,"particleNum",void 0),_defineProperty(this,"paused",void 0),_defineProperty(this,"particles",void 0),_defineProperty(this,"emitterShape",void 0),_defineProperty(this,"emitter",void 0),_defineProperty(this,"rendererSettings",void 0),_defineProperty(this,"neededToUpdateRender",void 0),_defineProperty(this,"behaviors",void 0),_defineProperty(this,"prewarmed",void 0),_defineProperty(this,"emissionState",void 0),_defineProperty(this,"emitEnded",void 0),_defineProperty(this,"markForDestroy",void 0),_defineProperty(this,"previousWorldPos",void 0),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"travelDistance",0),_defineProperty(this,"normalMatrix",new t.Matrix3),_defineProperty(this,"_renderer",void 0),this.autoDestroy=void 0!==e.autoDestroy&&e.autoDestroy,this.duration=null!==(r=e.duration)&&void 0!==r?r:1,this.looping=void 0===e.looping||e.looping,this.prewarm=void 0!==e.prewarm&&e.prewarm,this.startLife=null!==(n=e.startLife)&&void 0!==n?n:new O(5),this.startSpeed=null!==(o=e.startSpeed)&&void 0!==o?o:new O(0),this.startRotation=null!==(a=e.startRotation)&&void 0!==a?a:new O(0),this.startSize=null!==(s=e.startSize)&&void 0!==s?s:new O(1),this.startColor=null!==(l=e.startColor)&&void 0!==l?l:new w(new t.Vector4(1,1,1,1)),this.emissionOverTime=null!==(u=e.emissionOverTime)&&void 0!==u?u:new O(10),this.emissionOverDistance=null!==(c=e.emissionOverDistance)&&void 0!==c?c:new O(0),this.emissionBursts=null!==(d=e.emissionBursts)&&void 0!==d?d:[],this.onlyUsedByOther=null!==(h=e.onlyUsedByOther)&&void 0!==h&&h,this.emitterShape=null!==(f=e.shape)&&void 0!==f?f:new Se,this.behaviors=null!==(p=e.behaviors)&&void 0!==p?p:new Array,this.worldSpace=null!==(m=e.worldSpace)&&void 0!==m&&m,this.rendererEmitterSettings=null!==(y=e.rendererEmitterSettings)&&void 0!==y?y:{},e.renderMode===be.StretchedBillBoard){var N,P,k=this.rendererEmitterSettings;void 0!==e.speedFactor&&(k.speedFactor=e.speedFactor),k.speedFactor=null!==(N=k.speedFactor)&&void 0!==N?N:0,k.lengthFactor=null!==(P=k.lengthFactor)&&void 0!==P?P:0}this.rendererSettings={instancingGeometry:null!==(v=e.instancingGeometry)&&void 0!==v?v:Ve,renderMode:null!==(g=e.renderMode)&&void 0!==g?g:be.BillBoard,renderOrder:null!==(S=e.renderOrder)&&void 0!==S?S:0,material:e.material,uTileCount:null!==(_=e.uTileCount)&&void 0!==_?_:1,vTileCount:null!==(x=e.vTileCount)&&void 0!==x?x:1,layers:null!==(b=e.layers)&&void 0!==b?b:new t.Layers},this.neededToUpdateRender=!0,this.particles=new Array,this.startTileIndex=e.startTileIndex||new O(0),this.emitter=new i(this),this.paused=!1,this.particleNum=0,this.emissionState={burstIndex:0,burstWaveIndex:0,time:0,waitEmiting:0,travelDistance:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return _createClass(ParticleSystem,[{key:"time",get:function get(){return this.emissionState.time},set:function set(e){this.emissionState.time=e}},{key:"layers",get:function get(){return this.rendererSettings.layers}},{key:"texture",get:function get(){return this.rendererSettings.material.map},set:function set(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function get(){return this.rendererSettings.material},set:function set(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"uTileCount",get:function get(){return this.rendererSettings.uTileCount},set:function set(e){this.rendererSettings.uTileCount=e,this.neededToUpdateRender=!0}},{key:"vTileCount",get:function get(){return this.rendererSettings.vTileCount},set:function set(e){this.rendererSettings.vTileCount=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function get(){return this.rendererSettings.instancingGeometry},set:function set(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function get(){return this.rendererSettings.renderMode},set:function set(e){if((this.rendererSettings.renderMode!=be.Trail&&e===be.Trail||this.rendererSettings.renderMode==be.Trail&&e!==be.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==e)switch(e){case be.Trail:this.rendererEmitterSettings={startLength:new O(30),followLocalOrigin:!1};break;case be.Mesh:this.rendererEmitterSettings={geometry:new t.PlaneGeometry(1,1)},this.startRotation=new k(new t.Vector3(0,1,0),new O(0));break;case be.StretchedBillBoard:this.rendererEmitterSettings={speedFactor:0,lengthFactor:2},this.rendererSettings.renderMode===be.Mesh&&(this.startRotation=new O(0));break;case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:this.rendererEmitterSettings={},this.rendererSettings.renderMode===be.Mesh&&(this.startRotation=new O(0))}this.rendererSettings.renderMode=e,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function get(){return this.rendererSettings.renderOrder},set:function set(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function get(){return this.rendererSettings.material.blending},set:function set(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function pause(){this.paused=!0}},{key:"play",value:function play(){this.paused=!1}},{key:"spawn",value:function spawn(e,i,r){ke.setFromRotationMatrix(r);var n=Me,o=ke,s=Ce;r.decompose(n,o,s);for(var u=0;u<e;u++){for(this.particleNum++;this.particles.length<this.particleNum;)this.rendererSettings.renderMode===be.Trail?this.particles.push(new l):this.particles.push(new a);var c=this.particles[this.particleNum-1];if(this.startColor.genColor(c.startColor,this.emissionState.time,{}),c.color.copy(c.startColor),c.startSpeed=this.startSpeed.genValue(i.time/this.duration),c.life=this.startLife.genValue(i.time/this.duration),c.age=0,c.startSize=this.startSize.genValue(i.time/this.duration),c.uvTile=Math.floor(this.startTileIndex.genValue()),c.size=c.startSize,this.rendererSettings.renderMode===be.Mesh||this.rendererSettings.renderMode===be.BillBoard||this.rendererSettings.renderMode===be.VerticalBillBoard||this.rendererSettings.renderMode===be.HorizontalBillBoard||this.rendererSettings.renderMode===be.StretchedBillBoard){var d=c;this.rendererSettings.renderMode===be.Mesh?(d.rotation instanceof t.Quaternion||(d.rotation=new t.Quaternion),"rotation"===this.startRotation.type?this.startRotation.genValue(d.rotation,i.time/this.duration):d.rotation.setFromAxisAngle(Pe,this.startRotation.genValue(i.time/this.duration))):"rotation"===this.startRotation.type?d.rotation=0:d.rotation=this.startRotation.genValue(i.time/this.duration)}else if(this.rendererSettings.renderMode===be.Trail){var h=c;h.length=this.rendererEmitterSettings.startLength.genValue(i.time/this.duration),h.reset()}if(this.emitterShape.initialize(c),this.rendererSettings.renderMode===be.Trail&&this.rendererEmitterSettings.followLocalOrigin){var f=c;f.localPosition=(new t.Vector3).copy(f.position)}this.worldSpace?(c.position.applyMatrix4(r),c.startSize=c.startSize*(Math.abs(s.x)+Math.abs(s.y)+Math.abs(s.z))/3,c.size=c.startSize,c.velocity.multiply(s).applyMatrix3(this.normalMatrix),c.rotation&&c.rotation instanceof t.Quaternion&&c.rotation.multiplyQuaternions(ke,c.rotation)):this.onlyUsedByOther&&(c.parentMatrix=r);for(var p=0;p<this.behaviors.length;p++)this.behaviors[p].initialize(c)}}},{key:"endEmit",value:function endEmit(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function dispose(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function restart(){this.paused=!1,this.particleNum=0,this.emissionState.burstIndex=0,this.emissionState.burstWaveIndex=0,this.emissionState.time=0,this.emissionState.waitEmiting=0,this.behaviors.forEach((function(e){e.reset()})),this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function update(e){if(!this.paused){for(var t=this.emitter;t.parent;)t=t.parent;if("Scene"===t.type)if(this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var i=0;i<60*this.duration;i++)this.update(1/60)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.onlyUsedByOther||this.emit(e,this.emissionState,this.emitter.matrixWorld);for(var r=0;r<this.behaviors.length;r++){for(var n=0;n<this.particleNum;n++)this.particles[n].died||this.behaviors[r].update(this.particles[n],e);this.behaviors[r].frameUpdate(e)}for(var o=0;o<this.particleNum;o++){if(this.rendererEmitterSettings.followLocalOrigin&&this.particles[o].localPosition)this.particles[o].position.copy(this.particles[o].localPosition),this.particles[o].parentMatrix?this.particles[o].position.applyMatrix4(this.particles[o].parentMatrix):this.particles[o].position.applyMatrix4(this.emitter.matrixWorld);else{var a,s=null!==(a=this.particles[o].speedModifier)&&void 0!==a?a:1;this.particles[o].position.addScaledVector(this.particles[o].velocity,e*s)}this.particles[o].age+=e}if(this.rendererSettings.renderMode===be.Trail)for(var u=0;u<this.particleNum;u++)this.particles[u].update();for(var c=0;c<this.particleNum;c++){var d=this.particles[c];!d.died||d instanceof l&&0!==d.previous.length||(this.particles[c]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=d,this.particleNum--,c--)}}else this.dispose()}}},{key:"emit",value:function emit(e,i,r){i.time>this.duration&&(this.looping?(i.time-=this.duration,i.burstIndex=0,this.behaviors.forEach((function(e){e.reset()}))):this.emitEnded||this.onlyUsedByOther||this.endEmit()),this.normalMatrix.getNormalMatrix(r);var n=Math.ceil(i.waitEmiting);for(this.spawn(n,i,r),i.waitEmiting-=n;i.burstIndex<this.emissionBursts.length&&this.emissionBursts[i.burstIndex].time<=i.time;){if(Math.random()<this.emissionBursts[i.burstIndex].probability){var o=this.emissionBursts[i.burstIndex].count.genValue(this.time);this.spawn(o,i,r)}i.burstIndex++}if(!this.emitEnded&&(i.waitEmiting+=e*this.emissionOverTime.genValue(i.time/this.duration),null!=i.previousWorldPos)){this.temp.set(r.elements[12],r.elements[13],r.elements[14]),i.travelDistance+=i.previousWorldPos.distanceTo(this.temp);var a=this.emissionOverDistance.genValue(i.time/this.duration);if(i.travelDistance*a>0){var s=Math.floor(i.travelDistance*a);i.travelDistance-=s/a,i.waitEmiting+=s}}void 0===i.previousWorldPos&&(i.previousWorldPos=new t.Vector3),i.previousWorldPos.set(r.elements[12],r.elements[13],r.elements[14]),i.time+=e}},{key:"toJSON",value:function toJSON(e){var t,i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if((void 0===e||"string"==typeof e)&&(e={geometries:{},materials:{},textures:{},images:{},shapes:{},skeletons:{},animations:{},nodes:{}}),e.materials[this.rendererSettings.material.uuid]=this.rendererSettings.material.toJSON(e),i.useUrlForImage&&void 0!==this.texture.source){var r=this.texture.source;e.images[r.uuid]={uuid:r.uuid,url:this.texture.image.url}}t=this.renderMode===be.Trail?{startLength:this.rendererEmitterSettings.startLength.toJSON(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:this.renderMode===be.Mesh?{}:this.renderMode===be.StretchedBillBoard?{speedFactor:this.rendererEmitterSettings.speedFactor,lengthFactor:this.rendererEmitterSettings.lengthFactor}:{};var n=this.rendererSettings.instancingGeometry;return e.geometries&&!e.geometries[n.uuid]&&(e.geometries[n.uuid]=n.toJSON()),{version:"2.0",autoDestroy:this.autoDestroy,looping:this.looping,prewarm:this.prewarm,duration:this.duration,shape:this.emitterShape.toJSON(),startLife:this.startLife.toJSON(),startSpeed:this.startSpeed.toJSON(),startRotation:this.startRotation.toJSON(),startSize:this.startSize.toJSON(),startColor:this.startColor.toJSON(),emissionOverTime:this.emissionOverTime.toJSON(),emissionOverDistance:this.emissionOverDistance.toJSON(),emissionBursts:this.emissionBursts.map((function(e){return{time:e.time,count:e.count.toJSON(),probability:e.probability,interval:e.interval,cycle:e.cycle}})),onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry.uuid,renderOrder:this.renderOrder,renderMode:this.renderMode,rendererEmitterSettings:t,material:this.rendererSettings.material.uuid,layers:this.layers.mask,startTileIndex:this.startTileIndex.toJSON(),uTileCount:this.uTileCount,vTileCount:this.vTileCount,behaviors:this.behaviors.map((function(e){return e.toJSON()})),worldSpace:this.worldSpace}}},{key:"addBehavior",value:function addBehavior(e){this.behaviors.push(e)}},{key:"getRendererSettings",value:function getRendererSettings(){return this.rendererSettings}},{key:"clone",value:function clone(){var e,i=[],r=_createForOfIteratorHelper(this.emissionBursts);try{for(r.s();!(e=r.n()).done;){var n=e.value,o={};Object.assign(o,n),i.push(o)}}catch(e){r.e(e)}finally{r.f()}var a,s,l=[],u=_createForOfIteratorHelper(this.behaviors);try{for(u.s();!(a=u.n()).done;){var c=a.value;l.push(c.clone())}}catch(e){u.e(e)}finally{u.f()}s=this.renderMode===be.Trail?{startLength:this.rendererEmitterSettings.startLength.clone(),followLocalOrigin:this.rendererEmitterSettings.followLocalOrigin}:{};var d=new t.Layers;return d.mask=this.layers.mask,new ParticleSystem({autoDestroy:this.autoDestroy,looping:this.looping,duration:this.duration,shape:this.emitterShape.clone(),startLife:this.startLife.clone(),startSpeed:this.startSpeed.clone(),startRotation:this.startRotation.clone(),startSize:this.startSize.clone(),startColor:this.startColor.clone(),emissionOverTime:this.emissionOverTime.clone(),emissionOverDistance:this.emissionOverDistance.clone(),emissionBursts:i,onlyUsedByOther:this.onlyUsedByOther,instancingGeometry:this.rendererSettings.instancingGeometry,renderMode:this.renderMode,renderOrder:this.renderOrder,rendererEmitterSettings:s,material:this.rendererSettings.material,startTileIndex:this.startTileIndex,uTileCount:this.uTileCount,vTileCount:this.vTileCount,behaviors:l,worldSpace:this.worldSpace,layers:d})}}],[{key:"fromJSON",value:function fromJSON(e,i,r){var n,o,a,s=EmitterFromJSON(e.shape,i);if(e.renderMode===be.Trail){var l=e.rendererEmitterSettings;a={startLength:null!=l.startLength?ValueGeneratorFromJSON(l.startLength):new O(30),followLocalOrigin:l.followLocalOrigin}}else e.renderMode===be.Mesh?a={}:e.renderMode===be.StretchedBillBoard?(a=e.rendererEmitterSettings,null!=e.speedFactor&&(a.speedFactor=e.speedFactor)):a={};var u=new t.Layers;e.layers&&(u.mask=e.layers);var c=new ParticleSystem({autoDestroy:e.autoDestroy,looping:e.looping,prewarm:e.prewarm,duration:e.duration,shape:s,startLife:ValueGeneratorFromJSON(e.startLife),startSpeed:ValueGeneratorFromJSON(e.startSpeed),startRotation:GeneratorFromJSON(e.startRotation),startSize:ValueGeneratorFromJSON(e.startSize),startColor:ColorGeneratorFromJSON(e.startColor),emissionOverTime:ValueGeneratorFromJSON(e.emissionOverTime),emissionOverDistance:ValueGeneratorFromJSON(e.emissionOverDistance),emissionBursts:null===(n=e.emissionBursts)||void 0===n?void 0:n.map((function(e){return{time:e.time,count:"number"==typeof e.count?new O(e.count):ValueGeneratorFromJSON(e.count),probability:e.probability,interval:e.interval,cycle:e.cycle}})),onlyUsedByOther:e.onlyUsedByOther,instancingGeometry:i.geometries[e.instancingGeometry],renderMode:e.renderMode,rendererEmitterSettings:a,renderOrder:e.renderOrder,layers:u,material:e.material?i.materials[e.material]:e.texture?new t.MeshBasicMaterial({map:i.textures[e.texture],transparent:null===(o=e.transparent)||void 0===o||o,blending:e.blending,side:t.DoubleSide}):new t.MeshBasicMaterial({color:16777215,transparent:!0,blending:t.AdditiveBlending,side:t.DoubleSide}),startTileIndex:"number"==typeof e.startTileIndex?new O(e.startTileIndex):ValueGeneratorFromJSON(e.startTileIndex),uTileCount:e.uTileCount,vTileCount:e.vTileCount,behaviors:[],worldSpace:e.worldSpace});return c.behaviors=e.behaviors.map((function(e){var t=BehaviorFromJSON(e,c);return"EmitSubParticleSystem"===t.type&&(r[e.subParticleSystem]=t),t})),c}}]),ParticleSystem}(),Te="\n\n#include <common>\n#include <uv_pars_fragment>\n#include <color_pars_fragment>\n#include <map_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n#include <alphatest_pars_fragment>\n\nvoid main() {\n\n    #include <clipping_planes_fragment>\n    \n    vec3 outgoingLight = vec3( 0.0 );\n    vec4 diffuseColor = vColor;\n    \n    #include <logdepthbuf_fragment>\n    \n    #ifdef USE_MAP\n    diffuseColor *= texture2D( map, vMapUv);\n    #endif\n    \n    #include <alphatest_fragment>\n\n    outgoingLight = diffuseColor.rgb;\n    \n    #ifdef USE_COLOR_AS_ALPHA\n    gl_FragColor = vec4( outgoingLight, diffuseColor.r );\n    #else\n    gl_FragColor = vec4( outgoingLight, diffuseColor.a );\n    #endif\n    \n    \n    #include <tonemapping_fragment>\n\n}\n",Ee="\n\n    #ifdef UV_TILE\n        float col = mod(uvTile, tileCount.x);\n        float row = (tileCount.y - floor(uvTile / tileCount.x) - 1.0);\n        \n        mat3 tileTransform = mat3(\n          1.0 / tileCount.x, 0.0, 0.0,\n          0.0, 1.0 / tileCount.y, 0.0, \n          col / tileCount.x, row / tileCount.y, 1.0);\n    #else\n        mat3 tileTransform = mat3(1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0);\n    #endif\n\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\nvUv = (tileTransform *vec3( uv, 1 )).xy;\n\n#endif\n#ifdef USE_MAP\n\nvMapUv = ( tileTransform * (mapTransform * vec3( MAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ALPHAMAP\n\nvAlphaMapUv = ( tileTransform * (alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_LIGHTMAP\n\nvLightMapUv = ( tileTransform * (lightMapTransform * vec3( LIGHTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_AOMAP\n\nvAoMapUv = ( tileTransform * (aoMapTransform * vec3( AOMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_BUMPMAP\n\nvBumpMapUv = ( tileTransform * (bumpMapTransform * vec3( BUMPMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_NORMALMAP\n\nvNormalMapUv = ( tileTransform * (normalMapTransform * vec3( NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\nvDisplacementMapUv = ( tileTransform * (displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\nvEmissiveMapUv = ( tileTransform * (emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_METALNESSMAP\n\nvMetalnessMapUv = ( tileTransform * (metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\nvRoughnessMapUv = ( tileTransform * (roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\nvAnisotropyMapUv = ( tileTransform * (anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\nvClearcoatMapUv = ( tileTransform * (clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\nvClearcoatNormalMapUv = ( tileTransform * (clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\nvClearcoatRoughnessMapUv = ( tileTransform * (clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\nvIridescenceMapUv = ( tileTransform * (iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\nvIridescenceThicknessMapUv = ( tileTransform * (iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\nvSheenColorMapUv = ( tileTransform * (sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\nvSheenRoughnessMapUv = ( tileTransform * (sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULARMAP\n\nvSpecularMapUv = ( tileTransform * (specularMapTransform * vec3( SPECULARMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\nvSpecularColorMapUv = ( tileTransform * (specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\nvSpecularIntensityMapUv = ( tileTransform * (specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\nvTransmissionMapUv = ( tileTransform * transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\nvThicknessMapUv = ( tileTransform * thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n",ze="\n#include <common>\n#include <color_pars_vertex>\n#include <uv_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nvoid main() {\n\n    ".concat(Ee,"\n\t\n    vec2 alignedPosition = ( position.xy ) * size;\n    \n    vec2 rotatedPosition;\n    rotatedPosition.x = cos( rotation ) * alignedPosition.x - sin( rotation ) * alignedPosition.y;\n    rotatedPosition.y = sin( rotation ) * alignedPosition.x + cos( rotation ) * alignedPosition.y;\n#ifdef HORIZONTAL\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.x += rotatedPosition.x;\n    mvPosition.z -= rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n#elif defined(VERTICAL)\n    vec4 mvPosition = modelMatrix * vec4( offset, 1.0 );\n    mvPosition.y += rotatedPosition.y;\n    mvPosition = viewMatrix * mvPosition;\n    mvPosition.x += rotatedPosition.x;\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    mvPosition.xy += rotatedPosition;\n#endif\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n"),Ae="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\n// attribute vec4 color;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nvoid main() {\n\n    ".concat(Ee,"\n    \n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n    \n    mat4 matrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n    \n    vec4 mvPosition = modelViewMatrix * (matrix * vec4( position, 1.0 ));\n\n\tvColor = color;\n\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\n}\n"),Je="\n#define STANDARD\nvarying vec3 vViewPosition;\n#ifdef USE_TRANSMISSION\n\tvarying vec3 vWorldPosition;\n#endif\n#include <common>\n#include <uv_pars_vertex>\n\nattribute vec3 offset;\nattribute vec4 rotation;\nattribute float size;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\n#include <displacementmap_pars_vertex>\n#include <color_pars_vertex>\n#include <fog_pars_vertex>\n#include <normal_pars_vertex>\n#include <morphtarget_pars_vertex>\n#include <skinning_pars_vertex>\n#include <shadowmap_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nvoid main() {\n    ".concat(Ee,"\n\n    float x2 = rotation.x + rotation.x, y2 = rotation.y + rotation.y, z2 = rotation.z + rotation.z;\n    float xx = rotation.x * x2, xy = rotation.x * y2, xz = rotation.x * z2;\n    float yy = rotation.y * y2, yz = rotation.y * z2, zz = rotation.z * z2;\n    float wx = rotation.w * x2, wy = rotation.w * y2, wz = rotation.w * z2;\n    float sx = size, sy = size, sz = size;\n\n    mat4 particleMatrix = mat4(( 1.0 - ( yy + zz ) ) * sx, ( xy + wz ) * sx, ( xz - wy ) * sx, 0.0,  // 1. column\n                      ( xy - wz ) * sy, ( 1.0 - ( xx + zz ) ) * sy, ( yz + wx ) * sy, 0.0,  // 2. column\n                      ( xz + wy ) * sz, ( yz - wx ) * sz, ( 1.0 - ( xx + yy ) ) * sz, 0.0,  // 3. column\n                      offset.x, offset.y, offset.z, 1.0);\n\n\t#include <color_vertex>\n\t#include <morphcolor_vertex>\n\t#include <beginnormal_vertex>\n\t#include <morphnormal_vertex>\n\t#include <skinbase_vertex>\n\t#include <skinnormal_vertex>\n\n\t// replace defaultnormal_vertex\n\tvec3 transformedNormal = objectNormal;\n    mat3 m = mat3( particleMatrix );\n    transformedNormal /= vec3( dot( m[ 0 ], m[ 0 ] ), dot( m[ 1 ], m[ 1 ] ), dot( m[ 2 ], m[ 2 ] ) );\n    transformedNormal = m * transformedNormal;\n    transformedNormal = normalMatrix * transformedNormal;\n    #ifdef FLIP_SIDED\n        transformedNormal = - transformedNormal;\n    #endif\n    #ifdef USE_TANGENT\n        vec3 transformedTangent = ( modelViewMatrix * vec4( objectTangent, 0.0 ) ).xyz;\n        #ifdef FLIP_SIDED\n        transformedTangent = - transformedTangent;\n        #endif\n    #endif\n\n\t#include <normal_vertex>\n\t#include <begin_vertex>\n\t#include <morphtarget_vertex>\n\t#include <skinning_vertex>\n\t#include <displacementmap_vertex>\n\n\t// replace include <project_vertex>\n  vec4 mvPosition = vec4( transformed, 1.0 );\n  mvPosition = modelViewMatrix * (particleMatrix * mvPosition);\n\tgl_Position = projectionMatrix * mvPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n\tvViewPosition = - mvPosition.xyz;\n\t\n\t#include <worldpos_vertex>\n\t#include <shadowmap_vertex>\n\t#include <fog_vertex>\n#ifdef USE_TRANSMISSION\n\tvWorldPosition = worldPosition.xyz;\n#endif\n}\n"),Le="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <clipping_planes_pars_vertex>\n\nattribute vec3 offset;\nattribute float rotation;\nattribute float size;\nattribute vec4 velocity;\nattribute float uvTile;\n\n#ifdef UV_TILE\nuniform vec2 tileCount;\n#endif\n\nuniform float speedFactor;\n\nvoid main() {\n\n    ".concat(Ee,"\n    \n    float lengthFactor = velocity.w;\n#ifdef USE_SKEW\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n\n    vec3 scaledPos = vec3(position.xy * size, position.z);\n    float vlength = length(viewVelocity);\n    vec3 projVelocity =  dot(scaledPos, viewVelocity) * viewVelocity / vlength;\n    mvPosition.xyz += scaledPos + projVelocity * (speedFactor / size + lengthFactor / vlength);\n#else\n    vec4 mvPosition = modelViewMatrix * vec4( offset, 1.0 );\n    vec3 viewVelocity = normalMatrix * velocity.xyz;\n    float vlength = length(viewVelocity); \n    mvPosition.xyz += position.y * normalize(cross(mvPosition.xyz, viewVelocity)) * size; // switch the cross to  match unity implementation\n    mvPosition.xyz -= (position.x + 0.5) * viewVelocity * (1.0 + lengthFactor / vlength) * size; // minus position.x to match unity implementation\n#endif\n\tvColor = color;\n\tgl_Position = projectionMatrix * mvPosition;\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n}\n");function getMaterialUVChannelName(e){return 0===e?"uv":"uv".concat(e)}new t.Vector3(0,0,1);var Ue=function(e){_inherits(SpriteBatch,e);var i=_createSuper(SpriteBatch);function SpriteBatch(e){var r;return _classCallCheck(this,SpriteBatch),_defineProperty(_assertThisInitialized(r=i.call(this,e)),"offsetBuffer",void 0),_defineProperty(_assertThisInitialized(r),"rotationBuffer",void 0),_defineProperty(_assertThisInitialized(r),"sizeBuffer",void 0),_defineProperty(_assertThisInitialized(r),"colorBuffer",void 0),_defineProperty(_assertThisInitialized(r),"uvTileBuffer",void 0),_defineProperty(_assertThisInitialized(r),"velocityBuffer",void 0),_defineProperty(_assertThisInitialized(r),"vector_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector2_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector3_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"quaternion_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"quaternion2_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"quaternion3_",new t.Quaternion),_defineProperty(_assertThisInitialized(r),"rotationMat_",new t.Matrix3),_defineProperty(_assertThisInitialized(r),"rotationMat2_",new t.Matrix3),r.maxParticles=1e3,r.setupBuffers(),r.rebuildMaterial(),r}return _createClass(SpriteBatch,[{key:"buildExpandableBuffers",value:function buildExpandableBuffers(){this.offsetBuffer=new t.InstancedBufferAttribute(new Float32Array(3*this.maxParticles),3),this.offsetBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("offset",this.offsetBuffer),this.colorBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.colorBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("color",this.colorBuffer),this.settings.renderMode===be.Mesh?(this.rotationBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.rotationBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("rotation",this.rotationBuffer)):this.settings.renderMode!==be.BillBoard&&this.settings.renderMode!==be.HorizontalBillBoard&&this.settings.renderMode!==be.VerticalBillBoard&&this.settings.renderMode!==be.StretchedBillBoard||(this.rotationBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.rotationBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("rotation",this.rotationBuffer)),this.sizeBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.sizeBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("size",this.sizeBuffer),this.uvTileBuffer=new t.InstancedBufferAttribute(new Float32Array(this.maxParticles),1),this.uvTileBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("uvTile",this.uvTileBuffer),this.settings.renderMode===be.StretchedBillBoard&&(this.velocityBuffer=new t.InstancedBufferAttribute(new Float32Array(4*this.maxParticles),4),this.velocityBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("velocity",this.velocityBuffer))}},{key:"setupBuffers",value:function setupBuffers(){this.geometry&&this.geometry.dispose(),this.geometry=new t.InstancedBufferGeometry,this.geometry.setIndex(this.settings.instancingGeometry.getIndex()),this.settings.instancingGeometry.hasAttribute("normal")&&this.geometry.setAttribute("normal",this.settings.instancingGeometry.getAttribute("normal")),this.geometry.setAttribute("position",this.settings.instancingGeometry.getAttribute("position")),this.geometry.setAttribute("uv",this.settings.instancingGeometry.getAttribute("uv")),this.buildExpandableBuffers()}},{key:"expandBuffers",value:function expandBuffers(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function rebuildMaterial(){var e;this.layers.mask=this.settings.layers.mask;var i={};if("MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type){var r=this.settings.material;(e=t.UniformsUtils.merge([t.UniformsLib.common,t.UniformsLib.envmap,t.UniformsLib.aomap,t.UniformsLib.lightmap,t.UniformsLib.emissivemap,t.UniformsLib.bumpmap,t.UniformsLib.normalmap,t.UniformsLib.displacementmap,t.UniformsLib.roughnessmap,t.UniformsLib.metalnessmap,t.UniformsLib.fog,t.UniformsLib.lights,{emissive:{value:new t.Color(0)},roughness:{value:1},metalness:{value:0},envMapIntensity:{value:1}}])).diffuse.value=r.color,e.opacity.value=r.opacity,e.emissive.value=r.emissive,e.roughness.value=r.roughness,e.metalness.value=r.metalness,r.envMap&&(e.envMap.value=r.envMap,e.envMapIntensity.value=r.envMapIntensity),r.normalMap&&(e.normalMap.value=r.normalMap,e.normalScale.value=r.normalScale),r.roughnessMap&&(e.roughnessMap.value=r.roughnessMap),r.metalnessMap&&(e.metalnessMap.value=r.metalnessMap),r.map&&(e.map=new t.Uniform(r.map))}else(e={}).map=new t.Uniform(this.settings.material.map);this.settings.material.alphaTest&&(i.USE_ALPHATEST="",e.alphaTest=new t.Uniform(this.settings.material.alphaTest)),i.USE_UV="";var n=this.settings.uTileCount,o=this.settings.vTileCount;(n>1||o>1)&&(i.UV_TILE="",e.tileCount=new t.Uniform(new t.Vector2(n,o))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(i.USE_COLOR_AS_ALPHA=""),this.settings.material.normalMap&&(i.USE_NORMALMAP="",i.NORMALMAP_UV=getMaterialUVChannelName(this.settings.material.normalMap.channel),e.normalMapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.normalMap.matrix))),this.settings.material.map&&(i.USE_MAP="",i.MAP_UV=getMaterialUVChannelName(this.settings.material.map.channel),e.mapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.map.matrix))),i.USE_COLOR_ALPHA="";var a=!1;if(this.settings.renderMode===be.BillBoard||this.settings.renderMode===be.VerticalBillBoard||this.settings.renderMode===be.HorizontalBillBoard||this.settings.renderMode===be.Mesh){var s,l;this.settings.renderMode===be.Mesh?"MeshStandardMaterial"===this.settings.material.type||"MeshPhysicalMaterial"===this.settings.material.type?(i.USE_COLOR="",s=Je,l="\n#define STANDARD\n#ifdef PHYSICAL\n#define IOR\n#define SPECULAR\n#endif\nuniform vec3 diffuse;\nuniform vec3 emissive;\nuniform float roughness;\nuniform float metalness;\nuniform float opacity;\n#ifdef IOR\nuniform float ior;\n#endif\n#ifdef SPECULAR\nuniform float specularIntensity;\nuniform vec3 specularColor;\n#ifdef USE_SPECULARINTENSITYMAP\nuniform sampler2D specularIntensityMap;\n#endif\n#ifdef USE_SPECULARCOLORMAP\nuniform sampler2D specularColorMap;\n#endif\n#endif\n#ifdef USE_CLEARCOAT\nuniform float clearcoat;\nuniform float clearcoatRoughness;\n#endif\n#ifdef USE_IRIDESCENCE\nuniform float iridescence;\nuniform float iridescenceIOR;\nuniform float iridescenceThicknessMinimum;\nuniform float iridescenceThicknessMaximum;\n#endif\n#ifdef USE_SHEEN\nuniform vec3 sheenColor;\nuniform float sheenRoughness;\n#ifdef USE_SHEENCOLORMAP\nuniform sampler2D sheenColorMap;\n#endif\n#ifdef USE_SHEENROUGHNESSMAP\nuniform sampler2D sheenRoughnessMap;\n#endif\n#endif\n\nvarying vec3 vViewPosition;\n#include <common>\n#include <packing>\n#include <dithering_pars_fragment>\n#include <color_pars_fragment>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <alphamap_pars_fragment>\n#include <alphatest_pars_fragment>\n#include <aomap_pars_fragment>\n#include <lightmap_pars_fragment>\n#include <emissivemap_pars_fragment>\n#include <bsdfs>\n#include <iridescence_fragment>\n#include <cube_uv_reflection_fragment>\n#include <envmap_common_pars_fragment>\n#include <envmap_physical_pars_fragment>\n#include <fog_pars_fragment>\n#include <lights_pars_begin>\n#include <normal_pars_fragment>\n#include <lights_physical_pars_fragment>\n#include <transmission_pars_fragment>\n#include <shadowmap_pars_fragment>\n#include <bumpmap_pars_fragment>\n#include <normalmap_pars_fragment>\n#include <clearcoat_pars_fragment>\n#include <iridescence_pars_fragment>\n#include <roughnessmap_pars_fragment>\n#include <metalnessmap_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nvoid main() {\n    #include <clipping_planes_fragment>\n    vec4 diffuseColor = vec4( diffuse, opacity );\n    ReflectedLight reflectedLight = ReflectedLight( vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ), vec3( 0.0 ) );\n    vec3 totalEmissiveRadiance = emissive;\n    #include <logdepthbuf_fragment>\n    #include <map_fragment>\n    #include <color_fragment>\n    #include <alphamap_fragment>\n    #include <alphatest_fragment>\n    #include <roughnessmap_fragment>\n    #include <metalnessmap_fragment>\n    #include <normal_fragment_begin>\n    #include <normal_fragment_maps>\n    #include <clearcoat_normal_fragment_begin>\n    #include <clearcoat_normal_fragment_maps>\n    #include <emissivemap_fragment>\n    // accumulation\n    #include <lights_physical_fragment>\n    #include <lights_fragment_begin>\n    #include <lights_fragment_maps>\n    #include <lights_fragment_end>\n    // modulation\n    #include <aomap_fragment>\n    vec3 totalDiffuse = reflectedLight.directDiffuse + reflectedLight.indirectDiffuse;\n    vec3 totalSpecular = reflectedLight.directSpecular + reflectedLight.indirectSpecular;\n    #include <transmission_fragment>\n    vec3 outgoingLight = totalDiffuse + totalSpecular + totalEmissiveRadiance;\n    #ifdef USE_SHEEN\n    // Sheen energy compensation approximation calculation can be found at the end of\n        // https://drive.google.com/file/d/1T0D1VSyR4AllqIJTQAraEIzjlb5h4FKH/view?usp=sharing\n        float sheenEnergyComp = 1.0 - 0.157 * max3( material.sheenColor );\n        outgoingLight = outgoingLight * sheenEnergyComp + sheenSpecular;\n    #endif\n    #ifdef USE_CLEARCOAT\n        float dotNVcc = saturate( dot( geometry.clearcoatNormal, geometry.viewDir ) );\n        vec3 Fcc = F_Schlick( material.clearcoatF0, material.clearcoatF90, dotNVcc );\n        outgoingLight = outgoingLight * ( 1.0 - material.clearcoat * Fcc ) + clearcoatSpecular * material.clearcoat;\n    #endif\n    #include <output_fragment>\n    #include <tonemapping_fragment>\n    #include <encodings_fragment>\n    #include <fog_fragment>\n    #include <premultiplied_alpha_fragment>\n    #include <dithering_fragment>\n}",a=!0):(s=Ae,l=Te):(s=ze,l=Te),this.settings.renderMode===be.VerticalBillBoard?i.VERTICAL="":this.settings.renderMode===be.HorizontalBillBoard&&(i.HORIZONTAL=""),this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:s,fragmentShader:l,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest,lights:a})}else{if(this.settings.renderMode!==be.StretchedBillBoard)throw new Error("render mode unavailable");e.speedFactor=new t.Uniform(1),this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:Le,fragmentShader:Te,transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,blending:this.settings.material.blending,side:this.settings.material.side,alphaTest:this.settings.material.alphaTest})}}},{key:"update",value:function update(){var e=this,t=0,i=0;this.systems.forEach((function(e){i+=e.particleNum})),i>this.maxParticles&&this.expandBuffers(i),this.systems.forEach((function(i){var r=i.particles,n=i.particleNum,o=e.quaternion2_,a=e.vector2_,s=e.vector3_;i.emitter.matrixWorld.decompose(a,o,s),e.rotationMat_.setFromMatrix4(i.emitter.matrixWorld);for(var l=0;l<n;l++,t++){var u=r[l];if(e.settings.renderMode===be.Mesh){var c=void 0;if(i.worldSpace)c=u.rotation;else{var d=void 0;d=u.parentMatrix?e.quaternion3_.setFromRotationMatrix(u.parentMatrix):o,(c=e.quaternion_).copy(u.rotation).multiply(d)}e.rotationBuffer.setXYZW(t,c.x,c.y,c.z,c.w)}else e.settings.renderMode!==be.StretchedBillBoard&&e.settings.renderMode!==be.VerticalBillBoard&&e.settings.renderMode!==be.HorizontalBillBoard&&e.settings.renderMode!==be.BillBoard||e.rotationBuffer.setX(t,u.rotation);var h=void 0;if(i.worldSpace?h=u.position:(h=e.vector_,u.parentMatrix?h.copy(u.position).applyMatrix4(u.parentMatrix):h.copy(u.position).applyMatrix4(i.emitter.matrixWorld)),e.offsetBuffer.setXYZ(t,h.x,h.y,h.z),e.colorBuffer.setXYZW(t,u.color.x,u.color.y,u.color.z,u.color.w),i.worldSpace||u.parentMatrix?e.sizeBuffer.setX(t,u.size):e.sizeBuffer.setX(t,u.size*(Math.abs(s.x)+Math.abs(s.y)+Math.abs(s.z))/3),e.uvTileBuffer.setX(t,u.uvTile),e.settings.renderMode===be.StretchedBillBoard&&e.velocityBuffer){var f=i.rendererEmitterSettings.speedFactor;0===f&&(f=.001);var p=i.rendererEmitterSettings.lengthFactor,m=void 0;i.worldSpace?m=u.velocity:(m=e.vector_,u.parentMatrix?(e.rotationMat2_.setFromMatrix4(u.parentMatrix),m.copy(u.velocity).applyMatrix3(e.rotationMat2_)):m.copy(u.velocity).applyMatrix3(e.rotationMat_)),e.velocityBuffer.setXYZW(t,m.x*f,m.y*f,m.z*f,p)}}})),this.geometry.instanceCount=t,t>0&&(this.offsetBuffer.updateRange.count=3*t,this.offsetBuffer.needsUpdate=!0,this.sizeBuffer.updateRange.count=t,this.sizeBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.uvTileBuffer.updateRange.count=t,this.uvTileBuffer.needsUpdate=!0,this.settings.renderMode===be.StretchedBillBoard&&this.velocityBuffer&&(this.velocityBuffer.updateRange.count=4*t,this.velocityBuffer.needsUpdate=!0),this.settings.renderMode===be.Mesh?(this.rotationBuffer.updateRange.count=4*t,this.rotationBuffer.needsUpdate=!0):this.settings.renderMode!==be.StretchedBillBoard&&this.settings.renderMode!==be.HorizontalBillBoard&&this.settings.renderMode!==be.VerticalBillBoard&&this.settings.renderMode!==be.BillBoard||(this.rotationBuffer.updateRange.count=t,this.rotationBuffer.needsUpdate=!0))}},{key:"dispose",value:function dispose(){this.geometry.dispose()}}]),SpriteBatch}(Ne),Re="\n#include <common>\n#include <uv_pars_vertex>\n#include <color_pars_vertex>\n#include <clipping_planes_pars_vertex>\n#include <logdepthbuf_pars_vertex>\n#include <fog_pars_vertex>\n\nattribute vec3 previous;\nattribute vec3 next;\nattribute float side;\nattribute float width;\n\nuniform vec2 resolution;\nuniform float lineWidth;\nuniform float sizeAttenuation;\n    \nvec2 fix(vec4 i, float aspect) {\n    vec2 res = i.xy / i.w;\n    res.x *= aspect;\n    return res;\n}\n    \nvoid main() {\n\n    ".concat(Ee,"\n    \n    float aspect = resolution.x / resolution.y;\n\n    vColor = color;\n\n    mat4 m = projectionMatrix * modelViewMatrix;\n    vec4 finalPosition = m * vec4( position, 1.0 );\n    vec4 prevPos = m * vec4( previous, 1.0 );\n    vec4 nextPos = m * vec4( next, 1.0 );\n\n    vec2 currentP = fix( finalPosition, aspect );\n    vec2 prevP = fix( prevPos, aspect );\n    vec2 nextP = fix( nextPos, aspect );\n\n    float w = lineWidth * width;\n\n    vec2 dir;\n    if( nextP == currentP ) dir = normalize( currentP - prevP );\n    else if( prevP == currentP ) dir = normalize( nextP - currentP );\n    else {\n        vec2 dir1 = normalize( currentP - prevP );\n        vec2 dir2 = normalize( nextP - currentP );\n        dir = normalize( dir1 + dir2 );\n\n        vec2 perp = vec2( -dir1.y, dir1.x );\n        vec2 miter = vec2( -dir.y, dir.x );\n        //w = clamp( w / dot( miter, perp ), 0., 4., * lineWidth * width );\n\n    }\n\n    //vec2 normal = ( cross( vec3( dir, 0. ) vec3( 0., 0., 1. ) ) ).xy;\n    vec4 normal = vec4( -dir.y, dir.x, 0., 1. );\n    normal.xy *= .5 * w;\n    normal *= projectionMatrix;\n    if( sizeAttenuation == 0. ) {\n        normal.xy *= finalPosition.w;\n        normal.xy /= ( vec4( resolution, 0., 1. ) * projectionMatrix ).xy;\n    }\n\n    finalPosition.xy += normal.xy * side;\n\n    gl_Position = finalPosition;\n\n\t#include <logdepthbuf_vertex>\n\t#include <clipping_planes_vertex>\n\t\n    vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );\n    \n\t#include <fog_vertex>\n}");new t.Vector3(0,0,1);var Fe=function(e){_inherits(TrailBatch,e);var i=_createSuper(TrailBatch);function TrailBatch(e){var r;return _classCallCheck(this,TrailBatch),_defineProperty(_assertThisInitialized(r=i.call(this,e)),"positionBuffer",void 0),_defineProperty(_assertThisInitialized(r),"previousBuffer",void 0),_defineProperty(_assertThisInitialized(r),"nextBuffer",void 0),_defineProperty(_assertThisInitialized(r),"uvBuffer",void 0),_defineProperty(_assertThisInitialized(r),"sideBuffer",void 0),_defineProperty(_assertThisInitialized(r),"widthBuffer",void 0),_defineProperty(_assertThisInitialized(r),"colorBuffer",void 0),_defineProperty(_assertThisInitialized(r),"indexBuffer",void 0),_defineProperty(_assertThisInitialized(r),"vector_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector2_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"vector3_",new t.Vector3),_defineProperty(_assertThisInitialized(r),"quaternion_",new t.Quaternion),r.maxParticles=1e4,r.setupBuffers(),r.rebuildMaterial(),r}return _createClass(TrailBatch,[{key:"setupBuffers",value:function setupBuffers(){this.geometry&&this.geometry.dispose(),this.geometry=new t.BufferGeometry,this.indexBuffer=new t.BufferAttribute(new Uint32Array(6*this.maxParticles),1),this.indexBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setIndex(this.indexBuffer),this.positionBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.positionBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("position",this.positionBuffer),this.previousBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.previousBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("previous",this.previousBuffer),this.nextBuffer=new t.BufferAttribute(new Float32Array(6*this.maxParticles),3),this.nextBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("next",this.nextBuffer),this.widthBuffer=new t.BufferAttribute(new Float32Array(2*this.maxParticles),1),this.widthBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("width",this.widthBuffer),this.sideBuffer=new t.BufferAttribute(new Float32Array(2*this.maxParticles),1),this.sideBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("side",this.sideBuffer),this.uvBuffer=new t.BufferAttribute(new Float32Array(4*this.maxParticles),2),this.uvBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("uv",this.uvBuffer),this.colorBuffer=new t.BufferAttribute(new Float32Array(8*this.maxParticles),4),this.colorBuffer.setUsage(t.DynamicDrawUsage),this.geometry.setAttribute("color",this.colorBuffer)}},{key:"expandBuffers",value:function expandBuffers(e){for(;e>=this.maxParticles;)this.maxParticles*=2;this.setupBuffers()}},{key:"rebuildMaterial",value:function rebuildMaterial(){this.layers.mask=this.settings.layers.mask;var e={lineWidth:{value:1},map:{value:null},useMap:{value:0},alphaMap:{value:null},useAlphaMap:{value:0},resolution:{value:new t.Vector2(1,1)},sizeAttenuation:{value:1},visibility:{value:1},alphaTest:{value:0},repeat:{value:new t.Vector2(1,1)}},i={USE_UV:"",USE_COLOR_ALPHA:""};if(this.settings.material.map&&(i.USE_MAP="",i.MAP_UV=getMaterialUVChannelName(this.settings.material.map.channel),e.map=new t.Uniform(this.settings.material.map),e.mapTransform=new t.Uniform((new t.Matrix3).copy(this.settings.material.map.matrix))),this.settings.material.defines&&void 0!==this.settings.material.defines.USE_COLOR_AS_ALPHA&&(i.USE_COLOR_AS_ALPHA=""),this.settings.renderMode!==be.Trail)throw new Error("render mode unavailable");this.material=new t.ShaderMaterial({uniforms:e,defines:i,vertexShader:Re,fragmentShader:"\n\n#include <common>\n#include <uv_pars_fragment>\n#include <map_pars_fragment>\n#include <fog_pars_fragment>\n#include <logdepthbuf_pars_fragment>\n#include <clipping_planes_pars_fragment>\n\nuniform sampler2D alphaMap;\nuniform float useAlphaMap;\nuniform float visibility;\nuniform float alphaTest;\nuniform vec2 repeat;\n\nvarying vec4 vColor;\n    \nvoid main() {\n    #include <clipping_planes_fragment>\n    #include <logdepthbuf_fragment>\n\n    vec4 c = vColor;\n    \n    #ifdef USE_MAP\n    #ifdef USE_COLOR_AS_ALPHA\n    vec4 tex = texture2D( map, vUv * repeat );\n    c *= vec4(tex.rgb, tex.r);\n    #else\n    c *= texture2D( map, vUv * repeat );\n    #endif\n    #endif\n    if( useAlphaMap == 1. ) c.a *= texture2D( alphaMap, vUv * repeat ).a;\n    if( c.a < alphaTest ) discard;\n    gl_FragColor = c;\n\n    #include <fog_fragment>\n    #include <tonemapping_fragment>\n}",transparent:this.settings.material.transparent,depthWrite:!this.settings.material.transparent,side:this.settings.material.side,blending:this.settings.material.blending||t.AdditiveBlending})}},{key:"update",value:function update(){var e=this,t=0,i=0,r=0;this.systems.forEach((function(e){for(var t=0;t<e.particleNum;t++)r+=2*e.particles[t].previous.length})),r>this.maxParticles&&this.expandBuffers(r),this.systems.forEach((function(r){var n=e.quaternion_,o=e.vector2_,a=e.vector3_;r.emitter.matrixWorld.decompose(o,n,a);for(var s=r.particles,l=r.particleNum,u=e.settings.uTileCount,c=e.settings.vTileCount,d=1/u,h=1/c,f=0;f<l;f++){var p=s[f],m=p.uvTile%c,y=Math.floor(p.uvTile/c),v=p.previous.values(),g=v.next(),S=g.value,_=S;g.done||(g=v.next());var w=void 0;w=void 0!==g.value?g.value:_;for(var O=0;O<p.previous.length;O++,t+=2){if(e.positionBuffer.setXYZ(t,_.position.x,_.position.y,_.position.z),e.positionBuffer.setXYZ(t+1,_.position.x,_.position.y,_.position.z),r.worldSpace?(e.positionBuffer.setXYZ(t,_.position.x,_.position.y,_.position.z),e.positionBuffer.setXYZ(t+1,_.position.x,_.position.y,_.position.z)):(p.parentMatrix?e.vector_.copy(_.position).applyMatrix4(p.parentMatrix):e.vector_.copy(_.position).applyMatrix4(r.emitter.matrixWorld),e.positionBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.positionBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),r.worldSpace?(e.previousBuffer.setXYZ(t,S.position.x,S.position.y,S.position.z),e.previousBuffer.setXYZ(t+1,S.position.x,S.position.y,S.position.z)):(p.parentMatrix?e.vector_.copy(S.position).applyMatrix4(p.parentMatrix):e.vector_.copy(S.position).applyMatrix4(r.emitter.matrixWorld),e.previousBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.previousBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),r.worldSpace?(e.nextBuffer.setXYZ(t,w.position.x,w.position.y,w.position.z),e.nextBuffer.setXYZ(t+1,w.position.x,w.position.y,w.position.z)):(p.parentMatrix?e.vector_.copy(w.position).applyMatrix4(p.parentMatrix):e.vector_.copy(w.position).applyMatrix4(r.emitter.matrixWorld),e.nextBuffer.setXYZ(t,e.vector_.x,e.vector_.y,e.vector_.z),e.nextBuffer.setXYZ(t+1,e.vector_.x,e.vector_.y,e.vector_.z)),e.sideBuffer.setX(t,-1),e.sideBuffer.setX(t+1,1),r.worldSpace)e.widthBuffer.setX(t,_.size),e.widthBuffer.setX(t+1,_.size);else if(p.parentMatrix)e.widthBuffer.setX(t,_.size),e.widthBuffer.setX(t+1,_.size);else{var x=(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z))/3;e.widthBuffer.setX(t,_.size*x),e.widthBuffer.setX(t+1,_.size*x)}e.uvBuffer.setXY(t,(O/p.previous.length+m)*d,(c-y-1)*h),e.uvBuffer.setXY(t+1,(O/p.previous.length+m)*d,(c-y)*h),e.colorBuffer.setXYZW(t,_.color.x,_.color.y,_.color.z,_.color.w),e.colorBuffer.setXYZW(t+1,_.color.x,_.color.y,_.color.z,_.color.w),O+1<p.previous.length&&(e.indexBuffer.setX(3*i,t),e.indexBuffer.setX(3*i+1,t+1),e.indexBuffer.setX(3*i+2,t+2),i++,e.indexBuffer.setX(3*i,t+2),e.indexBuffer.setX(3*i+1,t+1),e.indexBuffer.setX(3*i+2,t+3),i++),S=_,_=w,g.done||void 0!==(g=v.next()).value&&(w=g.value)}}})),this.positionBuffer.updateRange.count=3*t,this.positionBuffer.needsUpdate=!0,this.previousBuffer.updateRange.count=3*t,this.previousBuffer.needsUpdate=!0,this.nextBuffer.updateRange.count=3*t,this.nextBuffer.needsUpdate=!0,this.sideBuffer.updateRange.count=t,this.sideBuffer.needsUpdate=!0,this.widthBuffer.updateRange.count=t,this.widthBuffer.needsUpdate=!0,this.uvBuffer.updateRange.count=2*t,this.uvBuffer.needsUpdate=!0,this.colorBuffer.updateRange.count=4*t,this.colorBuffer.needsUpdate=!0,this.indexBuffer.updateRange.count=3*i,this.indexBuffer.needsUpdate=!0,this.geometry.setDrawRange(0,3*i)}},{key:"dispose",value:function dispose(){this.geometry.dispose()}}]),TrailBatch}(Ne),Ie=function(e){_inherits(BatchedRenderer,e);var t=_createSuper(BatchedRenderer);function BatchedRenderer(){var e;return _classCallCheck(this,BatchedRenderer),_defineProperty(_assertThisInitialized(e=t.call(this)),"batches",[]),_defineProperty(_assertThisInitialized(e),"systemToBatchIndex",new Map),_defineProperty(_assertThisInitialized(e),"type","BatchedRenderer"),e}return _createClass(BatchedRenderer,[{key:"addSystem",value:function addSystem(e){e._renderer=this;for(var t,i=e.getRendererSettings(),r=0;r<this.batches.length;r++)if(BatchedRenderer.equals(this.batches[r].settings,i))return this.batches[r].addSystem(e),void this.systemToBatchIndex.set(e,r);switch(i.renderMode){case be.Trail:t=new Fe(i);break;case be.Mesh:case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:case be.StretchedBillBoard:t=new Ue(i)}t.addSystem(e),this.batches.push(t),this.systemToBatchIndex.set(e,this.batches.length-1),this.add(t)}},{key:"deleteSystem",value:function deleteSystem(e){var t=this.systemToBatchIndex.get(e);null!=t&&(this.batches[t].removeSystem(e),this.systemToBatchIndex.delete(e))}},{key:"updateSystem",value:function updateSystem(e){this.deleteSystem(e),this.addSystem(e)}},{key:"update",value:function update(e){this.systemToBatchIndex.forEach((function(t,i){i.update(e)}));for(var t=0;t<this.batches.length;t++)this.batches[t].update()}}],[{key:"equals",value:function equals(e,t){return e.material.side===t.material.side&&e.material.blending===t.material.blending&&e.material.transparent===t.material.transparent&&e.material.type===t.material.type&&e.material.alphaTest===t.material.alphaTest&&e.material.map===t.material.map&&e.renderMode===t.renderMode&&e.uTileCount===t.uTileCount&&e.vTileCount===t.vTileCount&&e.instancingGeometry===t.instancingGeometry&&e.renderOrder===t.renderOrder&&e.layers.mask===t.layers.mask}}]),BatchedRenderer}(t.Object3D),Ge=Ie,De=function(e){_inherits(QuarksLoader,e);var i=_createSuper(QuarksLoader);function QuarksLoader(e){return _classCallCheck(this,QuarksLoader),i.call(this,e)}return _createClass(QuarksLoader,[{key:"linkReference",value:function linkReference(e){var t={};e.traverse((function(e){t[e.uuid]=e})),e.traverse((function(e){if("ParticleEmitter"===e.type){var i=e.system;i.emitterShape;for(var r=0;r<i.behaviors.length;r++)i.behaviors[r]instanceof j&&(i.behaviors[r].subParticleSystem=t[i.behaviors[r].subParticleSystem])}}))}},{key:"parse",value:function parse(e,t){var i=_get(_getPrototypeOf(QuarksLoader.prototype),"parse",this).call(this,e,t);return this.linkReference(i),i}},{key:"parseObject",value:function parseObject(e,i,r,n,o){var a,s,l;function getGeometry(e){return void 0===i[e]&&console.warn("THREE.ObjectLoader: Undefined geometry",e),i[e]}function getMaterial(e){if(void 0!==e){if(Array.isArray(e)){for(var t=[],i=0,n=e.length;i<n;i++){var o=e[i];void 0===r[o]&&console.warn("THREE.ObjectLoader: Undefined material",o),t.push(r[o])}return t}return void 0===r[e]&&console.warn("THREE.ObjectLoader: Undefined material",e),r[e]}}function getTexture(e){return void 0===n[e]&&console.warn("THREE.ObjectLoader: Undefined texture",e),n[e]}var u={textures:n,geometries:i,materials:r};switch(e.type){case"ParticleEmitter":a=Be.fromJSON(e.ps,u,{}).emitter;break;case"Scene":a=new t.Scene,void 0!==e.background&&(Number.isInteger(e.background)?a.background=new t.Color(e.background):a.background=getTexture(e.background)),void 0!==e.environment&&(a.environment=getTexture(e.environment)),void 0!==e.fog&&("Fog"===e.fog.type?a.fog=new t.Fog(e.fog.color,e.fog.near,e.fog.far):"FogExp2"===e.fog.type&&(a.fog=new t.FogExp2(e.fog.color,e.fog.density))),void 0!==e.backgroundBlurriness&&(a.backgroundBlurriness=e.backgroundBlurriness);break;case"PerspectiveCamera":a=new t.PerspectiveCamera(e.fov,e.aspect,e.near,e.far),void 0!==e.focus&&(a.focus=e.focus),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.filmGauge&&(a.filmGauge=e.filmGauge),void 0!==e.filmOffset&&(a.filmOffset=e.filmOffset),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"OrthographicCamera":a=new t.OrthographicCamera(e.left,e.right,e.top,e.bottom,e.near,e.far),void 0!==e.zoom&&(a.zoom=e.zoom),void 0!==e.view&&(a.view=Object.assign({},e.view));break;case"AmbientLight":a=new t.AmbientLight(e.color,e.intensity);break;case"DirectionalLight":a=new t.DirectionalLight(e.color,e.intensity);break;case"PointLight":a=new t.PointLight(e.color,e.intensity,e.distance,e.decay);break;case"RectAreaLight":a=new t.RectAreaLight(e.color,e.intensity,e.width,e.height);break;case"SpotLight":a=new t.SpotLight(e.color,e.intensity,e.distance,e.angle,e.penumbra,e.decay);break;case"HemisphereLight":a=new t.HemisphereLight(e.color,e.groundColor,e.intensity);break;case"LightProbe":a=(new t.LightProbe).fromJSON(e);break;case"SkinnedMesh":s=getGeometry(e.geometry),l=getMaterial(e.material),a=new t.SkinnedMesh(s,l),void 0!==e.bindMode&&(a.bindMode=e.bindMode),void 0!==e.bindMatrix&&a.bindMatrix.fromArray(e.bindMatrix),void 0!==e.skeleton&&(a.skeleton=e.skeleton);break;case"Mesh":s=getGeometry(e.geometry),l=getMaterial(e.material),a=new t.Mesh(s,l);break;case"InstancedMesh":s=getGeometry(e.geometry),l=getMaterial(e.material);var c=e.count,d=e.instanceMatrix,h=e.instanceColor;(a=new t.InstancedMesh(s,l,c)).instanceMatrix=new t.InstancedBufferAttribute(new Float32Array(d.array),16),void 0!==h&&(a.instanceColor=new t.InstancedBufferAttribute(new Float32Array(h.array),h.itemSize));break;case"LOD":a=new t.LOD;break;case"Line":a=new t.Line(getGeometry(e.geometry),getMaterial(e.material));break;case"LineLoop":a=new t.LineLoop(getGeometry(e.geometry),getMaterial(e.material));break;case"LineSegments":a=new t.LineSegments(getGeometry(e.geometry),getMaterial(e.material));break;case"PointCloud":case"Points":a=new t.Points(getGeometry(e.geometry),getMaterial(e.material));break;case"Sprite":a=new t.Sprite(getMaterial(e.material));break;case"Group":a=new t.Group;break;case"Bone":a=new t.Bone;break;default:a=new t.Object3D}if(a.uuid=e.uuid,void 0!==e.name&&(a.name=e.name),void 0!==e.matrix?(a.matrix.fromArray(e.matrix),void 0!==e.matrixAutoUpdate&&(a.matrixAutoUpdate=e.matrixAutoUpdate),a.matrixAutoUpdate&&a.matrix.decompose(a.position,a.quaternion,a.scale)):(void 0!==e.position&&a.position.fromArray(e.position),void 0!==e.rotation&&a.rotation.fromArray(e.rotation),void 0!==e.quaternion&&a.quaternion.fromArray(e.quaternion),void 0!==e.scale&&a.scale.fromArray(e.scale)),void 0!==e.castShadow&&(a.castShadow=e.castShadow),void 0!==e.receiveShadow&&(a.receiveShadow=e.receiveShadow),e.shadow&&(void 0!==e.shadow.bias&&(a.shadow.bias=e.shadow.bias),void 0!==e.shadow.normalBias&&(a.normalBias=e.shadow.normalBias),void 0!==e.shadow.radius&&(a.radius=e.shadow.radius),void 0!==e.shadow.mapSize&&a.mapSize.fromArray(e.shadow.mapSize),void 0!==e.shadow.camera&&(a.camera=this.parseObject(e.shadow.camera))),void 0!==e.visible&&(a.visible=e.visible),void 0!==e.frustumCulled&&(a.frustumCulled=e.frustumCulled),void 0!==e.renderOrder&&(a.renderOrder=e.renderOrder),void 0!==e.userData&&(a.userData=e.userData),void 0!==e.layers&&(a.layers.mask=e.layers),void 0!==e.children)for(var f=e.children,p=0;p<f.length;p++)a.add(this.parseObject(f[p],i,r,n,o));if(void 0!==e.animations)for(var m=e.animations,y=0;y<m.length;y++){var v=m[y];a.animations.push(o[v])}if("LOD"===e.type){void 0!==e.autoUpdate&&(a.autoUpdate=e.autoUpdate);for(var g=e.levels,S=0;S<g.length;S++){var _=g[S],w=a.getObjectByProperty("uuid",_.object);void 0!==w&&a.addLevel(w,_.distance)}}return a}}]),QuarksLoader}(t.ObjectLoader),qe=[],Xe=function(e){return e[e.Number=0]="Number",e[e.Vec2=1]="Vec2",e[e.Vec3=2]="Vec3",e[e.Vec4=3]="Vec4",e[e.Boolean=4]="Boolean",e[e.AnyType=5]="AnyType",e[e.NullableAnyType=6]="NullableAnyType",e[e.EventStream=7]="EventStream",e}({}),je=function genDefaultForNodeValueType(e){switch(e){case Xe.Boolean:return!1;case Xe.Number:return 0;case Xe.Vec2:return new t.Vector2;case Xe.Vec3:return new t.Vector3;case Xe.Vec4:return new t.Vector4;case Xe.AnyType:return 0;case Xe.NullableAnyType:return}},He=function(){function Node(e){var i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:-1,r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};_classCallCheck(this,Node),_defineProperty(this,"id",void 0),_defineProperty(this,"inputs",[]),_defineProperty(this,"outputs",[]),_defineProperty(this,"type",void 0),_defineProperty(this,"signatureIndex",-1),_defineProperty(this,"data",void 0),_defineProperty(this,"position",new t.Vector2),_defineProperty(this,"outputValues",[]),this.id=""+Math.round(1e5*Math.random()),this.type=e,this.signatureIndex=i,this.data=r;for(var n=-1===i?0:i,o=0;o<e.nodeTypeSignatures[n].inputTypes.length;o++)this.inputs.push(void 0);for(var a=0;a<e.nodeTypeSignatures[n].outputTypes.length;a++)this.outputs.push([]),this.outputValues.push(je(e.nodeTypeSignatures[n].outputTypes[a]))}return _createClass(Node,[{key:"inputTypes",get:function get(){var e=-1===this.signatureIndex?0:this.signatureIndex;return this.type.nodeTypeSignatures[e].inputTypes}},{key:"outputTypes",get:function get(){var e=-1===this.signatureIndex?0:this.signatureIndex;return this.type.nodeTypeSignatures[e].outputTypes}},{key:"func",value:function func(e,t,i){var r=-1===this.signatureIndex?0:this.signatureIndex;this.type.nodeTypeSignatures[r].func(e,this.data,t,i)}}]),Node}(),We=_createClass((function Wire(e,t,i,r){_classCallCheck(this,Wire),_defineProperty(this,"input",void 0),_defineProperty(this,"inputIndex",void 0),_defineProperty(this,"output",void 0),_defineProperty(this,"outputIndex",void 0),this.input=e,this.inputIndex=t,this.input.outputs[t].push(this),this.output=i,this.outputIndex=r,this.output.inputs[r]=this})),Qe=function(){function BaseCompiler(){_classCallCheck(this,BaseCompiler),_defineProperty(this,"visited",new Set),BaseCompiler.Instance=this}return _createClass(BaseCompiler,[{key:"buildExecutionOrder",value:function buildExecutionOrder(e,t){e.nodesInOrder.length=0,this.visited.clear();for(var i=0;i<e.outputNodes.length;i++){var r=e.outputNodes[i];void 0!==r.inputs[0]&&this._traverse(r,e,t)}e.compiled=!0}},{key:"_traverse",value:function _traverse(e,t,i){this.visited.add(e.id);for(var r=0;r<e.inputs.length;r++)if(e.inputs[r]instanceof We){var n=e.inputs[r].input;this.visited.has(n.id)||this._traverse(n,t,i)}else e.inputs[r];t.nodesInOrder.push(e)}}]),BaseCompiler}();_defineProperty(Qe,"Instance",void 0);var Ye=function(e){_inherits(Interpreter,e);var t=_createSuper(Interpreter);function Interpreter(){return _classCallCheck(this,Interpreter),t.call(this)}return _createClass(Interpreter,[{key:"executeCompiledGraph",value:function executeCompiledGraph(e,t){for(var i=e.nodesInOrder,r=0;r<i.length;r++){for(var n=[],o=i[r],a=0;a<o.inputs.length;a++)o.inputs[a]instanceof We?n.push(o.inputs[a].input.outputValues[o.inputs[a].inputIndex]):void 0!==o.inputs[a]?n.push(o.inputs[a].getValue(t)):n.push(void 0);o.func(t,n,o.outputValues)}}},{key:"run",value:function run(e,t){e.compiled||this.buildExecutionOrder(e,t),this.executeCompiledGraph(e,t)}}]),Interpreter}(Qe),Ze=function(){function NodeType(e){_classCallCheck(this,NodeType),_defineProperty(this,"name",void 0),_defineProperty(this,"nodeTypeSignatures",[]),this.name=e}return _createClass(NodeType,[{key:"addSignature",value:function addSignature(e,t,i){this.nodeTypeSignatures.push({inputTypes:e,outputTypes:t,func:i})}}]),NodeType}(),Ke=function(e){_inherits(GraphNodeType,e);var t=_createSuper(GraphNodeType);function GraphNodeType(e){var i;_classCallCheck(this,GraphNodeType);for(var r=[],n=0;n<e.inputNodes.length;n++)"input"===e.inputNodes[n].type.name&&r.push(e.inputNodes[n].data.type);for(var o=[],a=0;a<e.outputNodes.length;a++)"output"===e.outputNodes[a].type.name&&o.push(e.outputNodes[a].data.type);return _defineProperty(_assertThisInitialized(i=t.call(this,e.name)),"nodeGraph",void 0),i.addSignature(r,o,(function(t,i,r,n){t.inputs=r,t.outputs=n,Ye.Instance.run(e,t)})),i.nodeGraph=e,i}return _createClass(GraphNodeType)}(Ze),$e={},et=new Ze("add");et.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]+i[1]})),et.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),et.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),et.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].addVectors(i[0],i[1])})),$e.add=et;var tt=new Ze("sub");tt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]-i[1]})),tt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),tt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),tt.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].subVectors(i[0],i[1])})),$e.sub=tt;var it=new Ze("mul");it.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]*i[1]})),it.addSignature([Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),it.addSignature([Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),it.addSignature([Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).multiplyScalar(i[1])})),$e.mul=it;var rt=new Ze("div");rt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]/i[1]})),rt.addSignature([Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),rt.addSignature([Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),rt.addSignature([Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).divideScalar(i[1])})),$e.div=rt;var nt=new Ze("sin");nt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.sin(i[0])})),$e.sin=nt;var ot=new Ze("cos");ot.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.cos(i[0])})),$e.cos=ot;var at=new Ze("tan");at.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.tan(i[0])})),$e.tan=at;var st=new Ze("abs");st.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.abs(i[0])})),$e.abs=st;var lt=new Ze("min");lt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.min(i[0],i[1])})),$e.min=lt;var ut=new Ze("max");ut.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.max(i[0],i[1])})),$e.max=ut;var ct=new Ze("dot");ct.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),ct.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),ct.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].dot(i[1])})),$e.dot=ct;var dt=new Ze("cross");dt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].crossVectors(i[0],i[1])})),$e.cross=dt;var ht=new Ze("length");ht.addSignature([Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),ht.addSignature([Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),ht.addSignature([Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].length()})),$e.length=ht;var ft=new Ze("lengthSq");ft.addSignature([Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),ft.addSignature([Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),ft.addSignature([Xe.Vec4],[Xe.Number],(function(e,t,i,r){r[0]=i[0].lengthSq()})),$e.lengthSq=ft;var pt=new Ze("normalize");pt.addSignature([Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),pt.addSignature([Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),pt.addSignature([Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0].copy(i[0]).normalize()})),$e.normalize=pt;var mt=new Ze("distance");mt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Number],(function(e,t,i,r){r[0]=i[0].distanceTo(i[1])})),mt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Number],(function(e,t,i,r){r[0]=i[0].distanceTo(i[1])})),$e.distance=mt;var yt=new Ze("and");yt.addSignature([Xe.Boolean,Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]&&i[1]})),$e.and=yt;var vt=new Ze("or");vt.addSignature([Xe.Boolean,Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]||i[1]})),$e.or=vt;var gt=new Ze("not");gt.addSignature([Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=!i[0]})),$e.not=gt;var St=new Ze("equal");St.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]===i[1]})),St.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),St.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),St.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0].equals(i[1])})),$e.equal=St;var _t=new Ze("lessThan");_t.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]<i[1]})),$e.lessThan=_t;var wt=new Ze("greaterThan");wt.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]>i[1]})),$e.greaterThan=wt;var Ot=new Ze("lessThanOrEqual");Ot.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]<=i[1]})),$e.lessThanOrEqual=Ot;var xt=new Ze("greaterThanOrEqual");xt.addSignature([Xe.Number,Xe.Number],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]>=i[1]})),$e.greaterThanOrEqual=xt;var bt=new Ze("if");bt.addSignature([Xe.Boolean,Xe.AnyType,Xe.AnyType],[Xe.AnyType],(function(e,t,i,r){r[0]=i[0]?i[1]:i[2]})),$e.if=bt;var Nt=new Ze("number");Nt.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=t.value})),$e.number=Nt;var Pt=new Ze("vec2");Pt.addSignature([Xe.Number,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1]})),$e.vec2=Pt;var kt=new Ze("vec3");kt.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1],r[0].z=i[2]})),$e.vec3=kt;var Mt=new Ze("vec4");Mt.addSignature([Xe.Number,Xe.Number,Xe.Number,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].x=i[0],r[0].y=i[1],r[0].z=i[2],r[0].w=i[3]})),$e.vec4=Mt;var Ct=new Ze("splitVec2");Ct.addSignature([Xe.Vec2],[Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y})),$e.splitVec2=Ct;var Vt=new Ze("splitVec3");Vt.addSignature([Xe.Vec3],[Xe.Number,Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y,r[2]=i[0].z})),$e.splitVec3=Vt;var Bt=new Ze("splitVec4");Bt.addSignature([Xe.Vec4],[Xe.Number,Xe.Number,Xe.Number,Xe.Number],(function(e,t,i,r){r[0]=i[0].x,r[1]=i[0].y,r[2]=i[0].z,r[3]=i[0].w})),$e.splitVec4=Bt;var Tt=new Ze("bool");Tt.addSignature([],[Xe.Boolean],(function(e,t,i,r){r[0]=t.value})),$e.bool=Tt;var Et=new Ze("particleProperty");Et.addSignature([Xe.NullableAnyType],[Xe.NullableAnyType],(function(e,t,i,r){void 0!==i[0]&&("object"===_typeof(i[0])?e.particle[t.property].copy(i[0]):e.particle[t.property]=i[0]),void 0!==e.particle[t.property]&&("object"===_typeof(r[0])?r[0].copy(e.particle[t.property]):r[0]=e.particle[t.property])})),$e.particleProperty=Et;var zt=new Ze("emit");zt.addSignature([Xe.EventStream],[],(function(e,t,i,r){for(var n=i[0],o=0;o<n.length;o++)e.signal(o,n[o])})),$e.emit=zt;var At=new Ze("graphProperty");At.addSignature([Xe.NullableAnyType],[Xe.NullableAnyType],(function(e,t,i,r){void 0!==i[0]&&("object"===_typeof(i[0])?e.graph[t.property].copy(i[0]):e.graph[t.property]=i[0]),void 0!==e.graph[t.property]&&("object"===_typeof(r[0])?r[0].copy(e.graph[t.property]):r[0]=e.graph[t.property])})),$e.graphProperty=At;var Jt=new Ze("startEvent");Jt.addSignature([],[Xe.EventStream],(function(e,t,i,r){r[0]=[{type:"start"}]})),$e.startEvent=Jt;var Lt=new Ze("repeater");Lt.addSignature([Xe.EventStream,Xe.Number],[Xe.EventStream],(function(e,t,i,r){for(var n=i[0],o=i[1],a=[],s=0;s<n.length;s++)for(var l=0;l<o;l++)a.push(n[s]);r[0]=a})),$e.repeater=Lt;var Ut=new Ze("time");Ut.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=e.emissionState.time})),$e.time=Ut;var Rt=new Ze("delta");Rt.addSignature([],[Xe.Number],(function(e,t,i,r){r[0]=e.delta})),$e.delta=Rt;var Ft=new Ze("output");Ft.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){r[0]=i[0]})),Ft.addSignature([Xe.Boolean],[Xe.Boolean],(function(e,t,i,r){r[0]=i[0]})),$e.output=Ft;var It=new Ze("lerp");It.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=i[0]*(1-i[2])+i[1]*i[2]})),It.addSignature([Xe.Vec2,Xe.Vec2,Xe.Number],[Xe.Vec2],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),It.addSignature([Xe.Vec3,Xe.Vec3,Xe.Number],[Xe.Vec3],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),It.addSignature([Xe.Vec4,Xe.Vec4,Xe.Number],[Xe.Vec4],(function(e,t,i,r){r[0].lerpVectors(i[0],i[1],i[2])})),$e.lerp=It;var Gt=new Ze("normDistrib");Gt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=function normalD(e){return 1/Math.sqrt(2*Math.PI)*Math.exp(e*e*-.5)}(i[0])})),$e.normDistrib=Gt;var Dt=new Ze("normcdf");Dt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){var n=i[0],o=1;n<0&&(o=-1);var a=1/(1+.3275911*(n=Math.abs(n)/Math.sqrt(2))),s=1-((((1.061405429*a-1.453152027)*a+1.421413741)*a-.284496736)*a+.254829592)*a*Math.exp(-n*n);r[0]=.5*(1+o*s)})),$e.normcdf=Dt;var qt=new Ze("normcdfInv"),Xt=function rationalApproximation(e){var t=[2.515517,.802853,.010328],i=[1.432788,.189269,.001308];return e-((t[2]*e+t[1])*e+t[0])/(((i[2]*e+i[1])*e+i[0])*e+1)},jt=function normcdfInv(e){return e<.5?-Xt(Math.sqrt(-2*Math.log(e))):Xt(Math.sqrt(-2*Math.log(1-e)))};qt.addSignature([Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=jt(i[0])})),$e.normcdfInv=qt;var Ht=new Ze("clamp");Ht.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.max(Math.min(i[0],i[2]),i[1])})),$e.clamp=Ht;var Wt=new Ze("smoothstep");Wt.addSignature([Xe.Number,Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){var n=Math.max(Math.min(i[0],i[2]),i[1]);r[0]=n*n*(3-2*n)})),$e.smoothstep=Wt;var Qt=new Ze("random");Qt.addSignature([Xe.Number,Xe.Number],[Xe.Number],(function(e,t,i,r){r[0]=Math.random()*(i[1]-i[0])+i[0]})),Qt.addSignature([Xe.Vec2,Xe.Vec2],[Xe.Vec2],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),Qt.addSignature([Xe.Vec3,Xe.Vec3],[Xe.Vec3],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),Qt.addSignature([Xe.Vec4,Xe.Vec4],[Xe.Vec4],(function(e,t,i,r){var n=Math.random();r[0].lerpVectors(i[0],i[1],n)})),$e.random=Qt;var Yt=new Ze("vrand");Yt.addSignature([],[Xe.Vec2],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=Math.sqrt(n*n+o*o);r[0].set(n/a,o/a)})),Yt.addSignature([],[Xe.Vec3],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=jt(Math.random()),s=Math.sqrt(n*n+o*o+a*a);r[0].set(n/s,o/s,a/s)})),Yt.addSignature([],[Xe.Vec4],(function(e,t,i,r){var n=jt(Math.random()),o=jt(Math.random()),a=jt(Math.random()),s=jt(Math.random()),l=Math.sqrt(n*n+o*o+a*a+s*s);r[0].set(n/l,o/l,a/l,s/l)})),$e.vrand=Yt;var Zt=new Ze("bsdf");Zt.addSignature([Xe.Vec3,Xe.Vec3,Xe.Vec3,Xe.Number],[],(function(e,t,i,r){})),$e.bsdf=Zt;var Kt=new Set(["output","particleProperty","graphProperty","emit"]),$t=function(){function NodeGraph(e){_classCallCheck(this,NodeGraph),_defineProperty(this,"uuid",void 0),_defineProperty(this,"name",void 0),_defineProperty(this,"version",void 0),_defineProperty(this,"revision",void 0),_defineProperty(this,"inputNodes",[]),_defineProperty(this,"outputNodes",[]),_defineProperty(this,"allNodes",new Map),_defineProperty(this,"wires",[]),_defineProperty(this,"compiled",!1),_defineProperty(this,"nodesInOrder",[]),this.version="1.0",this.uuid=t.MathUtils.generateUUID(),this.name=e,this.revision=0}return _createClass(NodeGraph,[{key:"addWire",value:function addWire(e){this.wires.push(e),this.revision++}},{key:"addNode",value:function addNode(e){this.allNodes.set(e.id,e),e.type===$e.input?this.inputNodes.push(e):Kt.has(e.type.name)&&this.outputNodes.push(e),this.revision++}},{key:"getNode",value:function getNode(e){return this.allNodes.get(e)}},{key:"deleteNode",value:function deleteNode(e){this.allNodes.delete(e.id),this.revision++}},{key:"deleteWire",value:function deleteWire(e){var t=e.input.outputs[e.inputIndex].indexOf(e);-1!==t&&e.input.outputs[e.inputIndex].splice(t,1),e.output.inputs[e.outputIndex]=void 0,-1!=(t=this.wires.indexOf(e))&&(this.wires[t]=this.wires[this.wires.length-1],this.wires.pop()),this.revision++}},{key:"toJSON",value:function toJSON(){throw new Error("not implemented")}},{key:"clone",value:function clone(){throw new Error("not implemented")}}]),NodeGraph}();new t.Vector3(0,0,1);var ei=new t.Quaternion,ti=new t.Vector3,ii=new t.Vector3,ri=new t.PlaneGeometry(1,1,1,1),ni=function(){function NodeVFX(e){var r,n,o,a,s,l,u;_classCallCheck(this,NodeVFX),_defineProperty(this,"emissionGraph",void 0),_defineProperty(this,"updateGraph",void 0),_defineProperty(this,"interpreter",void 0),_defineProperty(this,"autoDestroy",void 0),_defineProperty(this,"prewarm",void 0),_defineProperty(this,"looping",void 0),_defineProperty(this,"duration",void 0),_defineProperty(this,"particleNum",void 0),_defineProperty(this,"paused",void 0),_defineProperty(this,"particles",void 0),_defineProperty(this,"emitter",void 0),_defineProperty(this,"rendererSettings",void 0),_defineProperty(this,"neededToUpdateRender",void 0),_defineProperty(this,"rendererEmitterSettings",void 0),_defineProperty(this,"worldSpace",void 0),_defineProperty(this,"prewarmed",void 0),_defineProperty(this,"emissionState",void 0),_defineProperty(this,"emitEnded",void 0),_defineProperty(this,"markForDestroy",void 0),_defineProperty(this,"previousWorldPos",void 0),_defineProperty(this,"temp",new t.Vector3),_defineProperty(this,"travelDistance",0),_defineProperty(this,"normalMatrix",new t.Matrix3),_defineProperty(this,"_renderer",void 0),_defineProperty(this,"speedFactor",0),this.autoDestroy=void 0!==e.autoDestroy&&e.autoDestroy,this.duration=null!==(r=e.duration)&&void 0!==r?r:1,this.looping=void 0===e.looping||e.looping,this.prewarm=void 0!==e.prewarm&&e.prewarm,this.worldSpace=null!==(n=e.worldSpace)&&void 0!==n&&n,this.rendererEmitterSettings=null!==(o=e.rendererEmitterSettings)&&void 0!==o?o:{},this.emissionGraph=e.emissionGraph,this.updateGraph=e.updateGraph,this.interpreter=new Ye,this.rendererSettings={instancingGeometry:null!==(a=e.instancingGeometry)&&void 0!==a?a:ri,renderMode:null!==(s=e.renderMode)&&void 0!==s?s:be.BillBoard,renderOrder:null!==(l=e.renderOrder)&&void 0!==l?l:0,material:e.material,layers:null!==(u=e.layers)&&void 0!==u?u:new t.Layers,uTileCount:1,vTileCount:1},this.neededToUpdateRender=!0,this.particles=new Array,this.emitter=new i(this),this.paused=!1,this.particleNum=0,this.emissionState={time:0},this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}return _createClass(NodeVFX,[{key:"time",get:function get(){return this.emissionState.time},set:function set(e){this.emissionState.time=e}},{key:"layers",get:function get(){return this.rendererSettings.layers}},{key:"texture",get:function get(){return this.rendererSettings.material.map},set:function set(e){this.rendererSettings.material.map=e,this.neededToUpdateRender=!0}},{key:"material",get:function get(){return this.rendererSettings.material},set:function set(e){this.rendererSettings.material=e,this.neededToUpdateRender=!0}},{key:"instancingGeometry",get:function get(){return this.rendererSettings.instancingGeometry},set:function set(e){this.restart(),this.particles.length=0,this.rendererSettings.instancingGeometry=e,this.neededToUpdateRender=!0}},{key:"renderMode",get:function get(){return this.rendererSettings.renderMode},set:function set(e){if((this.rendererSettings.renderMode!=be.Trail&&e===be.Trail||this.rendererSettings.renderMode==be.Trail&&e!==be.Trail)&&(this.restart(),this.particles.length=0),this.rendererSettings.renderMode!==e)switch(e){case be.Trail:this.rendererEmitterSettings={startLength:30,followLocalOrigin:!1};break;case be.Mesh:this.rendererEmitterSettings={geometry:new t.PlaneGeometry(1,1)};break;case be.BillBoard:case be.VerticalBillBoard:case be.HorizontalBillBoard:case be.StretchedBillBoard:this.rendererEmitterSettings={}}this.rendererSettings.renderMode=e,this.neededToUpdateRender=!0}},{key:"renderOrder",get:function get(){return this.rendererSettings.renderOrder},set:function set(e){this.rendererSettings.renderOrder=e,this.neededToUpdateRender=!0}},{key:"blending",get:function get(){return this.rendererSettings.material.blending},set:function set(e){this.rendererSettings.material.blending=e,this.neededToUpdateRender=!0}},{key:"pause",value:function pause(){this.paused=!0}},{key:"play",value:function play(){this.paused=!1}},{key:"spawn",value:function spawn(e,i){ei.setFromRotationMatrix(i);var r=ti,n=ei,a=ii;for(i.decompose(r,n,a),this.particleNum++;this.particles.length<this.particleNum;)this.particles.push(new o);var s=this.particles[this.particleNum-1];if(s.reset(),this.interpreter.run(this.updateGraph,{particle:s,emissionState:this.emissionState}),this.rendererSettings.renderMode===be.Trail&&this.rendererEmitterSettings.followLocalOrigin){var l=s;l.localPosition=(new t.Vector3).copy(l.position)}this.worldSpace&&(s.position.applyMatrix4(i),s.size*=(Math.abs(a.x)+Math.abs(a.y)+Math.abs(a.z))/3,s.velocity.multiply(a).applyMatrix3(this.normalMatrix),s.rotation&&s.rotation instanceof t.Quaternion&&s.rotation.multiplyQuaternions(ei,s.rotation))}},{key:"endEmit",value:function endEmit(){this.emitEnded=!0,this.autoDestroy&&(this.markForDestroy=!0)}},{key:"dispose",value:function dispose(){this._renderer&&this._renderer.deleteSystem(this),this.emitter.dispose(),this.emitter.parent&&this.emitter.parent.remove(this.emitter)}},{key:"restart",value:function restart(){this.paused=!1,this.particleNum=0,this.emissionState.time=0,this.emitEnded=!1,this.markForDestroy=!1,this.prewarmed=!1}},{key:"update",value:function update(e){if(!this.paused){for(var t=this.emitter;t.parent;)t=t.parent;if("Scene"===t.type)if(this.emitEnded&&0===this.particleNum)this.markForDestroy&&this.emitter.parent&&this.dispose();else{if(this.looping&&this.prewarm&&!this.prewarmed){this.prewarmed=!0;for(var i=0;i<60*this.duration;i++)this.update(1/60)}e>.1&&(e=.1),this.neededToUpdateRender&&(this._renderer&&this._renderer.updateSystem(this),this.neededToUpdateRender=!1),this.emit(e,this.emissionState,this.emitter.matrixWorld);for(var r={particle:void 0,emissionState:this.emissionState,delta:e},n=0;n<this.particleNum;n++)r.particle=this.particles[n],this.interpreter.run(this.updateGraph,r);for(var o=0;o<this.particleNum;o++)this.rendererEmitterSettings.followLocalOrigin&&this.particles[o].localPosition?(this.particles[o].position.copy(this.particles[o].localPosition),this.particles[o].parentMatrix?this.particles[o].position.applyMatrix4(this.particles[o].parentMatrix):this.particles[o].position.applyMatrix4(this.emitter.matrixWorld)):this.particles[o].position.addScaledVector(this.particles[o].velocity,e),this.particles[o].age+=e;if(this.rendererSettings.renderMode===be.Trail)for(var a=0;a<this.particleNum;a++)this.particles[a].update();for(var s=0;s<this.particleNum;s++){var u=this.particles[s];!u.died||u instanceof l&&0!==u.previous.length||(this.particles[s]=this.particles[this.particleNum-1],this.particles[this.particleNum-1]=u,this.particleNum--,s--)}}else this.dispose()}}},{key:"emit",value:function emit(e,i,r){var n=this;i.time>this.duration&&(this.looping?i.time-=this.duration:this.emitEnded||this.endEmit()),this.normalMatrix.getNormalMatrix(r);var o={signal:function signal(){n.spawn(i,r)},emissionState:i,delta:e};this.emitEnded||this.interpreter.run(this.emissionGraph,o),void 0===this.previousWorldPos&&(this.previousWorldPos=new t.Vector3),this.emitter.getWorldPosition(this.previousWorldPos),i.time+=e}},{key:"toJSON",value:function toJSON(e){return{}}},{key:"getRendererSettings",value:function getRendererSettings(){return this.rendererSettings}},{key:"clone",value:function clone(){return this}}]),NodeVFX}();console.log("%c Particle system powered by three.quarks. https://quarks.art/","font-size: 16px; font-weight: bold;"),e.ApplyCollision=ue,e.ApplyForce=R,e.ApplySequences=le,e.AxisAngleGenerator=k,e.BatchedParticleRenderer=Ge,e.BatchedRenderer=Ie,e.BehaviorFromJSON=BehaviorFromJSON,e.BehaviorTypes=pe,e.Bezier=u,e.ChangeEmitDirection=G,e.CircleEmitter=ye,e.ColorBySpeed=ce,e.ColorGeneratorFromJSON=ColorGeneratorFromJSON,e.ColorOverLife=C,e.ColorRange=m,e.ConeEmitter=me,e.ConstantColor=w,e.ConstantValue=O,e.DonutEmitter=ve,e.EmitSubParticleSystem=j,e.EmitterFromJSON=EmitterFromJSON,e.EmitterShapes=xe,e.EulerGenerator=M,e.ForceOverLife=E,e.FrameOverLife=J,e.GeneratorFromJSON=GeneratorFromJSON,e.Gradient=g,e.GraphNodeType=Ke,e.GravityForce=I,e.GridEmitter=we,e.HemisphereEmitter=_e,e.Interpreter=Ye,e.IntervalValue=x,e.LimitSpeedOverLife=fe,e.MeshSurfaceEmitter=Oe,e.Node=He,e.NodeGraph=$t,e.NodeParticle=o,e.NodeType=Ze,e.NodeTypes=$e,e.NodeVFX=ni,e.NodeValueType=Xe,e.Noise=oe,e.OrbitOverLife=L,e.OutputNodeTypeNames=Kt,e.ParticleEmitter=i,e.ParticleSystem=Be,e.PiecewiseBezier=N,e.PiecewiseFunction=b,e.Plugins=qe,e.PointEmitter=ge,e.QuarksLoader=De,e.RandomColor=p,e.RandomColorBetweenGradient=_,e.RandomQuatGenerator=P,e.RecordState=s,e.RenderMode=be,e.Rotation3DOverLife=T,e.RotationBySpeed=he,e.RotationGeneratorFromJSON=RotationGeneratorFromJSON,e.RotationOverLife=V,e.SequencerFromJSON=SequencerFromJSON,e.SizeBySpeed=de,e.SizeOverLife=z,e.SpeedOverLife=A,e.SphereEmitter=Se,e.SpriteBatch=Ue,e.SpriteParticle=a,e.SubParticleEmitMode=X,e.TextureSequencer=ae,e.TrailBatch=Fe,e.TrailParticle=l,e.TurbulenceField=te,e.VFXBatch=Ne,e.ValueGeneratorFromJSON=ValueGeneratorFromJSON,e.WidthOverLength=U,e.Wire=We,e.genDefaultForNodeValueType=je,e.getPhysicsResolver=getPhysicsResolver,e.loadPlugin=function loadPlugin(e){if(!qe.find((function(t){return t.id===e.id}))){e.initialize();var t,i=_createForOfIteratorHelper(e.emitterShapes);try{for(i.s();!(t=i.n()).done;){var r=t.value;xe[r.type]||(xe[r.type]=r)}}catch(e){i.e(e)}finally{i.f()}var n,o=_createForOfIteratorHelper(e.behaviors);try{for(o.s();!(n=o.n()).done;){var a=n.value;pe[a.type]||(pe[a.type]=a)}}catch(e){o.e(e)}finally{o.f()}}},e.setPhysicsResolver=function setPhysicsResolver(e){se=e},e.unloadPlugin=function unloadPlugin(e){var t=qe.find((function(t){return t.id===e}));if(t){var i,r=_createForOfIteratorHelper(t.emitterShapes);try{for(r.s();!(i=r.n()).done;){var n=i.value;xe[n.type]&&delete xe[n.type]}}catch(e){r.e(e)}finally{r.f()}var o,a=_createForOfIteratorHelper(t.behaviors);try{for(a.s();!(o=a.n()).done;){var s=o.value;pe[s.type]&&delete pe[s.type]}}catch(e){a.e(e)}finally{a.f()}}}},"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("three")):"function"==typeof define&&define.amd?define(["exports","three"],t):t(((e="undefined"!=typeof globalThis?globalThis:e||self).THREE=e.THREE||{},e.THREE.QUARKS={}),e.THREE)}));
diff --git a/node_modules/three.quarks/dist/types/EmitterShape.d.ts b/node_modules/three.quarks/dist/types/EmitterShape.d.ts
deleted file mode 100644
index c025a69..0000000
--- a/node_modules/three.quarks/dist/types/EmitterShape.d.ts
+++ /dev/null
@@ -1,15 +0,0 @@
-import { Particle } from "./Particle";
-export interface ShapeJSON {
-    type: string;
-    radius?: number;
-    arc?: number;
-    thickness?: number;
-    angle?: number;
-    mesh?: string;
-}
-export interface EmitterShape {
-    type: string;
-    initialize(particle: Particle): void;
-    toJSON(): ShapeJSON;
-    clone(): EmitterShape;
-}
diff --git a/node_modules/three.quarks/dist/types/InstancedParticleSystemRenderer.d.ts b/node_modules/three.quarks/dist/types/InstancedParticleSystemRenderer.d.ts
deleted file mode 100644
index e69de29..0000000
diff --git a/node_modules/three.quarks/dist/types/ParticleEmitter.d.ts b/node_modules/three.quarks/dist/types/ParticleEmitter.d.ts
index 72d7719..4c47094 100644
--- a/node_modules/three.quarks/dist/types/ParticleEmitter.d.ts
+++ b/node_modules/three.quarks/dist/types/ParticleEmitter.d.ts
@@ -1,4 +1,4 @@
-import { Object3D, BaseEvent } from 'three';
+import { Object3D, Object3DEventMap } from 'three';
 import { IParticleSystem, SerializationOptions } from './BatchedRenderer';
 export interface MetaData {
     geometries: {
@@ -26,7 +26,7 @@ export interface MetaData {
         [key: string]: any;
     };
 }
-export declare class ParticleEmitter<E extends BaseEvent> extends Object3D<E> {
+export declare class ParticleEmitter<E extends Object3DEventMap = Object3DEventMap> extends Object3D<E> {
     type: string;
     system: IParticleSystem;
     constructor(system: IParticleSystem);
diff --git a/node_modules/three.quarks/dist/types/ParticleSystem.d.ts b/node_modules/three.quarks/dist/types/ParticleSystem.d.ts
index 834e5df..b24a6ac 100644
--- a/node_modules/three.quarks/dist/types/ParticleSystem.d.ts
+++ b/node_modules/three.quarks/dist/types/ParticleSystem.d.ts
@@ -3,7 +3,7 @@ import { Behavior } from './behaviors';
 import { Particle } from './Particle';
 import { MetaData, ParticleEmitter } from './ParticleEmitter';
 import { EmitterShape, ShapeJSON } from './shape';
-import { BaseEvent, Blending, BufferGeometry, Layers, Material, Matrix4, Texture, Vector3 } from 'three';
+import { Object3DEventMap, Blending, BufferGeometry, Layers, Material, Matrix4, Texture, Vector3 } from 'three';
 import { RenderMode } from './VFXBatch';
 import { BatchedRenderer, IParticleSystem, RendererEmitterSettings, SerializationOptions, VFXBatchSettings } from './BatchedRenderer';
 import { RotationGenerator } from './functions/RotationGenerator';
@@ -119,7 +119,7 @@ export declare class ParticleSystem implements IParticleSystem {
     paused: boolean;
     particles: Array<Particle>;
     emitterShape: EmitterShape;
-    emitter: ParticleEmitter<BaseEvent>;
+    emitter: ParticleEmitter<Object3DEventMap>;
     rendererSettings: VFXBatchSettings;
     neededToUpdateRender: boolean;
     behaviors: Array<Behavior>;
diff --git a/node_modules/three.quarks/dist/types/ParticleSystemBatch.d.ts b/node_modules/three.quarks/dist/types/ParticleSystemBatch.d.ts
deleted file mode 100644
index e2eb21f..0000000
--- a/node_modules/three.quarks/dist/types/ParticleSystemBatch.d.ts
+++ /dev/null
@@ -1,33 +0,0 @@
-import { ParticleSystem } from './ParticleSystem';
-import { Blending, Mesh, ShaderMaterial, Texture, BufferGeometry } from 'three';
-export interface ParticleSystemBatchSettings {
-    instancingGeometry: BufferGeometry;
-    texture: Texture;
-    uTileCount: number;
-    vTileCount: number;
-    blending: Blending;
-    renderMode: RenderMode;
-    renderOrder: number;
-    transparent: boolean;
-}
-export declare enum RenderMode {
-    BillBoard = 0,
-    StretchedBillBoard = 1,
-    Mesh = 2,
-    Trail = 3
-}
-export declare abstract class ParticleSystemBatch extends Mesh {
-    type: string;
-    systems: Set<ParticleSystem>;
-    material: ShaderMaterial;
-    settings: ParticleSystemBatchSettings;
-    protected maxParticles: number;
-    protected constructor(settings: ParticleSystemBatchSettings);
-    addSystem(system: ParticleSystem): void;
-    removeSystem(system: ParticleSystem): void;
-    abstract setupBuffers(): void;
-    abstract expandBuffers(target: number): void;
-    abstract rebuildMaterial(): void;
-    abstract update(): void;
-    abstract dispose(): void;
-}
diff --git a/node_modules/three.quarks/dist/types/QuarksLoader.d.ts b/node_modules/three.quarks/dist/types/QuarksLoader.d.ts
index c45d1fe..569ed1e 100644
--- a/node_modules/three.quarks/dist/types/QuarksLoader.d.ts
+++ b/node_modules/three.quarks/dist/types/QuarksLoader.d.ts
@@ -1,7 +1,7 @@
-import { Texture, Object3D, LoadingManager, ObjectLoader, Material, AnimationClip } from 'three';
+import { Texture, Object3D, LoadingManager, ObjectLoader, Material, AnimationClip, Object3DEventMap } from 'three';
 export declare class QuarksLoader extends ObjectLoader {
     constructor(manager?: LoadingManager);
     linkReference(object: Object3D): void;
     parse<T extends Object3D>(json: any, onLoad?: (object: Object3D) => void): T;
-    parseObject<T extends Object3D<Event>>(data: any, geometries: any, materials: Material[], textures: Texture[], animations: AnimationClip[]): T;
+    parseObject<T extends Object3D<Object3DEventMap>>(data: any, geometries: any, materials: Material[], textures: Texture[], animations: AnimationClip[]): T;
 }
diff --git a/node_modules/three.quarks/dist/types/behaviors/EmitSubParticleSystem.d.ts b/node_modules/three.quarks/dist/types/behaviors/EmitSubParticleSystem.d.ts
index 87861bc..194d5c1 100644
--- a/node_modules/three.quarks/dist/types/behaviors/EmitSubParticleSystem.d.ts
+++ b/node_modules/three.quarks/dist/types/behaviors/EmitSubParticleSystem.d.ts
@@ -1,7 +1,7 @@
 import { Behavior } from './Behavior';
 import { Particle } from '../Particle';
 import { ParticleSystem } from '../ParticleSystem';
-import { BaseEvent } from 'three';
+import { Object3DEventMap } from 'three';
 import { ParticleEmitter } from '../ParticleEmitter';
 export declare enum SubParticleEmitMode {
     Death = 0,
@@ -11,7 +11,7 @@ export declare enum SubParticleEmitMode {
 export declare class EmitSubParticleSystem implements Behavior {
     private particleSystem;
     useVelocityAsBasis: boolean;
-    subParticleSystem: ParticleEmitter<BaseEvent> | undefined;
+    subParticleSystem: ParticleEmitter<Object3DEventMap> | undefined;
     mode: SubParticleEmitMode;
     emitProbability: number;
     type: string;
@@ -19,7 +19,7 @@ export declare class EmitSubParticleSystem implements Behavior {
     private v_;
     private v2_;
     private subEmissions;
-    constructor(particleSystem: ParticleSystem, useVelocityAsBasis: boolean, subParticleSystem: ParticleEmitter<BaseEvent> | undefined, mode?: SubParticleEmitMode, emitProbability?: number);
+    constructor(particleSystem: ParticleSystem, useVelocityAsBasis: boolean, subParticleSystem: ParticleEmitter<Object3DEventMap> | undefined, mode?: SubParticleEmitMode, emitProbability?: number);
     initialize(particle: Particle): void;
     update(particle: Particle, delta: number): void;
     private emit;
diff --git a/node_modules/three.quarks/dist/types/behaviors/WidthOverPosition.d.ts b/node_modules/three.quarks/dist/types/behaviors/WidthOverPosition.d.ts
deleted file mode 100644
index e69de29..0000000
diff --git a/node_modules/three.quarks/dist/types/functions/ColorRange.d.ts b/node_modules/three.quarks/dist/types/functions/ColorRange.d.ts
index 9c5cff2..b858152 100644
--- a/node_modules/three.quarks/dist/types/functions/ColorRange.d.ts
+++ b/node_modules/three.quarks/dist/types/functions/ColorRange.d.ts
@@ -1,13 +1,13 @@
-import { FunctionColorGenerator } from "./ColorGenerator";
-import { FunctionJSON } from "./FunctionJSON";
-import { Vector4 } from "three";
-export declare class ColorRange implements FunctionColorGenerator {
+import { ColorGenerator } from './ColorGenerator';
+import { FunctionJSON } from './FunctionJSON';
+import { Vector4 } from 'three';
+export declare class ColorRange implements ColorGenerator {
     a: Vector4;
     b: Vector4;
     constructor(a: Vector4, b: Vector4);
-    genColor(color: Vector4, t: number): Vector4;
-    type: "function";
+    genColor(color: Vector4, t?: number): Vector4;
+    type: 'value';
     toJSON(): FunctionJSON;
     static fromJSON(json: FunctionJSON): ColorRange;
-    clone(): FunctionColorGenerator;
+    clone(): ColorGenerator;
 }
diff --git a/node_modules/three.quarks/dist/types/nodes/NodeDef.d.ts b/node_modules/three.quarks/dist/types/nodes/NodeDef.d.ts
deleted file mode 100644
index 72e009b..0000000
--- a/node_modules/three.quarks/dist/types/nodes/NodeDef.d.ts
+++ /dev/null
@@ -1,36 +0,0 @@
-import { NodeValueType } from './NodeValueType';
-import { NodeGraph } from './NodeGraph';
-import { IParticle } from '../Particle';
-import { Vector2, Vector3, Vector4 } from 'three';
-import { NodeData } from './Node';
-export interface ExecutionContext {
-    inputs?: NodeValue[];
-    outputs?: NodeValue[];
-    particle?: IParticle;
-    [key: string]: any;
-}
-type NodeValue = number | boolean | Vector2 | Vector3 | Vector4 | Array<any>;
-type NodeExecFunction = (context: ExecutionContext, data: NodeData, inputs: NodeValue[], outputs: NodeValue[]) => void;
-export interface NodeTypeSignature {
-    inputTypes: NodeValueType[];
-    outputTypes: NodeValueType[];
-    func: NodeExecFunction;
-}
-export declare enum NodeType {
-    Variable = 0,
-    Expression = 1,
-    Storage = 2,
-    Function = 3
-}
-export declare class NodeDef {
-    name: string;
-    type: NodeType;
-    nodeTypeSignatures: NodeTypeSignature[];
-    constructor(name: string, type: NodeType);
-    addSignature(inputTypes: NodeValueType[], outputTypes: NodeValueType[], func: NodeExecFunction): void;
-}
-export declare class GraphNodeType extends NodeDef {
-    nodeGraph: NodeGraph;
-    constructor(nodeGraph: NodeGraph);
-}
-export {};
diff --git a/node_modules/three.quarks/dist/types/nodes/NodeVFX.d.ts b/node_modules/three.quarks/dist/types/nodes/NodeVFX.d.ts
index 1bf2156..95def7c 100644
--- a/node_modules/three.quarks/dist/types/nodes/NodeVFX.d.ts
+++ b/node_modules/three.quarks/dist/types/nodes/NodeVFX.d.ts
@@ -1,6 +1,6 @@
 import { IParticle } from '../Particle';
 import { ParticleEmitter } from '../ParticleEmitter';
-import { BaseEvent, BufferGeometry, Layers, Material, Matrix4, Texture } from 'three';
+import { Object3DEventMap, BufferGeometry, Layers, Material, Matrix4, Texture } from 'three';
 import { RenderMode } from '../VFXBatch';
 import { BatchedRenderer, IParticleSystem, SerializationOptions, VFXBatchSettings } from '../BatchedRenderer';
 import { NodeGraph } from './NodeGraph';
@@ -36,7 +36,7 @@ export declare class NodeVFX implements IParticleSystem {
     particleNum: number;
     paused: boolean;
     particles: Array<IParticle>;
-    emitter: ParticleEmitter<BaseEvent>;
+    emitter: ParticleEmitter<Object3DEventMap>;
     rendererSettings: VFXBatchSettings;
     neededToUpdateRender: boolean;
     rendererEmitterSettings: {};
diff --git a/node_modules/three.quarks/dist/types/shaders/lib/uv_vertex_tile.glsl.d.ts b/node_modules/three.quarks/dist/types/shaders/lib/uv_vertex_tile.glsl.d.ts
deleted file mode 100644
index cd2e4e6..0000000
--- a/node_modules/three.quarks/dist/types/shaders/lib/uv_vertex_tile.glsl.d.ts
+++ /dev/null
@@ -1,2 +0,0 @@
-declare const _default: "\n\n    #ifdef UV_TILE\n        float col = mod(uvTile, tileCount.x);\n        float row = (tileCount.y - floor(uvTile / tileCount.x) - 1.0);\n        \n        mat3 tileTransform = mat3(\n          1.0 / tileCount.x, 0.0, 0.0,\n          0.0, 1.0 / tileCount.y, 0.0, \n          col / tileCount.x, row / tileCount.y, 1.0);\n    #else\n        mat3 tileTransform = mat3(1.0, 0.0, 0.0, 0.0, 1.0, 0.0, 0.0, 0.0, 1.0);\n    #endif\n\n#if defined( USE_UV ) || defined( USE_ANISOTROPY )\n\nvUv = (tileTransform *vec3( uv, 1 )).xy;\n\n#endif\n#ifdef USE_MAP\n\nvMapUv = ( tileTransform * (mapTransform * vec3( MAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ALPHAMAP\n\nvAlphaMapUv = ( tileTransform * (alphaMapTransform * vec3( ALPHAMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_LIGHTMAP\n\nvLightMapUv = ( tileTransform * (lightMapTransform * vec3( LIGHTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_AOMAP\n\nvAoMapUv = ( tileTransform * (aoMapTransform * vec3( AOMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_BUMPMAP\n\nvBumpMapUv = ( tileTransform * (bumpMapTransform * vec3( BUMPMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_NORMALMAP\n\nvNormalMapUv = ( tileTransform * (normalMapTransform * vec3( NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_DISPLACEMENTMAP\n\nvDisplacementMapUv = ( tileTransform * (displacementMapTransform * vec3( DISPLACEMENTMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_EMISSIVEMAP\n\nvEmissiveMapUv = ( tileTransform * (emissiveMapTransform * vec3( EMISSIVEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_METALNESSMAP\n\nvMetalnessMapUv = ( tileTransform * (metalnessMapTransform * vec3( METALNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ROUGHNESSMAP\n\nvRoughnessMapUv = ( tileTransform * (roughnessMapTransform * vec3( ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_ANISOTROPYMAP\n\nvAnisotropyMapUv = ( tileTransform * (anisotropyMapTransform * vec3( ANISOTROPYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOATMAP\n\nvClearcoatMapUv = ( tileTransform * (clearcoatMapTransform * vec3( CLEARCOATMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_NORMALMAP\n\nvClearcoatNormalMapUv = ( tileTransform * (clearcoatNormalMapTransform * vec3( CLEARCOAT_NORMALMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_CLEARCOAT_ROUGHNESSMAP\n\nvClearcoatRoughnessMapUv = ( tileTransform * (clearcoatRoughnessMapTransform * vec3( CLEARCOAT_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCEMAP\n\nvIridescenceMapUv = ( tileTransform * (iridescenceMapTransform * vec3( IRIDESCENCEMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_IRIDESCENCE_THICKNESSMAP\n\nvIridescenceThicknessMapUv = ( tileTransform * (iridescenceThicknessMapTransform * vec3( IRIDESCENCE_THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_COLORMAP\n\nvSheenColorMapUv = ( tileTransform * (sheenColorMapTransform * vec3( SHEEN_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SHEEN_ROUGHNESSMAP\n\nvSheenRoughnessMapUv = ( tileTransform * (sheenRoughnessMapTransform * vec3( SHEEN_ROUGHNESSMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULARMAP\n\nvSpecularMapUv = ( tileTransform * (specularMapTransform * vec3( SPECULARMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_COLORMAP\n\nvSpecularColorMapUv = ( tileTransform * (specularColorMapTransform * vec3( SPECULAR_COLORMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_SPECULAR_INTENSITYMAP\n\nvSpecularIntensityMapUv = ( tileTransform * (specularIntensityMapTransform * vec3( SPECULAR_INTENSITYMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_TRANSMISSIONMAP\n\nvTransmissionMapUv = ( tileTransform * transmissionMapTransform * vec3( TRANSMISSIONMAP_UV, 1 ) )).xy;\n\n#endif\n#ifdef USE_THICKNESSMAP\n\nvThicknessMapUv = ( tileTransform * thicknessMapTransform * vec3( THICKNESSMAP_UV, 1 ) )).xy;\n\n#endif\n";
-export default _default;
diff --git a/node_modules/three.quarks/dist/types/util/simplex-noise.d.ts b/node_modules/three.quarks/dist/types/util/simplex-noise.d.ts
deleted file mode 100644
index 86ea242..0000000
--- a/node_modules/three.quarks/dist/types/util/simplex-noise.d.ts
+++ /dev/null
@@ -1,12 +0,0 @@
-export type RandomFn = () => number;
-export declare class SimplexNoise {
-    private p;
-    private perm;
-    private permMod12;
-    constructor(randomOrSeed?: RandomFn | string | number);
-    noise2D(x: number, y: number): number;
-    noise3D(x: number, y: number, z: number): number;
-    noise4D(x: number, y: number, z: number, w: number): number;
-}
-export default SimplexNoise;
-export declare function buildPermutationTable(random: RandomFn): Uint8Array;
