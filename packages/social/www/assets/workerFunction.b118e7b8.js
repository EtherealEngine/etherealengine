(()=>{(function(){"use strict";function B(e,r,t){if(r&3)throw"Memory aligned on 4 bytes is mandatory";var n=this,s=n.stream=new P(e,r,t),o=s.readInt();if(o==2021286656){s.readInt(),n.entropy=s.readUChar(),n.geometry={};for(var a=s.readInt(),i=0;i<a;i++){var v=s.readString();n.geometry[v]=s.readString()}var a=s.readInt();n.attributes={};for(var i=0;i<a;i++){var f=s.readString(),l=s.readInt(),h=s.readFloat(),u=s.readUChar(),d=s.readUChar(),c=s.readUChar(),y;switch(l){case 2:y=m;break;case 3:y=L;break;case 1:default:y=F;break}n.attributes[f]=new y(f,h,u,d,c)}n.geometry.nvert=n.nvert=n.stream.readInt(),n.geometry.nface=n.nface=n.stream.readInt()}}onmessage=function(e){if(typeof e.data!="string"){var r=e.data.buffer;if(!!r){var t=new B(r);t.attributes.normal&&e.data.short_normals&&(t.attributes.normal.type=3),t.attributes.color&&e.data.rgba_colors&&(t.attributes.color.outcomponents=4);var n=t.decode();postMessage({model:n,buffer:r,request:e.data.request},"*")}}},B.prototype={decode:function(){var e=this;e.last=new Uint32Array(e.nvert*3),e.last_count=0;for(var r in e.attributes)e.attributes[r].init(e.nvert,e.nface);return e.nface==0?e.decodePointCloud():e.decodeMesh(),e.geometry},decodePointCloud:function(){var e=this;e.index=new O(e.nvert,e.nface,0),e.index.decodeGroups(e.stream),e.geometry.groups=e.index.groups;for(var r in e.attributes){var t=e.attributes[r];t.decode(e.nvert,e.stream),t.deltaDecode(e.nvert),t.dequantize(e.nvert),e.geometry[t.name]=t.buffer}},decodeMesh:function(){var e=this;e.index=new O(e.nvert,e.nface),e.index.decodeGroups(e.stream),e.index.decode(e.stream),e.vertex_count=0;var r=0;e.cler=0;for(var t=0;t<e.index.groups.length;t++){var n=e.index.groups[t].end;this.decodeFaces(r*3,n*3),r=n}e.geometry.index=e.index.faces,e.geometry.groups=e.index.groups;for(var s in e.attributes)e.attributes[s].decode(e.nvert,e.stream);for(var s in e.attributes)e.attributes[s].deltaDecode(e.nvert,e.index.prediction);for(var s in e.attributes)e.attributes[s].postDelta(e.nvert,e.nface,e.attributes,e.index);for(var s in e.attributes){var o=e.attributes[s];o.dequantize(e.nvert),e.geometry[o.name]=o.buffer}},ilog2:function(e){for(var r=0;e>>=1;)++r;return r},decodeFaces:function(e,r){var t=this,n=t.index.clers,s=t.index.bitstream,o=t.index.front,a=0;function i(G,V,H,Q,W){o[a]=G,o[a+1]=V,o[a+2]=H,o[a+3]=Q,o[a+4]=W,a+=5}for(var v=new Uint32Array(r-e),f=0,l=0,h=[],u=t.ilog2(t.nvert)+1,d=-1,c=t.index.prediction;e<r;){if(d==-1&&f>=l&&!h.length){var y=t.vertex_count-1,p=[],w=0;n[t.cler++]==6&&(w=s.read(3));for(var q=0;q<3;q++){var S;w&1<<q?S=s.read(u):(c[t.vertex_count*3]=c[t.vertex_count*3+1]=c[t.vertex_count*3+2]=y,y=S=t.vertex_count++),p[q]=S,t.index.faces[e++]=S}var g=a;v[l++]=a,i(p[1],p[2],p[0],g+2*5,g+1*5),v[l++]=a,i(p[2],p[0],p[1],g+0*5,g+2*5),v[l++]=a,i(p[0],p[1],p[2],g+1*5,g+0*5);continue}var b;if(d!=-1?(b=d,d=-1):f<l?b=v[f++]:b=h.pop(),typeof b=="undefined")throw"aarrhhj";if(!(o[b]<0)){var T=n[t.cler++];if(T!=4){var I=o[b+0],E=o[b+1],x=o[b+2],A=o[b+3],U=o[b+4];d=a;var D=-1;if(T==0||T==6)T==6?D=s.read(u):(c[t.vertex_count*3]=E,c[t.vertex_count*3+1]=I,c[t.vertex_count*3+2]=x,D=t.vertex_count++),o[A+4]=d,o[U+3]=d+5,o[a]=I,o[a+1]=D,o[a+2]=E,o[a+3]=A,o[a+4]=d+5,a+=5,v[l++]=a,o[a]=D,o[a+1]=E,o[a+2]=I,o[a+3]=d,o[a+4]=U,a+=5;else if(T==1)o[o[A+3]+4]=d,o[U+3]=d,D=o[A],o[a]=D,o[a+1]=E,o[a+2]=I,o[a+3]=o[A+3],o[a+4]=U,a+=5,o[A]=-1;else if(T==2)o[o[U+4]+3]=d,o[A+4]=d,D=o[U+1],o[a]=I,o[a+1]=D,o[a+2]=E,o[a+3]=A,o[a+4]=o[U+4],a+=5,o[U]=-1;else if(T==5){h.push(b),d=-1;continue}else if(T==3)o[o[A+3]+4]=o[U+4],o[o[U+4]+3]=o[A+3],D=o[A],o[A]=-1,o[U]=-1,d=-1;else throw"INVALID CLER!";if(E>=t.nvert||I>=t.nvert||D>=t.nvert)throw"Topological error";t.index.faces[e]=E,t.index.faces[e+1]=I,t.index.faces[e+2]=D,e+=3}}}}};function F(e,r,t,n,s){var o=this;o.name=e,o.q=r,o.components=t,o.type=n,o.strategy=s}F.prototype={Type:{UINT32:0,INT32:1,UINT16:2,INT16:3,UINT8:4,INT8:5,FLOAT:6,DOUBLE:7},Strategy:{PARALLEL:1,CORRELATED:2},init:function(e,r){var t=this,n=e*t.components;switch(t.values=new Int32Array(n),t.type){case t.Type.UINT32:case t.Type.INT32:t.values=t.buffer=new Int32Array(n);break;case t.Type.UINT16:case t.Type.INT16:t.buffer=new Int16Array(n);break;case t.Type.UINT8:t.buffer=new Uint8Array(n);break;case t.Type.INT8:t.buffer=new Int8Array(n);break;case t.Type.FLOAT:case t.Type.DOUBLE:t.buffer=new Float32Array(n);break;default:throw"Error if reading"}},decode:function(e,r){var t=this;t.strategy&t.Strategy.CORRELATED?r.decodeArray(t.components,t.values):r.decodeValues(t.components,t.values)},deltaDecode:function(e,r){var t=this,n=t.values,s=t.components;if(t.strategy&t.Strategy.PARALLEL)for(var o=r.length/3,a=1;a<o;a++)for(var i=0;i<s;i++)n[a*s+i]+=n[r[a*3]*s+i]+n[r[a*3+1]*s+i]-n[r[a*3+2]*s+i];else if(r)for(var o=r.length/3,a=1;a<o;a++)for(var i=0;i<s;i++)n[a*s+i]+=n[r[a*3]*s+i];else for(a=s;a<e*s;a++)n[a]+=n[a-s]},postDelta:function(){},dequantize:function(e){var r=this,t=r.components*e;switch(r.type){case r.Type.UINT32:case r.Type.INT32:break;case r.Type.UINT16:case r.Type.INT16:case r.Type.UINT8:case r.Type.INT8:for(var n=0;n<t;n++)r.buffer[n]=r.values[n]*r.q;break;case r.Type.FLOAT:case r.Type.DOUBLE:for(var n=0;n<t;n++)r.buffer[n]=r.values[n]*r.q;break}}};function L(e,r,t,n,s){F.call(this,e,r,t,n,s),this.qc=[],this.outcomponents=3}L.prototype=Object.create(F.prototype),L.prototype.decode=function(e,r){for(var t=0;t<4;t++)this.qc[t]=r.readUChar();F.prototype.decode.call(this,e,r)},L.prototype.dequantize=function(e){for(var r=this,t=0;t<e;t++){var n=t*4,s=t*r.outcomponents,o=r.values[n+0],a=r.values[n+1],i=r.values[n+2];r.buffer[s+0]=(i+o)*r.qc[0]&255,r.buffer[s+1]=o*r.qc[1],r.buffer[s+2]=(a+o)*r.qc[2]&255}};function m(e,r,t,n,s){F.call(this,e,r,t,n,s)}m.prototype=Object.create(F.prototype),m.prototype.Prediction={DIFF:0,ESTIMATED:1,BORDER:2},m.prototype.init=function(e,r){var t=this,n=e*t.components;switch(t.values=new Int32Array(2*e),t.type){case t.Type.INT16:t.buffer=new Int16Array(n);break;case t.Type.FLOAT:case t.Type.DOUBLE:t.buffer=new Float32Array(n);break;default:throw"Error if reading"}},m.prototype.decode=function(e,r){var t=this;t.prediction=r.readUChar(),r.decodeArray(2,t.values)},m.prototype.deltaDecode=function(e,r){var t=this;if(t.prediction==t.Prediction.DIFF)if(r)for(var n=1;n<e;n++)for(var s=0;s<2;s++)t.values[n*2+s],t.values[n*2+s]+=t.values[r[n*3]*2+s];else for(var n=2;n<e*2;n++)t.values[n],t.values[n]+=t.values[n-2]},m.prototype.postDelta=function(e,r,t,n){var s=this;if(s.prediction!=s.Prediction.DIFF){if(!t.position)throw"No position attribute found. Use DIFF normal strategy instead.";var o=t.position;s.estimated=new Float32Array(e*3),s.estimateNormals(e,o.values,r,n.faces),s.prediction==s.Prediction.BORDER&&(s.boundary=new Uint32Array(e),s.markBoundary(e,r,n.faces,s.boundary)),s.computeNormals(e)}},m.prototype.dequantize=function(e){var r=this;if(r.prediction==r.Prediction.DIFF)for(var t=0;t<e;t++)r.toSphere(t,r.values,t,r.buffer,r.q)},m.prototype.computeNormals=function(e){var r=this,t=r.estimated;if(r.prediction==r.Prediction.ESTIMATED)for(var n=0;n<e;n++)r.toOcta(n,t,n,r.values,r.q),r.toSphere(n,r.values,n,r.buffer,r.q);else for(var s=0,n=0,o=0;n<e;n++,o+=3)if(r.boundary[n]!=0)r.toOcta(n,t,s,r.values,r.q),r.toSphere(s,r.values,n,r.buffer,r.q),s++;else{var a=1/Math.sqrt(t[o]*t[o]+t[o+1]*t[o+1]+t[o+2]*t[o+2]);r.type==r.Type.INT16&&(a*=32767),r.buffer[o]=t[o]*a,r.buffer[o+1]=t[o+1]*a,r.buffer[o+2]=t[o+2]*a}},m.prototype.markBoundary=function(e,r,t,n){for(var s=0;s<r*3;s+=3)n[t[s+0]]^=t[s+1]^t[s+2],n[t[s+1]]^=t[s+2]^t[s+0],n[t[s+2]]^=t[s+0]^t[s+1]},m.prototype.estimateNormals=function(e,r,t,n){for(var s=this,o=0;o<t*3;o+=3){var a=3*n[o+0],i=3*n[o+1],v=3*n[o+2],f=r[i+0]-r[a+0],l=r[i+1]-r[a+1],h=r[i+2]-r[a+2],u=r[v+0]-r[a+0],d=r[v+1]-r[a+1],c=r[v+2]-r[a+2],y=l*c-h*d,p=h*u-f*c,w=f*d-l*u;s.estimated[a+0]+=y,s.estimated[a+1]+=p,s.estimated[a+2]+=w,s.estimated[i+0]+=y,s.estimated[i+1]+=p,s.estimated[i+2]+=w,s.estimated[v+0]+=y,s.estimated[v+1]+=p,s.estimated[v+2]+=w}},m.prototype.toSphere=function(e,r,t,n,s){var o=this,a=e*2,i=t*3,v=r[a]>0?r[a]:-r[a],f=r[a+1]>0?r[a+1]:-r[a+1];n[i]=r[a],n[i+1]=r[a+1],n[i+2]=s-v-f,n[i+2]<0&&(n[i]=r[a]>0?s-f:f-s,n[i+1]=r[a+1]>0?s-v:v-s);var l=1/Math.sqrt(n[i]*n[i]+n[i+1]*n[i+1]+n[i+2]*n[i+2]);o.type==o.Type.INT16&&(l*=32767),n[i]*=l,n[i+1]*=l,n[i+2]*=l},m.prototype.toOcta=function(e,r,t,n,s){var o=t*2,a=e*3,i=r[a]>0?r[a]:-r[a],v=r[a+1]>0?r[a+1]:-r[a+1],f=r[a+2]>0?r[a+2]:-r[a+2],l=i+v+f,h=r[a]/l,u=r[a+1]/l,d=h>0?h:-h,c=u>0?u:-u;r[a+2]<0&&(h=r[a]>=0?1-c:c-1,u=r[a+1]>=0?1-d:d-1),n[o]+=h*s,n[o+1]+=u*s};function O(e,r,t){var n=this;if(!t&&r<1<<16||t==0)n.faces=new Uint16Array(r*3);else if(!t||t==2)n.faces=new Uint32Array(r*3);else throw"Unsupported type";n.prediction=new Uint32Array(e*3)}O.prototype={decode:function(e){var r=this,t=e.readInt();r.front=new Int32Array(t*5);var n=new N;r.clers=n.decompress(e),r.bitstream=e.readBitStream()},decodeGroups:function(e){var r=this,t=e.readInt();r.groups=new Array(t);for(var n=0;n<t;n++){for(var s=e.readInt(),o=e.readUChar(),a={end:s,properties:{}},i=0;i<o;i++){var v=e.readString();a.properties[v]=e.readString()}r.groups[n]=a}}};function C(e){var r=this;r.a=e,r.current=e[0],r.position=0,r.pending=32}C.prototype={read:function(e){var r=this;if(e>r.pending){r.pending=e-r.pending;var t=r.current<<r.pending>>>0;return r.pending=32-r.pending,r.current=r.a[++r.position],t|=r.current>>>r.pending,r.current=(r.current&(1<<r.pending)-1)>>>0,t}else{r.pending-=e;var t=r.current>>>r.pending;return r.current=(r.current&(1<<r.pending)-1)>>>0,t}}};function P(e,r,t){var n=this;n.data=e,n.buffer=new Uint8Array(e),n.pos=r||0,n.view=new DataView(e)}P.prototype={logs:new Uint8Array(16768),readChar:function(){var e=this.buffer[this.pos++];return e>127&&(e-=256),e},readUChar:function(){return this.buffer[this.pos++]},readShort:function(){return this.pos+=2,this.view.getInt16(this.pos-2,!0)},readFloat:function(){return this.pos+=4,this.view.getFloat32(this.pos-4,!0)},readInt:function(){return this.pos+=4,this.view.getInt32(this.pos-4,!0)},readArray:function(e){var r=this.buffer.subarray(this.pos,this.pos+e);return this.pos+=e,r},readString:function(){var e=this.readShort(),r=String.fromCharCode.apply(null,this.readArray(e-1));return this.pos++,r},readBitStream:function(){var e=this.readInt(),r=this.pos&3;r!=0&&(this.pos+=4-r);var t=new C(new Uint32Array(this.data,this.pos,e));return this.pos+=e*4,t},decodeArray:function(e,r){for(var t=this,n=t.readBitStream(),s=new N;t.logs.length<r.length;)t.logs=new Uint8Array(r.length);s.decompress(this,t.logs);for(var o=0;o<t.logs.readed;o++){var a=t.logs[o];if(a==0){for(var i=0;i<e;i++)r[o*e+i]=0;continue}for(var v=1<<a>>>1,i=0;i<e;i++)r[o*e+i]=n.read(a)-v}return t.logs.readed},decodeValues:function(e,r){for(var t=this,n=t.readBitStream(),s=new N,o=r.length/e;t.logs.length<o;)t.logs=new Uint8Array(o);for(var a=0;a<e;a++){s.decompress(this,t.logs);for(var i=0;i<t.logs.readed;i++){var v=t.logs[i];if(v==0){r[i*e+a]=0;continue}var f=n.read(v),l=1<<v-1>>>0;f<l&&(f=-f-l),r[i*e+a]=f}}return t.logs.readed},decodeDiffs:function(e){for(var r=this,t=r.readBitStream(),n=new N,s=e.length;r.logs.length<s;)r.logs=new Uint8Array(s);n.decompress(this,r.logs);for(var o=0;o<r.logs.readed;o++){var a=r.logs[o];if(a==0){e[o]=0;continue}var i=1<<a>>>1;e[o]=t.read(a)-i}return r.logs.readed},decodeIndices:function(e){for(var r=this,t=r.readBitStream(),n=new N,s=e.length;r.logs.length<s;)r.logs=new Uint8Array(s);n.decompress(this,r.logs);for(var o=0;o<r.logs.readed;o++){var a=r.logs[o];if(a==0){e[o]=0;continue}e[o]=(1<<a)+t.read(a)-1}return r.logs.readed}};function N(){}N.prototype={wordsize:8,dictionary_size:256,starts:new Uint32Array(256),queue:new Uint32Array(512),index:new Uint32Array(512),lengths:new Uint32Array(512),table:new Uint8Array(8192),decompress:function(e,r){var t=e.readUChar();this.probs=e.readArray(t*2),this.createDecodingTables();var n=e.readInt();if(n>1e8)throw"TOO LARGE!";if(r||(r=new Uint8Array(n)),r.length<n)throw"Array for results too small";r.readed=n;var s=e.readInt();if(n>1e8)throw"TOO LARGE!";var o=e.readArray(s);return n&&this._decompress(o,s,r,n),r},createDecodingTables:function(){var e=this,r=e.probs.length/2;if(!(r<=1)){for(var t=N.prototype.queue,n=0,s=0,o=0,a=0;a<r;a++)t[a]=e.probs[2*a+1]<<8;for(var i=Math.floor((e.dictionary_size-1)/(r-1)),v=2,f=t[0],l=t[1],h=f*f>>>16;h>l&&v<i;)h=h*f>>>16,v++;if(v>=16){e.table[s++]=e.probs[0];for(var u=1;u<r;u++){for(var a=0;a<v-1;a++)e.table[s++]=e.probs[0];e.table[s++]=e.probs[2*u]}e.starts[0]=(v-1)*r;for(var u=1;u<r;u++)e.starts[u]=u;for(var d=0;d<v;d++){for(var c=1;c<r;c++){var y=c+d*r;d>0&&(t[y]=h*t[c]>>16),e.index[y]=c*v-d,e.lengths[y]=d+1}d==0?h=f:h=h*f>>>16}var p=(v-1)*r;t[p]=h,e.index[p]=0,e.lengths[p]=v,o=1+v*(r-1),n=v*r}else{for(var a=0;a<r;a++)t[a]=e.probs[a*2+1]<<8,e.index[a]=a,e.lengths[a]=1,e.starts[a]=a,e.table[a]=e.probs[a*2];s=r,n=r,o=r}for(;o<e.dictionary_size;){for(var w=0,q=0,a=0;a<r;a++){var S=t[e.starts[a]];S>q&&(w=a,q=S)}for(var g=e.starts[w],b=e.index[g],T=e.lengths[g],a=0;a<r;a++){t[n]=t[a]*t[g]>>>16,e.index[n]=s,e.lengths[n]=T+1,n++;for(var u=0;u<T;u++)e.table[s+u]=e.table[b+u];if(s+=T,e.table[s++]=e.probs[a*2],a+o==e.dictionary_size-1)break}a==r&&(e.starts[w]+=r),o+=r-1}var I=0;for(a=0,c=0;a<n;a++,c++)c>=r&&(c=0),!(e.starts[c]>a)&&(e.index[I]=e.index[a],e.lengths[I]=e.lengths[a],I++)}},_decompress:function(e,r,t,n){var s=0,o=0;if(this.probs.length==2){for(var v=this.probs[0],a=0;a<n;a++)t[a]=v;return}for(;s<r-1;){var v=e[s++],f=this.index[v],i=f+this.lengths[v];for(a=f;a<i;a++)t[o++]=this.table[a]}var v=e[s],f=this.index[v];for(i=f+n-o,a=f;a<i;a++)t[o++]=this.table[a];return t}};let z,_;const R=[];function M(e){R.push(e),console.log("Message added to queue",e)}function k({meshFilePath:e,numberOfFrames:r,fileHeader:t}){z=e,_=t,globalThis.postMessage({type:"initialized"}),setInterval(async()=>{if(R.length<1)return;let{frameStart:n,frameEnd:s}=R.shift();s<n&&(M({frameStart:0,frameEnd:s}),s=r-1);const a=_.frameData[n],i=_.frameData[s],v=a.startBytePosition,f=i.startBytePosition+i.meshLength,l=[],h=await fetch(z,{headers:{range:`bytes=${v}-${f}`}}).catch(c=>{console.error("WORKERERROR: ",c)}),u=[],d=await h.arrayBuffer().catch(c=>{console.error("Weird error",c)});for(let c=n;c<=s;c++){const y=_.frameData[c],p=y.startBytePosition-a.startBytePosition,w=p+y.meshLength,q=d.slice(p,w),g=new B(q).decode();l.push({frameNumber:y.frameNumber,keyframeNumber:y.keyframeNumber,bufferGeometry:g}),u.push(g.position.buffer),u.push(g.uv.buffer),u.push(g.index.buffer)}globalThis.postMessage({type:"framedata",payload:l},u)},100)}globalThis.onmessage=function(e){e.data.type==="initialize"&&k(e.data.payload),e.data.type==="request"&&M(e.data.payload)}})();})();
