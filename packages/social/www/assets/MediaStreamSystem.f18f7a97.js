import{E as d,g as u,i as P,b as l}from"./avatarFunctions.c7a0e273.js";import{N as h}from"./AuthService.6db25508.js";import{T as f}from"./SystemUpdateType.4e88f289.js";import"./three.module.0404e109.js";import"./index.0040ebb6.js";import"./vendor.c8b8cc93.js";import"./AlertService.bfed2141.js";import"./_app.009e96ac.js";import"./feathers.081246a7.js";import"./upload.38e3baaf.js";import"./index.9af95596.js";const g={qvga:{width:{ideal:320},height:{ideal:240}},vga:{width:{ideal:640},height:{ideal:480}},hd:{width:{ideal:1280},height:{ideal:720}},fhd:{width:{ideal:1920},height:{ideal:1080}}},m={audio:!0},v={video:{width:g.hd.width,height:g.hd.height,frameRate:{max:30}}},E=(o,e)=>o.distance-e.distance;function p(o,e=8){const a=d.defaultWorld.getUserAvatarEntity(o),t=[];for(const[i]of d.defaultWorld.clients)o!==i&&t.push(o);if(a!=null){const i=u(a,f).position;if(i){const s=[];for(const n of t){const S=d.defaultWorld.getUserAvatarEntity(n),c=u(S,f).position;c&&s.push({id:n,distance:c.distanceTo(i)})}return s.sort(E).slice(0,e)}else return[]}else return[]}class r{static EVENTS={TRIGGER_UPDATE_CONSUMERS:"NETWORK_TRANSPORT_EVENT_UPDATE_CONSUMERS",CLOSE_CONSUMER:"NETWORK_TRANSPORT_EVENT_CLOSE_CONSUMER",UPDATE_NEARBY_LAYER_USERS:"NETWORK_TRANSPORT_EVENT_UPDATE_NEARBY_LAYER_USERS"};static instance=new r;videoPaused=!1;audioPaused=!1;faceTracking=!1;videoStream=null;audioStream=null;audioGainNode=null;localScreen=null;camVideoProducer=null;camAudioProducer=null;screenVideoProducer=null;screenAudioProducer=null;producers=[];consumers=[];screenShareVideoPaused=!1;screenShareAudioPaused=!1;initialized=!1;channelType=null;channelId=null;nearbyLayerUsers=[];setFaceTracking(e){return this.faceTracking=e,this.faceTracking}setVideoPaused(e){return console.log("setVideoPaused"),this.videoPaused=e,this.videoPaused}setAudioPaused(e){return this.audioPaused=e,this.audioPaused}setScreenShareVideoPaused(e){return this.screenShareVideoPaused=e,this.screenShareVideoPaused}setScreenShareAudioPaused(e){return this.screenShareAudioPaused=e,this.screenShareAudioPaused}toggleVideoPaused(){return console.log("toggleVideoPaused"),console.log(this.videoPaused),this.videoPaused=!this.videoPaused,this.videoPaused}toggleAudioPaused(){return this.audioPaused=!this.audioPaused,this.audioPaused}toggleScreenShareVideoPaused(){return this.screenShareVideoPaused=!this.screenShareVideoPaused,this.screenShareVideoPaused}toggleScreenShareAudioPaused(){return this.screenShareAudioPaused=!this.screenShareAudioPaused,this.screenShareAudioPaused}async startCamera(){return console.log("start camera"),this.videoStream?!1:await this.getVideoStream()}async startMic(){return console.log("start Mic"),this.audioStream?!1:await this.getAudioStream()}async cycleCamera(){if(!(this.camVideoProducer&&this.camVideoProducer.track))return console.log("cannot cycle camera - no current camera track"),!1;console.log("cycle camera");const e=await this.getCurrentDeviceId("video"),t=(await navigator.mediaDevices.enumerateDevices()).filter(s=>s.kind==="videoinput");if(!(t.length>1))return console.log("cannot cycle camera - only one camera"),!1;let i=t.findIndex(s=>s.deviceId===e);return i===t.length-1?i=0:i+=1,console.log("getting a video stream from new device",t[i].label),this.videoStream=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:t[i].deviceId}}}),await this.camVideoProducer.replaceTrack({track:this.videoStream.getVideoTracks()[0]}),!0}getScreenPausedState(){return this.screenShareVideoPaused}getScreenAudioPausedState(){return this.screenShareAudioPaused}static removeVideoAudio(e){document.querySelectorAll(e.id).forEach(a=>{a.consumer===e&&a?.parentNode.removeChild(a)})}async getCurrentDeviceId(e){if(e==="video"){if(!this.camVideoProducer)return null;const{deviceId:a}=this.camVideoProducer.track.getSettings();if(a)return a;const t=this.videoStream&&this.videoStream.getVideoTracks()[0];return t?(await navigator.mediaDevices.enumerateDevices()).find(n=>n.label.startsWith(t.label)).deviceId:null}if(e==="audio"){if(!this.camAudioProducer)return null;const{deviceId:a}=this.camAudioProducer.track.getSettings();if(a)return a;const t=this.audioStream&&this.audioStream.getAudioTracks()[0];return t?(await navigator.mediaDevices.enumerateDevices()).find(n=>n.label.startsWith(t.label)).deviceId:null}}async getVideoStream(){try{return console.log("Getting video stream"),console.log(v),this.videoStream=await navigator.mediaDevices.getUserMedia(v),console.log(this.videoStream),this.videoStream.active?(this.videoPaused=!1,!0):(this.videoPaused=!0,!1)}catch(e){console.log("failed to get video stream"),console.log(e)}return!1}async getAudioStream(){try{return console.log("Getting audio stream"),console.log(m),this.audioStream=await navigator.mediaDevices.getUserMedia(m),console.log(this.audioStream),this.audioStream.active?(this.audioPaused=!1,!0):(this.audioPaused=!0,!1)}catch(e){console.log("failed to get audio stream"),console.log(e)}return!1}}async function w(o){let e=0,a=!1;return()=>{if(e++,h.instance.mediasoupOperationQueue.getBufferLength()>0&&a===!1){a=!0;const t=h.instance.mediasoupOperationQueue.pop();if(t.object&&t.object.closed!==!0&&t.object._closed!==!0)try{t.action==="resume"?t.object.resume():t.action==="pause"&&t.object.pause(),a=!1}catch(i){a=!1,console.log("Pause or resume error"),console.log(i),console.log(t.object)}else a=!1}if(e>500&&(e=0,P&&r.instance.channelType==="instance")){r.instance.nearbyLayerUsers=p(d.userId);const t=r.instance.nearbyLayerUsers.map(i=>i.id);l.instance.dispatchEvent({type:r.EVENTS.UPDATE_NEARBY_LAYER_USERS}),r.instance.consumers.forEach(i=>{t.includes(i._appData.peerId)||l.instance.dispatchEvent({type:r.EVENTS.CLOSE_CONSUMER,consumer:i})})}}}export{r as MediaStreams,w as default};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiTWVkaWFTdHJlYW1TeXN0ZW0uZjE4ZjdhOTcuanMiLCJzb3VyY2VzIjpbIi4uLy4uLy4uL2VuZ2luZS9zcmMvbmV0d29ya2luZy9jb25zdGFudHMvVmlkZW9Db25zdGFudHMudHMiLCIuLi8uLi8uLi9lbmdpbmUvc3JjL25ldHdvcmtpbmcvZnVuY3Rpb25zL2dldE5lYXJieVVzZXJzLnRzIiwiLi4vLi4vLi4vZW5naW5lL3NyYy9uZXR3b3JraW5nL3N5c3RlbXMvTWVkaWFTdHJlYW1TeXN0ZW0udHMiXSwic291cmNlc0NvbnRlbnQiOlsiLyoqIFZJREVPX0NPTlNUUkFJTlRTIGlzIHZpZGVvIHF1YWxpdHkgbGV2ZWxzLiAqL1xuZXhwb3J0IGNvbnN0IFZJREVPX0NPTlNUUkFJTlRTID0ge1xuICBxdmdhOiB7IHdpZHRoOiB7IGlkZWFsOiAzMjAgfSwgaGVpZ2h0OiB7IGlkZWFsOiAyNDAgfSB9LFxuICB2Z2E6IHsgd2lkdGg6IHsgaWRlYWw6IDY0MCB9LCBoZWlnaHQ6IHsgaWRlYWw6IDQ4MCB9IH0sXG4gIGhkOiB7IHdpZHRoOiB7IGlkZWFsOiAxMjgwIH0sIGhlaWdodDogeyBpZGVhbDogNzIwIH0gfSxcbiAgZmhkOiB7IHdpZHRoOiB7IGlkZWFsOiAxOTIwIH0sIGhlaWdodDogeyBpZGVhbDogMTA4MCB9IH1cbn1cblxuLyoqIGxvY2FsTWVkaWFDb25zdHJhaW50cyBpcyBwYXNzZWQgdG8gdGhlIGdldFVzZXJNZWRpYSBvYmplY3QgdG8gcmVxdWVzdCBhIGxvd2VyIHZpZGVvIHF1YWxpdHkgdGhhbiB0aGUgbWF4aW11bS4gKi9cbmV4cG9ydCBjb25zdCBsb2NhbEF1ZGlvQ29uc3RyYWludHMgPSB7XG4gIGF1ZGlvOiB0cnVlXG59XG5cbmV4cG9ydCBjb25zdCBsb2NhbFZpZGVvQ29uc3RyYWludHMgPSB7XG4gIHZpZGVvOiB7XG4gICAgd2lkdGg6IFZJREVPX0NPTlNUUkFJTlRTLmhkLndpZHRoLFxuICAgIGhlaWdodDogVklERU9fQ09OU1RSQUlOVFMuaGQuaGVpZ2h0LFxuICAgIGZyYW1lUmF0ZTogeyBtYXg6IDMwIH1cbiAgfVxufVxuXG4vKipcbiAqIEVuY29kaW5ncyBmb3Igb3V0Z29pbmcgdmlkZW8uXFxcbiAqIEp1c3QgdHdvIHJlc29sdXRpb25zLCBmb3Igbm93LCBhcyBjaHJvbWUgNzUgc2VlbXMgdG8gaWdub3JlIG1vcmVcbiAqIHRoYW4gdHdvIGVuY29kaW5ncy5cbiAqL1xuZXhwb3J0IGNvbnN0IENBTV9WSURFT19TSU1VTENBU1RfRU5DT0RJTkdTID0gW1xuICB7IG1heEJpdHJhdGU6IDM2MDAwLCBzY2FsZVJlc29sdXRpb25Eb3duQnk6IDQgfSxcbiAgeyBtYXhCaXRyYXRlOiA5NjAwMCwgc2NhbGVSZXNvbHV0aW9uRG93bkJ5OiAyIH0sXG4gIHsgbWF4Qml0cmF0ZTogNjgwMDAwLCBzY2FsZVJlc29sdXRpb25Eb3duQnk6IDEgfVxuXVxuIiwiaW1wb3J0IHsgZ2V0Q29tcG9uZW50IH0gZnJvbSAnLi4vLi4vZWNzL2Z1bmN0aW9ucy9Db21wb25lbnRGdW5jdGlvbnMnXG5pbXBvcnQgeyBFbmdpbmUgfSBmcm9tICcuLi8uLi9lY3MvY2xhc3Nlcy9FbmdpbmUnXG5pbXBvcnQgeyBUcmFuc2Zvcm1Db21wb25lbnQgfSBmcm9tICcuLi8uLi90cmFuc2Zvcm0vY29tcG9uZW50cy9UcmFuc2Zvcm1Db21wb25lbnQnXG5pbXBvcnQgeyBVc2VySWQgfSBmcm9tICdAeHJlbmdpbmUvY29tbW9uL3NyYy9pbnRlcmZhY2VzL1VzZXJJZCdcblxuZXhwb3J0IHR5cGUgTmVhcmJ5VXNlciA9IHsgaWQ6IFVzZXJJZDsgZGlzdGFuY2U6IG51bWJlciB9XG5cbmNvbnN0IGNvbXBhcmVEaXN0YW5jZSA9IChhOiBOZWFyYnlVc2VyLCBiOiBOZWFyYnlVc2VyKSA9PiBhLmRpc3RhbmNlIC0gYi5kaXN0YW5jZVxuXG5leHBvcnQgZnVuY3Rpb24gZ2V0TmVhcmJ5VXNlcnModXNlcklkOiBVc2VySWQsIG1heE1lZGlhVXNlcnMgPSA4KTogQXJyYXk8TmVhcmJ5VXNlcj4ge1xuICBjb25zdCB1c2VyQXZhdGFyID0gRW5naW5lLmRlZmF1bHRXb3JsZC5nZXRVc2VyQXZhdGFyRW50aXR5KHVzZXJJZClcbiAgY29uc3Qgb3RoZXJVc2VycyA9IFtdIGFzIFVzZXJJZFtdXG4gIGZvciAoY29uc3QgW290aGVyVXNlcklkXSBvZiBFbmdpbmUuZGVmYXVsdFdvcmxkLmNsaWVudHMpIHtcbiAgICBpZiAodXNlcklkID09PSBvdGhlclVzZXJJZCkgY29udGludWVcbiAgICBvdGhlclVzZXJzLnB1c2godXNlcklkKVxuICB9XG4gIGlmICh1c2VyQXZhdGFyICE9IG51bGwpIHtcbiAgICBjb25zdCB1c2VyUG9zaXRpb24gPSBnZXRDb21wb25lbnQodXNlckF2YXRhciwgVHJhbnNmb3JtQ29tcG9uZW50KS5wb3NpdGlvblxuICAgIGlmICh1c2VyUG9zaXRpb24pIHtcbiAgICAgIGNvbnN0IHVzZXJEaXN0YW5jZXMgPSBbXSBhcyBBcnJheTx7IGlkOiBVc2VySWQ7IGRpc3RhbmNlOiBudW1iZXIgfT5cbiAgICAgIGZvciAoY29uc3QgaWQgb2Ygb3RoZXJVc2Vycykge1xuICAgICAgICBjb25zdCBhdmF0YXIgPSBFbmdpbmUuZGVmYXVsdFdvcmxkLmdldFVzZXJBdmF0YXJFbnRpdHkoaWQpXG4gICAgICAgIGNvbnN0IHBvc2l0aW9uID0gZ2V0Q29tcG9uZW50KGF2YXRhciwgVHJhbnNmb3JtQ29tcG9uZW50KS5wb3NpdGlvblxuICAgICAgICBpZiAocG9zaXRpb24pIHtcbiAgICAgICAgICB1c2VyRGlzdGFuY2VzLnB1c2goe1xuICAgICAgICAgICAgaWQsXG4gICAgICAgICAgICBkaXN0YW5jZTogcG9zaXRpb24uZGlzdGFuY2VUbyh1c2VyUG9zaXRpb24pXG4gICAgICAgICAgfSlcbiAgICAgICAgfVxuICAgICAgfVxuICAgICAgcmV0dXJuIHVzZXJEaXN0YW5jZXMuc29ydChjb21wYXJlRGlzdGFuY2UpLnNsaWNlKDAsIG1heE1lZGlhVXNlcnMpXG4gICAgfSBlbHNlIHJldHVybiBbXVxuICB9IGVsc2UgcmV0dXJuIFtdXG59XG4iLCJpbXBvcnQgeyBFbmdpbmVFdmVudHMgfSBmcm9tICcuLi8uLi9lY3MvY2xhc3Nlcy9FbmdpbmVFdmVudHMnXG5pbXBvcnQgeyBsb2NhbEF1ZGlvQ29uc3RyYWludHMsIGxvY2FsVmlkZW9Db25zdHJhaW50cyB9IGZyb20gJy4uL2NvbnN0YW50cy9WaWRlb0NvbnN0YW50cydcbmltcG9ydCB7IE5ldHdvcmsgfSBmcm9tICcuLi9jbGFzc2VzL05ldHdvcmsnXG5pbXBvcnQgeyBpc0NsaWVudCB9IGZyb20gJy4uLy4uL2NvbW1vbi9mdW5jdGlvbnMvaXNDbGllbnQnXG5pbXBvcnQgeyBnZXROZWFyYnlVc2VycywgTmVhcmJ5VXNlciB9IGZyb20gJy4uL2Z1bmN0aW9ucy9nZXROZWFyYnlVc2VycydcbmltcG9ydCB7IFdvcmxkIH0gZnJvbSAnLi4vLi4vZWNzL2NsYXNzZXMvV29ybGQnXG5pbXBvcnQgeyBTeXN0ZW0gfSBmcm9tICcuLi8uLi9lY3MvY2xhc3Nlcy9TeXN0ZW0nXG5pbXBvcnQgeyBFbmdpbmUgfSBmcm9tICcuLi8uLi9lY3MvY2xhc3Nlcy9FbmdpbmUnXG5cbi8qKiBTeXN0ZW0gY2xhc3MgZm9yIG1lZGlhIHN0cmVhbWluZy4gKi9cbmV4cG9ydCBjbGFzcyBNZWRpYVN0cmVhbXMge1xuICBzdGF0aWMgRVZFTlRTID0ge1xuICAgIFRSSUdHRVJfVVBEQVRFX0NPTlNVTUVSUzogJ05FVFdPUktfVFJBTlNQT1JUX0VWRU5UX1VQREFURV9DT05TVU1FUlMnLFxuICAgIENMT1NFX0NPTlNVTUVSOiAnTkVUV09SS19UUkFOU1BPUlRfRVZFTlRfQ0xPU0VfQ09OU1VNRVInLFxuICAgIFVQREFURV9ORUFSQllfTEFZRVJfVVNFUlM6ICdORVRXT1JLX1RSQU5TUE9SVF9FVkVOVF9VUERBVEVfTkVBUkJZX0xBWUVSX1VTRVJTJ1xuICB9XG4gIHB1YmxpYyBzdGF0aWMgaW5zdGFuY2UgPSBuZXcgTWVkaWFTdHJlYW1zKClcblxuICAvKiogV2hldGhlciB0aGUgdmlkZW8gaXMgcGF1c2VkIG9yIG5vdC4gKi9cbiAgcHVibGljIHZpZGVvUGF1c2VkID0gZmFsc2VcbiAgLyoqIFdoZXRoZXIgdGhlIGF1ZGlvIGlzIHBhdXNlZCBvciBub3QuICovXG4gIHB1YmxpYyBhdWRpb1BhdXNlZCA9IGZhbHNlXG4gIC8qKiBXaGV0aGVyIHRoZSBmYWNlIHRyYWNraW5nIGlzIGVuYWJsZWQgb3Igbm90LiAqL1xuICBwdWJsaWMgZmFjZVRyYWNraW5nID0gZmFsc2VcbiAgLyoqIFZpZGVvIHN0cmVhbSBmb3Igc3RyZWFtaW5nIGRhdGEuICovXG4gIHB1YmxpYyB2aWRlb1N0cmVhbTogTWVkaWFTdHJlYW0gPSBudWxsIVxuICAvKiogVmlkZW8gc3RyZWFtIGZvciBzdHJlYW1pbmcgZGF0YS4gKi9cbiAgcHVibGljIGF1ZGlvU3RyZWFtOiBNZWRpYVN0cmVhbSA9IG51bGwhXG4gIC8qKiBBdWRpbyBHYWluIHRvIGJlIGFwcGxpZWQgb24gbWVkaWEgc3RyZWFtLiAqL1xuICBwdWJsaWMgYXVkaW9HYWluTm9kZTogR2Fpbk5vZGUgPSBudWxsIVxuXG4gIC8qKiBMb2NhbCBzY3JlZW4gY29udGFpbmVyLiAqL1xuICBwdWJsaWMgbG9jYWxTY3JlZW4gPSBudWxsIGFzIGFueVxuICAvKiogUHJvZHVjZXIgdXNpbmcgY2FtZXJhIHRvIGdldCBWaWRlby4gKi9cbiAgcHVibGljIGNhbVZpZGVvUHJvZHVjZXIgPSBudWxsIGFzIGFueVxuICAvKiogUHJvZHVjZXIgdXNpbmcgY2FtZXJhIHRvIGdldCBBdWRpby4gKi9cbiAgcHVibGljIGNhbUF1ZGlvUHJvZHVjZXIgPSBudWxsIGFzIGFueVxuICAvKiogUHJvZHVjZXIgdXNpbmcgc2NyZWVuIHRvIGdldCBWaWRlby4gKi9cbiAgcHVibGljIHNjcmVlblZpZGVvUHJvZHVjZXIgPSBudWxsIGFzIGFueVxuICAvKiogUHJvZHVjZXIgdXNpbmcgc2NyZWVuIHRvIGdldCBBdWRpby4gKi9cbiAgcHVibGljIHNjcmVlbkF1ZGlvUHJvZHVjZXIgPSBudWxsIGFzIGFueVxuICAvKiogTGlzdCBvZiBhbGwgcHJvZHVjZXJzIG5vZGVzLi4gKi9cbiAgcHVibGljIHByb2R1Y2VycyA9IFtdIGFzIGFueVtdXG4gIC8qKiBMaXN0IG9mIGFsbCBjb25zdW1lciBub2Rlcy4gKi9cbiAgcHVibGljIGNvbnN1bWVycyA9IFtdIGFzIGFueVtdXG4gIC8qKiBJbmRpY2F0aW9uIG9mIHdoZXRoZXIgdGhlIHZpZGVvIHdoaWxlIHNjcmVlbiBzaGFyaW5nIGlzIHBhdXNlZCBvciBub3QuICovXG4gIHB1YmxpYyBzY3JlZW5TaGFyZVZpZGVvUGF1c2VkID0gZmFsc2VcbiAgLyoqIEluZGljYXRpb24gb2Ygd2hldGhlciB0aGUgYXVkaW8gd2hpbGUgc2NyZWVuIHNoYXJpbmcgaXMgcGF1c2VkIG9yIG5vdC4gKi9cbiAgcHVibGljIHNjcmVlblNoYXJlQXVkaW9QYXVzZWQgPSBmYWxzZVxuICAvKiogV2hldGhlciB0aGUgY29tcG9uZW50IGlzIGluaXRpYWxpemVkIG9yIG5vdC4gKi9cbiAgcHVibGljIGluaXRpYWxpemVkID0gZmFsc2VcbiAgLyoqIEN1cnJlbnQgY2hhbm5lbCB0eXBlICovXG4gIHB1YmxpYyBjaGFubmVsVHlwZTogJ2NoYW5uZWwnIHwgJ3VzZXInIHwgJ2dyb3VwJyB8ICdpbnN0YW5jZScgPSBudWxsIVxuICAvKiogQ3VycmVudCBjaGFubmVsIElEICovXG4gIHB1YmxpYyBjaGFubmVsSWQ6IHN0cmluZyA9IG51bGwhXG5cbiAgcHVibGljIG5lYXJieUxheWVyVXNlcnMgPSBbXSBhcyBOZWFyYnlVc2VyW11cblxuICAvKipcbiAgICogU2V0IGZhY2UgdHJhY2tpbmcgc3RhdGUuXG4gICAqIEBwYXJhbSBzdGF0ZSBOZXcgZmFjZSB0cmFja2luZyBzdGF0ZS5cbiAgICogQHJldHVybnMgVXBkYXRlZCBmYWNlIHRyYWNraW5nIHN0YXRlLlxuICAgKi9cbiAgcHVibGljIHNldEZhY2VUcmFja2luZyhzdGF0ZTogYm9vbGVhbik6IGJvb2xlYW4ge1xuICAgIHRoaXMuZmFjZVRyYWNraW5nID0gc3RhdGVcbiAgICByZXR1cm4gdGhpcy5mYWNlVHJhY2tpbmdcbiAgfVxuXG4gIC8qKlxuICAgKiBQYXVzZS9SZXN1bWUgdGhlIHZpZGVvLlxuICAgKiBAcGFyYW0gc3RhdGUgTmV3IFBhdXNlIHN0YXRlLlxuICAgKiBAcmV0dXJucyBVcGRhdGVkIFBhdXNlIHN0YXRlLlxuICAgKi9cbiAgcHVibGljIHNldFZpZGVvUGF1c2VkKHN0YXRlOiBib29sZWFuKTogYm9vbGVhbiB7XG4gICAgY29uc29sZS5sb2coJ3NldFZpZGVvUGF1c2VkJylcbiAgICB0aGlzLnZpZGVvUGF1c2VkID0gc3RhdGVcbiAgICByZXR1cm4gdGhpcy52aWRlb1BhdXNlZFxuICB9XG5cbiAgLyoqXG4gICAqIFBhdXNlL1Jlc3VtZSB0aGUgYXVkaW8uXG4gICAqIEBwYXJhbSBzdGF0ZSBOZXcgUGF1c2Ugc3RhdGUuXG4gICAqIEByZXR1cm5zIFVwZGF0ZWQgUGF1c2Ugc3RhdGUuXG4gICAqL1xuICBwdWJsaWMgc2V0QXVkaW9QYXVzZWQoc3RhdGU6IGJvb2xlYW4pOiBib29sZWFuIHtcbiAgICB0aGlzLmF1ZGlvUGF1c2VkID0gc3RhdGVcbiAgICByZXR1cm4gdGhpcy5hdWRpb1BhdXNlZFxuICB9XG5cbiAgLyoqXG4gICAqIFBhdXNlL1Jlc3VtZSB0aGUgdmlkZW8gd2hpbGUgc2NyZWVuIHNoYXJpbmcuXG4gICAqIEBwYXJhbSBzdGF0ZSBOZXcgUGF1c2Ugc3RhdGUuXG4gICAqIEByZXR1cm5zIFVwZGF0ZWQgUGF1c2Ugc3RhdGUuXG4gICAqL1xuICBwdWJsaWMgc2V0U2NyZWVuU2hhcmVWaWRlb1BhdXNlZChzdGF0ZTogYm9vbGVhbik6IGJvb2xlYW4ge1xuICAgIHRoaXMuc2NyZWVuU2hhcmVWaWRlb1BhdXNlZCA9IHN0YXRlXG4gICAgcmV0dXJuIHRoaXMuc2NyZWVuU2hhcmVWaWRlb1BhdXNlZFxuICB9XG5cbiAgLyoqXG4gICAqIFBhdXNlL1Jlc3VtZSB0aGUgYXVkaW8gd2hpbGUgc2NyZWVuIHNoYXJpbmcuXG4gICAqIEBwYXJhbSBzdGF0ZSBOZXcgUGF1c2Ugc3RhdGUuXG4gICAqIEByZXR1cm5zIFVwZGF0ZWQgUGF1c2Ugc3RhdGUuXG4gICAqL1xuICBwdWJsaWMgc2V0U2NyZWVuU2hhcmVBdWRpb1BhdXNlZChzdGF0ZTogYm9vbGVhbik6IGJvb2xlYW4ge1xuICAgIHRoaXMuc2NyZWVuU2hhcmVBdWRpb1BhdXNlZCA9IHN0YXRlXG4gICAgcmV0dXJuIHRoaXMuc2NyZWVuU2hhcmVBdWRpb1BhdXNlZFxuICB9XG5cbiAgLyoqXG4gICAqIFRvZ2dsZSBQYXVzZSBzdGF0ZSBvZiB2aWRlby5cbiAgICogQHJldHVybnMgVXBkYXRlZCBQYXVzZSBzdGF0ZS5cbiAgICovXG4gIHB1YmxpYyB0b2dnbGVWaWRlb1BhdXNlZCgpOiBib29sZWFuIHtcbiAgICBjb25zb2xlLmxvZygndG9nZ2xlVmlkZW9QYXVzZWQnKVxuICAgIGNvbnNvbGUubG9nKHRoaXMudmlkZW9QYXVzZWQpXG4gICAgdGhpcy52aWRlb1BhdXNlZCA9ICF0aGlzLnZpZGVvUGF1c2VkXG4gICAgcmV0dXJuIHRoaXMudmlkZW9QYXVzZWRcbiAgfVxuXG4gIC8qKlxuICAgKiBUb2dnbGUgUGF1c2Ugc3RhdGUgb2YgYXVkaW8uXG4gICAqIEByZXR1cm5zIFVwZGF0ZWQgUGF1c2Ugc3RhdGUuXG4gICAqL1xuICBwdWJsaWMgdG9nZ2xlQXVkaW9QYXVzZWQoKTogYm9vbGVhbiB7XG4gICAgdGhpcy5hdWRpb1BhdXNlZCA9ICF0aGlzLmF1ZGlvUGF1c2VkXG4gICAgcmV0dXJuIHRoaXMuYXVkaW9QYXVzZWRcbiAgfVxuXG4gIC8qKlxuICAgKiBUb2dnbGUgUGF1c2Ugc3RhdGUgb2YgdmlkZW8gd2hpbGUgc2NyZWVuIHNoYXJpbmcuXG4gICAqIEByZXR1cm5zIFVwZGF0ZWQgUGF1c2Ugc3RhdGUuXG4gICAqL1xuICBwdWJsaWMgdG9nZ2xlU2NyZWVuU2hhcmVWaWRlb1BhdXNlZCgpOiBib29sZWFuIHtcbiAgICB0aGlzLnNjcmVlblNoYXJlVmlkZW9QYXVzZWQgPSAhdGhpcy5zY3JlZW5TaGFyZVZpZGVvUGF1c2VkXG4gICAgcmV0dXJuIHRoaXMuc2NyZWVuU2hhcmVWaWRlb1BhdXNlZFxuICB9XG5cbiAgLyoqXG4gICAqIFRvZ2dsZSBQYXVzZSBzdGF0ZSBvZiBhdWRpbyB3aGlsZSBzY3JlZW4gc2hhcmluZy5cbiAgICogQHJldHVybnMgVXBkYXRlZCBQYXVzZSBzdGF0ZS5cbiAgICovXG4gIHB1YmxpYyB0b2dnbGVTY3JlZW5TaGFyZUF1ZGlvUGF1c2VkKCk6IGJvb2xlYW4ge1xuICAgIHRoaXMuc2NyZWVuU2hhcmVBdWRpb1BhdXNlZCA9ICF0aGlzLnNjcmVlblNoYXJlQXVkaW9QYXVzZWRcbiAgICByZXR1cm4gdGhpcy5zY3JlZW5TaGFyZUF1ZGlvUGF1c2VkXG4gIH1cblxuICAvKipcbiAgICogU3RhcnQgdGhlIGNhbWVyYS5cbiAgICogQHJldHVybnMgV2hldGhlciB0aGUgY2FtZXJhIGlzIHN0YXJ0ZWQgb3Igbm90LiAqL1xuICBhc3luYyBzdGFydENhbWVyYSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBjb25zb2xlLmxvZygnc3RhcnQgY2FtZXJhJylcbiAgICBpZiAodGhpcy52aWRlb1N0cmVhbSkgcmV0dXJuIGZhbHNlXG4gICAgcmV0dXJuIGF3YWl0IHRoaXMuZ2V0VmlkZW9TdHJlYW0oKVxuICB9XG5cbiAgYXN5bmMgc3RhcnRNaWMoKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgY29uc29sZS5sb2coJ3N0YXJ0IE1pYycpXG4gICAgaWYgKHRoaXMuYXVkaW9TdHJlYW0pIHJldHVybiBmYWxzZVxuICAgIHJldHVybiBhd2FpdCB0aGlzLmdldEF1ZGlvU3RyZWFtKClcbiAgfVxuXG4gIC8qKlxuICAgKiBTd2l0Y2ggdG8gc2VuZGluZyB2aWRlbyBmcm9tIHRoZSBcIm5leHRcIiBjYW1lcmEgZGV2aWNlIGluIGRldmljZSBsaXN0IChpZiB0aGVyZSBhcmUgbXVsdGlwbGUgY2FtZXJhcykuXG4gICAqIEByZXR1cm5zIFdoZXRoZXIgY2FtZXJhIGN5Y2xlZCBvciBub3QuXG4gICAqL1xuICBhc3luYyBjeWNsZUNhbWVyYSgpOiBQcm9taXNlPGJvb2xlYW4+IHtcbiAgICBpZiAoISh0aGlzLmNhbVZpZGVvUHJvZHVjZXIgJiYgdGhpcy5jYW1WaWRlb1Byb2R1Y2VyLnRyYWNrKSkge1xuICAgICAgY29uc29sZS5sb2coJ2Nhbm5vdCBjeWNsZSBjYW1lcmEgLSBubyBjdXJyZW50IGNhbWVyYSB0cmFjaycpXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9XG4gICAgY29uc29sZS5sb2coJ2N5Y2xlIGNhbWVyYScpXG5cbiAgICAvLyBmaW5kIFwibmV4dFwiIGRldmljZSBpbiBkZXZpY2UgbGlzdFxuICAgIGNvbnN0IGRldmljZUlkID0gYXdhaXQgdGhpcy5nZXRDdXJyZW50RGV2aWNlSWQoJ3ZpZGVvJylcbiAgICBjb25zdCBhbGxEZXZpY2VzID0gYXdhaXQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKClcbiAgICBjb25zdCB2aWREZXZpY2VzID0gYWxsRGV2aWNlcy5maWx0ZXIoKGQpID0+IGQua2luZCA9PT0gJ3ZpZGVvaW5wdXQnKVxuICAgIGlmICghKHZpZERldmljZXMubGVuZ3RoID4gMSkpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdjYW5ub3QgY3ljbGUgY2FtZXJhIC0gb25seSBvbmUgY2FtZXJhJylcbiAgICAgIHJldHVybiBmYWxzZVxuICAgIH1cbiAgICBsZXQgaW5kZXggPSB2aWREZXZpY2VzLmZpbmRJbmRleCgoZCkgPT4gZC5kZXZpY2VJZCA9PT0gZGV2aWNlSWQpXG4gICAgaWYgKGluZGV4ID09PSB2aWREZXZpY2VzLmxlbmd0aCAtIDEpIGluZGV4ID0gMFxuICAgIGVsc2UgaW5kZXggKz0gMVxuXG4gICAgLy8gZ2V0IGEgbmV3IHZpZGVvIHN0cmVhbS4gbWlnaHQgYXMgd2VsbCBnZXQgYSBuZXcgYXVkaW8gc3RyZWFtIHRvbyxcbiAgICAvLyBqdXN0IGluIGNhc2UgYnJvd3NlcnMgd2FudCB0byBncm91cCBhdWRpby92aWRlbyBzdHJlYW1zIHRvZ2V0aGVyXG4gICAgLy8gZnJvbSB0aGUgc2FtZSBkZXZpY2Ugd2hlbiBwb3NzaWJsZSAodGhvdWdoIHRoZXkgZG9uJ3Qgc2VlbSB0byxcbiAgICAvLyBjdXJyZW50bHkpXG4gICAgY29uc29sZS5sb2coJ2dldHRpbmcgYSB2aWRlbyBzdHJlYW0gZnJvbSBuZXcgZGV2aWNlJywgdmlkRGV2aWNlc1tpbmRleF0ubGFiZWwpXG4gICAgdGhpcy52aWRlb1N0cmVhbSA9IGF3YWl0IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKHtcbiAgICAgIHZpZGVvOiB7IGRldmljZUlkOiB7IGV4YWN0OiB2aWREZXZpY2VzW2luZGV4XS5kZXZpY2VJZCB9IH1cbiAgICB9KVxuXG4gICAgLy8gcmVwbGFjZSB0aGUgdHJhY2tzIHdlIGFyZSBzZW5kaW5nXG4gICAgYXdhaXQgdGhpcy5jYW1WaWRlb1Byb2R1Y2VyLnJlcGxhY2VUcmFjayh7XG4gICAgICB0cmFjazogdGhpcy52aWRlb1N0cmVhbS5nZXRWaWRlb1RyYWNrcygpWzBdXG4gICAgfSlcbiAgICByZXR1cm4gdHJ1ZVxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB3aGV0aGVyIHNjcmVlbiB2aWRlbyBwYXVzZWQgb3Igbm90LlxuICAgKiBAcmV0dXJucyBTY3JlZW4gdmlkZW8gcGF1c2VkIHN0YXRlLlxuICAgKi9cbiAgZ2V0U2NyZWVuUGF1c2VkU3RhdGUoKTogYm9vbGVhbiB7XG4gICAgcmV0dXJuIHRoaXMuc2NyZWVuU2hhcmVWaWRlb1BhdXNlZFxuICB9XG5cbiAgLyoqXG4gICAqIEdldCB3aGV0aGVyIHNjcmVlbiBhdWRpbyBwYXVzZWQgb3Igbm90LlxuICAgKiBAcmV0dXJucyBTY3JlZW4gYXVkaW8gcGF1c2VkIHN0YXRlLlxuICAgKi9cbiAgZ2V0U2NyZWVuQXVkaW9QYXVzZWRTdGF0ZSgpOiBib29sZWFuIHtcbiAgICByZXR1cm4gdGhpcy5zY3JlZW5TaGFyZUF1ZGlvUGF1c2VkXG4gIH1cblxuICAvKipcbiAgICogUmVtb3ZlIHZpZGVvIGFuZCBhdWRpbyBub2RlIGZyb20gdGhlIGNvbnN1bWVyLlxuICAgKiBAcGFyYW0gY29uc3VtZXIgQ29uc3VtZXIgZnJvbSB3aGljaCB2aWRlbyBhbmQgYXVkaW8gbm9kZSB3aWxsIGJlIHJlbW92ZWQuXG4gICAqL1xuICBzdGF0aWMgcmVtb3ZlVmlkZW9BdWRpbyhjb25zdW1lcjogYW55KTogdm9pZCB7XG4gICAgZG9jdW1lbnQucXVlcnlTZWxlY3RvckFsbChjb25zdW1lci5pZCkuZm9yRWFjaCgodikgPT4ge1xuICAgICAgaWYgKHYuY29uc3VtZXIgPT09IGNvbnN1bWVyKSB2Py5wYXJlbnROb2RlLnJlbW92ZUNoaWxkKHYpXG4gICAgfSlcbiAgfVxuXG4gIC8qKiBHZXQgZGV2aWNlIElEIG9mIGRldmljZSB3aGljaCBpcyBjdXJyZW50bHkgc3RyZWFtaW5nIG1lZGlhLiAqL1xuICBhc3luYyBnZXRDdXJyZW50RGV2aWNlSWQoc3RyZWFtVHlwZTogc3RyaW5nKSB7XG4gICAgaWYgKHN0cmVhbVR5cGUgPT09ICd2aWRlbycpIHtcbiAgICAgIGlmICghdGhpcy5jYW1WaWRlb1Byb2R1Y2VyKSByZXR1cm4gbnVsbFxuXG4gICAgICBjb25zdCB7IGRldmljZUlkIH0gPSB0aGlzLmNhbVZpZGVvUHJvZHVjZXIudHJhY2suZ2V0U2V0dGluZ3MoKVxuICAgICAgaWYgKGRldmljZUlkKSByZXR1cm4gZGV2aWNlSWRcbiAgICAgIC8vIEZpcmVmb3ggZG9lc24ndCBoYXZlIGRldmljZUlkIGluIE1lZGlhVHJhY2tTZXR0aW5ncyBvYmplY3RcbiAgICAgIGNvbnN0IHRyYWNrID0gdGhpcy52aWRlb1N0cmVhbSAmJiB0aGlzLnZpZGVvU3RyZWFtLmdldFZpZGVvVHJhY2tzKClbMF1cbiAgICAgIGlmICghdHJhY2spIHJldHVybiBudWxsXG4gICAgICBjb25zdCBkZXZpY2VzID0gYXdhaXQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKClcbiAgICAgIGNvbnN0IGRldmljZUluZm8gPSBkZXZpY2VzLmZpbmQoKGQpID0+IGQubGFiZWwuc3RhcnRzV2l0aCh0cmFjay5sYWJlbCkpIVxuICAgICAgcmV0dXJuIGRldmljZUluZm8uZGV2aWNlSWRcbiAgICB9XG4gICAgaWYgKHN0cmVhbVR5cGUgPT09ICdhdWRpbycpIHtcbiAgICAgIGlmICghdGhpcy5jYW1BdWRpb1Byb2R1Y2VyKSByZXR1cm4gbnVsbFxuXG4gICAgICBjb25zdCB7IGRldmljZUlkIH0gPSB0aGlzLmNhbUF1ZGlvUHJvZHVjZXIudHJhY2suZ2V0U2V0dGluZ3MoKVxuICAgICAgaWYgKGRldmljZUlkKSByZXR1cm4gZGV2aWNlSWRcbiAgICAgIC8vIEZpcmVmb3ggZG9lc24ndCBoYXZlIGRldmljZUlkIGluIE1lZGlhVHJhY2tTZXR0aW5ncyBvYmplY3RcbiAgICAgIGNvbnN0IHRyYWNrID0gdGhpcy5hdWRpb1N0cmVhbSAmJiB0aGlzLmF1ZGlvU3RyZWFtLmdldEF1ZGlvVHJhY2tzKClbMF1cbiAgICAgIGlmICghdHJhY2spIHJldHVybiBudWxsXG4gICAgICBjb25zdCBkZXZpY2VzID0gYXdhaXQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5lbnVtZXJhdGVEZXZpY2VzKClcbiAgICAgIGNvbnN0IGRldmljZUluZm8gPSBkZXZpY2VzLmZpbmQoKGQpID0+IGQubGFiZWwuc3RhcnRzV2l0aCh0cmFjay5sYWJlbCkpIVxuICAgICAgcmV0dXJuIGRldmljZUluZm8uZGV2aWNlSWRcbiAgICB9XG4gIH1cblxuICAvKipcbiAgICogR2V0IHVzZXIgdmlkZW8gc3RyZWFtLlxuICAgKiBAcmV0dXJucyBXaGV0aGVyIHN0cmVhbSBpcyBhY3RpdmUgb3Igbm90LlxuICAgKi9cbiAgcHVibGljIGFzeW5jIGdldFZpZGVvU3RyZWFtKCk6IFByb21pc2U8Ym9vbGVhbj4ge1xuICAgIHRyeSB7XG4gICAgICBjb25zb2xlLmxvZygnR2V0dGluZyB2aWRlbyBzdHJlYW0nKVxuICAgICAgY29uc29sZS5sb2cobG9jYWxWaWRlb0NvbnN0cmFpbnRzKVxuICAgICAgdGhpcy52aWRlb1N0cmVhbSA9IGF3YWl0IG5hdmlnYXRvci5tZWRpYURldmljZXMuZ2V0VXNlck1lZGlhKGxvY2FsVmlkZW9Db25zdHJhaW50cylcbiAgICAgIGNvbnNvbGUubG9nKHRoaXMudmlkZW9TdHJlYW0pXG4gICAgICBpZiAodGhpcy52aWRlb1N0cmVhbS5hY3RpdmUpIHtcbiAgICAgICAgdGhpcy52aWRlb1BhdXNlZCA9IGZhbHNlXG4gICAgICAgIHJldHVybiB0cnVlXG4gICAgICB9XG4gICAgICB0aGlzLnZpZGVvUGF1c2VkID0gdHJ1ZVxuICAgICAgcmV0dXJuIGZhbHNlXG4gICAgfSBjYXRjaCAoZXJyKSB7XG4gICAgICBjb25zb2xlLmxvZygnZmFpbGVkIHRvIGdldCB2aWRlbyBzdHJlYW0nKVxuICAgICAgY29uc29sZS5sb2coZXJyKVxuICAgIH1cbiAgICByZXR1cm4gZmFsc2VcbiAgfVxuXG4gIC8qKlxuICAgKiBHZXQgdXNlciB2aWRlbyBzdHJlYW0uXG4gICAqIEByZXR1cm5zIFdoZXRoZXIgc3RyZWFtIGlzIGFjdGl2ZSBvciBub3QuXG4gICAqL1xuICBwdWJsaWMgYXN5bmMgZ2V0QXVkaW9TdHJlYW0oKTogUHJvbWlzZTxib29sZWFuPiB7XG4gICAgdHJ5IHtcbiAgICAgIGNvbnNvbGUubG9nKCdHZXR0aW5nIGF1ZGlvIHN0cmVhbScpXG4gICAgICBjb25zb2xlLmxvZyhsb2NhbEF1ZGlvQ29uc3RyYWludHMpXG4gICAgICB0aGlzLmF1ZGlvU3RyZWFtID0gYXdhaXQgbmF2aWdhdG9yLm1lZGlhRGV2aWNlcy5nZXRVc2VyTWVkaWEobG9jYWxBdWRpb0NvbnN0cmFpbnRzKVxuICAgICAgY29uc29sZS5sb2codGhpcy5hdWRpb1N0cmVhbSlcbiAgICAgIGlmICh0aGlzLmF1ZGlvU3RyZWFtLmFjdGl2ZSkge1xuICAgICAgICB0aGlzLmF1ZGlvUGF1c2VkID0gZmFsc2VcbiAgICAgICAgcmV0dXJuIHRydWVcbiAgICAgIH1cbiAgICAgIHRoaXMuYXVkaW9QYXVzZWQgPSB0cnVlXG4gICAgICByZXR1cm4gZmFsc2VcbiAgICB9IGNhdGNoIChlcnIpIHtcbiAgICAgIGNvbnNvbGUubG9nKCdmYWlsZWQgdG8gZ2V0IGF1ZGlvIHN0cmVhbScpXG4gICAgICBjb25zb2xlLmxvZyhlcnIpXG4gICAgfVxuICAgIHJldHVybiBmYWxzZVxuICB9XG59XG5cbmV4cG9ydCBkZWZhdWx0IGFzeW5jIGZ1bmN0aW9uIE1lZGlhU3RyZWFtU3lzdGVtKHdvcmxkOiBXb3JsZCk6IFByb21pc2U8U3lzdGVtPiB7XG4gIGxldCBuZWFyYnlBdmF0YXJUaWNrID0gMFxuICBsZXQgZXhlY3V0ZUluUHJvZ3Jlc3MgPSBmYWxzZVxuXG4gIHJldHVybiAoKSA9PiB7XG4gICAgbmVhcmJ5QXZhdGFyVGljaysrXG5cbiAgICBpZiAoTmV0d29yay5pbnN0YW5jZS5tZWRpYXNvdXBPcGVyYXRpb25RdWV1ZS5nZXRCdWZmZXJMZW5ndGgoKSA+IDAgJiYgZXhlY3V0ZUluUHJvZ3Jlc3MgPT09IGZhbHNlKSB7XG4gICAgICBleGVjdXRlSW5Qcm9ncmVzcyA9IHRydWVcbiAgICAgIGNvbnN0IGJ1ZmZlciA9IE5ldHdvcmsuaW5zdGFuY2UubWVkaWFzb3VwT3BlcmF0aW9uUXVldWUucG9wKCkgYXMgYW55XG4gICAgICBpZiAoYnVmZmVyLm9iamVjdCAmJiBidWZmZXIub2JqZWN0LmNsb3NlZCAhPT0gdHJ1ZSAmJiBidWZmZXIub2JqZWN0Ll9jbG9zZWQgIT09IHRydWUpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICBpZiAoYnVmZmVyLmFjdGlvbiA9PT0gJ3Jlc3VtZScpIGJ1ZmZlci5vYmplY3QucmVzdW1lKClcbiAgICAgICAgICBlbHNlIGlmIChidWZmZXIuYWN0aW9uID09PSAncGF1c2UnKSBidWZmZXIub2JqZWN0LnBhdXNlKClcbiAgICAgICAgICBleGVjdXRlSW5Qcm9ncmVzcyA9IGZhbHNlXG4gICAgICAgIH0gY2F0Y2ggKGVycikge1xuICAgICAgICAgIGV4ZWN1dGVJblByb2dyZXNzID0gZmFsc2VcbiAgICAgICAgICBjb25zb2xlLmxvZygnUGF1c2Ugb3IgcmVzdW1lIGVycm9yJylcbiAgICAgICAgICBjb25zb2xlLmxvZyhlcnIpXG4gICAgICAgICAgY29uc29sZS5sb2coYnVmZmVyLm9iamVjdClcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZXhlY3V0ZUluUHJvZ3Jlc3MgPSBmYWxzZVxuICAgICAgfVxuICAgIH1cblxuICAgIGlmIChuZWFyYnlBdmF0YXJUaWNrID4gNTAwKSB7XG4gICAgICBuZWFyYnlBdmF0YXJUaWNrID0gMFxuICAgICAgaWYgKGlzQ2xpZW50ICYmIE1lZGlhU3RyZWFtcy5pbnN0YW5jZS5jaGFubmVsVHlwZSA9PT0gJ2luc3RhbmNlJykge1xuICAgICAgICBNZWRpYVN0cmVhbXMuaW5zdGFuY2UubmVhcmJ5TGF5ZXJVc2VycyA9IGdldE5lYXJieVVzZXJzKEVuZ2luZS51c2VySWQpXG4gICAgICAgIGNvbnN0IG5lYXJieVVzZXJJZHMgPSBNZWRpYVN0cmVhbXMuaW5zdGFuY2UubmVhcmJ5TGF5ZXJVc2Vycy5tYXAoKHVzZXIpID0+IHVzZXIuaWQpXG4gICAgICAgIEVuZ2luZUV2ZW50cy5pbnN0YW5jZS5kaXNwYXRjaEV2ZW50KHsgdHlwZTogTWVkaWFTdHJlYW1zLkVWRU5UUy5VUERBVEVfTkVBUkJZX0xBWUVSX1VTRVJTIH0pXG4gICAgICAgIE1lZGlhU3RyZWFtcy5pbnN0YW5jZS5jb25zdW1lcnMuZm9yRWFjaCgoY29uc3VtZXIpID0+IHtcbiAgICAgICAgICBpZiAoIW5lYXJieVVzZXJJZHMuaW5jbHVkZXMoY29uc3VtZXIuX2FwcERhdGEucGVlcklkKSkge1xuICAgICAgICAgICAgRW5naW5lRXZlbnRzLmluc3RhbmNlLmRpc3BhdGNoRXZlbnQoeyB0eXBlOiBNZWRpYVN0cmVhbXMuRVZFTlRTLkNMT1NFX0NPTlNVTUVSLCBjb25zdW1lciB9KVxuICAgICAgICAgIH1c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
